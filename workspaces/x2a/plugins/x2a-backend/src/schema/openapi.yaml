openapi: 3.0.4
info:
  title: x2a
  description: The [X2Ansible](https://github.com/redhat-developer/x2ansible) API.
  version: 0.0.1

servers:
  - url: /

paths:
  /projects:
    get:
      summary: Returns a list of projects.
      parameters:
        - in: query
          name: page
          schema:
            type: integer
          required: false
          description: Page number
        - in: query
          name: pageSize
          schema:
            type: integer
          required: false
          description: Page size
        - in: query
          name: order
          schema:
            type: string
            enum:
              - asc
              - desc
          required: false
          description: Sort order, either ascending ("asc") or descending ("desc")
        - in: query
          name: sort
          schema:
            type: string
            enum:
              - createdAt
              - name
              - abbreviation
              - status
              - description
              - createdBy
          required: false
          description: Sort by field
      responses:
        '200':
          description: All projects filtered by the user permissions. Sorted and paginated.
          content:
            application/json:
              schema:
                type: object
                properties:
                  totalCount:
                    type: integer
                    description: Total number of projects available after filtering (useful for pagination).
                  items:
                    type: array
                    description: Projects filtered by the user permissions and pagination (if requested).
                    items:
                      $ref: '#/components/schemas/Project'
    post:
      summary: Creates a new project.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                  description: Full name of the project
                description:
                  type: string
                  description: Description of the project
                abbreviation:
                  type: string
                  description: Project abbreviation
              required:
                - name
                - description
                - abbreviation
      responses:
        '201':
          description: Created project data.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Project'

  /projects/{projectId}:
    get:
      summary: Returns a project by ID.
      parameters:
        - in: path
          name: projectId
          schema:
            type: string
          required: true
      responses:
        '200':
          description: Project data.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Project'
        '404':
          description: Project not found.
    delete:
      summary: Deletes a project by ID.
      parameters:
        - in: path
          name: projectId
          schema:
            type: string
          required: true
      responses:
        '200':
          description: Project deleted successfully.
          content:
            application/json:
              schema:
                type: object
                properties:
                  deletedCount:
                    type: integer
                    description: Number of projects deleted (0 or 1)
                required:
                  - deletedCount

  /projects/{projectId}/run:
    post:
      summary: Triggers the init phase to produce the migration plan
      parameters:
        - in: path
          name: projectId
          schema:
            type: string
          required: true
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                sourceRepo:
                  $ref: '#/components/schemas/GitRepoCredentials'
                targetRepo:
                  $ref: '#/components/schemas/GitRepoCredentials'
                aapCredentials:
                  $ref: '#/components/schemas/AAPCredentials'
                userPrompt:
                  type: string
                  description: Optional user prompt for customizing the migration
              required:
                - sourceRepo
                - targetRepo
      responses:
        '200':
          description: Init job created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    enum:
                      - pending
                    description: Job status
                  jobId:
                    type: string
                    description: UUID of the created job
                required:
                  - status
                  - jobId
        '404':
          description: Project not found

  /projects/{projectId}/modules:
    post:
      summary: Creates a new module for a project
      description: |
        **TEMPORARY ENDPOINT FOR TESTING ONLY**

        This endpoint provides simple CRUD functionality to create modules for testing the job triggering infrastructure.

        According to the ADR, this endpoint should eventually sync modules by parsing the migration plan (created by the init phase).
        The proper implementation will be added when the init phase integration is complete.

        TODO: Replace with proper sync logic that parses the migration plan via LLM (see ADR lines 202-213)
      parameters:
        - in: path
          name: projectId
          schema:
            type: string
          required: true
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                  description: Module name
                sourcePath:
                  type: string
                  description: Path to the module in the source repository
              required:
                - name
                - sourcePath
      responses:
        '201':
          description: Module created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Module'
        '404':
          description: Project not found

  /projects/{projectId}/modules/{moduleId}/run:
    post:
      summary: Triggers a migration phase for a specific module
      parameters:
        - in: path
          name: projectId
          schema:
            type: string
          required: true
        - in: path
          name: moduleId
          schema:
            type: string
          required: true
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                phase:
                  type: string
                  enum:
                    - analyze
                    - migrate
                    - publish
                  description: Migration phase to execute
                sourceRepo:
                  $ref: '#/components/schemas/GitRepoCredentials'
                targetRepo:
                  $ref: '#/components/schemas/GitRepoCredentials'
                aapCredentials:
                  $ref: '#/components/schemas/AAPCredentials'
                userPrompt:
                  type: string
                  description: Optional user prompt for customizing the migration
              required:
                - phase
                - sourceRepo
                - targetRepo
      responses:
        '200':
          description: Migration job created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    enum:
                      - pending
                    description: Job status
                  jobId:
                    type: string
                    description: UUID of the created job
                required:
                  - status
                  - jobId
        '404':
          description: Project or module not found
components:
  schemas:
    Project:
      type: object
      properties:
        id:
          type: string
          description: UUID for the project
        abbreviation:
          type: string
          description: Abbreviation of the project
        name:
          type: string
          description: Full name of the project
        description:
          type: string
          description: Description of the project
        createdAt:
          type: string
          format: date-time
          description: Date/time when the project was created
        createdBy:
          type: string
          description: The user who created the project (Backstage user reference)
      required:
        - id
        - name
        - abbreviation
        - createdAt
        - createdBy

    Module:
      type: object
      properties:
        id:
          type: string
          description: UUID for the module
        name:
          type: string
          description: Module name
        sourcePath:
          type: string
          description: Path to the module in the source repository
        projectId:
          type: string
          description: UUID of the parent project
      required:
        - id
        - name
        - sourcePath
        - projectId

    GitRepoCredentials:
      type: object
      properties:
        url:
          type: string
          description: Git repository URL
        token:
          type: string
          description: Authentication token for the git repository
        branch:
          type: string
          description: Git branch name
      required:
        - url
        - token
        - branch

    AAPCredentials:
      type: object
      properties:
        url:
          type: string
          description: Ansible Automation Platform URL
        orgName:
          type: string
          description: AAP organization name
        oauthToken:
          type: string
          description: OAuth token for AAP authentication
        username:
          type: string
          description: Username for AAP authentication (alternative to OAuth token)
        password:
          type: string
          description: Password for AAP authentication (alternative to OAuth token)
      required:
        - url
        - orgName
