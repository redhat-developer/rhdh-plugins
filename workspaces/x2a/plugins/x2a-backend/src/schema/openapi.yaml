openapi: 3.0.4
info:
  title: x2a
  description: The [X2Ansible](https://github.com/redhat-developer/x2ansible) API.
  version: 0.0.1

servers:
  - url: /

paths:
  /projects:
    get:
      summary: Returns a list of projects.
      parameters:
        - in: query
          name: page
          schema:
            type: integer
          required: false
          description: Page number
        - in: query
          name: pageSize
          schema:
            type: integer
          required: false
          description: Page size
        - in: query
          name: order
          schema:
            type: string
            enum:
              - asc
              - desc
          required: false
          description: Sort order, either ascending ("asc") or descending ("desc")
        - in: query
          name: sort
          schema:
            type: string
            enum:
              - createdAt
              - name
              - abbreviation
              - status
              - description
              - createdBy
          required: false
          description: Sort by field
      responses:
        '200':
          description: All projects filtered by the user permissions. Sorted and paginated.
          content:
            application/json:
              schema:
                type: object
                properties:
                  totalCount:
                    type: integer
                    description: Total number of projects available after filtering (useful for pagination).
                  items:
                    type: array
                    description: Projects filtered by the user permissions and pagination (if requested).
                    items:
                      $ref: '#/components/schemas/Project'
    post:
      summary: Creates a new project.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                  description: Full name of the project
                description:
                  type: string
                  description: Description of the project
                abbreviation:
                  type: string
                  description: Project abbreviation
                sourceRepoUrl:
                  type: string
                  description: URL of the source repository
                targetRepoUrl:
                  type: string
                  description: URL of the target repository
                sourceRepoBranch:
                  type: string
                  description: Branch of the source repository (default to main)
                targetRepoBranch:
                  type: string
                  description: Branch of the target repository (default to main)
              required:
                - name
                - description
                - abbreviation
                - sourceRepoUrl
                - targetRepoUrl
                - sourceRepoBranch
                - targetRepoBranch
      responses:
        '201':
          description: Created project data.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Project'

  /projects/{projectId}:
    get:
      summary: Returns a project by ID.
      parameters:
        - in: path
          name: projectId
          schema:
            type: string
          required: true
      responses:
        '200':
          description: Project data.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Project'
        '404':
          description: Project not found.
    delete:
      summary: Deletes a project by ID.
      parameters:
        - in: path
          name: projectId
          schema:
            type: string
          required: true
      responses:
        '200':
          description: Project deleted successfully.
          content:
            application/json:
              schema:
                type: object
                properties:
                  deletedCount:
                    type: integer
                    description: Number of projects deleted (0 or 1)
                required:
                  - deletedCount

  /projects/{projectId}/run:
    post:
      summary: Triggers the init phase to produce the migration plan
      parameters:
        - in: path
          name: projectId
          schema:
            type: string
          required: true
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                sourceRepoAuth:
                  $ref: '#/components/schemas/GitRepoAuth'
                targetRepoAuth:
                  $ref: '#/components/schemas/GitRepoAuth'
                aapCredentials:
                  $ref: '#/components/schemas/AAPCredentials'
                userPrompt:
                  type: string
                  description: Optional user prompt for customizing the migration
              required:
                - sourceRepoAuth
                - targetRepoAuth
      responses:
        '200':
          description: Init job created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    enum:
                      - pending
                    description: Job status
                  jobId:
                    type: string
                    description: UUID of the created job
                required:
                  - status
                  - jobId
        '404':
          description: Project not found

  /projects/{projectId}/modules:
    get:
      summary: Returns a list of modules for a project
      parameters:
        - in: path
          name: projectId
          schema:
            type: string
          required: true
      responses:
        '200':
          description: Modules list
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Module'
        '404':
          description: Project not found
    post:
      summary: Creates a new module for a project
      description: |
        **TEMPORARY ENDPOINT FOR TESTING ONLY**

        This endpoint provides simple CRUD functionality to create modules for testing the job triggering infrastructure.

        According to the ADR, this endpoint should eventually sync modules by parsing the migration plan (created by the init phase).
        The proper implementation will be added when the init phase integration is complete.

        TODO: Replace with proper sync logic that parses the migration plan via LLM (see ADR lines 202-213)
      parameters:
        - in: path
          name: projectId
          schema:
            type: string
          required: true
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                  description: Module name
                sourcePath:
                  type: string
                  description: Path to the module in the source repository
              required:
                - name
                - sourcePath
      responses:
        '201':
          description: Module created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Module'
        '404':
          description: Project not found

  /projects/{projectId}/modules/{moduleId}/run:
    post:
      summary: Triggers a migration phase for a specific module
      parameters:
        - in: path
          name: projectId
          schema:
            type: string
          required: true
        - in: path
          name: moduleId
          schema:
            type: string
          required: true
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                phase:
                  $ref: '#/components/schemas/ModulePhase'
                  description: Migration phase to execute
                sourceRepoAuth:
                  $ref: '#/components/schemas/GitRepoAuth'
                targetRepoAuth:
                  $ref: '#/components/schemas/GitRepoAuth'
                aapCredentials:
                  $ref: '#/components/schemas/AAPCredentials'
              required:
                - phase
      responses:
        '200':
          description: Migration job created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    enum:
                      - pending
                    description: Job status
                  jobId:
                    type: string
                    description: UUID of the created job
                required:
                  - status
                  - jobId
        '404':
          description: Project or module not found

  /projects/{projectId}/modules/{moduleId}/log:
    get:
      summary: Returns logs for the latest job of a module
      parameters:
        - in: path
          name: projectId
          schema:
            type: string
          required: true
          description: Project UUID
        - in: path
          name: moduleId
          schema:
            type: string
          required: true
          description: Module UUID
        - in: query
          name: streaming
          schema:
            type: boolean
          required: false
          description: Whether to stream logs (text/plain) or return all at once
        - in: query
          name: phase
          schema:
            $ref: '#/components/schemas/ModulePhase'
          required: true
          description: Migration module phase to filter
      responses:
        '200':
          description: Module logs
          content:
            text/plain:
              schema:
                type: string
        '404':
          description: Module not found or no jobs exist

  /projects/{projectId}/collectArtifacts:
    post:
      summary: Collects artifacts from a completed X2Ansible job
      description: |
        Callback endpoint for X2Ansible jobs to submit execution artifacts and results.
        This endpoint is called by the X2Ansible job runner when a migration phase completes.
      parameters:
        - in: path
          name: projectId
          schema:
            type: string
          required: true
          description: UUID of the project
        - in: query
          name: moduleId
          schema:
            type: string
          required: false
          description: |
            UUID of the module.
            - Required for analyze, migrate, and publish phases
            - Should be omitted for init phase
        - in: query
          name: phase
          schema:
            $ref: '#/components/schemas/MigrationPhase'
          required: true
          description: Migration phase that completed
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                status:
                  type: string
                  enum:
                    - success
                    - error
                  description: Execution status of the job
                errorDetails:
                  type: string
                  description: Error details if status is Error
                jobId:
                  type: string
                  description: UUID of the completed job
                artifacts:
                  type: array
                  description: List of artifacts produced by the job
                  items:
                    $ref: '#/components/schemas/Artifact'
                telemetry:
                  $ref: '#/components/schemas/Telemetry'
              required:
                - status
                - jobId
                - artifacts
      responses:
        '200':
          description: Artifacts collected successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    description: Success confirmation message
                required:
                  - message
        '404':
          description: Project or job not found
        '400':
          description: Invalid request data
components:
  schemas:
    Project:
      type: object
      properties:
        id:
          type: string
          description: UUID for the project
        abbreviation:
          type: string
          description: Abbreviation of the project
        name:
          type: string
          description: Full name of the project
        description:
          type: string
          description: Description of the project
        sourceRepoUrl:
          type: string
          description: URL of the source repository
        targetRepoUrl:
          type: string
          description: URL of the target repository
        sourceRepoBranch:
          description: Branch of the source repository
          type: string
        targetRepoBranch:
          description: Branch of the target repository
          type: string
        createdAt:
          type: string
          format: date-time
          description: Date/time when the project was created
        createdBy:
          type: string
          description: The user who created the project (Backstage user reference)
        migrationPlan:
          $ref: '#/components/schemas/Artifact'
          description: Project migration plan artifact (by init phase)
        status:
          $ref: '#/components/schemas/ProjectStatus'
          description: Project status calculated from the status of its modules
      required:
        - id
        - name
        - abbreviation
        - sourceRepoUrl
        - targetRepoUrl
        - sourceRepoBranch
        - targetRepoBranch
        - createdAt
        - createdBy

    Module:
      type: object
      properties:
        # Module's status is status of its last job, no matter of the phase the job is from.
        id:
          type: string
          description: UUID for the module
        name:
          type: string
          description: Module name
        sourcePath:
          type: string
          description: Path to the module in the source repository
        projectId:
          type: string
          description: UUID of the owning project
        analyze:
          $ref: '#/components/schemas/Job'
        migrate:
          $ref: '#/components/schemas/Job'
        publish:
          $ref: '#/components/schemas/Job'
        status:
          $ref: '#/components/schemas/ModuleStatus'
        errorDetails:
          type: string
          description: Detailed error information if the module failed to execute
      required:
        - id
        - name
        - sourcePath
        - projectId

    JobStatusEnum:
      type: string
      enum:
        - pending
        - running
        - success
        - error

    ModuleStatus:
      type: string
      description: |
        Module status is the status of the last job of its last phase.
        If a later retrigger for an earlier phase fails (e.g. when retrigger on analyze
        fails but a former migrate already passed), the modules status should not change (is still based on the last phase).
        The pending state is used for modules that are scheduled for execution but not yet actually running. If a module
        is in pending state for long time, it can refer to an issue with the OCP setup.
      enum:
        - pending
        - running
        - success
        - error

    ProjectStatusState:
      type: string
      description: |
        Project status state.
        It is calculated from the status of its modules.
        - created: Project is created but not yet initialized
        - initializing: Project's init job is running
        - initialized: Project's init job finished successfully, pending next phase execution
        - inProgress: A non-init phase is running
        - completed: All modules are in success state
        - failed: At least one module is in error state
      enum:
        - created
        - initializing
        - initialized
        - inProgress
        - completed
        - failed

    ModulesStatusSummary:
      type: object
      properties:
        total:
          type: integer
          description: Total number of modules in the project
        finished:
          type: integer
          description: Number of modules in success state of the publish phase (no more work is needed)
        waiting:
          type: integer
          description: Number of modules in success state of a non-publish phase (means waiting for human interaction)
        pending:
          type: integer
          description: Number of modules in pending state (scheduled for execution but not actually running)
        running:
          type: integer
          description: Number of modules in running state (actually running)
        error:
          type: integer
          description: Number of modules in error state (execution is over but failed)
      required:
        - total
        - finished
        - waiting
        - completed
        - pending
        - running
        - error

    ProjectStatus:
      type: object
      properties:
        state:
          $ref: '#/components/schemas/ProjectStatusState'
        modulesSummary:
          $ref: '#/components/schemas/ModulesStatusSummary'
      required:
        - state
        - modulesSummary

    Job:
      type: object
      required:
        - id
        - projectId
        - startedAt
        - phase
        - k8sJobName
        - status
      properties:
        id:
          type: string
          description: UUID for the job
        projectId:
          type: string
          description: UUID of the owning project
        moduleId:
          type: string
          description: UUID of the owning module (optional)
        startedAt:
          type: string
          format: date-time
          description: Date/time when the job started
        finishedAt:
          type: string
          format: date-time
          description: Date/time when the job finished
        phase:
          $ref: '#/components/schemas/MigrationPhase'
          description: Migration phase of the job
        k8sJobName:
          type: string
          description: Name of the Kubernetes job
        status:
          $ref: '#/components/schemas/JobStatusEnum'
        errorDetails:
          type: string
          description: Detailed error information if the job failed to execute
        artifacts:
          type: array
          description: List of artifacts produced by the job
          items:
            $ref: '#/components/schemas/Artifact'
        telemetry:
          $ref: '#/components/schemas/Telemetry'

    ArtifactType:
      type: string
      enum:
        - migration_plan
        - module_migration_plan
        - migrated_sources

    Artifact:
      type: object
      properties:
        id:
          type: string
          description: UUID for the artifact
        type:
          $ref: '#/components/schemas/ArtifactType'
          description: Type of the artifact
        value:
          type: string
          description: Value of the artifact
      required:
        - id
        - type
        - value

    GitRepoAuth:
      type: object
      properties:
        token:
          type: string
          description: Authentication token for the git repository
      required:
        - token

    AAPCredentials:
      type: object
      properties:
        url:
          type: string
          description: Ansible Automation Platform URL
        orgName:
          type: string
          description: AAP organization name
        oauthToken:
          type: string
          description: OAuth token for AAP authentication
        username:
          type: string
          description: Username for AAP authentication (alternative to OAuth token)
        password:
          type: string
          description: Password for AAP authentication (alternative to OAuth token)
      required:
        - url
        - orgName

    MigrationPhase:
      type: string
      enum:
        - init
        - analyze
        - migrate
        - publish
      description: All migration phases

    ModulePhase:
      type: string
      enum:
        - analyze
        - migrate
        - publish
      description: Phases to execute on a module

    Telemetry:
      type: object
      description: Execution telemetry and metrics for a migration phase
      properties:
        summary:
          type: string
          description: Execution summary from x2aconvertor
        phase:
          type: string
          description: Phase name (init, analyze, migrate, publish)
        startedAt:
          type: string
          format: date-time
          description: When the phase started (ISO 8601 format)
        endedAt:
          type: string
          format: date-time
          description: When the phase completed (ISO 8601 format)
        agents:
          type: object
          additionalProperties:
            $ref: '#/components/schemas/AgentMetrics'
          description: Per-agent execution metrics (agent name to metrics mapping)
      required:
        - summary
        - phase
        - startedAt

    AgentMetrics:
      type: object
      description: Telemetry data for a single agent execution within a phase
      properties:
        name:
          type: string
          description: Agent identifier (e.g., "PlanningAgent", "WriteAgent")
        startedAt:
          type: string
          format: date-time
          description: When agent execution started (ISO 8601 format)
        endedAt:
          type: string
          format: date-time
          description: When agent execution completed (ISO 8601 format)
        durationSeconds:
          type: number
          format: double
          description: Execution duration in seconds
        metrics:
          type: object
          additionalProperties: true
          description: Custom key-value metrics recorded by the agent
        toolCalls:
          type: object
          additionalProperties:
            type: integer
          description: Tool call counts (tool name to count mapping)
      required:
        - name
        - durationSeconds
