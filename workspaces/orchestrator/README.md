# Orchestrator Plugin for Backstage

The Orchestrator for Backstage is designed to enable self-service flows. It serves as a vital component that enhances and augments the existing scaffolder functionality of Backstage with a more flexible and powerful set of features including long-running and asynchronous flows.

The Backstage Orchestrator plugin aims to provide a better option to Scaffolder, based on workflows to have a more flexible and powerful tool that addresses the need by streamlining and automating processes, allowing developers to focus more on coding and innovation.

It utilizes [SonataFlow](https://sonataflow.org/), a powerful tool for building cloud-native workflow applications.

## Architecture Overview

The architecture adheres to standard Backstage plugin guidelines and requires the following plugins to be installed for proper functionality:

1. **`backstage-plugin-orchestrator`**
   - Provides the frontend interface.

2. **`backstage-plugin-orchestrator-backend`**
   - Serves as a backend proxy between Backstage and SonataFlow.

3. **`backstage-plugin-orchestrator-form-widgets`**
   - Provides custom widgets for the workflow execution form.
   - Check for [more details](./docs/orchestratorFormWidgets.md).

4. **`scaffolder-backend-module-orchestrator`**
   - Provides callable actions from [scaffolder templates](https://backstage.io/docs/features/software-templates/writing-custom-actions), like `orchestrator:workflow:run` or `orchestrator:workflow:get_params`.
   - Check for [more details](./plugins/scaffolder-backend-module-orchestrator/README.md).

These plugins farther import following isolated plugins:

1. **`backstage-plugin-orchestrator-common`**
   - Contains the backend OpenAPI specification along with autogenerated API documentation and client libraries.

2. **`backstage-plugin-orchestrator-form`**
   - Provides the workflow execution form.

3. **`backstage-plugin-orchestrator-form-api`**
   - Defines the API for extending the workflow execution form.
   - For more details, see the [Extensible Form Documentation](./docs/extensibleForm.md).

For more details about architecture, see the [Architecture](https://www.rhdhorchestrator.io/main/docs/architecture/) page.

## Local Development Setup

The orchestrator workspace is structured like a standard Backstage application. To get it up and running locally for development, follow these steps:

### Prerequisites

- Docker up and running
- Developer tools installed:
  - **Fedora/Red Hat-based Linux**:
    ```bash
    sudo dnf install python3 make g++ zlib-devel brotli-devel openssl-devel libuv-devel
    ```
  - **Debian/Ubuntu-based Linux**:
    ```bash
    sudo apt-get install python3 g++ build-essential
    ```
  - **Windows**: Follow the [Windows setup instructions](https://github.com/nodejs/node-gyp#on-windows) in the `node-gyp` documentation.
  - **macOS**: Follow the [macOS setup instructions](https://github.com/nodejs/node-gyp#on-macos) in the `node-gyp` documentation.

### Installation and Startup

1. Navigate to the orchestrator workspace and start the app:
   ```bash
   cd workspaces/orchestrator
   yarn install
   yarn dev
   ```

This will trigger a docker container run of devmode SonataFlow using the pre-configured settings in this workspace.

More development guidelines available in the [contributors documentation](./docs/Contributors.md).

The workspace includes the following configuration by default:

```yaml title="app-config.yaml"
backend:
  csp:
    script-src: ["'self'", "'unsafe-inline'", "'unsafe-eval'"]
    script-src-elem: ["'self'", "'unsafe-inline'", "'unsafe-eval'"]
    connect-src: ["'self'", 'http:', 'https:', 'data:']
orchestrator:
  sonataFlowService:
    baseUrl: http://localhost
    port: 8899
    autoStart: true
    workflowsSource:
      gitRepositoryUrl: https://github.com/rhdhorchestrator/backstage-orchestrator-workflows
      localPath: /tmp/orchestrator/repository
  dataIndexService:
    url: http://localhost:8899
```

This configuration will trigger the following:

1. Cloning https://github.com/rhdhorchestrator/backstage-orchestrator-workflows to /tmp/orchestrator/repository.
2. Running the SonataFlow devmode container configured to load the workflows located in /tmp/orchestrator/repository.

> **Note:** /tmp/orchestrator needs to be accessible to docker.

## Dynamic Plugin Installation (Red Hat Developer Hub)

The Orchestrator plugin can be installed as a dynamic plugin in Red Hat Developer Hub for both production deployments and local development environments.

### Required Packages

To install the Orchestrator plugin as a dynamic plugin, ensure the following packages are available in your RHDH deployment:

**Required packages:**

- `@red-hat-developer-hub/backstage-plugin-orchestrator` _(frontend plugin)_
- `@red-hat-developer-hub/backstage-plugin-orchestrator-backend` _(backend plugin)_

**Optional packages:**

- `@red-hat-developer-hub/backstage-plugin-orchestrator-form-widgets` _(provides enhanced form widgets)_
- `@red-hat-developer-hub/backstage-plugin-scaffolder-backend-module-orchestrator` _(enables scaffolder actions)_

### Configuration

The dynamic plugin requires both frontend and backend configuration to properly integrate with RHDH.

#### Frontend Configuration

- **App Icons**: Defines the orchestrator icon for navigation
- **Dynamic Routes**: Sets up the `/orchestrator` route with menu integration
- **Entity Tabs**: Adds workflow tabs to entity pages
- **Mount Points**: Configures catalog integration for workflow visibility

The configuratoin can be found in [`plugins/orchestrator/app-config.yaml`](./plugins/orchestrator/app-config.yaml).

#### Backend Configuration

The orchestrator backend requires configuration to connect to the SonataFlow infrastructure:

```yaml title="app-config.yaml"
orchestrator:
  dataIndexService:
    url: <url to SonataFlow data index>
```

The SonataFlow infrastructure needs to be installed and configured before the orchestrator plugin can function properly.
For production deployments with operator-based installation, follow [these guidelines](https://github.com/rhdhorchestrator/orchestrator-helm-operator/blob/main/docs/main/existing-rhdh.md#install-the-orchestrator-operator).

### testing dynamic plugins locally

For development with local clone of [rhdh](https://github.com/redhat-developer/rhdh) or local clone of [rhdh-local](https://github.com/redhat-developer/rhdh-local), run the helper script:

```bash
yarn enable-in-rhdh-repo
```

This will build the dynamic plugins and configure your local RHDH setup. For detailed setup instructions, directory requirements, and configuration options, see the [enableInRhdhRepo documentation](./docs/enableInRhdhRepo.md).

## Static Plugin Installation

Follow these instructions to install the orchestrator plugin in a Backstage environment. These instructions assume the code structure has the standard [backstage app structure](https://backstage.io/docs/getting-started/).

### Setting up the Orchestrator backend package

1. Install the Orchestrator backend plugin using the following command:

   ```console
   yarn workspace backend add @red-hat-developer-hub/backstage-plugin-orchestrator-backend
   ```

2. Add the following code to the `packages/backend/src/index.ts` file:

   ```ts title="packages/backend/src/index.ts"
   const backend = createBackend();

   /* highlight-add-next-line */
   backend.add(
     import('@red-hat-developer-hub/backstage-plugin-orchestrator-backend'),
   );

   backend.start();
   ```

### Setting up the Orchestrator frontend package

1. Install the Orchestrator frontend plugin using the following command:

   ```console
   yarn workspace app add @red-hat-developer-hub/backstage-plugin-orchestrator
   ```

2. Add a route to the `OrchestratorPage` and the customized template card component to Backstage App (`packages/app/src/App.tsx`):

   ```tsx title="packages/app/src/App.tsx"
   /* highlight-add-next-line */
   import { OrchestratorPage } from '@red-hat-developer-hub/backstage-plugin-orchestrator';

   const routes = (
     <FlatRoutes>
       {/* ... */}
       {/* highlight-add-next-line */}
       <Route path="/orchestrator" element={<OrchestratorPage />} />
     </FlatRoutes>
   );
   ```

3. Add the Orchestrator to Backstage sidebar (`packages/app/src/components/Root/Root.tsx`):

   ```tsx title="packages/app/src/components/Root/Root.tsx"
   /* highlight-add-next-line */
   import { OrchestratorIcon } from '@red-hat-developer-hub/backstage-plugin-orchestrator';

   export const Root = ({ children }: PropsWithChildren<{}>) => (
     <SidebarPage>
       <Sidebar>
         <SidebarGroup label="Menu" icon={<MenuIcon />}>
           {/* ... */}
           {/* highlight-add-start */}
           <SidebarItem
             icon={OrchestratorIcon}
             to="orchestrator"
             text="Orchestrator"
           />
           {/* highlight-add-end */}
         </SidebarGroup>
         {/* ... */}
       </Sidebar>
       {children}
     </SidebarPage>
   );
   ```

### Static Plugin Configuration

Add the following production configuration to your `app-config.yaml`:

```yaml title="app-config.yaml"
backend:
  csp:
    script-src: ["'self'", "'unsafe-inline'", "'unsafe-eval'"]
    script-src-elem: ["'self'", "'unsafe-inline'", "'unsafe-eval'"]
    connect-src: ["'self'", 'http:', 'https:', 'data:']
orchestrator:
  dataIndexService:
    url: <url to SonataFlow data index>
```

The CSP headers are required for the Workflow viewer to load.

> **Note:** To get started quickly with local development, you can also use the [Local Development Configuration](#local-development-configuration) which includes SonataFlow autoStart capabilities.

## User interface

The Orchestrator plugin supports two primary modes of workflow interaction:

### 1. Direct Workflow Access

The user interface is accessible via the orchestrator button added in the Backstage sidebar. It provides a list of workflows and the option to run the workflows and view the results.

![user interface](./docs/userInterface.png)

### 2. Template-based Workflow Integration

Workflows can also be invoked from Backstage software templates using the `orchestrator:workflow:run` action. When workflows are executed this way, a dedicated "Workflows" tab appears on the entity page, allowing users to view and manage workflow instances associated with that specific entity.

## Permissions

The Orchestrator plugin protects its backend endpoints with the builtin permission mechanism and combines it with
the RBAC plugin. The result is control over what users can see or execute. Details available [here](./docs/Permissions.md).

## Orchestrator API

The backend plugin provides OpenAPI `v2` endpoints definition.

The OpenAPI specification file is available in the [openapi spec file](./plugins/orchestrator-common/src/openapi/openapi.yaml).

Documentation is available in the autogenerated [documentation](./plugins/orchestrator-common/src/generated/docs/markdown/README.md)

The plugin provides an auto generated typescript client that can be used to call the API. To use it include the @red-hat-developer-hub/backstage-plugin-orchestrator-common plugin in your project. You can see in the [OrchestratorClient.ts](./plugins/orchestrator/src/api/OrchestratorClient.ts#L59) how the client can be used.

## scaffolder-backend-module-orchestrator

To call workflows from a [Backstage software template](https://backstage.io/docs/features/software-templates/), additional [custom actions](https://backstage.io/docs/features/software-templates/writing-custom-actions) need to be deployed.

Their implementation lives in the [plugins/scaffolder-backend-module-orchestrator](./plugins/scaffolder-backend-module-orchestrator) module.

## Audit log

The orchestrator backend has audit logs for all incoming requests.

For more information about audit logs in RHDH, please refer to [the official documentation](https://docs.redhat.com/en/documentation/red_hat_developer_hub/1.6/html/audit_logs_in_red_hat_developer_hub/index).
[The official Log storage OpenShift documentation](https://docs.openshift.com/container-platform/4.15/observability/logging/log_storage/about-log-storage.html) may also be of interest.

## Extensible workflow execution form

The `orchestrator` plugin includes an extensible form for executing workflows. Details are available in the [extensible form documentation](./docs/extensibleForm.md).

### Authentication in Workflows

Workflows that call external APIs requiring authentication can request tokens in the input schema — [see docs/auth.md](docs/auth.md) for details.
