{"version":3,"file":"DeleteRoleDialog.esm.js","sources":["../../../src/components/RolesList/DeleteRoleDialog.tsx"],"sourcesContent":["/*\n * Copyright 2024 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport React from 'react';\n\nimport { useApi } from '@backstage/core-plugin-api';\n\nimport CloseIcon from '@mui/icons-material/Close';\nimport ErrorIcon from '@mui/icons-material/Error';\nimport Alert from '@mui/material/Alert';\nimport Box from '@mui/material/Box';\nimport Button from '@mui/material/Button';\nimport Dialog from '@mui/material/Dialog';\nimport DialogActions from '@mui/material/DialogActions';\nimport DialogContent from '@mui/material/DialogContent';\nimport DialogTitle from '@mui/material/DialogTitle';\nimport IconButton from '@mui/material/IconButton';\nimport TextField from '@mui/material/TextField';\nimport Typography from '@mui/material/Typography';\n\nimport { RoleBasedPolicy } from '@backstage-community/plugin-rbac-common';\n\nimport { rbacApiRef } from '../../api/RBACBackendClient';\nimport { getMembers } from '../../utils/rbac-utils';\nimport {\n  removeConditions,\n  removePermissions,\n} from '../../utils/role-form-utils';\nimport { useToast } from '../ToastContext';\n\ntype DeleteRoleDialogProps = {\n  open: boolean;\n  closeDialog: () => void;\n  roleName: string;\n  propOptions: {\n    memberRefs: string[];\n    permissions: number;\n  };\n};\n\nconst DeleteRoleDialog = ({\n  open,\n  closeDialog,\n  roleName,\n  propOptions,\n}: DeleteRoleDialogProps) => {\n  const { setToastMessage } = useToast();\n  const [deleteRoleValue, setDeleteRoleValue] = React.useState<string>();\n  const [disableDelete, setDisableDelete] = React.useState(false);\n  const [error, setError] = React.useState<string>('');\n\n  const rbacApi = useApi(rbacApiRef);\n\n  const dialogBackgroundColor = (theme: { palette: { mode: string } }) =>\n    theme.palette.mode === 'dark' ? '#1b1d21' : '#fff';\n\n  const deleteRole = async () => {\n    try {\n      const policies = await rbacApi.getAssociatedPolicies(roleName);\n      const conditionalPolicies = await rbacApi.getRoleConditions(roleName);\n\n      if (Array.isArray(policies)) {\n        const allowedPolicies = policies.filter(\n          (policy: RoleBasedPolicy) => policy.effect !== 'deny',\n        );\n        await removePermissions(roleName, allowedPolicies, rbacApi);\n      }\n\n      if (Array.isArray(conditionalPolicies)) {\n        const conditionalPoliciesIds = conditionalPolicies.map(cp => cp.id);\n        await removeConditions(conditionalPoliciesIds, rbacApi);\n      }\n\n      const response = await rbacApi.deleteRole(roleName);\n      if (response.status === 200 || response.status === 204) {\n        setToastMessage(`Role ${roleName} deleted successfully`);\n        closeDialog();\n      } else {\n        setError(`Unable to delete the role. ${response.statusText}`);\n      }\n    } catch (err) {\n      setError(err instanceof Error ? err.message : `${err}`);\n    }\n  };\n\n  const onTextInput = (value: string) => {\n    setDeleteRoleValue(value);\n    if (value === '') {\n      setDisableDelete(true);\n    } else if (value === roleName) {\n      setDisableDelete(false);\n    } else {\n      setDisableDelete(true);\n    }\n  };\n\n  return (\n    <Dialog maxWidth=\"md\" open={open} onClose={closeDialog}>\n      <DialogTitle\n        id=\"delete-role\"\n        title=\"Delete Role\"\n        sx={{\n          marginBottom: '0 !important',\n          backgroundColor: dialogBackgroundColor,\n        }}\n      >\n        <Box\n          sx={{\n            display: 'flex',\n            alignItems: 'center',\n            justifyContent: 'space-between',\n            gap: theme => theme.spacing(1),\n          }}\n        >\n          <Typography component=\"span\" sx={{ fontWeight: 'bold' }}>\n            <ErrorIcon\n              style={{\n                color: 'red',\n                alignContent: 'center',\n                marginTop: '7px',\n                marginRight: '5px',\n                marginBottom: '-3px',\n              }}\n              fontSize=\"small\"\n            />{' '}\n            Delete this role?\n          </Typography>\n\n          <IconButton\n            aria-label=\"close\"\n            sx={{\n              padding: '8px !important',\n              color: theme => theme.palette.grey[500],\n              borderRadius: '50%',\n              '&:hover': { borderRadius: '50%' },\n            }}\n            onClick={closeDialog}\n          >\n            <CloseIcon />\n          </IconButton>\n        </Box>\n      </DialogTitle>\n      <DialogContent sx={{ backgroundColor: dialogBackgroundColor }}>\n        Are you sure you want to delete the role{' '}\n        <Typography component=\"span\" sx={{ fontWeight: 'bold' }}>\n          {roleName}\n        </Typography>{' '}\n        ?\n        <br />\n        <br />\n        Deleting this role is irreversible and will remove its functionality\n        from the system. Proceed with caution.\n        <br />\n        <br />\n        The{' '}\n        <Typography component=\"span\" sx={{ fontWeight: 'bold' }}>{`${getMembers(\n          propOptions.memberRefs,\n        ).toLocaleLowerCase('en-US')}`}</Typography>{' '}\n        associated with this role will lose access to all the{' '}\n        <Typography\n          component=\"span\"\n          sx={{ fontWeight: 'bold' }}\n        >{`${propOptions.permissions} permission policies`}</Typography>{' '}\n        specified in this role.\n        <br />\n        <TextField\n          name=\"delete-role\"\n          data-testid=\"delete-role\"\n          sx={{\n            marginTop: '24px',\n            backgroundColor: `${dialogBackgroundColor} !important`,\n          }}\n          required\n          variant=\"outlined\"\n          label=\"Role name\"\n          defaultValue={deleteRoleValue}\n          helperText=\"Type the name of the role to confirm\"\n          onChange={({ target: { value } }) => onTextInput(value)}\n          onBlur={({ target: { value } }) => onTextInput(value)}\n        />\n      </DialogContent>\n      {error && (\n        <Box maxWidth=\"650px\" marginLeft=\"20px\">\n          <Alert severity=\"error\">{error}</Alert>\n        </Box>\n      )}\n      <DialogActions\n        sx={{\n          paddingLeft: '25px',\n          paddingBottom: '30px',\n          justifyContent: 'left',\n          paddingTop: '16px',\n          backgroundColor: dialogBackgroundColor,\n        }}\n      >\n        <Button\n          variant=\"contained\"\n          style={\n            disableDelete || !deleteRoleValue\n              ? {}\n              : { background: 'red', color: 'white' }\n          }\n          onClick={deleteRole}\n          disabled={disableDelete || !deleteRoleValue}\n        >\n          Delete\n        </Button>\n        <Button variant=\"outlined\" onClick={closeDialog}>\n          Cancel\n        </Button>\n      </DialogActions>\n    </Dialog>\n  );\n};\n\nexport default DeleteRoleDialog;\n"],"names":[],"mappings":"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"}