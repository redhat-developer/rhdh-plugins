{"version":3,"file":"PermissionPoliciesForm.esm.js","sources":["../../../src/components/CreateRole/PermissionPoliciesForm.tsx"],"sourcesContent":["/*\n * Copyright 2024 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport React from 'react';\nimport { useAsync } from 'react-use';\n\nimport { Progress } from '@backstage/core-components';\nimport { useApi } from '@backstage/core-plugin-api';\n\nimport AddIcon from '@mui/icons-material/Add';\nimport Button from '@mui/material/Button';\nimport FormHelperText from '@mui/material/FormHelperText';\nimport { styled, Theme } from '@mui/material/styles';\nimport { FormikErrors } from 'formik';\n\nimport { rbacApiRef } from '../../api/RBACBackendClient';\nimport { useConditionRules } from '../../hooks/useConditionRules';\nimport { PermissionsData } from '../../types';\nimport { getPluginsPermissionPoliciesData } from '../../utils/create-role-utils';\nimport { ConditionsData } from '../ConditionalAccess/types';\nimport { initialPermissionPolicyRowValue } from './const';\nimport { PermissionPoliciesFormRow } from './PermissionPoliciesFormRow';\nimport { RoleFormValues } from './types';\n\nconst classes = {\n  permissionPoliciesForm: 'permission-policies-form',\n};\n\nconst PermissionPoliciesFormContainer = styled('div')(\n  ({ theme }: { theme: Theme }) => ({\n    [`&.${classes.permissionPoliciesForm}`]: {\n      padding: '20px',\n      border: `2px solid ${theme.palette.border}`,\n      borderRadius: '5px',\n    },\n  }),\n);\n\ntype PermissionPoliciesFormProps = {\n  permissionPoliciesRows: PermissionsData[];\n  permissionPoliciesRowsError: FormikErrors<PermissionsData>[];\n  setFieldValue: (\n    field: string,\n    value: any,\n    shouldValidate?: boolean,\n  ) => Promise<FormikErrors<RoleFormValues>> | Promise<void>;\n  setFieldError: (field: string, value: string | undefined) => void;\n  handleBlur: React.FocusEventHandler<HTMLInputElement | HTMLTextAreaElement>;\n};\n\nexport const PermissionPoliciesForm = ({\n  permissionPoliciesRows,\n  permissionPoliciesRowsError,\n  setFieldValue,\n  setFieldError,\n  handleBlur,\n}: PermissionPoliciesFormProps) => {\n  const rbacApi = useApi(rbacApiRef);\n  const conditionRules = useConditionRules();\n\n  const {\n    value: permissionPolicies,\n    loading: permissionPoliciesLoading,\n    error: permissionPoliciesErr,\n  } = useAsync(async () => {\n    return await rbacApi.listPermissions();\n  });\n\n  const permissionPoliciesData =\n    !permissionPoliciesLoading && Array.isArray(permissionPolicies)\n      ? getPluginsPermissionPoliciesData(permissionPolicies)\n      : undefined;\n\n  const onChangePlugin = (plugin: string, index: number) => {\n    setFieldValue(`permissionPoliciesRows[${index}].plugin`, plugin, true);\n    setFieldValue(`permissionPoliciesRows[${index}].permission`, '', false);\n    setFieldValue(`permissionPoliciesRows[${index}].isResourced`, false, false);\n    setFieldValue(\n      `permissionPoliciesRows[${index}].conditions`,\n      undefined,\n      false,\n    );\n    setFieldValue(\n      `permissionPoliciesRows[${index}].policies`,\n      initialPermissionPolicyRowValue.policies,\n      false,\n    );\n  };\n\n  const onChangePermission = (\n    permission: string,\n    index: number,\n    isResourced: boolean,\n    policies?: string[],\n  ) => {\n    setFieldValue(\n      `permissionPoliciesRows[${index}].permission`,\n      permission,\n      true,\n    );\n    setFieldValue(\n      `permissionPoliciesRows[${index}].isResourced`,\n      isResourced,\n      false,\n    );\n    setFieldValue(\n      `permissionPoliciesRows[${index}].conditions`,\n      undefined,\n      false,\n    );\n    setFieldValue(\n      `permissionPoliciesRows[${index}].policies`,\n      policies\n        ? policies.map(p => ({ policy: p, effect: 'allow' }))\n        : initialPermissionPolicyRowValue.policies,\n      false,\n    );\n  };\n\n  const onChangePolicy = (\n    isChecked: boolean,\n    policyIndex: number,\n    index: number,\n  ) => {\n    setFieldValue(\n      `permissionPoliciesRows[${index}].policies[${policyIndex}].effect`,\n      isChecked ? 'allow' : 'deny',\n      true,\n    );\n  };\n\n  const onAddConditions = (index: number, conditions?: ConditionsData) => {\n    setFieldValue(`permissionPoliciesRows[${index}].conditions`, conditions);\n    if (!conditions)\n      setFieldValue(`permissionPoliciesRows[${index}].id`, undefined);\n  };\n\n  const onRowRemove = (index: number) => {\n    const finalPps = permissionPoliciesRows.filter(\n      (_pp, ppIndex) => index !== ppIndex,\n    );\n    setFieldError(`permissionPoliciesRows[${index}]`, undefined);\n    setFieldValue('permissionPoliciesRows', finalPps, false);\n  };\n\n  const onRowAdd = () =>\n    setFieldValue(\n      'permissionPoliciesRows',\n      [...permissionPoliciesRows, initialPermissionPolicyRowValue],\n      false,\n    );\n\n  return (\n    <div>\n      <FormHelperText>\n        Permission policies can be selected for each plugin. You can add\n        multiple permission policies using +Add option.\n      </FormHelperText>\n      <br />\n      {permissionPoliciesLoading ? (\n        <Progress />\n      ) : (\n        <PermissionPoliciesFormContainer\n          className={classes.permissionPoliciesForm}\n        >\n          {permissionPoliciesRows.map((pp, index) => (\n            <PermissionPoliciesFormRow\n              key={index}\n              permissionPoliciesRowError={\n                permissionPoliciesRowsError?.[index] ?? {}\n              }\n              rowName={`permissionPoliciesRows[${index}]`}\n              permissionPoliciesRowData={pp}\n              permissionPoliciesData={permissionPoliciesData}\n              rowCount={permissionPoliciesRows.length}\n              conditionRules={conditionRules}\n              onChangePlugin={(plugin: string) => onChangePlugin(plugin, index)}\n              onChangePermission={(\n                permission: string,\n                isResourced: boolean,\n                policies?: string[],\n              ) => onChangePermission(permission, index, isResourced, policies)}\n              onChangePolicy={(isChecked: boolean, policyIndex: number) =>\n                onChangePolicy(isChecked, policyIndex, index)\n              }\n              onAddConditions={(conditions?: ConditionsData) =>\n                onAddConditions(index, conditions)\n              }\n              onRemove={() => onRowRemove(index)}\n              handleBlur={handleBlur}\n              getPermissionDisabled={(permission: string) => {\n                const pluginPermissionPolicies = permissionPoliciesRows.filter(\n                  ppr => ppr.plugin === pp.plugin,\n                );\n                const previouslySelectedPermission =\n                  !!pluginPermissionPolicies.find(\n                    ppp => ppp.permission === permission,\n                  );\n                return (\n                  previouslySelectedPermission &&\n                  !permissionPoliciesData?.pluginsPermissions[pp.plugin]\n                    ?.policies[permission ?? '']?.isResourced\n                );\n              }}\n            />\n          ))}\n          <Button\n            sx={{\n              color: theme => theme.palette.primary.light,\n            }}\n            size=\"small\"\n            onClick={onRowAdd}\n            name=\"add-permission-policy\"\n          >\n            <AddIcon />\n            Add\n          </Button>\n        </PermissionPoliciesFormContainer>\n      )}\n      {!permissionPoliciesLoading &&\n        (permissionPoliciesErr?.message ||\n          !Array.isArray(permissionPolicies)) && (\n          <>\n            <br />\n            <FormHelperText error>\n              {`Error fetching the permission policies: ${\n                permissionPoliciesErr?.message ||\n                (permissionPolicies as Response)?.statusText\n              }`}\n            </FormHelperText>\n          </>\n        )}\n    </div>\n  );\n};\n"],"names":[],"mappings":"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"}