{"version":3,"file":"ConditionsForm.esm.js","sources":["../../../src/components/ConditionalAccess/ConditionsForm.tsx"],"sourcesContent":["/*\n * Copyright 2024 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport React from 'react';\n\nimport { PermissionCondition } from '@backstage/plugin-permission-common';\n\nimport WarningIcon from '@mui/icons-material/Warning';\nimport Alert from '@mui/material/Alert';\nimport AlertTitle from '@mui/material/AlertTitle';\nimport Box from '@mui/material/Box';\nimport Button from '@mui/material/Button';\n\nimport {\n  hasAllOfOrAnyOfErrors,\n  hasNestedNotErrors,\n  hasSimpleConditionOrNotErrors,\n  initializeErrors,\n  isSimpleRule,\n  resetErrors,\n} from '../../utils/conditional-access-utils';\nimport { ConditionsFormRow } from './ConditionsFormRow';\nimport { criterias } from './const';\nimport {\n  AccessConditionsErrors,\n  Condition,\n  ConditionsData,\n  RulesData,\n} from './types';\n\ntype ConditionFormProps = {\n  conditionRulesData?: RulesData;\n  conditionsFormVal?: ConditionsData;\n  selPluginResourceType: string;\n  onClose: () => void;\n  onSave: (conditions?: ConditionsData) => void;\n};\n\nexport const ConditionsForm = ({\n  conditionRulesData,\n  selPluginResourceType,\n  conditionsFormVal,\n  onClose,\n  onSave,\n}: ConditionFormProps) => {\n  const [conditions, setConditions] = React.useState<ConditionsData>(\n    conditionsFormVal ?? {\n      condition: {\n        rule: '',\n        resourceType: selPluginResourceType,\n        params: {},\n      },\n    },\n  );\n  const [criteria, setCriteria] = React.useState<keyof ConditionsData>(\n    (Object.keys(conditions)[0] as keyof ConditionsData) ?? criterias.condition,\n  );\n  const [errors, setErrors] = React.useState<\n    AccessConditionsErrors | undefined\n  >(initializeErrors(criteria, conditions));\n\n  const [removeAllClicked, setRemoveAllClicked] =\n    React.useState<boolean>(false);\n\n  const flattenConditions = (\n    conditionData: Condition[],\n  ): PermissionCondition[] => {\n    const flatConditions: PermissionCondition[] = [];\n\n    const processCondition = (condition: Condition) => {\n      if ('rule' in condition) {\n        flatConditions.push(condition);\n      } else {\n        if (condition.allOf) {\n          condition.allOf.forEach(processCondition);\n        }\n        if (condition.anyOf) {\n          condition.anyOf.forEach(processCondition);\n        }\n        if (condition.not) {\n          if ('rule' in condition.not) {\n            flatConditions.push(condition.not);\n          } else {\n            processCondition(condition.not);\n          }\n        }\n      }\n    };\n    conditionData.forEach(processCondition);\n    return flatConditions;\n  };\n\n  const isNoRuleSelected = () => {\n    switch (criteria) {\n      case criterias.condition:\n        return !conditions.condition?.rule;\n      case criterias.not: {\n        const flatConditions = flattenConditions([\n          conditions.not as PermissionCondition,\n        ]);\n        return flatConditions.some(c => !c.rule);\n      }\n      case criterias.allOf: {\n        const flatConditions = flattenConditions(conditions.allOf || []);\n        return flatConditions.some(c => !c.rule);\n      }\n      case criterias.anyOf: {\n        const flatConditions = flattenConditions(conditions.anyOf || []);\n        return flatConditions.some(c => !c.rule);\n      }\n      default:\n        return true;\n    }\n  };\n\n  const hasAnyErrors = (): boolean => {\n    if (!errors) return false;\n\n    if (\n      criteria === criterias.condition ||\n      (criteria === criterias.not &&\n        isSimpleRule(conditions[criteria] as Condition))\n    ) {\n      return hasSimpleConditionOrNotErrors(errors, criteria);\n    }\n\n    if (\n      criteria === criterias.not &&\n      !isSimpleRule(conditions[criteria] as Condition)\n    ) {\n      return hasNestedNotErrors(errors, conditions, criteria);\n    }\n\n    if (criteria === criterias.allOf || criteria === criterias.anyOf) {\n      return hasAllOfOrAnyOfErrors(errors, criteria);\n    }\n\n    return false;\n  };\n\n  const isSaveDisabled = () => {\n    if (removeAllClicked) return false;\n\n    return (\n      hasAnyErrors() ||\n      isNoRuleSelected() ||\n      Object.is(conditionsFormVal, conditions)\n    );\n  };\n\n  const hasMultiLevelNestedConditions = (): boolean => {\n    if (!Array.isArray(conditions[criteria])) {\n      return false;\n    }\n\n    return (conditions[criteria] as Condition[])\n      .filter(condition => !('rule' in condition))\n      .some((firstLevelNestedCondition: Condition) => {\n        const nestedConditionCriteria = Object.keys(\n          firstLevelNestedCondition,\n        )[0];\n        if (\n          Array.isArray(\n            firstLevelNestedCondition[\n              nestedConditionCriteria as keyof Condition\n            ],\n          )\n        ) {\n          return (\n            firstLevelNestedCondition[\n              nestedConditionCriteria as keyof Condition\n            ] as Condition[]\n          ).some((con: Condition) => !('rule' in con));\n        }\n\n        return !Object.keys(\n          firstLevelNestedCondition[\n            nestedConditionCriteria as keyof Condition\n          ] as Condition[],\n        ).includes('rule');\n      });\n  };\n\n  return (\n    <>\n      <Box\n        sx={{\n          padding: theme => theme.spacing(2.5),\n          paddingTop: 0,\n          flexGrow: 1,\n          overflow: 'auto',\n        }}\n      >\n        <ConditionsFormRow\n          conditionRulesData={conditionRulesData}\n          conditionRow={conditions}\n          criteria={criteria}\n          selPluginResourceType={selPluginResourceType}\n          onRuleChange={newCondition => setConditions(newCondition)}\n          setCriteria={setCriteria}\n          setErrors={setErrors}\n          setRemoveAllClicked={setRemoveAllClicked}\n        />\n        {hasMultiLevelNestedConditions() && (\n          <Alert\n            icon={<WarningIcon />}\n            style={{ margin: '1.5rem 0 1rem 0' }}\n            severity=\"warning\"\n            data-testid=\"multi-level-nested-conditions-warning\"\n          >\n            <AlertTitle data-testid=\"multi-level-nested-conditions-warning-title\">\n              Multiple levels of nested conditions are not supported\n            </AlertTitle>\n            Only one level is displayed. Please use the CLI to view all nested\n            conditions.\n          </Alert>\n        )}\n      </Box>\n      <Box\n        sx={{\n          display: 'flex',\n          flexDirection: 'row',\n          gap: '15px',\n          alignItems: 'baseline',\n          borderTop: theme => `2px solid ${theme.palette.border}`,\n          padding: theme => theme.spacing(2.5),\n          '& button': {\n            textTransform: 'none',\n          },\n        }}\n      >\n        <Button\n          variant=\"contained\"\n          color=\"primary\"\n          data-testid=\"save-conditions\"\n          disabled={isSaveDisabled()}\n          onClick={() => {\n            if (removeAllClicked) {\n              onSave(undefined);\n            } else onSave(conditions);\n          }}\n        >\n          Save\n        </Button>\n        <Button\n          variant=\"outlined\"\n          color=\"primary\"\n          onClick={onClose}\n          data-testid=\"cancel-conditions\"\n        >\n          Cancel\n        </Button>\n        <Button\n          variant=\"text\"\n          color=\"primary\"\n          disabled={removeAllClicked || isNoRuleSelected()}\n          onClick={() => {\n            setRemoveAllClicked(true);\n            setCriteria(criterias.condition);\n            setConditions({\n              condition: {\n                rule: '',\n                resourceType: selPluginResourceType,\n                params: {},\n              },\n            });\n            setErrors(resetErrors(criterias.condition));\n          }}\n          data-testid=\"remove-conditions\"\n        >\n          Remove all\n        </Button>\n      </Box>\n    </>\n  );\n};\n"],"names":[],"mappings":"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"}