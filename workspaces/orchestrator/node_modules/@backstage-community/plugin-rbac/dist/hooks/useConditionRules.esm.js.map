{"version":3,"file":"useConditionRules.esm.js","sources":["../../src/hooks/useConditionRules.ts"],"sourcesContent":["/*\n * Copyright 2024 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport { useAsync } from 'react-use';\n\nimport { useApi } from '@backstage/core-plugin-api';\n\nimport { rbacApiRef } from '../api/RBACBackendClient';\nimport {\n  ConditionRules,\n  ConditionRulesData,\n  ResourceTypeRuleData,\n  RulesData,\n} from '../components/ConditionalAccess/types';\nimport { ConditionRule, PluginConditionRules } from '../types';\nimport { uniqBy } from '../utils/create-role-utils';\n\nconst getPluginsResourceTypes = (\n  conditionRules: PluginConditionRules[],\n): { [plugin: string]: string[] } => {\n  return conditionRules.reduce((acc, pluginRules) => {\n    return {\n      ...acc,\n      [`${pluginRules.pluginId}`]: uniqBy(\n        pluginRules.rules.map(rule => rule.resourceType),\n        val => val,\n      ),\n    };\n  }, {});\n};\n\nconst getRuleData = (pluginRules: PluginConditionRules, resType: string) => {\n  return pluginRules.rules.reduce(\n    (ruleAcc: RulesData, rule: ConditionRule) => {\n      return rule.resourceType === resType\n        ? {\n            ...ruleAcc,\n            [`${rule.name}`]: {\n              schema: rule.paramsSchema,\n              description: rule.description,\n            },\n            rules: [...ruleAcc.rules, rule.name],\n          }\n        : ruleAcc;\n    },\n    { rules: [] },\n  );\n};\n\nconst getConditionRulesData = (conditionRules: PluginConditionRules[]) => {\n  const pluginsResourceTypes = getPluginsResourceTypes(conditionRules);\n\n  return conditionRules.reduce((acc: ConditionRulesData, pluginRules) => {\n    return {\n      ...acc,\n      [`${pluginRules.pluginId}`]: pluginsResourceTypes[\n        pluginRules.pluginId\n      ].reduce((resAcc: ResourceTypeRuleData, resType: string) => {\n        return {\n          ...resAcc,\n          [`${resType}`]: getRuleData(pluginRules, resType),\n        };\n      }, {}),\n    };\n  }, {});\n};\n\nexport const useConditionRules = (): ConditionRules => {\n  const rbacApi = useApi(rbacApiRef);\n\n  const {\n    value: conditionRules,\n    loading: conditionRulesLoading,\n    error: conditionRulesErr,\n  } = useAsync(async () => {\n    return await rbacApi.getPluginsConditionRules();\n  });\n\n  const isConditionRulesAvailable =\n    !conditionRulesLoading && Array.isArray(conditionRules);\n\n  const conditionRulesData = isConditionRulesAvailable\n    ? getConditionRulesData(conditionRules)\n    : undefined;\n\n  return {\n    data: conditionRulesData,\n    error: conditionRulesErr,\n  };\n};\n"],"names":[],"mappings":";;;;;AA6BA,MAAM,uBAAA,GAA0B,CAC9B,cACmC,KAAA;AACnC,EAAA,OAAO,cAAe,CAAA,MAAA,CAAO,CAAC,GAAA,EAAK,WAAgB,KAAA;AACjD,IAAO,OAAA;AAAA,MACL,GAAG,GAAA;AAAA,MACH,CAAC,CAAA,EAAG,WAAY,CAAA,QAAQ,EAAE,GAAG,MAAA;AAAA,QAC3B,WAAY,CAAA,KAAA,CAAM,GAAI,CAAA,CAAA,IAAA,KAAQ,KAAK,YAAY,CAAA;AAAA,QAC/C,CAAO,GAAA,KAAA;AAAA;AACT,KACF;AAAA,GACF,EAAG,EAAE,CAAA;AACP,CAAA;AAEA,MAAM,WAAA,GAAc,CAAC,WAAA,EAAmC,OAAoB,KAAA;AAC1E,EAAA,OAAO,YAAY,KAAM,CAAA,MAAA;AAAA,IACvB,CAAC,SAAoB,IAAwB,KAAA;AAC3C,MAAO,OAAA,IAAA,CAAK,iBAAiB,OACzB,GAAA;AAAA,QACE,GAAG,OAAA;AAAA,QACH,CAAC,CAAA,EAAG,IAAK,CAAA,IAAI,EAAE,GAAG;AAAA,UAChB,QAAQ,IAAK,CAAA,YAAA;AAAA,UACb,aAAa,IAAK,CAAA;AAAA,SACpB;AAAA,QACA,OAAO,CAAC,GAAG,OAAQ,CAAA,KAAA,EAAO,KAAK,IAAI;AAAA,OAErC,GAAA,OAAA;AAAA,KACN;AAAA,IACA,EAAE,KAAO,EAAA,EAAG;AAAA,GACd;AACF,CAAA;AAEA,MAAM,qBAAA,GAAwB,CAAC,cAA2C,KAAA;AACxE,EAAM,MAAA,oBAAA,GAAuB,wBAAwB,cAAc,CAAA;AAEnE,EAAA,OAAO,cAAe,CAAA,MAAA,CAAO,CAAC,GAAA,EAAyB,WAAgB,KAAA;AACrE,IAAO,OAAA;AAAA,MACL,GAAG,GAAA;AAAA,MACH,CAAC,CAAA,EAAG,WAAY,CAAA,QAAQ,CAAE,CAAA,GAAG,oBAC3B,CAAA,WAAA,CAAY,QACd,CAAA,CAAE,MAAO,CAAA,CAAC,QAA8B,OAAoB,KAAA;AAC1D,QAAO,OAAA;AAAA,UACL,GAAG,MAAA;AAAA,UACH,CAAC,CAAG,EAAA,OAAO,EAAE,GAAG,WAAA,CAAY,aAAa,OAAO;AAAA,SAClD;AAAA,OACF,EAAG,EAAE;AAAA,KACP;AAAA,GACF,EAAG,EAAE,CAAA;AACP,CAAA;AAEO,MAAM,oBAAoB,MAAsB;AACrD,EAAM,MAAA,OAAA,GAAU,OAAO,UAAU,CAAA;AAEjC,EAAM,MAAA;AAAA,IACJ,KAAO,EAAA,cAAA;AAAA,IACP,OAAS,EAAA,qBAAA;AAAA,IACT,KAAO,EAAA;AAAA,GACT,GAAI,SAAS,YAAY;AACvB,IAAO,OAAA,MAAM,QAAQ,wBAAyB,EAAA;AAAA,GAC/C,CAAA;AAED,EAAA,MAAM,yBACJ,GAAA,CAAC,qBAAyB,IAAA,KAAA,CAAM,QAAQ,cAAc,CAAA;AAExD,EAAA,MAAM,kBAAqB,GAAA,yBAAA,GACvB,qBAAsB,CAAA,cAAc,CACpC,GAAA,KAAA,CAAA;AAEJ,EAAO,OAAA;AAAA,IACL,IAAM,EAAA,kBAAA;AAAA,IACN,KAAO,EAAA;AAAA,GACT;AACF;;;;"}