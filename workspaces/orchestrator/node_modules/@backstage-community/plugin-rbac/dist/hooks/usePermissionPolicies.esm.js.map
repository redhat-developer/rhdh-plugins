{"version":3,"file":"usePermissionPolicies.esm.js","sources":["../../src/hooks/usePermissionPolicies.ts"],"sourcesContent":["/*\n * Copyright 2024 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport React from 'react';\nimport { useAsyncRetry, useInterval } from 'react-use';\n\nimport { useApi } from '@backstage/core-plugin-api';\n\nimport { rbacApiRef } from '../api/RBACBackendClient';\nimport { getPluginsPermissionPoliciesData } from '../utils/create-role-utils';\nimport {\n  getConditionalPermissionsData,\n  getPermissionsData,\n} from '../utils/rbac-utils';\n\nconst getErrorText = (\n  policies: any,\n  permissionPolicies: any,\n  conditionalPolicies: any,\n): { name: number; message: string } | undefined => {\n  if (!Array.isArray(policies) && (policies as Response)?.statusText) {\n    return {\n      name: (policies as Response).status,\n      message: `Error fetching policies. ${(policies as Response).statusText}`,\n    };\n  } else if (\n    !Array.isArray(permissionPolicies) &&\n    (permissionPolicies as Response)?.statusText\n  ) {\n    return {\n      name: (permissionPolicies as Response).status,\n      message: `Error fetching the plugins. ${\n        (permissionPolicies as Response).statusText\n      }`,\n    };\n  } else if (\n    !Array.isArray(conditionalPolicies) &&\n    (conditionalPolicies as Response)?.statusText\n  ) {\n    return {\n      name: (conditionalPolicies as Response).status,\n      message: `Error fetching the conditional permission policies. ${\n        (conditionalPolicies as Response).statusText\n      }`,\n    };\n  }\n  return undefined;\n};\n\nexport const usePermissionPolicies = (\n  entityReference: string,\n  pollInterval?: number,\n) => {\n  const rbacApi = useApi(rbacApiRef);\n  const {\n    value: policies,\n    retry: policiesRetry,\n    error: policiesError,\n  } = useAsyncRetry(async () => {\n    return await rbacApi.getAssociatedPolicies(entityReference);\n  });\n\n  const {\n    value: conditionalPolicies,\n    retry: conditionalPoliciesRetry,\n    error: conditionalPoliciesError,\n  } = useAsyncRetry(async () => {\n    return await rbacApi.getRoleConditions(entityReference);\n  });\n\n  const {\n    value: permissionPolicies,\n    error: permissionPoliciesError,\n    retry: permissionPoliciesRetry,\n  } = useAsyncRetry(async () => {\n    return await rbacApi.listPermissions();\n  });\n\n  const loading =\n    !permissionPoliciesError &&\n    !policiesError &&\n    !conditionalPoliciesError &&\n    (!permissionPolicies || !policies || !conditionalPolicies);\n\n  const allPermissionPolicies = React.useMemo(\n    () => (Array.isArray(permissionPolicies) ? permissionPolicies : []),\n    [permissionPolicies],\n  );\n\n  const data = React.useMemo(() => {\n    return Array.isArray(policies)\n      ? getPermissionsData(policies, allPermissionPolicies)\n      : [];\n  }, [allPermissionPolicies, policies]);\n\n  const conditionsData = React.useMemo(() => {\n    const cpp = Array.isArray(conditionalPolicies) ? conditionalPolicies : [];\n    const pluginsPermissionsPoliciesData =\n      allPermissionPolicies.length > 0\n        ? getPluginsPermissionPoliciesData(allPermissionPolicies)\n        : undefined;\n    return pluginsPermissionsPoliciesData\n      ? getConditionalPermissionsData(cpp, pluginsPermissionsPoliciesData)\n      : [];\n  }, [allPermissionPolicies, conditionalPolicies]);\n\n  useInterval(\n    () => {\n      policiesRetry();\n      permissionPoliciesRetry();\n      conditionalPoliciesRetry();\n    },\n    loading ? null : pollInterval || null,\n  );\n  return {\n    loading,\n    data: [...conditionsData, ...data],\n    retry: { policiesRetry, permissionPoliciesRetry, conditionalPoliciesRetry },\n    error:\n      policiesError ||\n      permissionPoliciesError ||\n      conditionalPoliciesError ||\n      getErrorText(policies, permissionPolicies, conditionalPolicies),\n  };\n};\n"],"names":[],"mappings":"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"}