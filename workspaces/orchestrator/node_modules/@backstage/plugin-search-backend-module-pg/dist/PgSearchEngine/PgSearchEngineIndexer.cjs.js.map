{"version":3,"file":"PgSearchEngineIndexer.cjs.js","sources":["../../src/PgSearchEngine/PgSearchEngineIndexer.ts"],"sourcesContent":["/*\n * Copyright 2022 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { BatchSearchEngineIndexer } from '@backstage/plugin-search-backend-node';\nimport { IndexableDocument } from '@backstage/plugin-search-common';\nimport { Knex } from 'knex';\nimport { DatabaseStore } from '../database';\nimport { LoggerService } from '@backstage/backend-plugin-api';\n\n/** @public */\nexport type PgSearchEngineIndexerOptions = {\n  batchSize: number;\n  type: string;\n  databaseStore: DatabaseStore;\n  logger?: LoggerService;\n};\n\n/** @public */\nexport class PgSearchEngineIndexer extends BatchSearchEngineIndexer {\n  private logger?: LoggerService;\n  private store: DatabaseStore;\n  private type: string;\n  private tx: Knex.Transaction | undefined;\n  private numRecords = 0;\n\n  constructor(options: PgSearchEngineIndexerOptions) {\n    super({ batchSize: options.batchSize });\n    this.store = options.databaseStore;\n    this.type = options.type;\n    this.logger = options.logger;\n  }\n\n  async initialize(): Promise<void> {\n    this.tx = await this.store.getTransaction();\n    try {\n      await this.store.prepareInsert(this.tx);\n    } catch (e) {\n      // In case of error, rollback the transaction and re-throw the error so\n      // that the stream can be closed and destroyed properly.\n      this.tx.rollback(e);\n      throw e;\n    }\n  }\n\n  async index(documents: IndexableDocument[]): Promise<void> {\n    this.numRecords += documents.length;\n\n    const refs = [...new Set(documents.map(d => d.authorization?.resourceRef))];\n    this.logger?.debug(\n      `Attempting to index the following entities: ${refs.toString()}`,\n    );\n\n    try {\n      await this.store.insertDocuments(this.tx!, this.type, documents);\n    } catch (e) {\n      // In case of error, rollback the transaction and re-throw the error so\n      // that the stream can be closed and destroyed properly.\n      this.tx!.rollback(e);\n      throw e;\n    }\n  }\n\n  async finalize(): Promise<void> {\n    // If no documents were indexed, rollback the transaction, log a warning,\n    // and do not continue. This ensures that collators that return empty sets\n    // of documents do not cause the index to be deleted.\n    if (this.numRecords === 0) {\n      this.logger?.warn(\n        `Index for ${this.type} was not replaced: indexer received 0 documents`,\n      );\n      this.tx!.rollback!();\n      return;\n    }\n\n    // Attempt to complete and commit the transaction.\n    try {\n      await this.store.completeInsert(this.tx!, this.type);\n      this.tx!.commit();\n    } catch (e) {\n      // Otherwise, rollback the transaction and re-throw the error so that the\n      // stream can be closed and destroyed properly.\n      this.tx!.rollback!(e);\n      throw e;\n    }\n  }\n\n  /**\n   * Custom handler covering the case where an error occurred somewhere else in\n   * the indexing pipeline (e.g. a collator or decorator). In such cases, the\n   * finalize method is not called, which leaves a dangling transaction and\n   * therefore an open connection to PG. This handler ensures we close the\n   * transaction and associated connection.\n   *\n   * todo(@backstage/search-maintainers): Consider introducing a more\n   * formal mechanism for handling such errors in BatchSearchEngineIndexer and\n   * replacing this method with it. See: #17291\n   *\n   * @internal\n   */\n  async _destroy(error: Error | null, done: (error?: Error | null) => void) {\n    // Ignore situations where there was no error.\n    if (!error) {\n      done();\n      return;\n    }\n\n    if (!this.tx!.isCompleted()) {\n      await this.tx!.rollback(error);\n    }\n\n    done(error);\n  }\n}\n"],"names":["BatchSearchEngineIndexer"],"mappings":";;;;AA+BO,MAAM,8BAA8BA,gDAAA,CAAyB;AAAA,EAC1D,MAAA;AAAA,EACA,KAAA;AAAA,EACA,IAAA;AAAA,EACA,EAAA;AAAA,EACA,UAAA,GAAa,CAAA;AAAA,EAErB,YAAY,OAAA,EAAuC;AACjD,IAAA,KAAA,CAAM,EAAE,SAAA,EAAW,OAAA,CAAQ,SAAA,EAAW,CAAA;AACtC,IAAA,IAAA,CAAK,QAAQ,OAAA,CAAQ,aAAA;AACrB,IAAA,IAAA,CAAK,OAAO,OAAA,CAAQ,IAAA;AACpB,IAAA,IAAA,CAAK,SAAS,OAAA,CAAQ,MAAA;AAAA,EACxB;AAAA,EAEA,MAAM,UAAA,GAA4B;AAChC,IAAA,IAAA,CAAK,EAAA,GAAK,MAAM,IAAA,CAAK,KAAA,CAAM,cAAA,EAAe;AAC1C,IAAA,IAAI;AACF,MAAA,MAAM,IAAA,CAAK,KAAA,CAAM,aAAA,CAAc,IAAA,CAAK,EAAE,CAAA;AAAA,IACxC,SAAS,CAAA,EAAG;AAGV,MAAA,IAAA,CAAK,EAAA,CAAG,SAAS,CAAC,CAAA;AAClB,MAAA,MAAM,CAAA;AAAA,IACR;AAAA,EACF;AAAA,EAEA,MAAM,MAAM,SAAA,EAA+C;AACzD,IAAA,IAAA,CAAK,cAAc,SAAA,CAAU,MAAA;AAE7B,IAAA,MAAM,IAAA,GAAO,CAAC,GAAG,IAAI,GAAA,CAAI,SAAA,CAAU,GAAA,CAAI,CAAA,CAAA,KAAK,CAAA,CAAE,aAAA,EAAe,WAAW,CAAC,CAAC,CAAA;AAC1E,IAAA,IAAA,CAAK,MAAA,EAAQ,KAAA;AAAA,MACX,CAAA,4CAAA,EAA+C,IAAA,CAAK,QAAA,EAAU,CAAA;AAAA,KAChE;AAEA,IAAA,IAAI;AACF,MAAA,MAAM,KAAK,KAAA,CAAM,eAAA,CAAgB,KAAK,EAAA,EAAK,IAAA,CAAK,MAAM,SAAS,CAAA;AAAA,IACjE,SAAS,CAAA,EAAG;AAGV,MAAA,IAAA,CAAK,EAAA,CAAI,SAAS,CAAC,CAAA;AACnB,MAAA,MAAM,CAAA;AAAA,IACR;AAAA,EACF;AAAA,EAEA,MAAM,QAAA,GAA0B;AAI9B,IAAA,IAAI,IAAA,CAAK,eAAe,CAAA,EAAG;AACzB,MAAA,IAAA,CAAK,MAAA,EAAQ,IAAA;AAAA,QACX,CAAA,UAAA,EAAa,KAAK,IAAI,CAAA,+CAAA;AAAA,OACxB;AACA,MAAA,IAAA,CAAK,GAAI,QAAA,EAAU;AACnB,MAAA;AAAA,IACF;AAGA,IAAA,IAAI;AACF,MAAA,MAAM,KAAK,KAAA,CAAM,cAAA,CAAe,IAAA,CAAK,EAAA,EAAK,KAAK,IAAI,CAAA;AACnD,MAAA,IAAA,CAAK,GAAI,MAAA,EAAO;AAAA,IAClB,SAAS,CAAA,EAAG;AAGV,MAAA,IAAA,CAAK,EAAA,CAAI,SAAU,CAAC,CAAA;AACpB,MAAA,MAAM,CAAA;AAAA,IACR;AAAA,EACF;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAeA,MAAM,QAAA,CAAS,KAAA,EAAqB,IAAA,EAAsC;AAExE,IAAA,IAAI,CAAC,KAAA,EAAO;AACV,MAAA,IAAA,EAAK;AACL,MAAA;AAAA,IACF;AAEA,IAAA,IAAI,CAAC,IAAA,CAAK,EAAA,CAAI,WAAA,EAAY,EAAG;AAC3B,MAAA,MAAM,IAAA,CAAK,EAAA,CAAI,QAAA,CAAS,KAAK,CAAA;AAAA,IAC/B;AAEA,IAAA,IAAA,CAAK,KAAK,CAAA;AAAA,EACZ;AACF;;;;"}