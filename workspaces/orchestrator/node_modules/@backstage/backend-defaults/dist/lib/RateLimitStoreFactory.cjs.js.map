{"version":3,"file":"RateLimitStoreFactory.cjs.js","sources":["../../src/lib/RateLimitStoreFactory.ts"],"sourcesContent":["/*\n * Copyright 2024 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport { Config } from '@backstage/config';\nimport type { Store } from 'express-rate-limit';\nimport { RedisStore } from 'rate-limit-redis';\n\n/**\n * Creates a store for `express-rate-limit` based on the configuration.\n *\n * @internal\n */\nexport class RateLimitStoreFactory {\n  static create(options: {\n    config: Config;\n    prefix?: string;\n  }): Store | undefined {\n    const { config, prefix } = options;\n    const store = config.getOptionalConfig('backend.rateLimit.store');\n    if (!store) {\n      return undefined;\n    }\n    const type = store.getString('type');\n    switch (type) {\n      case 'redis':\n        return this.redis({ store, prefix });\n      case 'memory':\n      default:\n        return undefined;\n    }\n  }\n\n  private static redis(options: { store: Config; prefix?: string }): Store {\n    const { store, prefix } = options;\n    const connectionString = store.getString('connection');\n    const KeyvRedis = require('@keyv/redis').default;\n    const keyv = new KeyvRedis(connectionString);\n    return new RedisStore({\n      prefix,\n      sendCommand: async (...args: string[]) => {\n        const client = await keyv.getClient();\n        return client.sendCommand(args);\n      },\n    });\n  }\n}\n"],"names":["RedisStore"],"mappings":";;;;AAwBO,MAAM,qBAAA,CAAsB;AAAA,EACjC,OAAO,OAAO,OAAA,EAGQ;AACpB,IAAA,MAAM,EAAE,MAAA,EAAQ,MAAA,EAAO,GAAI,OAAA;AAC3B,IAAA,MAAM,KAAA,GAAQ,MAAA,CAAO,iBAAA,CAAkB,yBAAyB,CAAA;AAChE,IAAA,IAAI,CAAC,KAAA,EAAO;AACV,MAAA,OAAO,MAAA;AAAA,IACT;AACA,IAAA,MAAM,IAAA,GAAO,KAAA,CAAM,SAAA,CAAU,MAAM,CAAA;AACnC,IAAA,QAAQ,IAAA;AAAM,MACZ,KAAK,OAAA;AACH,QAAA,OAAO,IAAA,CAAK,KAAA,CAAM,EAAE,KAAA,EAAO,QAAQ,CAAA;AAAA,MACrC,KAAK,QAAA;AAAA,MACL;AACE,QAAA,OAAO,MAAA;AAAA;AACX,EACF;AAAA,EAEA,OAAe,MAAM,OAAA,EAAoD;AACvE,IAAA,MAAM,EAAE,KAAA,EAAO,MAAA,EAAO,GAAI,OAAA;AAC1B,IAAA,MAAM,gBAAA,GAAmB,KAAA,CAAM,SAAA,CAAU,YAAY,CAAA;AACrD,IAAA,MAAM,SAAA,GAAY,OAAA,CAAQ,aAAa,CAAA,CAAE,OAAA;AACzC,IAAA,MAAM,IAAA,GAAO,IAAI,SAAA,CAAU,gBAAgB,CAAA;AAC3C,IAAA,OAAO,IAAIA,yBAAA,CAAW;AAAA,MACpB,MAAA;AAAA,MACA,WAAA,EAAa,UAAU,IAAA,KAAmB;AACxC,QAAA,MAAM,MAAA,GAAS,MAAM,IAAA,CAAK,SAAA,EAAU;AACpC,QAAA,OAAO,MAAA,CAAO,YAAY,IAAI,CAAA;AAAA,MAChC;AAAA,KACD,CAAA;AAAA,EACH;AACF;;;;"}