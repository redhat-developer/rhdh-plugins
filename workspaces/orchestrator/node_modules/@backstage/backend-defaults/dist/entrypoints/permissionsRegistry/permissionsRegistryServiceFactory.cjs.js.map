{"version":3,"file":"permissionsRegistryServiceFactory.cjs.js","sources":["../../../src/entrypoints/permissionsRegistry/permissionsRegistryServiceFactory.ts"],"sourcesContent":["/*\n * Copyright 2022 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  PermissionsRegistryService,\n  coreServices,\n  createServiceFactory,\n} from '@backstage/backend-plugin-api';\nimport {\n  PermissionResourceRef,\n  createPermissionIntegrationRouter,\n} from '@backstage/plugin-permission-node';\nimport { NotAllowedError } from '@backstage/errors';\nimport Router from 'express-promise-router';\n\nfunction assertRefPluginId(ref: PermissionResourceRef, pluginId: string) {\n  if (ref.pluginId !== pluginId) {\n    throw new Error(\n      `Resource type '${ref.resourceType}' belongs to plugin '${ref.pluginId}', but was used with plugin '${pluginId}'`,\n    );\n  }\n}\n\n/**\n * Permission system integration for registering resources and permissions.\n *\n * See {@link @backstage/core-plugin-api#PermissionsRegistryService}\n * and {@link https://backstage.io/docs/backend-system/core-services/permission-integrations | the service docs}\n * for more information.\n *\n * @public\n */\nexport const permissionsRegistryServiceFactory = createServiceFactory({\n  service: coreServices.permissionsRegistry,\n  deps: {\n    auth: coreServices.auth,\n    httpAuth: coreServices.httpAuth,\n    lifecycle: coreServices.lifecycle,\n    httpRouter: coreServices.httpRouter,\n    pluginMetadata: coreServices.pluginMetadata,\n  },\n  async factory({ auth, httpAuth, httpRouter, lifecycle, pluginMetadata }) {\n    const router = createPermissionIntegrationRouter();\n\n    const pluginId = pluginMetadata.getId();\n\n    const applyConditionMiddleware = Router();\n    applyConditionMiddleware.use(\n      '/.well-known/backstage/permissions/apply-conditions',\n      async (req, _res, next) => {\n        const credentials = await httpAuth.credentials(req, {\n          allow: ['user', 'service'],\n        });\n        if (\n          auth.isPrincipal(credentials, 'user') &&\n          !credentials.principal.actor\n        ) {\n          throw new NotAllowedError();\n        }\n        next();\n      },\n    );\n    httpRouter.use(applyConditionMiddleware);\n    httpRouter.use(router);\n\n    let started = false;\n    lifecycle.addStartupHook(() => {\n      started = true;\n    });\n\n    return {\n      addResourceType(resource) {\n        if (started) {\n          throw new Error(\n            'Cannot add permission resource types after the plugin has started',\n          );\n        }\n        assertRefPluginId(resource.resourceRef, pluginId);\n        router.addResourceType({\n          ...resource,\n          resourceType: resource.resourceRef.resourceType,\n        });\n      },\n      addPermissions(permissions) {\n        if (started) {\n          throw new Error(\n            'Cannot add permissions after the plugin has started',\n          );\n        }\n        router.addPermissions(permissions);\n      },\n      addPermissionRules(rules) {\n        if (started) {\n          throw new Error(\n            'Cannot add permission rules after the plugin has started',\n          );\n        }\n        router.addPermissionRules(rules);\n      },\n      getPermissionRuleset(resourceRef) {\n        assertRefPluginId(resourceRef, pluginId);\n        return router.getPermissionRuleset(resourceRef);\n      },\n    } satisfies PermissionsRegistryService;\n  },\n});\n"],"names":["createServiceFactory","coreServices","createPermissionIntegrationRouter","Router","NotAllowedError"],"mappings":";;;;;;;;;;;AA4BA,SAAS,iBAAA,CAAkB,KAA4B,QAAA,EAAkB;AACvE,EAAA,IAAI,GAAA,CAAI,aAAa,QAAA,EAAU;AAC7B,IAAA,MAAM,IAAI,KAAA;AAAA,MACR,kBAAkB,GAAA,CAAI,YAAY,wBAAwB,GAAA,CAAI,QAAQ,gCAAgC,QAAQ,CAAA,CAAA;AAAA,KAChH;AAAA,EACF;AACF;AAWO,MAAM,oCAAoCA,qCAAA,CAAqB;AAAA,EACpE,SAASC,6BAAA,CAAa,mBAAA;AAAA,EACtB,IAAA,EAAM;AAAA,IACJ,MAAMA,6BAAA,CAAa,IAAA;AAAA,IACnB,UAAUA,6BAAA,CAAa,QAAA;AAAA,IACvB,WAAWA,6BAAA,CAAa,SAAA;AAAA,IACxB,YAAYA,6BAAA,CAAa,UAAA;AAAA,IACzB,gBAAgBA,6BAAA,CAAa;AAAA,GAC/B;AAAA,EACA,MAAM,QAAQ,EAAE,IAAA,EAAM,UAAU,UAAA,EAAY,SAAA,EAAW,gBAAe,EAAG;AACvE,IAAA,MAAM,SAASC,sDAAA,EAAkC;AAEjD,IAAA,MAAM,QAAA,GAAW,eAAe,KAAA,EAAM;AAEtC,IAAA,MAAM,2BAA2BC,uBAAA,EAAO;AACxC,IAAA,wBAAA,CAAyB,GAAA;AAAA,MACvB,qDAAA;AAAA,MACA,OAAO,GAAA,EAAK,IAAA,EAAM,IAAA,KAAS;AACzB,QAAA,MAAM,WAAA,GAAc,MAAM,QAAA,CAAS,WAAA,CAAY,GAAA,EAAK;AAAA,UAClD,KAAA,EAAO,CAAC,MAAA,EAAQ,SAAS;AAAA,SAC1B,CAAA;AACD,QAAA,IACE,IAAA,CAAK,YAAY,WAAA,EAAa,MAAM,KACpC,CAAC,WAAA,CAAY,UAAU,KAAA,EACvB;AACA,UAAA,MAAM,IAAIC,sBAAA,EAAgB;AAAA,QAC5B;AACA,QAAA,IAAA,EAAK;AAAA,MACP;AAAA,KACF;AACA,IAAA,UAAA,CAAW,IAAI,wBAAwB,CAAA;AACvC,IAAA,UAAA,CAAW,IAAI,MAAM,CAAA;AAErB,IAAA,IAAI,OAAA,GAAU,KAAA;AACd,IAAA,SAAA,CAAU,eAAe,MAAM;AAC7B,MAAA,OAAA,GAAU,IAAA;AAAA,IACZ,CAAC,CAAA;AAED,IAAA,OAAO;AAAA,MACL,gBAAgB,QAAA,EAAU;AACxB,QAAA,IAAI,OAAA,EAAS;AACX,UAAA,MAAM,IAAI,KAAA;AAAA,YACR;AAAA,WACF;AAAA,QACF;AACA,QAAA,iBAAA,CAAkB,QAAA,CAAS,aAAa,QAAQ,CAAA;AAChD,QAAA,MAAA,CAAO,eAAA,CAAgB;AAAA,UACrB,GAAG,QAAA;AAAA,UACH,YAAA,EAAc,SAAS,WAAA,CAAY;AAAA,SACpC,CAAA;AAAA,MACH,CAAA;AAAA,MACA,eAAe,WAAA,EAAa;AAC1B,QAAA,IAAI,OAAA,EAAS;AACX,UAAA,MAAM,IAAI,KAAA;AAAA,YACR;AAAA,WACF;AAAA,QACF;AACA,QAAA,MAAA,CAAO,eAAe,WAAW,CAAA;AAAA,MACnC,CAAA;AAAA,MACA,mBAAmB,KAAA,EAAO;AACxB,QAAA,IAAI,OAAA,EAAS;AACX,UAAA,MAAM,IAAI,KAAA;AAAA,YACR;AAAA,WACF;AAAA,QACF;AACA,QAAA,MAAA,CAAO,mBAAmB,KAAK,CAAA;AAAA,MACjC,CAAA;AAAA,MACA,qBAAqB,WAAA,EAAa;AAChC,QAAA,iBAAA,CAAkB,aAAa,QAAQ,CAAA;AACvC,QAAA,OAAO,MAAA,CAAO,qBAAqB,WAAW,CAAA;AAAA,MAChD;AAAA,KACF;AAAA,EACF;AACF,CAAC;;;;"}