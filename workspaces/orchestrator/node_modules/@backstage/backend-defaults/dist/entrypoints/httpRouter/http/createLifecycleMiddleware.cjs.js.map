{"version":3,"file":"createLifecycleMiddleware.cjs.js","sources":["../../../../src/entrypoints/httpRouter/http/createLifecycleMiddleware.ts"],"sourcesContent":["/*\n * Copyright 2022 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  RootConfigService,\n  LifecycleService,\n} from '@backstage/backend-plugin-api';\nimport { readDurationFromConfig } from '@backstage/config';\nimport { ServiceUnavailableError } from '@backstage/errors';\nimport { HumanDuration, durationToMilliseconds } from '@backstage/types';\nimport { RequestHandler } from 'express';\n\nexport const DEFAULT_TIMEOUT = { seconds: 5 };\n\n/**\n * Options for {@link createLifecycleMiddleware}.\n * @public\n */\nexport interface LifecycleMiddlewareOptions {\n  config: RootConfigService;\n  lifecycle: LifecycleService;\n}\n\n/**\n * Creates a middleware that pauses requests until the service has started.\n *\n * @remarks\n *\n * Requests that arrive before the service has started will be paused until startup is complete.\n * If the service does not start within the provided timeout, the request will be rejected with a\n * {@link @backstage/errors#ServiceUnavailableError}.\n *\n * If the service is shutting down, all requests will be rejected with a\n * {@link @backstage/errors#ServiceUnavailableError}.\n *\n * @public\n */\nexport function createLifecycleMiddleware(\n  options: LifecycleMiddlewareOptions,\n): RequestHandler {\n  const { config, lifecycle } = options;\n\n  let state: 'init' | 'up' | 'down' = 'init';\n  const waiting = new Set<{\n    next: (err?: Error) => void;\n    timeout: NodeJS.Timeout;\n  }>();\n\n  lifecycle.addStartupHook(async () => {\n    if (state === 'init') {\n      state = 'up';\n      for (const item of waiting) {\n        clearTimeout(item.timeout);\n        item.next();\n      }\n      waiting.clear();\n    }\n  });\n\n  lifecycle.addShutdownHook(async () => {\n    state = 'down';\n\n    for (const item of waiting) {\n      clearTimeout(item.timeout);\n      item.next(new ServiceUnavailableError('Service is shutting down'));\n    }\n    waiting.clear();\n  });\n\n  let startupRequestPauseTimeout: HumanDuration = DEFAULT_TIMEOUT;\n\n  if (config.has('backend.lifecycle.startupRequestPauseTimeout')) {\n    startupRequestPauseTimeout = readDurationFromConfig(config, {\n      key: 'backend.lifecycle.startupRequestPauseTimeout',\n    });\n  }\n\n  const timeoutMs = durationToMilliseconds(startupRequestPauseTimeout);\n\n  return (_req, _res, next) => {\n    if (state === 'up') {\n      next();\n      return;\n    } else if (state === 'down') {\n      next(new ServiceUnavailableError('Service is shutting down'));\n      return;\n    }\n\n    const item = {\n      next,\n      timeout: setTimeout(() => {\n        if (waiting.delete(item)) {\n          next(new ServiceUnavailableError('Service has not started up yet'));\n        }\n      }, timeoutMs),\n    };\n\n    waiting.add(item);\n  };\n}\n"],"names":["config","ServiceUnavailableError","readDurationFromConfig","durationToMilliseconds"],"mappings":";;;;;;AAyBO,MAAM,eAAA,GAAkB,EAAE,OAAA,EAAS,CAAA;AAyBnC,SAAS,0BACd,OAAA,EACgB;AAChB,EAAA,MAAM,UAAEA,QAAA,EAAQ,SAAA,EAAU,GAAI,OAAA;AAE9B,EAAA,IAAI,KAAA,GAAgC,MAAA;AACpC,EAAA,MAAM,OAAA,uBAAc,GAAA,EAGjB;AAEH,EAAA,SAAA,CAAU,eAAe,YAAY;AACnC,IAAA,IAAI,UAAU,MAAA,EAAQ;AACpB,MAAA,KAAA,GAAQ,IAAA;AACR,MAAA,KAAA,MAAW,QAAQ,OAAA,EAAS;AAC1B,QAAA,YAAA,CAAa,KAAK,OAAO,CAAA;AACzB,QAAA,IAAA,CAAK,IAAA,EAAK;AAAA,MACZ;AACA,MAAA,OAAA,CAAQ,KAAA,EAAM;AAAA,IAChB;AAAA,EACF,CAAC,CAAA;AAED,EAAA,SAAA,CAAU,gBAAgB,YAAY;AACpC,IAAA,KAAA,GAAQ,MAAA;AAER,IAAA,KAAA,MAAW,QAAQ,OAAA,EAAS;AAC1B,MAAA,YAAA,CAAa,KAAK,OAAO,CAAA;AACzB,MAAA,IAAA,CAAK,IAAA,CAAK,IAAIC,8BAAA,CAAwB,0BAA0B,CAAC,CAAA;AAAA,IACnE;AACA,IAAA,OAAA,CAAQ,KAAA,EAAM;AAAA,EAChB,CAAC,CAAA;AAED,EAAA,IAAI,0BAAA,GAA4C,eAAA;AAEhD,EAAA,IAAID,QAAA,CAAO,GAAA,CAAI,8CAA8C,CAAA,EAAG;AAC9D,IAAA,0BAAA,GAA6BE,8BAAuBF,QAAA,EAAQ;AAAA,MAC1D,GAAA,EAAK;AAAA,KACN,CAAA;AAAA,EACH;AAEA,EAAA,MAAM,SAAA,GAAYG,6BAAuB,0BAA0B,CAAA;AAEnE,EAAA,OAAO,CAAC,IAAA,EAAM,IAAA,EAAM,IAAA,KAAS;AAC3B,IAAA,IAAI,UAAU,IAAA,EAAM;AAClB,MAAA,IAAA,EAAK;AACL,MAAA;AAAA,IACF,CAAA,MAAA,IAAW,UAAU,MAAA,EAAQ;AAC3B,MAAA,IAAA,CAAK,IAAIF,8BAAA,CAAwB,0BAA0B,CAAC,CAAA;AAC5D,MAAA;AAAA,IACF;AAEA,IAAA,MAAM,IAAA,GAAO;AAAA,MACX,IAAA;AAAA,MACA,OAAA,EAAS,WAAW,MAAM;AACxB,QAAA,IAAI,OAAA,CAAQ,MAAA,CAAO,IAAI,CAAA,EAAG;AACxB,UAAA,IAAA,CAAK,IAAIA,8BAAA,CAAwB,gCAAgC,CAAC,CAAA;AAAA,QACpE;AAAA,MACF,GAAG,SAAS;AAAA,KACd;AAEA,IAAA,OAAA,CAAQ,IAAI,IAAI,CAAA;AAAA,EAClB,CAAA;AACF;;;;;"}