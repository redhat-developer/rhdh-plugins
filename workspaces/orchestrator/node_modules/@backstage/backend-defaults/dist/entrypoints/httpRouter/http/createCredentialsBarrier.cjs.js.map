{"version":3,"file":"createCredentialsBarrier.cjs.js","sources":["../../../../src/entrypoints/httpRouter/http/createCredentialsBarrier.ts"],"sourcesContent":["/*\n * Copyright 2024 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  HttpAuthService,\n  HttpRouterServiceAuthPolicy,\n  RootConfigService,\n} from '@backstage/backend-plugin-api';\nimport { RequestHandler } from 'express';\nimport { pathToRegexp } from 'path-to-regexp';\n\nexport function createPathPolicyPredicate(policyPath: string) {\n  if (policyPath === '/' || policyPath === '*') {\n    return () => true;\n  }\n\n  const { regexp: pathRegex } = pathToRegexp(policyPath, {\n    end: false,\n  });\n\n  return (path: string): boolean => {\n    return pathRegex.test(path);\n  };\n}\n\n/**\n * @public\n */\nexport function createCredentialsBarrier(options: {\n  httpAuth: HttpAuthService;\n  config: RootConfigService;\n}): {\n  middleware: RequestHandler;\n  addAuthPolicy: (policy: HttpRouterServiceAuthPolicy) => void;\n} {\n  const { httpAuth, config } = options;\n\n  const disableDefaultAuthPolicy = config.getOptionalBoolean(\n    'backend.auth.dangerouslyDisableDefaultAuthPolicy',\n  );\n\n  if (disableDefaultAuthPolicy) {\n    return {\n      middleware: (_req, _res, next) => next(),\n      addAuthPolicy: () => {},\n    };\n  }\n\n  const unauthenticatedPredicates = new Array<(path: string) => boolean>();\n  const cookiePredicates = new Array<(path: string) => boolean>();\n\n  const middleware: RequestHandler = (req, _, next) => {\n    const allowsUnauthenticated = unauthenticatedPredicates.some(predicate =>\n      predicate(req.path),\n    );\n\n    if (allowsUnauthenticated) {\n      next();\n      return;\n    }\n\n    const allowsCookie = cookiePredicates.some(predicate =>\n      predicate(req.path),\n    );\n\n    httpAuth\n      .credentials(req, {\n        allow: ['user', 'service'],\n        allowLimitedAccess: allowsCookie,\n      })\n      .then(\n        () => next(),\n        err => next(err),\n      );\n  };\n\n  const addAuthPolicy = (policy: HttpRouterServiceAuthPolicy) => {\n    if (policy.allow === 'unauthenticated') {\n      unauthenticatedPredicates.push(createPathPolicyPredicate(policy.path));\n    } else if (policy.allow === 'user-cookie') {\n      cookiePredicates.push(createPathPolicyPredicate(policy.path));\n    } else {\n      throw new Error('Invalid auth policy');\n    }\n  };\n\n  return { middleware, addAuthPolicy };\n}\n"],"names":["pathToRegexp"],"mappings":";;;;AAwBO,SAAS,0BAA0B,UAAA,EAAoB;AAC5D,EAAA,IAAI,UAAA,KAAe,GAAA,IAAO,UAAA,KAAe,GAAA,EAAK;AAC5C,IAAA,OAAO,MAAM,IAAA;AAAA,EACf;AAEA,EAAA,MAAM,EAAE,MAAA,EAAQ,SAAA,EAAU,GAAIA,0BAAa,UAAA,EAAY;AAAA,IACrD,GAAA,EAAK;AAAA,GACN,CAAA;AAED,EAAA,OAAO,CAAC,IAAA,KAA0B;AAChC,IAAA,OAAO,SAAA,CAAU,KAAK,IAAI,CAAA;AAAA,EAC5B,CAAA;AACF;AAKO,SAAS,yBAAyB,OAAA,EAMvC;AACA,EAAA,MAAM,EAAE,QAAA,EAAU,MAAA,EAAO,GAAI,OAAA;AAE7B,EAAA,MAAM,2BAA2B,MAAA,CAAO,kBAAA;AAAA,IACtC;AAAA,GACF;AAEA,EAAA,IAAI,wBAAA,EAA0B;AAC5B,IAAA,OAAO;AAAA,MACL,UAAA,EAAY,CAAC,IAAA,EAAM,IAAA,EAAM,SAAS,IAAA,EAAK;AAAA,MACvC,eAAe,MAAM;AAAA,MAAC;AAAA,KACxB;AAAA,EACF;AAEA,EAAA,MAAM,yBAAA,GAA4B,IAAI,KAAA,EAAiC;AACvE,EAAA,MAAM,gBAAA,GAAmB,IAAI,KAAA,EAAiC;AAE9D,EAAA,MAAM,UAAA,GAA6B,CAAC,GAAA,EAAK,CAAA,EAAG,IAAA,KAAS;AACnD,IAAA,MAAM,wBAAwB,yBAAA,CAA0B,IAAA;AAAA,MAAK,CAAA,SAAA,KAC3D,SAAA,CAAU,GAAA,CAAI,IAAI;AAAA,KACpB;AAEA,IAAA,IAAI,qBAAA,EAAuB;AACzB,MAAA,IAAA,EAAK;AACL,MAAA;AAAA,IACF;AAEA,IAAA,MAAM,eAAe,gBAAA,CAAiB,IAAA;AAAA,MAAK,CAAA,SAAA,KACzC,SAAA,CAAU,GAAA,CAAI,IAAI;AAAA,KACpB;AAEA,IAAA,QAAA,CACG,YAAY,GAAA,EAAK;AAAA,MAChB,KAAA,EAAO,CAAC,MAAA,EAAQ,SAAS,CAAA;AAAA,MACzB,kBAAA,EAAoB;AAAA,KACrB,CAAA,CACA,IAAA;AAAA,MACC,MAAM,IAAA,EAAK;AAAA,MACX,CAAA,GAAA,KAAO,KAAK,GAAG;AAAA,KACjB;AAAA,EACJ,CAAA;AAEA,EAAA,MAAM,aAAA,GAAgB,CAAC,MAAA,KAAwC;AAC7D,IAAA,IAAI,MAAA,CAAO,UAAU,iBAAA,EAAmB;AACtC,MAAA,yBAAA,CAA0B,IAAA,CAAK,yBAAA,CAA0B,MAAA,CAAO,IAAI,CAAC,CAAA;AAAA,IACvE,CAAA,MAAA,IAAW,MAAA,CAAO,KAAA,KAAU,aAAA,EAAe;AACzC,MAAA,gBAAA,CAAiB,IAAA,CAAK,yBAAA,CAA0B,MAAA,CAAO,IAAI,CAAC,CAAA;AAAA,IAC9D,CAAA,MAAO;AACL,MAAA,MAAM,IAAI,MAAM,qBAAqB,CAAA;AAAA,IACvC;AAAA,EACF,CAAA;AAEA,EAAA,OAAO,EAAE,YAAY,aAAA,EAAc;AACrC;;;;;"}