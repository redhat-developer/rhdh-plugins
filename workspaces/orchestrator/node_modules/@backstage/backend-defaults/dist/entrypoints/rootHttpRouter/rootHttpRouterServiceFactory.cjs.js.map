{"version":3,"file":"rootHttpRouterServiceFactory.cjs.js","sources":["../../../src/entrypoints/rootHttpRouter/rootHttpRouterServiceFactory.ts"],"sourcesContent":["/*\n * Copyright 2022 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  coreServices,\n  createServiceFactory,\n  LifecycleService,\n  LoggerService,\n  RootConfigService,\n} from '@backstage/backend-plugin-api';\nimport express, { Express, RequestHandler } from 'express';\nimport type { Server } from 'node:http';\nimport {\n  createHttpServer,\n  MiddlewareFactory,\n  readHttpServerOptions,\n} from './http';\nimport { DefaultRootHttpRouter } from './DefaultRootHttpRouter';\nimport { createHealthRouter } from './createHealthRouter';\nimport { durationToMilliseconds } from '@backstage/types';\nimport { readDurationFromConfig } from '@backstage/config';\n\n/**\n * @public\n */\nexport interface RootHttpRouterConfigureContext {\n  app: Express;\n  server: Server;\n  middleware: MiddlewareFactory;\n  routes: RequestHandler;\n  config: RootConfigService;\n  logger: LoggerService;\n  lifecycle: LifecycleService;\n  healthRouter: RequestHandler;\n  applyDefaults: () => void;\n}\n\n/**\n * HTTP route registration for root services.\n *\n * See {@link @backstage/code-plugin-api#RootHttpRouterService}\n * and {@link https://backstage.io/docs/backend-system/core-services/root-http-router | the service docs}\n * for more information.\n *\n * @public\n */\nexport type RootHttpRouterFactoryOptions = {\n  /**\n   * The path to forward all unmatched requests to. Defaults to '/api/app' if\n   * not given. Disables index path behavior if false is given.\n   */\n  indexPath?: string | false;\n\n  configure?(context: RootHttpRouterConfigureContext): void;\n};\n\nfunction defaultConfigure({ applyDefaults }: RootHttpRouterConfigureContext) {\n  applyDefaults();\n}\n\nconst rootHttpRouterServiceFactoryWithOptions = (\n  options?: RootHttpRouterFactoryOptions,\n) =>\n  createServiceFactory({\n    service: coreServices.rootHttpRouter,\n    deps: {\n      config: coreServices.rootConfig,\n      rootLogger: coreServices.rootLogger,\n      lifecycle: coreServices.rootLifecycle,\n      health: coreServices.rootHealth,\n    },\n    async factory({ config, rootLogger, lifecycle, health }) {\n      const { indexPath, configure = defaultConfigure } = options ?? {};\n      const logger = rootLogger.child({ service: 'rootHttpRouter' });\n      const app = express();\n\n      const trustProxy = config.getOptional('backend.trustProxy');\n\n      const router = DefaultRootHttpRouter.create({ indexPath });\n      const middleware = MiddlewareFactory.create({ config, logger });\n      const routes = router.handler();\n\n      const healthRouter = createHealthRouter({ config, health });\n\n      const server = await createHttpServer(\n        app,\n        readHttpServerOptions(config.getOptionalConfig('backend')),\n        { logger },\n      );\n\n      configure({\n        app,\n        server,\n        routes,\n        middleware,\n        config,\n        logger,\n        lifecycle,\n        healthRouter,\n        applyDefaults() {\n          if (process.env.NODE_ENV === 'development') {\n            app.set('json spaces', 2);\n          }\n          if (trustProxy !== undefined) {\n            app.set('trust proxy', trustProxy);\n          }\n          app.use(middleware.helmet());\n          app.use(middleware.cors());\n          app.use(middleware.compression());\n          app.use(middleware.logging());\n          app.use(middleware.rateLimit());\n          app.use(healthRouter);\n          app.use(routes);\n          app.use(middleware.notFound());\n          app.use(middleware.error());\n        },\n      });\n\n      if (config.has('backend.lifecycle.serverShutdownDelay')) {\n        const serverShutdownDelay = readDurationFromConfig(config, {\n          key: 'backend.lifecycle.serverShutdownDelay',\n        });\n        lifecycle.addBeforeShutdownHook(async () => {\n          const timeoutMs = durationToMilliseconds(serverShutdownDelay);\n          return await new Promise(resolve => {\n            setTimeout(resolve, timeoutMs);\n          });\n        });\n      }\n\n      lifecycle.addShutdownHook(() => server.stop());\n\n      await server.start();\n\n      return router;\n    },\n  });\n\n/** @public */\nexport const rootHttpRouterServiceFactory = Object.assign(\n  rootHttpRouterServiceFactoryWithOptions,\n  rootHttpRouterServiceFactoryWithOptions(),\n);\n"],"names":["createServiceFactory","coreServices","config","express","DefaultRootHttpRouter","MiddlewareFactory","createHealthRouter","createHttpServer","readHttpServerOptions","readDurationFromConfig","durationToMilliseconds"],"mappings":"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"}