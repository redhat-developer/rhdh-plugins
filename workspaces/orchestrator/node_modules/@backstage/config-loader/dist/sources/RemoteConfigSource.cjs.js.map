{"version":3,"file":"RemoteConfigSource.cjs.js","sources":["../../src/sources/RemoteConfigSource.ts"],"sourcesContent":["/*\n * Copyright 2023 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { ResponseError } from '@backstage/errors';\nimport {\n  HumanDuration,\n  JsonObject,\n  durationToMilliseconds,\n} from '@backstage/types';\nimport isEqual from 'lodash/isEqual';\nimport { ConfigTransformer, createConfigTransformer } from './transform';\nimport {\n  AsyncConfigSourceGenerator,\n  ConfigSource,\n  SubstitutionFunc,\n  ReadConfigDataOptions,\n  Parser,\n} from './types';\nimport { parseYamlContent } from './utils';\n\nconst DEFAULT_RELOAD_INTERVAL = { seconds: 60 };\n\n/**\n * Options for {@link RemoteConfigSource.create}.\n *\n * @public\n */\nexport interface RemoteConfigSourceOptions {\n  /**\n   * The URL to load the config from.\n   */\n  url: string;\n\n  /**\n   * How often to reload the config from the remote URL, defaults to 1 minute.\n   *\n   * Set to Infinity to disable reloading, for example `{ days: Infinity }`.\n   */\n  reloadInterval?: HumanDuration;\n\n  /**\n   * A substitution function to use instead of the default environment substitution.\n   */\n  substitutionFunc?: SubstitutionFunc;\n\n  /**\n   * A content parsing function to transform string content to configuration values.\n   */\n  parser?: Parser;\n}\n\n/**\n * A config source that loads configuration from a remote URL.\n *\n * @public\n */\nexport class RemoteConfigSource implements ConfigSource {\n  /**\n   * Creates a new {@link RemoteConfigSource}.\n   *\n   * @param options - Options for the source.\n   * @returns A new remote config source.\n   */\n  static create(options: RemoteConfigSourceOptions): ConfigSource {\n    try {\n      // eslint-disable-next-line no-new\n      new URL(options.url);\n    } catch (error) {\n      throw new Error(\n        `Invalid URL provided to remote config source, '${options.url}', ${error}`,\n      );\n    }\n    return new RemoteConfigSource(options);\n  }\n\n  readonly #url: string;\n  readonly #reloadIntervalMs: number;\n  readonly #transformer: ConfigTransformer;\n  readonly #parser: Parser;\n\n  private constructor(options: RemoteConfigSourceOptions) {\n    this.#url = options.url;\n    this.#reloadIntervalMs = durationToMilliseconds(\n      options.reloadInterval ?? DEFAULT_RELOAD_INTERVAL,\n    );\n    this.#transformer = createConfigTransformer({\n      substitutionFunc: options.substitutionFunc,\n    });\n    this.#parser = options.parser ?? parseYamlContent;\n  }\n\n  async *readConfigData(\n    options?: ReadConfigDataOptions | undefined,\n  ): AsyncConfigSourceGenerator {\n    let data = await this.#load();\n\n    yield { configs: [{ data, context: this.#url }] };\n\n    for (;;) {\n      await this.#wait(options?.signal);\n\n      if (options?.signal?.aborted) {\n        return;\n      }\n\n      try {\n        const newData = await this.#load(options?.signal);\n        if (newData && !isEqual(data, newData)) {\n          data = newData;\n          yield { configs: [{ data, context: this.#url }] };\n        }\n      } catch (error) {\n        if (error.name !== 'AbortError') {\n          console.error(`Failed to read config from ${this.#url}, ${error}`);\n        }\n      }\n    }\n  }\n\n  toString() {\n    return `RemoteConfigSource{path=\"${this.#url}\"}`;\n  }\n\n  async #load(signal?: AbortSignal): Promise<JsonObject> {\n    const res = await fetch(this.#url, {\n      signal: signal as RequestInit['signal'],\n    });\n    if (!res.ok) {\n      throw await ResponseError.fromResponse(res);\n    }\n\n    const contents = await res.text();\n    const { result: rawData } = await this.#parser({ contents });\n    if (rawData === undefined) {\n      /**\n       * This error message is/was coupled to the implementation and with refactoring it is no longer truly accurate\n       * This behavior is also inconsistent with {@link FileConfigSource}, which doesn't error on unparsable or empty\n       * content\n       *\n       * Preserving to not make a breaking change\n       */\n      throw new Error('configuration data is null');\n    }\n\n    const data = await this.#transformer(rawData);\n    if (typeof data !== 'object') {\n      throw new Error('configuration data is not an object');\n    } else if (Array.isArray(data)) {\n      throw new Error(\n        'configuration data is an array, expected an object instead',\n      );\n    }\n    return data;\n  }\n\n  async #wait(signal?: AbortSignal) {\n    return new Promise<void>(resolve => {\n      const timeoutId = setTimeout(onDone, this.#reloadIntervalMs);\n      signal?.addEventListener('abort', onDone);\n\n      function onDone() {\n        clearTimeout(timeoutId);\n        signal?.removeEventListener('abort', onDone);\n        resolve();\n      }\n    });\n  }\n}\n"],"names":["durationToMilliseconds","createConfigTransformer","parseYamlContent","isEqual","ResponseError"],"mappings":";;;;;;;;;;;;AAiCA,MAAM,uBAAA,GAA0B,EAAE,OAAA,EAAS,EAAA,EAAG;AAoCvC,MAAM,kBAAA,CAA2C;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAOtD,OAAO,OAAO,OAAA,EAAkD;AAC9D,IAAA,IAAI;AAEF,MAAA,IAAI,GAAA,CAAI,QAAQ,GAAG,CAAA;AAAA,IACrB,SAAS,KAAA,EAAO;AACd,MAAA,MAAM,IAAI,KAAA;AAAA,QACR,CAAA,+CAAA,EAAkD,OAAA,CAAQ,GAAG,CAAA,GAAA,EAAM,KAAK,CAAA;AAAA,OAC1E;AAAA,IACF;AACA,IAAA,OAAO,IAAI,mBAAmB,OAAO,CAAA;AAAA,EACvC;AAAA,EAES,IAAA;AAAA,EACA,iBAAA;AAAA,EACA,YAAA;AAAA,EACA,OAAA;AAAA,EAED,YAAY,OAAA,EAAoC;AACtD,IAAA,IAAA,CAAK,OAAO,OAAA,CAAQ,GAAA;AACpB,IAAA,IAAA,CAAK,iBAAA,GAAoBA,4BAAA;AAAA,MACvB,QAAQ,cAAA,IAAkB;AAAA,KAC5B;AACA,IAAA,IAAA,CAAK,eAAeC,6BAAA,CAAwB;AAAA,MAC1C,kBAAkB,OAAA,CAAQ;AAAA,KAC3B,CAAA;AACD,IAAA,IAAA,CAAK,OAAA,GAAU,QAAQ,MAAA,IAAUC,sBAAA;AAAA,EACnC;AAAA,EAEA,OAAO,eACL,OAAA,EAC4B;AAC5B,IAAA,IAAI,IAAA,GAAO,MAAM,IAAA,CAAK,KAAA,EAAM;AAE5B,IAAA,MAAM,EAAE,SAAS,CAAC,EAAE,MAAM,OAAA,EAAS,IAAA,CAAK,IAAA,EAAM,CAAA,EAAE;AAEhD,IAAA,WAAS;AACP,MAAA,MAAM,IAAA,CAAK,KAAA,CAAM,OAAA,EAAS,MAAM,CAAA;AAEhC,MAAA,IAAI,OAAA,EAAS,QAAQ,OAAA,EAAS;AAC5B,QAAA;AAAA,MACF;AAEA,MAAA,IAAI;AACF,QAAA,MAAM,OAAA,GAAU,MAAM,IAAA,CAAK,KAAA,CAAM,SAAS,MAAM,CAAA;AAChD,QAAA,IAAI,OAAA,IAAW,CAACC,wBAAA,CAAQ,IAAA,EAAM,OAAO,CAAA,EAAG;AACtC,UAAA,IAAA,GAAO,OAAA;AACP,UAAA,MAAM,EAAE,SAAS,CAAC,EAAE,MAAM,OAAA,EAAS,IAAA,CAAK,IAAA,EAAM,CAAA,EAAE;AAAA,QAClD;AAAA,MACF,SAAS,KAAA,EAAO;AACd,QAAA,IAAI,KAAA,CAAM,SAAS,YAAA,EAAc;AAC/B,UAAA,OAAA,CAAQ,MAAM,CAAA,2BAAA,EAA8B,IAAA,CAAK,IAAI,CAAA,EAAA,EAAK,KAAK,CAAA,CAAE,CAAA;AAAA,QACnE;AAAA,MACF;AAAA,IACF;AAAA,EACF;AAAA,EAEA,QAAA,GAAW;AACT,IAAA,OAAO,CAAA,yBAAA,EAA4B,KAAK,IAAI,CAAA,EAAA,CAAA;AAAA,EAC9C;AAAA,EAEA,MAAM,MAAM,MAAA,EAA2C;AACrD,IAAA,MAAM,GAAA,GAAM,MAAM,KAAA,CAAM,IAAA,CAAK,IAAA,EAAM;AAAA,MACjC;AAAA,KACD,CAAA;AACD,IAAA,IAAI,CAAC,IAAI,EAAA,EAAI;AACX,MAAA,MAAM,MAAMC,oBAAA,CAAc,YAAA,CAAa,GAAG,CAAA;AAAA,IAC5C;AAEA,IAAA,MAAM,QAAA,GAAW,MAAM,GAAA,CAAI,IAAA,EAAK;AAChC,IAAA,MAAM,EAAE,QAAQ,OAAA,EAAQ,GAAI,MAAM,IAAA,CAAK,OAAA,CAAQ,EAAE,QAAA,EAAU,CAAA;AAC3D,IAAA,IAAI,YAAY,MAAA,EAAW;AAQzB,MAAA,MAAM,IAAI,MAAM,4BAA4B,CAAA;AAAA,IAC9C;AAEA,IAAA,MAAM,IAAA,GAAO,MAAM,IAAA,CAAK,YAAA,CAAa,OAAO,CAAA;AAC5C,IAAA,IAAI,OAAO,SAAS,QAAA,EAAU;AAC5B,MAAA,MAAM,IAAI,MAAM,qCAAqC,CAAA;AAAA,IACvD,CAAA,MAAA,IAAW,KAAA,CAAM,OAAA,CAAQ,IAAI,CAAA,EAAG;AAC9B,MAAA,MAAM,IAAI,KAAA;AAAA,QACR;AAAA,OACF;AAAA,IACF;AACA,IAAA,OAAO,IAAA;AAAA,EACT;AAAA,EAEA,MAAM,MAAM,MAAA,EAAsB;AAChC,IAAA,OAAO,IAAI,QAAc,CAAA,OAAA,KAAW;AAClC,MAAA,MAAM,SAAA,GAAY,UAAA,CAAW,MAAA,EAAQ,IAAA,CAAK,iBAAiB,CAAA;AAC3D,MAAA,MAAA,EAAQ,gBAAA,CAAiB,SAAS,MAAM,CAAA;AAExC,MAAA,SAAS,MAAA,GAAS;AAChB,QAAA,YAAA,CAAa,SAAS,CAAA;AACtB,QAAA,MAAA,EAAQ,mBAAA,CAAoB,SAAS,MAAM,CAAA;AAC3C,QAAA,OAAA,EAAQ;AAAA,MACV;AAAA,IACF,CAAC,CAAA;AAAA,EACH;AACF;;;;"}