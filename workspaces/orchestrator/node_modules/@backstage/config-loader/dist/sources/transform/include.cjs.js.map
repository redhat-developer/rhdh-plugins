{"version":3,"file":"include.cjs.js","sources":["../../../src/sources/transform/include.ts"],"sourcesContent":["/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport yaml from 'yaml';\nimport { extname, dirname, resolve as resolvePath } from 'path';\nimport { JsonObject, JsonValue } from '@backstage/types';\nimport { isObject } from './utils';\nimport { TransformFunc, ReadFileFunc } from './types';\nimport { SubstitutionFunc } from '../types';\n\nconst INCLUDE_KEYS = ['$file', '$env', '$include'];\n\n// Parsers for each type of included file\nconst includeFileParser: {\n  [ext in string]: (content: string) => Promise<JsonObject>;\n} = {\n  '.json': async content => JSON.parse(content),\n  '.yaml': async content => yaml.parse(content),\n  '.yml': async content => yaml.parse(content),\n};\n\n/**\n * Transforms a include description into the actual included value.\n */\nexport function createIncludeTransform(\n  env: SubstitutionFunc,\n  readFile: ReadFileFunc,\n  substitute: TransformFunc,\n): TransformFunc {\n  return async (input, context) => {\n    const { dir } = context;\n    if (!dir) {\n      throw new Error('Include transform requires a base directory');\n    }\n    if (!isObject(input)) {\n      return { applied: false };\n    }\n    // Check if there's any key that starts with a '$', in that case we treat\n    // this entire object as an include description.\n    const [includeKey] = Object.keys(input).filter(key =>\n      INCLUDE_KEYS.includes(key),\n    );\n    if (includeKey) {\n      if (Object.keys(input).length !== 1) {\n        throw new Error(\n          `include key ${includeKey} should not have adjacent keys`,\n        );\n      }\n    } else {\n      return { applied: false };\n    }\n\n    const rawIncludedValue = input[includeKey];\n    if (typeof rawIncludedValue !== 'string') {\n      throw new Error(`${includeKey} include value is not a string`);\n    }\n\n    const substituteResults = await substitute(rawIncludedValue, { dir });\n    const includeValue = substituteResults.applied\n      ? substituteResults.value\n      : rawIncludedValue;\n\n    // The second string check is needed for Typescript to know this is a string.\n    if (includeValue === undefined || typeof includeValue !== 'string') {\n      throw new Error(`${includeKey} substitution value was undefined`);\n    }\n\n    switch (includeKey) {\n      case '$file':\n        try {\n          const value = await readFile(resolvePath(dir, includeValue));\n          return { applied: true, value: value.trimEnd() };\n        } catch (error) {\n          throw new Error(`failed to read file ${includeValue}, ${error}`);\n        }\n      case '$env':\n        try {\n          return { applied: true, value: await env(includeValue) };\n        } catch (error) {\n          throw new Error(`failed to read env ${includeValue}, ${error}`);\n        }\n\n      case '$include': {\n        const [filePath, dataPath] = includeValue.split(/#(.*)/);\n\n        const ext = extname(filePath);\n        const parser = includeFileParser[ext];\n        if (!parser) {\n          throw new Error(\n            `no configuration parser available for included file ${filePath}`,\n          );\n        }\n\n        const path = resolvePath(dir, filePath);\n        const content = await readFile(path);\n        const newDir = dirname(path);\n\n        const parts = dataPath ? dataPath.split('.') : [];\n\n        let value: JsonValue | undefined;\n        try {\n          value = await parser(content);\n        } catch (error) {\n          throw new Error(\n            `failed to parse included file ${filePath}, ${error}`,\n          );\n        }\n\n        // This bit handles selecting a subtree in the included file, if a path was provided after a #\n        for (const [index, part] of parts.entries()) {\n          if (!isObject(value)) {\n            const errPath = parts.slice(0, index).join('.');\n            throw new Error(\n              `value at '${errPath}' in included file ${filePath} is not an object`,\n            );\n          }\n          value = value[part];\n        }\n\n        if (typeof value === 'string') {\n          const substituted = await substitute(value, { dir: newDir });\n          if (substituted.applied) {\n            value = substituted.value;\n          }\n        }\n\n        return {\n          applied: true,\n          value,\n          newDir: newDir !== dir ? newDir : undefined,\n        };\n      }\n\n      default:\n        throw new Error(`unknown include ${includeKey}`);\n    }\n  };\n}\n"],"names":["yaml","isObject","resolvePath","extname","path","dirname"],"mappings":"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"}