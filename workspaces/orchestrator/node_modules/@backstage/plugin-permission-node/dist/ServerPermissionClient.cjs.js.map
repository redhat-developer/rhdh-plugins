{"version":3,"file":"ServerPermissionClient.cjs.js","sources":["../src/ServerPermissionClient.ts"],"sourcesContent":["/*\n * Copyright 2021 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  AuthService,\n  BackstageCredentials,\n  BackstageServicePrincipal,\n  DiscoveryService,\n  PermissionsService,\n  PermissionsServiceRequestOptions,\n} from '@backstage/backend-plugin-api';\nimport { Config } from '@backstage/config';\nimport {\n  AuthorizePermissionRequest,\n  AuthorizePermissionResponse,\n  AuthorizeResult,\n  DefinitivePolicyDecision,\n  Permission,\n  PermissionClient,\n  PolicyDecision,\n  QueryPermissionRequest,\n} from '@backstage/plugin-permission-common';\n\n/**\n * A thin wrapper around\n * {@link @backstage/plugin-permission-common#PermissionClient} that allows all\n * service-to-service requests.\n * @public\n */\nexport class ServerPermissionClient implements PermissionsService {\n  readonly #auth: AuthService;\n  readonly #permissionClient: PermissionClient;\n  readonly #permissionEnabled: boolean;\n\n  static fromConfig(\n    config: Config,\n    options: {\n      discovery: DiscoveryService;\n      auth: AuthService;\n    },\n  ) {\n    const { auth, discovery } = options;\n    const permissionClient = new PermissionClient({ discovery, config });\n    const permissionEnabled =\n      config.getOptionalBoolean('permission.enabled') ?? false;\n\n    return new ServerPermissionClient({\n      auth,\n      permissionClient,\n      permissionEnabled,\n    });\n  }\n\n  private constructor(options: {\n    auth: AuthService;\n    permissionClient: PermissionClient;\n    permissionEnabled: boolean;\n  }) {\n    this.#auth = options.auth;\n    this.#permissionClient = options.permissionClient;\n    this.#permissionEnabled = options.permissionEnabled;\n  }\n\n  async authorizeConditional(\n    queries: QueryPermissionRequest[],\n    options?: PermissionsServiceRequestOptions,\n  ): Promise<PolicyDecision[]> {\n    const credentials = await this.#getIncomingCredentials(options);\n    if (credentials && this.#auth.isPrincipal(credentials, 'service')) {\n      return this.#servicePrincipalDecision(queries, credentials);\n    } else if (!this.#permissionEnabled) {\n      return queries.map(_ => ({ result: AuthorizeResult.ALLOW }));\n    }\n\n    return this.#permissionClient.authorizeConditional(\n      queries,\n      await this.#getRequestOptions(options),\n    );\n  }\n\n  async authorize(\n    requests: AuthorizePermissionRequest[],\n    options?: PermissionsServiceRequestOptions,\n  ): Promise<AuthorizePermissionResponse[]> {\n    const credentials = await this.#getIncomingCredentials(options);\n    if (credentials && this.#auth.isPrincipal(credentials, 'service')) {\n      return this.#servicePrincipalDecision(requests, credentials);\n    } else if (!this.#permissionEnabled) {\n      return requests.map(_ => ({ result: AuthorizeResult.ALLOW }));\n    }\n\n    return this.#permissionClient.authorize(\n      requests,\n      await this.#getRequestOptions(options),\n    );\n  }\n\n  async #getRequestOptions(\n    options?: PermissionsServiceRequestOptions,\n  ): Promise<{ token?: string } | undefined> {\n    if (options && 'credentials' in options) {\n      if (this.#auth.isPrincipal(options.credentials, 'none')) {\n        return {};\n      }\n\n      return this.#auth.getPluginRequestToken({\n        onBehalfOf: options.credentials,\n        targetPluginId: 'permission',\n      });\n    }\n\n    return options;\n  }\n\n  async #getIncomingCredentials(\n    options?: PermissionsServiceRequestOptions,\n  ): Promise<BackstageCredentials | undefined> {\n    if (options && 'credentials' in options) {\n      return options.credentials;\n    }\n\n    return undefined;\n  }\n\n  /**\n   * For service principals, we can always make an immediate definitive decision\n   * based on their associated access restrictions (if any).\n   */\n  #servicePrincipalDecision(\n    input: { permission: Permission }[],\n    credentials: BackstageCredentials<BackstageServicePrincipal>,\n  ): DefinitivePolicyDecision[] {\n    const { permissionNames, permissionAttributes } =\n      credentials.principal.accessRestrictions ?? {};\n\n    return input.map(item => {\n      if (permissionNames && !permissionNames.includes(item.permission.name)) {\n        return { result: AuthorizeResult.DENY };\n      }\n\n      if (permissionAttributes?.action) {\n        const action = item.permission.attributes?.action;\n        if (!action || !permissionAttributes.action.includes(action)) {\n          return { result: AuthorizeResult.DENY };\n        }\n      }\n\n      return { result: AuthorizeResult.ALLOW };\n    });\n  }\n}\n"],"names":["PermissionClient","AuthorizeResult"],"mappings":"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"}