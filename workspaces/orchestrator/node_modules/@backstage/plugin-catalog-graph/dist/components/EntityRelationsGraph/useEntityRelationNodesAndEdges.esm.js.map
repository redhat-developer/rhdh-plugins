{"version":3,"file":"useEntityRelationNodesAndEdges.esm.js","sources":["../../../src/components/EntityRelationsGraph/useEntityRelationNodesAndEdges.ts"],"sourcesContent":["/*\n * Copyright 2021 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport { MouseEvent, useState } from 'react';\nimport useDebounce from 'react-use/esm/useDebounce';\nimport { RelationPairs, ALL_RELATION_PAIRS } from './relations';\nimport { EntityEdge, EntityNode } from './types';\nimport { useEntityRelationGraph } from './useEntityRelationGraph';\nimport { Entity, DEFAULT_NAMESPACE } from '@backstage/catalog-model';\n\n/**\n * Generate nodes and edges to render the entity graph.\n */\nexport function useEntityRelationNodesAndEdges({\n  rootEntityRefs,\n  maxDepth = Number.POSITIVE_INFINITY,\n  unidirectional = true,\n  mergeRelations = true,\n  kinds,\n  relations,\n  entityFilter,\n  onNodeClick,\n  relationPairs = ALL_RELATION_PAIRS,\n}: {\n  rootEntityRefs: string[];\n  maxDepth?: number;\n  unidirectional?: boolean;\n  mergeRelations?: boolean;\n  kinds?: string[];\n  relations?: string[];\n  entityFilter?: (entity: Entity) => boolean;\n  onNodeClick?: (value: EntityNode, event: MouseEvent<unknown>) => void;\n  relationPairs?: RelationPairs;\n}): {\n  loading: boolean;\n  nodes?: EntityNode[];\n  edges?: EntityEdge[];\n  error?: Error;\n} {\n  const [nodesAndEdges, setNodesAndEdges] = useState<{\n    nodes?: EntityNode[];\n    edges?: EntityEdge[];\n  }>({});\n  const { entities, loading, error } = useEntityRelationGraph({\n    rootEntityRefs,\n    filter: {\n      maxDepth,\n      kinds,\n      relations,\n      entityFilter,\n    },\n  });\n\n  useDebounce(\n    () => {\n      if (!entities || Object.keys(entities).length === 0) {\n        setNodesAndEdges({});\n        return;\n      }\n\n      const nodes = Object.entries(entities).map(([entityRef, entity]) => {\n        const focused = rootEntityRefs.includes(entityRef);\n        const node: EntityNode = {\n          id: entityRef,\n          entity,\n          focused,\n          color: focused ? 'secondary' : 'primary',\n          // @deprecated\n          kind: entity.kind,\n          name: entity.metadata.name,\n          namespace: entity.metadata.namespace || DEFAULT_NAMESPACE,\n          title: entity.metadata.title,\n          spec: entity.spec,\n        };\n\n        if (onNodeClick) {\n          node.onClick = event => onNodeClick(node, event);\n        }\n\n        return node;\n      });\n\n      const edges: EntityEdge[] = [];\n      const visitedNodes = new Set<string>();\n      const nodeQueue = [...rootEntityRefs];\n\n      const hasEdge = (\n        fromRef: string,\n        toRef: string,\n        relation: [string, string?],\n      ): boolean => {\n        return edges.some(\n          edge =>\n            fromRef === edge.from &&\n            toRef === edge.to &&\n            edge.relations.some(\n              rel => rel[0] === relation[0] && rel[1] === relation[1],\n            ),\n        );\n      };\n\n      while (nodeQueue.length > 0) {\n        const entityRef = nodeQueue.pop()!;\n        const entity = entities[entityRef];\n        visitedNodes.add(entityRef);\n\n        if (entity) {\n          entity?.relations?.forEach(rel => {\n            // Check if the related entity should be displayed, if not, ignore\n            // the relation too\n            if (!entities[rel.targetRef]) {\n              return;\n            }\n\n            if (relations && !relations.includes(rel.type)) {\n              return;\n            }\n\n            if (\n              kinds &&\n              !kinds.some(kind =>\n                rel.targetRef.startsWith(`${kind.toLocaleLowerCase('en-US')}:`),\n              )\n            ) {\n              return;\n            }\n\n            if (mergeRelations) {\n              const pair = relationPairs.find(\n                ([l, r]) => l === rel.type || r === rel.type,\n              ) ?? [rel.type];\n              const [left] = pair;\n              const from = left === rel.type ? entityRef : rel.targetRef;\n              const to = left === rel.type ? rel.targetRef : entityRef;\n              if (!unidirectional || !hasEdge(from, to, pair)) {\n                edges.push({\n                  from,\n                  to,\n                  relations: pair,\n                  label: 'visible',\n                });\n              }\n            } else {\n              if (\n                !unidirectional ||\n                !hasEdge(entityRef, rel.targetRef, [rel.type])\n              ) {\n                edges.push({\n                  from: entityRef,\n                  to: rel.targetRef,\n                  relations: [rel.type],\n                  label: 'visible',\n                });\n              }\n            }\n\n            if (!visitedNodes.has(rel.targetRef)) {\n              nodeQueue.push(rel.targetRef);\n              visitedNodes.add(rel.targetRef);\n            }\n\n            // if unidirectional add missing relations as entities are only visited once\n            if (unidirectional) {\n              const findIndex = edges.findIndex(\n                edge =>\n                  entityRef === edge.from &&\n                  rel.targetRef === edge.to &&\n                  !edge.relations.includes(rel.type),\n              );\n              if (findIndex >= 0) {\n                if (mergeRelations) {\n                  const pair = relationPairs.find(\n                    ([l, r]) => l === rel.type || r === rel.type,\n                  ) ?? [rel.type];\n                  edges[findIndex].relations = [\n                    ...edges[findIndex].relations,\n                    ...pair,\n                  ];\n                } else {\n                  edges[findIndex].relations = [\n                    ...edges[findIndex].relations,\n                    rel.type,\n                  ];\n                }\n              }\n            }\n          });\n        }\n      }\n\n      // Reduce edges as the dependency graph anyway ignores duplicated edges regarding from / to\n      // Additionally, this will improve rendering speed for the dependency graph\n      const finalEdges = edges.reduce((previousEdges, currentEdge) => {\n        const indexFound = previousEdges.findIndex(\n          previousEdge =>\n            previousEdge.from === currentEdge.from &&\n            previousEdge.to === currentEdge.to,\n        );\n        if (indexFound >= 0) {\n          previousEdges[indexFound] = {\n            ...previousEdges[indexFound],\n            relations: Array.from(\n              new Set([\n                ...previousEdges[indexFound].relations,\n                ...currentEdge.relations,\n              ]),\n            ),\n          };\n          return previousEdges;\n        }\n        return [...previousEdges, currentEdge];\n      }, [] as EntityEdge[]);\n\n      setNodesAndEdges({ nodes, edges: finalEdges });\n    },\n    100,\n    [\n      entities,\n      rootEntityRefs,\n      kinds,\n      relations,\n      unidirectional,\n      mergeRelations,\n      onNodeClick,\n      relationPairs,\n    ],\n  );\n\n  return {\n    loading,\n    error,\n    ...nodesAndEdges,\n  };\n}\n"],"names":[],"mappings":"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"}