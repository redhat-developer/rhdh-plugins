{"version":3,"file":"context.esm.js","sources":["../src/context.tsx"],"sourcesContent":["/*\n * Copyright 2022 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  Dispatch,\n  SetStateAction,\n  useContext,\n  useState,\n  memo,\n  ReactNode,\n  useEffect,\n} from 'react';\nimport useAsync, { AsyncState } from 'react-use/esm/useAsync';\nimport useAsyncRetry from 'react-use/esm/useAsyncRetry';\n\nimport {\n  CompoundEntityRef,\n  stringifyEntityRef,\n} from '@backstage/catalog-model';\nimport {\n  createVersionedContext,\n  createVersionedValueMap,\n} from '@backstage/version-bridge';\n\nimport {\n  AnalyticsContext,\n  configApiRef,\n  useApi,\n} from '@backstage/core-plugin-api';\n\nimport { techdocsApiRef } from './api';\nimport { TechDocsEntityMetadata, TechDocsMetadata } from './types';\n\nimport { toLowercaseEntityRefMaybe } from './helpers';\n\nconst areEntityRefsEqual = (\n  prevEntityRef: CompoundEntityRef,\n  nextEntityRef: CompoundEntityRef,\n) => {\n  return (\n    stringifyEntityRef(prevEntityRef) === stringifyEntityRef(nextEntityRef)\n  );\n};\n\n/**\n * @public type for the value of the TechDocsReaderPageContext\n */\nexport type TechDocsReaderPageValue = {\n  metadata: AsyncState<TechDocsMetadata>;\n  entityRef: CompoundEntityRef;\n  entityMetadata: AsyncState<TechDocsEntityMetadata>;\n  shadowRoot?: ShadowRoot;\n  setShadowRoot: Dispatch<SetStateAction<ShadowRoot | undefined>>;\n  title: string;\n  setTitle: Dispatch<SetStateAction<string>>;\n  subtitle: string;\n  setSubtitle: Dispatch<SetStateAction<string>>;\n  /**\n   * @deprecated property can be passed down directly to the `TechDocsReaderPageContent` instead.\n   */\n  onReady?: () => void;\n};\n\nconst defaultTechDocsReaderPageValue: TechDocsReaderPageValue = {\n  title: '',\n  subtitle: '',\n  setTitle: () => {},\n  setSubtitle: () => {},\n  setShadowRoot: () => {},\n  metadata: { loading: true },\n  entityMetadata: { loading: true },\n  entityRef: { kind: '', name: '', namespace: '' },\n};\n\nconst TechDocsReaderPageContext = createVersionedContext<{\n  1: TechDocsReaderPageValue;\n}>('techdocs-reader-page-context');\n\n/**\n * render function for {@link TechDocsReaderPageProvider}\n *\n * @public\n */\nexport type TechDocsReaderPageProviderRenderFunction = (\n  value: TechDocsReaderPageValue,\n) => JSX.Element;\n\n/**\n * Props for {@link TechDocsReaderPageProvider}\n *\n * @public\n */\nexport type TechDocsReaderPageProviderProps = {\n  entityRef: CompoundEntityRef;\n  children: TechDocsReaderPageProviderRenderFunction | ReactNode;\n};\n\n/**\n * A context to store the reader page state\n * @public\n */\nexport const TechDocsReaderPageProvider = memo(\n  (props: TechDocsReaderPageProviderProps) => {\n    const { entityRef, children } = props;\n\n    const techdocsApi = useApi(techdocsApiRef);\n    const config = useApi(configApiRef);\n\n    const entityMetadata = useAsync(async () => {\n      return techdocsApi.getEntityMetadata(entityRef);\n    }, [entityRef]);\n\n    const metadata = useAsyncRetry(async () => {\n      return techdocsApi.getTechDocsMetadata(entityRef);\n    }, [entityRef]);\n\n    const [title, setTitle] = useState(defaultTechDocsReaderPageValue.title);\n    const [subtitle, setSubtitle] = useState(\n      defaultTechDocsReaderPageValue.subtitle,\n    );\n    const [shadowRoot, setShadowRoot] = useState<ShadowRoot | undefined>(\n      defaultTechDocsReaderPageValue.shadowRoot,\n    );\n\n    useEffect(() => {\n      if (shadowRoot && !metadata.value && !metadata.loading) {\n        metadata.retry();\n      }\n    }, [\n      metadata.value,\n      metadata.loading,\n      shadowRoot,\n      metadata.retry,\n      metadata,\n    ]);\n\n    const value: TechDocsReaderPageValue = {\n      metadata,\n      entityRef: toLowercaseEntityRefMaybe(entityRef, config),\n      entityMetadata,\n      shadowRoot,\n      setShadowRoot,\n      title,\n      setTitle,\n      subtitle,\n      setSubtitle,\n    };\n    const versionedValue = createVersionedValueMap({ 1: value });\n\n    return (\n      <AnalyticsContext\n        attributes={{ entityRef: stringifyEntityRef(entityRef) }}\n      >\n        <TechDocsReaderPageContext.Provider value={versionedValue}>\n          {children instanceof Function ? children(value) : children}\n        </TechDocsReaderPageContext.Provider>\n      </AnalyticsContext>\n    );\n  },\n  (prevProps, nextProps) => {\n    return areEntityRefsEqual(prevProps.entityRef, nextProps.entityRef);\n  },\n);\n\n/**\n * Hook used to get access to shared state between reader page components.\n * @public\n */\nexport const useTechDocsReaderPage = () => {\n  const versionedContext = useContext(TechDocsReaderPageContext);\n\n  if (versionedContext === undefined) {\n    return defaultTechDocsReaderPageValue;\n  }\n\n  const context = versionedContext.atVersion(1);\n  if (context === undefined) {\n    throw new Error('No context found for version 1.');\n  }\n\n  return context;\n};\n"],"names":[],"mappings":"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"}