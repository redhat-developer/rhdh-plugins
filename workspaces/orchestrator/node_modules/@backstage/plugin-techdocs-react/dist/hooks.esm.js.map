{"version":3,"file":"hooks.esm.js","sources":["../src/hooks.ts"],"sourcesContent":["/*\n * Copyright 2022 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport { useEffect, useMemo, useState } from 'react';\nimport debounce from 'lodash/debounce';\nimport { useTechDocsReaderPage } from './context';\n\n/**\n * Hook for use within TechDocs addons that provides access to the underlying\n * shadow root of the current page, allowing the DOM within to be mutated.\n * @public\n */\nexport const useShadowRoot = () => {\n  const { shadowRoot } = useTechDocsReaderPage();\n  return shadowRoot;\n};\n\n/**\n * Convenience hook for use within TechDocs addons that provides access to\n * elements that match a given selector within the shadow root.\n *\n * @public\n */\nexport const useShadowRootElements = <\n  TReturnedElement extends HTMLElement = HTMLElement,\n>(\n  selectors: string[],\n): TReturnedElement[] => {\n  const shadowRoot = useShadowRoot();\n  const [root, setRootNode] = useState(shadowRoot?.firstChild);\n\n  useEffect(() => {\n    let observer: MutationObserver;\n    if (shadowRoot) {\n      observer = new MutationObserver(() => {\n        setRootNode(shadowRoot?.firstChild);\n      });\n      observer.observe(shadowRoot, {\n        attributes: true,\n        characterData: true,\n        childList: true,\n        subtree: true,\n      });\n    }\n    return () => observer?.disconnect();\n  }, [shadowRoot]);\n\n  if (!root || !(root instanceof HTMLElement)) return [];\n\n  return selectors\n    .map(selector => root.querySelectorAll<TReturnedElement>(selector))\n    .filter(nodeList => nodeList.length)\n    .map(nodeList => Array.from(nodeList))\n    .flat();\n};\n\nconst isValidSelection = (newSelection: Selection) => {\n  // Safari sets the selection rect to top zero\n  return (\n    newSelection.toString() &&\n    newSelection.rangeCount &&\n    newSelection.getRangeAt(0).getBoundingClientRect().top\n  );\n};\n\n/**\n * Hook for retrieving a selection within the ShadowRoot.\n * @public\n */\nexport const useShadowRootSelection = (waitMillis: number = 0) => {\n  const shadowRoot = useShadowRoot();\n  const [selection, setSelection] = useState<Selection | null>(null);\n  const handleSelectionChange = useMemo(\n    () =>\n      debounce(() => {\n        const shadowDocument = shadowRoot as ShadowRoot &\n          Pick<Document, 'getSelection'>;\n        // Firefox and Safari don't implement getSelection for Shadow DOM\n        const newSelection = shadowDocument.getSelection\n          ? shadowDocument.getSelection()\n          : document.getSelection();\n\n        if (newSelection && isValidSelection(newSelection)) {\n          setSelection(newSelection);\n        } else {\n          setSelection(null);\n        }\n      }, waitMillis),\n    [shadowRoot, setSelection, waitMillis],\n  );\n\n  useEffect(() => {\n    window.document.addEventListener('selectionchange', handleSelectionChange);\n    return () => {\n      handleSelectionChange.cancel();\n      window.document.removeEventListener(\n        'selectionchange',\n        handleSelectionChange,\n      );\n    };\n  }, [handleSelectionChange]);\n\n  return selection;\n};\n"],"names":[],"mappings":";;;;AAwBO,MAAM,gBAAgB,MAAM;AACjC,EAAA,MAAM,EAAE,UAAA,EAAW,GAAI,qBAAA,EAAsB;AAC7C,EAAA,OAAO,UAAA;AACT;AAQO,MAAM,qBAAA,GAAwB,CAGnC,SAAA,KACuB;AACvB,EAAA,MAAM,aAAa,aAAA,EAAc;AACjC,EAAA,MAAM,CAAC,IAAA,EAAM,WAAW,CAAA,GAAI,QAAA,CAAS,YAAY,UAAU,CAAA;AAE3D,EAAA,SAAA,CAAU,MAAM;AACd,IAAA,IAAI,QAAA;AACJ,IAAA,IAAI,UAAA,EAAY;AACd,MAAA,QAAA,GAAW,IAAI,iBAAiB,MAAM;AACpC,QAAA,WAAA,CAAY,YAAY,UAAU,CAAA;AAAA,MACpC,CAAC,CAAA;AACD,MAAA,QAAA,CAAS,QAAQ,UAAA,EAAY;AAAA,QAC3B,UAAA,EAAY,IAAA;AAAA,QACZ,aAAA,EAAe,IAAA;AAAA,QACf,SAAA,EAAW,IAAA;AAAA,QACX,OAAA,EAAS;AAAA,OACV,CAAA;AAAA,IACH;AACA,IAAA,OAAO,MAAM,UAAU,UAAA,EAAW;AAAA,EACpC,CAAA,EAAG,CAAC,UAAU,CAAC,CAAA;AAEf,EAAA,IAAI,CAAC,IAAA,IAAQ,EAAE,IAAA,YAAgB,WAAA,CAAA,SAAqB,EAAC;AAErD,EAAA,OAAO,SAAA,CACJ,IAAI,CAAA,QAAA,KAAY,IAAA,CAAK,iBAAmC,QAAQ,CAAC,EACjE,MAAA,CAAO,CAAA,QAAA,KAAY,SAAS,MAAM,CAAA,CAClC,IAAI,CAAA,QAAA,KAAY,KAAA,CAAM,KAAK,QAAQ,CAAC,EACpC,IAAA,EAAK;AACV;AAEA,MAAM,gBAAA,GAAmB,CAAC,YAAA,KAA4B;AAEpD,EAAA,OACE,YAAA,CAAa,QAAA,EAAS,IACtB,YAAA,CAAa,UAAA,IACb,aAAa,UAAA,CAAW,CAAC,CAAA,CAAE,qBAAA,EAAsB,CAAE,GAAA;AAEvD,CAAA;AAMO,MAAM,sBAAA,GAAyB,CAAC,UAAA,GAAqB,CAAA,KAAM;AAChE,EAAA,MAAM,aAAa,aAAA,EAAc;AACjC,EAAA,MAAM,CAAC,SAAA,EAAW,YAAY,CAAA,GAAI,SAA2B,IAAI,CAAA;AACjE,EAAA,MAAM,qBAAA,GAAwB,OAAA;AAAA,IAC5B,MACE,SAAS,MAAM;AACb,MAAA,MAAM,cAAA,GAAiB,UAAA;AAGvB,MAAA,MAAM,eAAe,cAAA,CAAe,YAAA,GAChC,eAAe,YAAA,EAAa,GAC5B,SAAS,YAAA,EAAa;AAE1B,MAAA,IAAI,YAAA,IAAgB,gBAAA,CAAiB,YAAY,CAAA,EAAG;AAClD,QAAA,YAAA,CAAa,YAAY,CAAA;AAAA,MAC3B,CAAA,MAAO;AACL,QAAA,YAAA,CAAa,IAAI,CAAA;AAAA,MACnB;AAAA,IACF,GAAG,UAAU,CAAA;AAAA,IACf,CAAC,UAAA,EAAY,YAAA,EAAc,UAAU;AAAA,GACvC;AAEA,EAAA,SAAA,CAAU,MAAM;AACd,IAAA,MAAA,CAAO,QAAA,CAAS,gBAAA,CAAiB,iBAAA,EAAmB,qBAAqB,CAAA;AACzE,IAAA,OAAO,MAAM;AACX,MAAA,qBAAA,CAAsB,MAAA,EAAO;AAC7B,MAAA,MAAA,CAAO,QAAA,CAAS,mBAAA;AAAA,QACd,iBAAA;AAAA,QACA;AAAA,OACF;AAAA,IACF,CAAA;AAAA,EACF,CAAA,EAAG,CAAC,qBAAqB,CAAC,CAAA;AAE1B,EAAA,OAAO,SAAA;AACT;;;;"}