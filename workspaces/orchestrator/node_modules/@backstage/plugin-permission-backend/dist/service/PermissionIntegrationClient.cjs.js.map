{"version":3,"file":"PermissionIntegrationClient.cjs.js","sources":["../../src/service/PermissionIntegrationClient.ts"],"sourcesContent":["/*\n * Copyright 2021 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { z } from 'zod';\nimport {\n  AuthorizeResult,\n  ConditionalPolicyDecision,\n} from '@backstage/plugin-permission-common';\nimport {\n  ApplyConditionsRequestEntry,\n  ApplyConditionsResponseEntry,\n} from '@backstage/plugin-permission-node';\nimport {\n  AuthService,\n  BackstageCredentials,\n  DiscoveryService,\n} from '@backstage/backend-plugin-api';\nimport { ResponseError } from '@backstage/errors';\n\nconst responseSchema = z.object({\n  items: z.array(\n    z.object({\n      id: z.string(),\n      result: z.union([\n        z.literal(AuthorizeResult.ALLOW),\n        z.literal(AuthorizeResult.DENY),\n        z.array(\n          z.union([\n            z.literal(AuthorizeResult.ALLOW),\n            z.literal(AuthorizeResult.DENY),\n          ]),\n        ),\n      ]),\n    }),\n  ),\n});\n\nexport type ResourcePolicyDecision = ConditionalPolicyDecision & {\n  resourceRef: string;\n};\n\n/**\n * @internal\n */\nexport class PermissionIntegrationClient {\n  private readonly discovery: DiscoveryService;\n  private readonly auth: AuthService;\n\n  constructor(options: { discovery: DiscoveryService; auth: AuthService }) {\n    this.discovery = options.discovery;\n    this.auth = options.auth;\n  }\n\n  async applyConditions(\n    pluginId: string,\n    credentials: BackstageCredentials,\n    decisions: readonly ApplyConditionsRequestEntry[],\n  ): Promise<ApplyConditionsResponseEntry[]> {\n    const baseUrl = await this.discovery.getBaseUrl(pluginId);\n    const endpoint = `${baseUrl}/.well-known/backstage/permissions/apply-conditions`;\n\n    const token = this.auth.isPrincipal(credentials, 'none')\n      ? undefined\n      : await this.auth\n          .getPluginRequestToken({\n            onBehalfOf: credentials,\n            targetPluginId: pluginId,\n          })\n          .then(t => t.token);\n\n    const response = await fetch(endpoint, {\n      method: 'POST',\n      body: JSON.stringify({\n        items: decisions,\n      }),\n      headers: {\n        ...(token ? { authorization: `Bearer ${token}` } : {}),\n        'content-type': 'application/json',\n      },\n    });\n\n    if (!response.ok) {\n      throw await ResponseError.fromResponse(response);\n    }\n\n    const result = responseSchema.parse(await response.json());\n\n    return result.items;\n  }\n}\n"],"names":["z","AuthorizeResult","ResponseError"],"mappings":";;;;;;AAgCA,MAAM,cAAA,GAAiBA,MAAE,MAAA,CAAO;AAAA,EAC9B,OAAOA,KAAA,CAAE,KAAA;AAAA,IACPA,MAAE,MAAA,CAAO;AAAA,MACP,EAAA,EAAIA,MAAE,MAAA,EAAO;AAAA,MACb,MAAA,EAAQA,MAAE,KAAA,CAAM;AAAA,QACdA,KAAA,CAAE,OAAA,CAAQC,sCAAA,CAAgB,KAAK,CAAA;AAAA,QAC/BD,KAAA,CAAE,OAAA,CAAQC,sCAAA,CAAgB,IAAI,CAAA;AAAA,QAC9BD,KAAA,CAAE,KAAA;AAAA,UACAA,MAAE,KAAA,CAAM;AAAA,YACNA,KAAA,CAAE,OAAA,CAAQC,sCAAA,CAAgB,KAAK,CAAA;AAAA,YAC/BD,KAAA,CAAE,OAAA,CAAQC,sCAAA,CAAgB,IAAI;AAAA,WAC/B;AAAA;AACH,OACD;AAAA,KACF;AAAA;AAEL,CAAC,CAAA;AASM,MAAM,2BAAA,CAA4B;AAAA,EACtB,SAAA;AAAA,EACA,IAAA;AAAA,EAEjB,YAAY,OAAA,EAA6D;AACvE,IAAA,IAAA,CAAK,YAAY,OAAA,CAAQ,SAAA;AACzB,IAAA,IAAA,CAAK,OAAO,OAAA,CAAQ,IAAA;AAAA,EACtB;AAAA,EAEA,MAAM,eAAA,CACJ,QAAA,EACA,WAAA,EACA,SAAA,EACyC;AACzC,IAAA,MAAM,OAAA,GAAU,MAAM,IAAA,CAAK,SAAA,CAAU,WAAW,QAAQ,CAAA;AACxD,IAAA,MAAM,QAAA,GAAW,GAAG,OAAO,CAAA,mDAAA,CAAA;AAE3B,IAAA,MAAM,KAAA,GAAQ,IAAA,CAAK,IAAA,CAAK,WAAA,CAAY,WAAA,EAAa,MAAM,CAAA,GACnD,MAAA,GACA,MAAM,IAAA,CAAK,IAAA,CACR,qBAAA,CAAsB;AAAA,MACrB,UAAA,EAAY,WAAA;AAAA,MACZ,cAAA,EAAgB;AAAA,KACjB,CAAA,CACA,IAAA,CAAK,CAAA,CAAA,KAAK,EAAE,KAAK,CAAA;AAExB,IAAA,MAAM,QAAA,GAAW,MAAM,KAAA,CAAM,QAAA,EAAU;AAAA,MACrC,MAAA,EAAQ,MAAA;AAAA,MACR,IAAA,EAAM,KAAK,SAAA,CAAU;AAAA,QACnB,KAAA,EAAO;AAAA,OACR,CAAA;AAAA,MACD,OAAA,EAAS;AAAA,QACP,GAAI,QAAQ,EAAE,aAAA,EAAe,UAAU,KAAK,CAAA,CAAA,KAAO,EAAC;AAAA,QACpD,cAAA,EAAgB;AAAA;AAClB,KACD,CAAA;AAED,IAAA,IAAI,CAAC,SAAS,EAAA,EAAI;AAChB,MAAA,MAAM,MAAMC,oBAAA,CAAc,YAAA,CAAa,QAAQ,CAAA;AAAA,IACjD;AAEA,IAAA,MAAM,SAAS,cAAA,CAAe,KAAA,CAAM,MAAM,QAAA,CAAS,MAAM,CAAA;AAEzD,IAAA,OAAO,MAAA,CAAO,KAAA;AAAA,EAChB;AACF;;;;"}