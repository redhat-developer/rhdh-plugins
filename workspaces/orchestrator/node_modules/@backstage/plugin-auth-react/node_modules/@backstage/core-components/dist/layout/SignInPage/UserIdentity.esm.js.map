{"version":3,"file":"UserIdentity.esm.js","sources":["../../../src/layout/SignInPage/UserIdentity.ts"],"sourcesContent":["/*\n * Copyright 2021 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  IdentityApi,\n  ProfileInfo,\n  ProfileInfoApi,\n  BackstageUserIdentity,\n  BackstageIdentityApi,\n  SessionApi,\n} from '@backstage/core-plugin-api';\n\nimport { GuestUserIdentity } from './GuestUserIdentity';\nimport { LegacyUserIdentity } from './LegacyUserIdentity';\n\n// TODO(Rugvip): This and the other IdentityApi implementations still implement\n//               the old removed methods. This is to allow for backwards compatibility\n//               with old plugins that still consume this API. We will leave these in\n//               place as a hidden compatibility for a couple of months.\n//               The AppIdentityProxy warns in case any of these methods are called.\n\n/**\n * An implementation of the IdentityApi that is constructed using\n * various backstage user identity representations.\n *\n * @public\n */\nexport class UserIdentity implements IdentityApi {\n  private profilePromise?: Promise<ProfileInfo>;\n  /**\n   * Creates a new IdentityApi that acts as a Guest User.\n   *\n   * @public\n   */\n  static createGuest(): IdentityApi {\n    return new GuestUserIdentity();\n  }\n\n  /**\n   * Creates a new IdentityApi using a legacy SignInResult object.\n   *\n   * @public\n   */\n  static fromLegacy(result: {\n    /**\n     * User ID that will be returned by the IdentityApi\n     */\n    userId: string;\n\n    profile: ProfileInfo;\n\n    /**\n     * Function used to retrieve an ID token for the signed in user.\n     */\n    getIdToken?: () => Promise<string>;\n\n    /**\n     * Sign out handler that will be called if the user requests to sign out.\n     */\n    signOut?: () => Promise<void>;\n  }): IdentityApi {\n    return LegacyUserIdentity.fromResult(result);\n  }\n\n  /**\n   * Creates a new IdentityApi implementation using a user identity\n   * and an auth API that will be used to request backstage tokens.\n   *\n   * @public\n   */\n  static create(options: {\n    identity: BackstageUserIdentity;\n    authApi: ProfileInfoApi & BackstageIdentityApi & SessionApi;\n    /**\n     * Passing a profile synchronously allows the deprecated `getProfile` method to be\n     * called by consumers of the {@link @backstage/core-plugin-api#IdentityApi}. If you\n     * do not have any consumers of that method then this is safe to leave out.\n     *\n     * @deprecated Only provide this if you have plugins that call the synchronous `getProfile` method, which is also deprecated.\n     */\n    profile?: ProfileInfo;\n  }): IdentityApi {\n    return new UserIdentity(options.identity, options.authApi, options.profile);\n  }\n\n  private constructor(\n    private readonly identity: BackstageUserIdentity,\n    private readonly authApi: ProfileInfoApi &\n      BackstageIdentityApi &\n      SessionApi,\n    private readonly profile?: ProfileInfo,\n  ) {}\n\n  /** {@inheritdoc @backstage/core-plugin-api#IdentityApi.getUserId} */\n  getUserId(): string {\n    const ref = this.identity.userEntityRef;\n    const match = /^([^:/]+:)?([^:/]+\\/)?([^:/]+)$/.exec(ref);\n    if (!match) {\n      throw new TypeError(`Invalid user entity reference \"${ref}\"`);\n    }\n\n    return match[3];\n  }\n\n  /** {@inheritdoc @backstage/core-plugin-api#IdentityApi.getIdToken} */\n  async getIdToken(): Promise<string | undefined> {\n    const identity = await this.authApi.getBackstageIdentity();\n    return identity!.token;\n  }\n\n  /** {@inheritdoc @backstage/core-plugin-api#IdentityApi.getProfile} */\n  getProfile(): ProfileInfo {\n    if (!this.profile) {\n      throw new Error(\n        'The identity API does not implement synchronous profile fetching, use getProfileInfo() instead',\n      );\n    }\n    return this.profile;\n  }\n\n  /** {@inheritdoc @backstage/core-plugin-api#IdentityApi.getProfileInfo} */\n  async getProfileInfo(): Promise<ProfileInfo> {\n    if (this.profilePromise) {\n      return await this.profilePromise;\n    }\n\n    try {\n      this.profilePromise = this.authApi.getProfile() as Promise<ProfileInfo>;\n      return await this.profilePromise;\n    } catch (ex) {\n      this.profilePromise = undefined;\n      throw ex;\n    }\n  }\n\n  /** {@inheritdoc @backstage/core-plugin-api#IdentityApi.getBackstageIdentity} */\n  async getBackstageIdentity(): Promise<BackstageUserIdentity> {\n    return this.identity;\n  }\n\n  /** {@inheritdoc @backstage/core-plugin-api#IdentityApi.getCredentials} */\n  async getCredentials(): Promise<{ token?: string | undefined }> {\n    const identity = await this.authApi.getBackstageIdentity();\n    return { token: identity!.token };\n  }\n\n  /** {@inheritdoc @backstage/core-plugin-api#IdentityApi.signOut} */\n  async signOut(): Promise<void> {\n    return this.authApi.signOut();\n  }\n}\n"],"names":[],"mappings":";;;AAwCO,MAAM,YAAA,CAAoC;AAAA,EA0DvC,WAAA,CACW,QAAA,EACA,OAAA,EAGA,OAAA,EACjB;AALiB,IAAA,IAAA,CAAA,QAAA,GAAA,QAAA;AACA,IAAA,IAAA,CAAA,OAAA,GAAA,OAAA;AAGA,IAAA,IAAA,CAAA,OAAA,GAAA,OAAA;AAAA,EAChB;AAAA,EA/DK,cAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAMR,OAAO,WAAA,GAA2B;AAChC,IAAA,OAAO,IAAI,iBAAA,EAAkB;AAAA,EAC/B;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAOA,OAAO,WAAW,MAAA,EAiBF;AACd,IAAA,OAAO,kBAAA,CAAmB,WAAW,MAAM,CAAA;AAAA,EAC7C;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAQA,OAAO,OAAO,OAAA,EAWE;AACd,IAAA,OAAO,IAAI,YAAA,CAAa,OAAA,CAAQ,UAAU,OAAA,CAAQ,OAAA,EAAS,QAAQ,OAAO,CAAA;AAAA,EAC5E;AAAA;AAAA,EAWA,SAAA,GAAoB;AAClB,IAAA,MAAM,GAAA,GAAM,KAAK,QAAA,CAAS,aAAA;AAC1B,IAAA,MAAM,KAAA,GAAQ,iCAAA,CAAkC,IAAA,CAAK,GAAG,CAAA;AACxD,IAAA,IAAI,CAAC,KAAA,EAAO;AACV,MAAA,MAAM,IAAI,SAAA,CAAU,CAAA,+BAAA,EAAkC,GAAG,CAAA,CAAA,CAAG,CAAA;AAAA,IAC9D;AAEA,IAAA,OAAO,MAAM,CAAC,CAAA;AAAA,EAChB;AAAA;AAAA,EAGA,MAAM,UAAA,GAA0C;AAC9C,IAAA,MAAM,QAAA,GAAW,MAAM,IAAA,CAAK,OAAA,CAAQ,oBAAA,EAAqB;AACzD,IAAA,OAAO,QAAA,CAAU,KAAA;AAAA,EACnB;AAAA;AAAA,EAGA,UAAA,GAA0B;AACxB,IAAA,IAAI,CAAC,KAAK,OAAA,EAAS;AACjB,MAAA,MAAM,IAAI,KAAA;AAAA,QACR;AAAA,OACF;AAAA,IACF;AACA,IAAA,OAAO,IAAA,CAAK,OAAA;AAAA,EACd;AAAA;AAAA,EAGA,MAAM,cAAA,GAAuC;AAC3C,IAAA,IAAI,KAAK,cAAA,EAAgB;AACvB,MAAA,OAAO,MAAM,IAAA,CAAK,cAAA;AAAA,IACpB;AAEA,IAAA,IAAI;AACF,MAAA,IAAA,CAAK,cAAA,GAAiB,IAAA,CAAK,OAAA,CAAQ,UAAA,EAAW;AAC9C,MAAA,OAAO,MAAM,IAAA,CAAK,cAAA;AAAA,IACpB,SAAS,EAAA,EAAI;AACX,MAAA,IAAA,CAAK,cAAA,GAAiB,MAAA;AACtB,MAAA,MAAM,EAAA;AAAA,IACR;AAAA,EACF;AAAA;AAAA,EAGA,MAAM,oBAAA,GAAuD;AAC3D,IAAA,OAAO,IAAA,CAAK,QAAA;AAAA,EACd;AAAA;AAAA,EAGA,MAAM,cAAA,GAA0D;AAC9D,IAAA,MAAM,QAAA,GAAW,MAAM,IAAA,CAAK,OAAA,CAAQ,oBAAA,EAAqB;AACzD,IAAA,OAAO,EAAE,KAAA,EAAO,QAAA,CAAU,KAAA,EAAM;AAAA,EAClC;AAAA;AAAA,EAGA,MAAM,OAAA,GAAyB;AAC7B,IAAA,OAAO,IAAA,CAAK,QAAQ,OAAA,EAAQ;AAAA,EAC9B;AACF;;;;"}