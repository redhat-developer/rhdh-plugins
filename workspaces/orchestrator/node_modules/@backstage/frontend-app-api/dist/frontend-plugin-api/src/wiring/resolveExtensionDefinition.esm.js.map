{"version":3,"file":"resolveExtensionDefinition.esm.js","sources":["../../../../../frontend-plugin-api/src/wiring/resolveExtensionDefinition.ts"],"sourcesContent":["/*\n * Copyright 2023 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { ApiHolder, AppNode } from '../apis';\nimport {\n  ExtensionAttachToSpec,\n  ExtensionDefinition,\n  ExtensionDefinitionParameters,\n  ResolvedExtensionInputs,\n} from './createExtension';\nimport { PortableSchema } from '../schema';\nimport { ExtensionInput } from './createExtensionInput';\nimport { ExtensionDataRef, ExtensionDataValue } from './createExtensionDataRef';\nimport { OpaqueExtensionDefinition } from '@internal/frontend';\n\n/** @public */\nexport interface Extension<TConfig, TConfigInput = TConfig> {\n  $$type: '@backstage/Extension';\n  readonly id: string;\n  readonly attachTo: ExtensionAttachToSpec;\n  readonly disabled: boolean;\n  readonly configSchema?: PortableSchema<TConfig, TConfigInput>;\n}\n\n/** @internal */\nexport type InternalExtension<TConfig, TConfigInput> = Extension<\n  TConfig,\n  TConfigInput\n> &\n  (\n    | {\n        readonly version: 'v1';\n        readonly inputs: {\n          [inputName in string]: {\n            $$type: '@backstage/ExtensionInput';\n            extensionData: {\n              [name in string]: ExtensionDataRef;\n            };\n            config: { optional: boolean; singleton: boolean };\n          };\n        };\n        readonly output: {\n          [name in string]: ExtensionDataRef;\n        };\n        factory(context: {\n          apis: ApiHolder;\n          node: AppNode;\n          config: TConfig;\n          inputs: {\n            [inputName in string]: unknown;\n          };\n        }): {\n          [inputName in string]: unknown;\n        };\n      }\n    | {\n        readonly version: 'v2';\n        readonly inputs: {\n          [inputName in string]: ExtensionInput<\n            ExtensionDataRef,\n            { optional: boolean; singleton: boolean }\n          >;\n        };\n        readonly output: Array<ExtensionDataRef>;\n        factory(options: {\n          apis: ApiHolder;\n          node: AppNode;\n          config: TConfig;\n          inputs: ResolvedExtensionInputs<{\n            [inputName in string]: ExtensionInput<\n              ExtensionDataRef,\n              { optional: boolean; singleton: boolean }\n            >;\n          }>;\n        }): Iterable<ExtensionDataValue<any, any>>;\n      }\n  );\n\n/** @internal */\nexport function toInternalExtension<TConfig, TConfigInput>(\n  overrides: Extension<TConfig, TConfigInput>,\n): InternalExtension<TConfig, TConfigInput> {\n  const internal = overrides as InternalExtension<TConfig, TConfigInput>;\n  if (internal.$$type !== '@backstage/Extension') {\n    throw new Error(\n      `Invalid extension instance, bad type '${internal.$$type}'`,\n    );\n  }\n  const version = internal.version;\n  if (version !== 'v1' && version !== 'v2') {\n    throw new Error(`Invalid extension instance, bad version '${version}'`);\n  }\n  return internal;\n}\n\n/** @ignore */\nexport type ResolveExtensionId<\n  TExtension extends ExtensionDefinition,\n  TNamespace extends string,\n> = TExtension extends ExtensionDefinition<{\n  kind: infer IKind extends string | undefined;\n  name: infer IName extends string | undefined;\n  params: any;\n}>\n  ? [string] extends [IKind | IName]\n    ? never\n    : (\n        undefined extends IName ? TNamespace : `${TNamespace}/${IName}`\n      ) extends infer INamePart extends string\n    ? IKind extends string\n      ? `${IKind}:${INamePart}`\n      : INamePart\n    : never\n  : never;\n\n/** @internal */\nexport function resolveExtensionDefinition<\n  T extends ExtensionDefinitionParameters,\n>(\n  definition: ExtensionDefinition<T>,\n  context?: { namespace?: string },\n): Extension<T['config'], T['configInput']> {\n  const internalDefinition = OpaqueExtensionDefinition.toInternal(definition);\n  const {\n    name,\n    kind,\n    namespace: _skip1,\n    override: _skip2,\n    ...rest\n  } = internalDefinition;\n\n  const namespace = internalDefinition.namespace ?? context?.namespace;\n\n  const namePart =\n    name && namespace ? `${namespace}/${name}` : namespace || name;\n  if (!namePart) {\n    throw new Error(\n      `Extension must declare an explicit namespace or name as it could not be resolved from context, kind=${kind} namespace=${namespace} name=${name}`,\n    );\n  }\n\n  const id = kind ? `${kind}:${namePart}` : namePart;\n\n  return {\n    ...rest,\n    $$type: '@backstage/Extension',\n    version: internalDefinition.version,\n    id,\n    toString() {\n      return `Extension{id=${id}}`;\n    },\n  } as InternalExtension<T['config'], T['configInput']> & Object;\n}\n"],"names":[],"mappings":";;;;AA4FO,SAAS,oBACd,SAAA,EAC0C;AAC1C,EAAA,MAAM,QAAA,GAAW,SAAA;AACjB,EAAA,IAAI,QAAA,CAAS,WAAW,sBAAA,EAAwB;AAC9C,IAAA,MAAM,IAAI,KAAA;AAAA,MACR,CAAA,sCAAA,EAAyC,SAAS,MAAM,CAAA,CAAA;AAAA,KAC1D;AAAA,EACF;AACA,EAAA,MAAM,UAAU,QAAA,CAAS,OAAA;AACzB,EAAA,IAAI,OAAA,KAAY,IAAA,IAAQ,OAAA,KAAY,IAAA,EAAM;AACxC,IAAA,MAAM,IAAI,KAAA,CAAM,CAAA,yCAAA,EAA4C,OAAO,CAAA,CAAA,CAAG,CAAA;AAAA,EACxE;AACA,EAAA,OAAO,QAAA;AACT;AAuBO,SAAS,0BAAA,CAGd,YACA,OAAA,EAC0C;AAC1C,EAAA,MAAM,kBAAA,GAAqB,yBAAA,CAA0B,UAAA,CAAW,UAAU,CAAA;AAC1E,EAAA,MAAM;AAAA,IACJ,IAAA;AAAA,IACA,IAAA;AAAA,IACA,SAAA,EAAW,MAAA;AAAA,IACX,QAAA,EAAU,MAAA;AAAA,IACV,GAAG;AAAA,GACL,GAAI,kBAAA;AAEJ,EAAA,MAAM,SAAA,GAAY,kBAAA,CAAmB,SAAA,IAAa,OAAA,EAAS,SAAA;AAE3D,EAAA,MAAM,QAAA,GACJ,QAAQ,SAAA,GAAY,CAAA,EAAG,SAAS,CAAA,CAAA,EAAI,IAAI,KAAK,SAAA,IAAa,IAAA;AAC5D,EAAA,IAAI,CAAC,QAAA,EAAU;AACb,IAAA,MAAM,IAAI,KAAA;AAAA,MACR,CAAA,oGAAA,EAAuG,IAAI,CAAA,WAAA,EAAc,SAAS,SAAS,IAAI,CAAA;AAAA,KACjJ;AAAA,EACF;AAEA,EAAA,MAAM,KAAK,IAAA,GAAO,CAAA,EAAG,IAAI,CAAA,CAAA,EAAI,QAAQ,CAAA,CAAA,GAAK,QAAA;AAE1C,EAAA,OAAO;AAAA,IACL,GAAG,IAAA;AAAA,IACH,MAAA,EAAQ,sBAAA;AAAA,IACR,SAAS,kBAAA,CAAmB,OAAA;AAAA,IAC5B,EAAA;AAAA,IACA,QAAA,GAAW;AACT,MAAA,OAAO,gBAAgB,EAAE,CAAA,CAAA,CAAA;AAAA,IAC3B;AAAA,GACF;AACF;;;;"}