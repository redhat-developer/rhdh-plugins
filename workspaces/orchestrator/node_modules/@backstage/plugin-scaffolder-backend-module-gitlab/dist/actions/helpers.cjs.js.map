{"version":3,"file":"helpers.cjs.js","sources":["../../src/actions/helpers.ts"],"sourcesContent":["/*\n * Copyright 2023 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport { parseRepoUrl } from '@backstage/plugin-scaffolder-node';\nimport { ErrorLike, InputError, isError } from '@backstage/errors';\nimport { ScmIntegrationRegistry } from '@backstage/integration';\nimport { Gitlab } from '@gitbeaker/rest';\nimport { GitbeakerRequestError } from '@gitbeaker/requester-utils';\n\nexport function createGitlabApi(options: {\n  integrations: ScmIntegrationRegistry;\n  token?: string;\n  repoUrl: string;\n}): InstanceType<typeof Gitlab> {\n  const { integrations, token: providedToken, repoUrl } = options;\n\n  const { host } = parseRepoUrl(repoUrl, integrations);\n\n  const integrationConfig = integrations.gitlab.byHost(host);\n\n  if (!integrationConfig) {\n    throw new InputError(\n      `No matching integration configuration for host ${host}, please check your integrations config`,\n    );\n  }\n\n  if (!integrationConfig.config.token && !providedToken) {\n    throw new InputError(`No token available for host ${host}`);\n  }\n\n  const token = providedToken ?? integrationConfig.config.token!;\n  const tokenType = providedToken ? 'oauthToken' : 'token';\n\n  return new Gitlab({\n    host: integrationConfig.config.baseUrl,\n    [tokenType]: token,\n  });\n}\n\ninterface GitlabError extends ErrorLike {\n  // Errors from Gitlab may also include a description field that contains additional info\n  description: string;\n}\n\nfunction isGitlabError(e: unknown): e is GitlabError {\n  return isError(e) && 'description' in e && typeof e.description === 'string';\n}\n\nfunction isGitbeakerRequestError(e: unknown): e is GitbeakerRequestError {\n  return isError(e) && e.name === 'GitbeakerRequestError';\n}\n\nexport function getErrorMessage(e: unknown): string {\n  if (isGitbeakerRequestError(e) && e.cause)\n    return `${e} - ${e.cause.description}`;\n  if (isGitlabError(e)) return `${e} - ${e.description}`;\n  return String(e);\n}\n"],"names":["parseRepoUrl","InputError","Gitlab","isError"],"mappings":";;;;;;AAqBO,SAAS,gBAAgB,OAAA,EAIA;AAC9B,EAAA,MAAM,EAAE,YAAA,EAAc,KAAA,EAAO,aAAA,EAAe,SAAQ,GAAI,OAAA;AAExD,EAAA,MAAM,EAAE,IAAA,EAAK,GAAIA,iCAAA,CAAa,SAAS,YAAY,CAAA;AAEnD,EAAA,MAAM,iBAAA,GAAoB,YAAA,CAAa,MAAA,CAAO,MAAA,CAAO,IAAI,CAAA;AAEzD,EAAA,IAAI,CAAC,iBAAA,EAAmB;AACtB,IAAA,MAAM,IAAIC,iBAAA;AAAA,MACR,kDAAkD,IAAI,CAAA,uCAAA;AAAA,KACxD;AAAA,EACF;AAEA,EAAA,IAAI,CAAC,iBAAA,CAAkB,MAAA,CAAO,KAAA,IAAS,CAAC,aAAA,EAAe;AACrD,IAAA,MAAM,IAAIA,iBAAA,CAAW,CAAA,4BAAA,EAA+B,IAAI,CAAA,CAAE,CAAA;AAAA,EAC5D;AAEA,EAAA,MAAM,KAAA,GAAQ,aAAA,IAAiB,iBAAA,CAAkB,MAAA,CAAO,KAAA;AACxD,EAAA,MAAM,SAAA,GAAY,gBAAgB,YAAA,GAAe,OAAA;AAEjD,EAAA,OAAO,IAAIC,WAAA,CAAO;AAAA,IAChB,IAAA,EAAM,kBAAkB,MAAA,CAAO,OAAA;AAAA,IAC/B,CAAC,SAAS,GAAG;AAAA,GACd,CAAA;AACH;AAOA,SAAS,cAAc,CAAA,EAA8B;AACnD,EAAA,OAAOC,eAAQ,CAAC,CAAA,IAAK,iBAAiB,CAAA,IAAK,OAAO,EAAE,WAAA,KAAgB,QAAA;AACtE;AAEA,SAAS,wBAAwB,CAAA,EAAwC;AACvE,EAAA,OAAOA,cAAA,CAAQ,CAAC,CAAA,IAAK,CAAA,CAAE,IAAA,KAAS,uBAAA;AAClC;AAEO,SAAS,gBAAgB,CAAA,EAAoB;AAClD,EAAA,IAAI,uBAAA,CAAwB,CAAC,CAAA,IAAK,CAAA,CAAE,KAAA;AAClC,IAAA,OAAO,CAAA,EAAG,CAAC,CAAA,GAAA,EAAM,CAAA,CAAE,MAAM,WAAW,CAAA,CAAA;AACtC,EAAA,IAAI,aAAA,CAAc,CAAC,CAAA,EAAG,OAAO,GAAG,CAAC,CAAA,GAAA,EAAM,EAAE,WAAW,CAAA,CAAA;AACpD,EAAA,OAAO,OAAO,CAAC,CAAA;AACjB;;;;;"}