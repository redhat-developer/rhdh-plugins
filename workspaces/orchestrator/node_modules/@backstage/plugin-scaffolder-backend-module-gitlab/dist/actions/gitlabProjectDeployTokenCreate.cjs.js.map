{"version":3,"file":"gitlabProjectDeployTokenCreate.cjs.js","sources":["../../src/actions/gitlabProjectDeployTokenCreate.ts"],"sourcesContent":["/*\n * Copyright 2021 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { InputError } from '@backstage/errors';\nimport { ScmIntegrationRegistry } from '@backstage/integration';\nimport { createTemplateAction } from '@backstage/plugin-scaffolder-node';\nimport { DeployTokenScope, Gitlab } from '@gitbeaker/rest';\nimport { getToken } from '../util';\nimport { examples } from './gitlabProjectDeployTokenCreate.examples';\n\n/**\n * Creates a `gitlab:projectDeployToken:create` Scaffolder action.\n *\n * @param options - Templating configuration.\n * @public\n */\nexport const createGitlabProjectDeployTokenAction = (options: {\n  integrations: ScmIntegrationRegistry;\n}) => {\n  const { integrations } = options;\n  return createTemplateAction({\n    id: 'gitlab:projectDeployToken:create',\n    examples,\n    schema: {\n      input: {\n        repoUrl: z =>\n          z.string({\n            description: `Accepts the format 'gitlab.com?repo=project_name&owner=group_name' where 'project_name' is the repository name and 'group_name' is a group or username`,\n          }),\n        token: z =>\n          z\n            .string({\n              description: 'The token to use for authorization to GitLab',\n            })\n            .optional(),\n        projectId: z =>\n          z.union([z.number(), z.string()], {\n            description: 'Project ID',\n          }),\n        name: z =>\n          z.string({\n            description: 'Deploy Token Name',\n          }),\n        username: z =>\n          z\n            .string({\n              description: 'Deploy Token Username',\n            })\n            .optional(),\n        scopes: z =>\n          z.array(z.string(), {\n            description: 'Scopes',\n          }),\n      },\n      output: {\n        deploy_token: z =>\n          z.string({\n            description: 'Deploy Token',\n          }),\n        user: z =>\n          z.string({\n            description: 'User',\n          }),\n      },\n    },\n    async handler(ctx) {\n      ctx.logger.info(`Creating Token for Project \"${ctx.input.projectId}\"`);\n      const { projectId, name, username, scopes } = ctx.input;\n      const { token, integrationConfig } = getToken(ctx.input, integrations);\n\n      if (scopes.length === 0) {\n        throw new InputError(\n          `Could not create token for project \"${ctx.input.projectId}\": scopes cannot be empty.`,\n        );\n      }\n\n      const api = new Gitlab({\n        host: integrationConfig.config.baseUrl,\n        token: token,\n      });\n\n      const { deployToken, deployUsername } = await ctx.checkpoint({\n        key: `create.deploy.token.${projectId}.${name}`,\n        fn: async () => {\n          const res = await api.DeployTokens.create(\n            name,\n            scopes as DeployTokenScope[],\n            {\n              projectId,\n              username,\n            },\n          );\n\n          if (!res.hasOwnProperty('token')) {\n            throw new InputError(`No deploy_token given from gitlab instance`);\n          }\n\n          return {\n            deployToken: res.token as string,\n            deployUsername: res.username,\n          };\n        },\n      });\n\n      ctx.output('deploy_token', deployToken);\n      ctx.output('user', deployUsername);\n    },\n  });\n};\n"],"names":["createTemplateAction","examples","getToken","InputError","Gitlab"],"mappings":"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"}