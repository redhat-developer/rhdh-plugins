{"version":3,"file":"util.cjs.js","sources":["../src/util.ts"],"sourcesContent":["/*\n * Copyright 2021 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { InputError } from '@backstage/errors';\nimport {\n  GitLabIntegration,\n  ScmIntegrationRegistry,\n} from '@backstage/integration';\nimport { Gitlab, GroupSchema } from '@gitbeaker/rest';\nimport { z } from 'zod';\nimport commonGitlabConfig from './commonGitlabConfig';\n\nexport const parseRepoHost = (repoUrl: string): string => {\n  let parsed;\n  try {\n    parsed = new URL(`https://${repoUrl}`);\n  } catch (error) {\n    throw new InputError(\n      `Invalid repo URL passed to publisher, got ${repoUrl}, ${error}`,\n    );\n  }\n  return parsed.host;\n};\n\nexport const getToken = (\n  config: z.infer<typeof commonGitlabConfig>,\n  integrations: ScmIntegrationRegistry,\n): { token: string; integrationConfig: GitLabIntegration } => {\n  const host = parseRepoHost(config.repoUrl);\n  const integrationConfig = integrations.gitlab.byHost(host);\n\n  if (!integrationConfig) {\n    throw new InputError(\n      `No matching integration configuration for host ${host}, please check your integrations config`,\n    );\n  }\n\n  const token = config.token || integrationConfig.config.token!;\n\n  return { token: token, integrationConfig: integrationConfig };\n};\n\nexport type RepoSpec = {\n  repo: string;\n  host: string;\n  owner?: string;\n};\n\nexport const parseRepoUrl = (\n  repoUrl: string,\n  integrations: ScmIntegrationRegistry,\n): RepoSpec => {\n  let parsed;\n  try {\n    parsed = new URL(`https://${repoUrl}`);\n  } catch (error) {\n    throw new InputError(\n      `Invalid repo URL passed to publisher, got ${repoUrl}, ${error}`,\n    );\n  }\n  const host = parsed.host;\n  const owner = parsed.searchParams.get('owner') ?? undefined;\n  const repo: string = parsed.searchParams.get('repo')!;\n\n  const type = integrations.byHost(host)?.type;\n\n  if (!type) {\n    throw new InputError(\n      `No matching integration configuration for host ${host}, please check your integrations config`,\n    );\n  }\n\n  return { host, owner, repo };\n};\n\nexport function getClient(props: {\n  host: string;\n  token?: string;\n  integrations: ScmIntegrationRegistry;\n}): InstanceType<typeof Gitlab> {\n  const { host, token, integrations } = props;\n  const integrationConfig = integrations.gitlab.byHost(host);\n\n  if (!integrationConfig) {\n    throw new InputError(\n      `No matching integration configuration for host ${host}, please check your integrations config`,\n    );\n  }\n\n  const { config } = integrationConfig;\n\n  if (!config.token && !token) {\n    throw new InputError(`No token available for host ${host}`);\n  }\n\n  const requestToken = token || config.token!;\n  const tokenType = token ? 'oauthToken' : 'token';\n\n  const gitlabOptions: any = {\n    host: config.baseUrl,\n  };\n\n  gitlabOptions[tokenType] = requestToken;\n  return new Gitlab(gitlabOptions);\n}\n\nexport function convertDate(\n  inputDate: string | undefined,\n  defaultDate: string,\n) {\n  try {\n    return inputDate\n      ? new Date(inputDate).toISOString()\n      : new Date(defaultDate).toISOString();\n  } catch (error) {\n    throw new InputError(`Error converting input date - ${error}`);\n  }\n}\n\nexport async function getTopLevelParentGroup(\n  client: InstanceType<typeof Gitlab>,\n  groupId: number,\n): Promise<GroupSchema> {\n  try {\n    const topParentGroup = await client.Groups.show(groupId);\n    if (topParentGroup.parent_id) {\n      return getTopLevelParentGroup(client, topParentGroup.parent_id as number);\n    }\n    return topParentGroup as GroupSchema;\n  } catch (error: any) {\n    throw new InputError(\n      `Error finding top-level parent group ID: ${error.message}`,\n    );\n  }\n}\n\nexport async function checkEpicScope(\n  client: InstanceType<typeof Gitlab>,\n  projectId: number,\n  epicId: number,\n) {\n  try {\n    // If project exists, get the top level group id\n    const project = await client.Projects.show(projectId);\n    if (!project) {\n      throw new InputError(\n        `Project with id ${projectId} not found. Check your GitLab instance.`,\n      );\n    }\n    const topParentGroup = await getTopLevelParentGroup(\n      client,\n      project.namespace.id,\n    );\n    if (!topParentGroup) {\n      throw new InputError(`Couldn't find a suitable top-level parent group.`);\n    }\n    // Get the epic\n    const epic = (await client.Epics.all(topParentGroup.id)).find(\n      (x: any) => x.id === epicId,\n    );\n    if (!epic) {\n      throw new InputError(\n        `Epic with id ${epicId} not found in the top-level parent group ${topParentGroup.name}.`,\n      );\n    }\n\n    const epicGroup = await client.Groups.show(epic.group_id as number);\n    const projectNamespace: string = project.path_with_namespace as string;\n    return projectNamespace.startsWith(epicGroup.full_path as string);\n  } catch (error: any) {\n    throw new InputError(`Could not find epic scope: ${error.message}`);\n  }\n}\n"],"names":["InputError","Gitlab"],"mappings":"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"}