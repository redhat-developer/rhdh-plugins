{"version":3,"file":"useTemplateSchema.esm.js","sources":["../../../src/next/hooks/useTemplateSchema.ts"],"sourcesContent":["/*\n * Copyright 2022 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport { featureFlagsApiRef, useApi } from '@backstage/core-plugin-api';\nimport { TemplatePresentationV1beta3 } from '@backstage/plugin-scaffolder-common';\nimport { JsonObject } from '@backstage/types';\nimport { UiSchema } from '@rjsf/utils';\nimport { TemplateParameterSchema } from '@backstage/plugin-scaffolder-react';\nimport { extractSchemaFromStep } from '../lib';\n\n/**\n * This is the parsed template schema that is returned from the {@link useTemplateSchema} hook.\n * @alpha\n */\nexport interface ParsedTemplateSchema {\n  uiSchema: UiSchema;\n  mergedSchema: JsonObject;\n  schema: JsonObject;\n  title: string;\n  description?: string;\n}\n\n/**\n * This hook will parse the template schema and return the steps with the\n * parsed schema and uiSchema. Filtering out any steps or properties that\n * are not enabled with feature flags.\n * @alpha\n */\nexport const useTemplateSchema = (\n  manifest: TemplateParameterSchema,\n): {\n  steps: ParsedTemplateSchema[];\n  presentation?: TemplatePresentationV1beta3;\n} => {\n  const featureFlags = useApi(featureFlagsApiRef);\n  const steps = manifest.steps.map(({ title, description, schema }) => ({\n    title,\n    description,\n    mergedSchema: schema,\n    ...extractSchemaFromStep(schema),\n  }));\n\n  const returningSteps = steps\n    // Filter out steps that are not enabled with the feature flags\n    .filter(step => {\n      const stepFeatureFlag = step.uiSchema['ui:backstage']?.featureFlag;\n      return stepFeatureFlag ? featureFlags.isActive(stepFeatureFlag) : true;\n    })\n    // Then filter out the properties that are not enabled with feature flag\n    .map(step => {\n      const strippedSchema = {\n        ...step,\n        schema: {\n          ...step.schema,\n          // Title is rendered at the top of the page, so let's ignore this from jsonschemaform\n          title: undefined,\n        },\n      } as ParsedTemplateSchema;\n\n      if (step.schema?.properties || !step.schema?.dependencies) {\n        strippedSchema.schema.properties = Object.fromEntries(\n          Object.entries((step.schema?.properties ?? {}) as JsonObject).filter(\n            ([key]) => {\n              const stepFeatureFlag =\n                step.uiSchema[key]?.['ui:backstage']?.featureFlag;\n              return stepFeatureFlag\n                ? featureFlags.isActive(stepFeatureFlag)\n                : true;\n            },\n          ),\n        );\n      }\n\n      return strippedSchema;\n    });\n\n  return {\n    presentation: manifest.presentation,\n    steps: returningSteps,\n  };\n};\n"],"names":[],"mappings":";;;AAwCO,MAAM,iBAAA,GAAoB,CAC/B,QAAA,KAIG;AACH,EAAA,MAAM,YAAA,GAAe,OAAO,kBAAkB,CAAA;AAC9C,EAAA,MAAM,KAAA,GAAQ,SAAS,KAAA,CAAM,GAAA,CAAI,CAAC,EAAE,KAAA,EAAO,WAAA,EAAa,MAAA,EAAO,MAAO;AAAA,IACpE,KAAA;AAAA,IACA,WAAA;AAAA,IACA,YAAA,EAAc,MAAA;AAAA,IACd,GAAG,sBAAsB,MAAM;AAAA,GACjC,CAAE,CAAA;AAEF,EAAA,MAAM,cAAA,GAAiB,KAAA,CAEpB,MAAA,CAAO,CAAA,IAAA,KAAQ;AACd,IAAA,MAAM,eAAA,GAAkB,IAAA,CAAK,QAAA,CAAS,cAAc,CAAA,EAAG,WAAA;AACvD,IAAA,OAAO,eAAA,GAAkB,YAAA,CAAa,QAAA,CAAS,eAAe,CAAA,GAAI,IAAA;AAAA,EACpE,CAAC,CAAA,CAEA,GAAA,CAAI,CAAA,IAAA,KAAQ;AACX,IAAA,MAAM,cAAA,GAAiB;AAAA,MACrB,GAAG,IAAA;AAAA,MACH,MAAA,EAAQ;AAAA,QACN,GAAG,IAAA,CAAK,MAAA;AAAA;AAAA,QAER,KAAA,EAAO;AAAA;AACT,KACF;AAEA,IAAA,IAAI,KAAK,MAAA,EAAQ,UAAA,IAAc,CAAC,IAAA,CAAK,QAAQ,YAAA,EAAc;AACzD,MAAA,cAAA,CAAe,MAAA,CAAO,aAAa,MAAA,CAAO,WAAA;AAAA,QACxC,OAAO,OAAA,CAAS,IAAA,CAAK,QAAQ,UAAA,IAAc,EAAiB,CAAA,CAAE,MAAA;AAAA,UAC5D,CAAC,CAAC,GAAG,CAAA,KAAM;AACT,YAAA,MAAM,kBACJ,IAAA,CAAK,QAAA,CAAS,GAAG,CAAA,GAAI,cAAc,CAAA,EAAG,WAAA;AACxC,YAAA,OAAO,eAAA,GACH,YAAA,CAAa,QAAA,CAAS,eAAe,CAAA,GACrC,IAAA;AAAA,UACN;AAAA;AACF,OACF;AAAA,IACF;AAEA,IAAA,OAAO,cAAA;AAAA,EACT,CAAC,CAAA;AAEH,EAAA,OAAO;AAAA,IACL,cAAc,QAAA,CAAS,YAAA;AAAA,IACvB,KAAA,EAAO;AAAA,GACT;AACF;;;;"}