{"version":3,"file":"useFilteredSchemaProperties.esm.js","sources":["../../../src/next/hooks/useFilteredSchemaProperties.ts"],"sourcesContent":["/*\n * Copyright 2023 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport cloneDeep from 'lodash/cloneDeep';\nimport { useApi, featureFlagsApiRef } from '@backstage/core-plugin-api';\nimport { TemplateParameterSchema } from '@backstage/plugin-scaffolder-react';\nimport { useMemo } from 'react';\n\n/**\n * Returns manifest of software templates with steps without a featureFlag tag.\n * @alpha\n */\n\nexport const useFilteredSchemaProperties = (\n  manifest: TemplateParameterSchema | undefined,\n): TemplateParameterSchema | undefined => {\n  const featureFlagKey = 'backstage:featureFlag';\n  const featureFlagApi = useApi(featureFlagsApiRef);\n\n  return useMemo(() => {\n    if (!manifest) {\n      return undefined;\n    }\n    const filteredSteps = manifest?.steps\n      .filter(step => {\n        const featureFlag = step.schema[featureFlagKey];\n        return (\n          typeof featureFlag !== 'string' ||\n          featureFlagApi.isActive(featureFlag)\n        );\n      })\n      .map(step => {\n        const filteredStep = cloneDeep(step);\n        const removedPropertyKeys: Array<string> = [];\n        if (filteredStep.schema.properties) {\n          filteredStep.schema.properties = Object.fromEntries(\n            Object.entries(filteredStep.schema.properties).filter(\n              ([key, value]) => {\n                if (value[featureFlagKey]) {\n                  if (featureFlagApi.isActive(value[featureFlagKey])) {\n                    return true;\n                  }\n\n                  removedPropertyKeys.push(key);\n                  return false;\n                }\n                return true;\n              },\n            ),\n          );\n\n          // remove the feature flag property key from required if they are not active\n          filteredStep.schema.required = Array.isArray(\n            filteredStep.schema.required,\n          )\n            ? filteredStep.schema.required?.filter(\n                r => !removedPropertyKeys.includes(r as string),\n              )\n            : filteredStep.schema.required;\n        }\n\n        return filteredStep;\n      });\n\n    return { ...manifest, steps: filteredSteps };\n  }, [manifest, featureFlagApi]);\n};\n"],"names":[],"mappings":";;;;AAyBO,MAAM,2BAAA,GAA8B,CACzC,QAAA,KACwC;AACxC,EAAA,MAAM,cAAA,GAAiB,uBAAA;AACvB,EAAA,MAAM,cAAA,GAAiB,OAAO,kBAAkB,CAAA;AAEhD,EAAA,OAAO,QAAQ,MAAM;AACnB,IAAA,IAAI,CAAC,QAAA,EAAU;AACb,MAAA,OAAO,MAAA;AAAA,IACT;AACA,IAAA,MAAM,aAAA,GAAgB,QAAA,EAAU,KAAA,CAC7B,MAAA,CAAO,CAAA,IAAA,KAAQ;AACd,MAAA,MAAM,WAAA,GAAc,IAAA,CAAK,MAAA,CAAO,cAAc,CAAA;AAC9C,MAAA,OACE,OAAO,WAAA,KAAgB,QAAA,IACvB,cAAA,CAAe,SAAS,WAAW,CAAA;AAAA,IAEvC,CAAC,CAAA,CACA,GAAA,CAAI,CAAA,IAAA,KAAQ;AACX,MAAA,MAAM,YAAA,GAAe,UAAU,IAAI,CAAA;AACnC,MAAA,MAAM,sBAAqC,EAAC;AAC5C,MAAA,IAAI,YAAA,CAAa,OAAO,UAAA,EAAY;AAClC,QAAA,YAAA,CAAa,MAAA,CAAO,aAAa,MAAA,CAAO,WAAA;AAAA,UACtC,MAAA,CAAO,OAAA,CAAQ,YAAA,CAAa,MAAA,CAAO,UAAU,CAAA,CAAE,MAAA;AAAA,YAC7C,CAAC,CAAC,GAAA,EAAK,KAAK,CAAA,KAAM;AAChB,cAAA,IAAI,KAAA,CAAM,cAAc,CAAA,EAAG;AACzB,gBAAA,IAAI,cAAA,CAAe,QAAA,CAAS,KAAA,CAAM,cAAc,CAAC,CAAA,EAAG;AAClD,kBAAA,OAAO,IAAA;AAAA,gBACT;AAEA,gBAAA,mBAAA,CAAoB,KAAK,GAAG,CAAA;AAC5B,gBAAA,OAAO,KAAA;AAAA,cACT;AACA,cAAA,OAAO,IAAA;AAAA,YACT;AAAA;AACF,SACF;AAGA,QAAA,YAAA,CAAa,MAAA,CAAO,WAAW,KAAA,CAAM,OAAA;AAAA,UACnC,aAAa,MAAA,CAAO;AAAA,SACtB,GACI,YAAA,CAAa,MAAA,CAAO,QAAA,EAAU,MAAA;AAAA,UAC5B,CAAA,CAAA,KAAK,CAAC,mBAAA,CAAoB,QAAA,CAAS,CAAW;AAAA,SAChD,GACA,aAAa,MAAA,CAAO,QAAA;AAAA,MAC1B;AAEA,MAAA,OAAO,YAAA;AAAA,IACT,CAAC,CAAA;AAEH,IAAA,OAAO,EAAE,GAAG,QAAA,EAAU,KAAA,EAAO,aAAA,EAAc;AAAA,EAC7C,CAAA,EAAG,CAAC,QAAA,EAAU,cAAc,CAAC,CAAA;AAC/B;;;;"}