{"version":3,"file":"schema.esm.js","sources":["../../../src/next/lib/schema.ts"],"sourcesContent":["/*\n * Copyright 2022 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport { JsonObject } from '@backstage/types';\nimport { stringify, parse } from 'flatted';\nimport { FieldValidation, UiSchema } from '@rjsf/utils';\n\nfunction isObject(value: unknown): value is JsonObject {\n  return typeof value === 'object' && value !== null && !Array.isArray(value);\n}\n\nfunction extractUiSchema(schema: JsonObject, uiSchema: JsonObject) {\n  if (!isObject(schema)) {\n    return;\n  }\n\n  const {\n    properties,\n    items,\n    anyOf,\n    oneOf,\n    allOf,\n    dependencies,\n    then,\n    else: _else,\n  } = schema;\n\n  for (const propName in schema) {\n    if (!schema.hasOwnProperty(propName)) {\n      continue;\n    }\n\n    if (propName.startsWith('ui:')) {\n      uiSchema[propName] = schema[propName];\n      delete schema[propName];\n    }\n  }\n\n  if (isObject(properties)) {\n    for (const propName in properties) {\n      if (!properties.hasOwnProperty(propName)) {\n        continue;\n      }\n\n      const schemaNode = properties[propName];\n      if (!isObject(schemaNode)) {\n        continue;\n      }\n\n      if (!isObject(uiSchema[propName])) {\n        const innerUiSchema = {};\n        uiSchema[propName] = innerUiSchema;\n      }\n\n      extractUiSchema(schemaNode, uiSchema[propName] as JsonObject);\n    }\n  }\n\n  if (isObject(items)) {\n    const innerUiSchema = {};\n    uiSchema.items = innerUiSchema;\n    extractUiSchema(items, innerUiSchema);\n  }\n\n  if (Array.isArray(anyOf)) {\n    for (const schemaNode of anyOf) {\n      if (!isObject(schemaNode)) {\n        continue;\n      }\n      extractUiSchema(schemaNode, uiSchema);\n    }\n  }\n\n  if (Array.isArray(oneOf)) {\n    for (const schemaNode of oneOf) {\n      if (!isObject(schemaNode)) {\n        continue;\n      }\n      extractUiSchema(schemaNode, uiSchema);\n    }\n  }\n\n  if (Array.isArray(allOf)) {\n    for (const schemaNode of allOf) {\n      if (!isObject(schemaNode)) {\n        continue;\n      }\n      extractUiSchema(schemaNode, uiSchema);\n    }\n  }\n\n  if (isObject(dependencies)) {\n    for (const depName of Object.keys(dependencies)) {\n      const schemaNode = dependencies[depName];\n      if (!isObject(schemaNode)) {\n        continue;\n      }\n      extractUiSchema(schemaNode, uiSchema);\n    }\n  }\n\n  if (isObject(then)) {\n    extractUiSchema(then, uiSchema);\n  }\n\n  if (isObject(_else)) {\n    extractUiSchema(_else, uiSchema);\n  }\n}\n\n/**\n * Takes a step from a Backstage Template Manifest and converts it to a JSON Schema and UI Schema for rjsf\n * @alpha\n */\nexport const extractSchemaFromStep = (\n  inputStep: JsonObject,\n): { uiSchema: UiSchema; schema: JsonObject } => {\n  const uiSchema: UiSchema = {};\n  const returnSchema: JsonObject = parse(stringify(inputStep));\n  extractUiSchema(returnSchema, uiSchema);\n  return { uiSchema, schema: returnSchema };\n};\n\n/**\n * Creates a field validation object for use in react jsonschema form\n * @alpha\n */\nexport const createFieldValidation = (): FieldValidation => {\n  const fieldValidation: FieldValidation = {\n    __errors: [] as string[],\n    addError: (message: string) => {\n      fieldValidation.__errors?.push(message);\n    },\n  };\n\n  return fieldValidation;\n};\n"],"names":[],"mappings":"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"}