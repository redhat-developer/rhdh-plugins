{"version":3,"file":"Workflow.esm.js","sources":["../../../../src/next/components/Workflow/Workflow.tsx"],"sourcesContent":["/*\n * Copyright 2022 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { stringifyEntityRef } from '@backstage/catalog-model';\nimport {\n  Content,\n  InfoCard,\n  MarkdownContent,\n  Progress,\n} from '@backstage/core-components';\nimport { errorApiRef, useAnalytics, useApi } from '@backstage/core-plugin-api';\nimport { useTranslationRef } from '@backstage/frontend-plugin-api';\nimport { ReviewStepProps } from '@backstage/plugin-scaffolder-react';\nimport { JsonValue } from '@backstage/types';\nimport { makeStyles } from '@material-ui/core/styles';\nimport { ComponentType, useCallback, useEffect } from 'react';\n\nimport { SecretsContextProvider } from '../../../secrets/SecretsContext';\nimport { scaffolderReactTranslationRef } from '../../../translation';\nimport { useFilteredSchemaProperties } from '../../hooks/useFilteredSchemaProperties';\nimport { useTemplateParameterSchema } from '../../hooks/useTemplateParameterSchema';\nimport { useTemplateTimeSavedMinutes } from '../../hooks/useTemplateTimeSaved';\nimport { Stepper, type StepperProps } from '../Stepper/Stepper';\n\nconst useStyles = makeStyles({\n  markdown: {\n    /** to make the styles for React Markdown not leak into the description */\n    '& :first-child': {\n      marginTop: 0,\n    },\n    '& :last-child': {\n      marginBottom: 0,\n    },\n  },\n});\n\n/**\n * @alpha\n */\nexport type WorkflowProps = {\n  title?: string;\n  description?: string;\n  namespace: string;\n  templateName: string;\n  components?: {\n    ReviewStepComponent?: ComponentType<ReviewStepProps>;\n  };\n  onError(error: Error | undefined): JSX.Element | null;\n} & Pick<\n  StepperProps,\n  | 'extensions'\n  | 'formProps'\n  | 'components'\n  | 'onCreate'\n  | 'initialState'\n  | 'layouts'\n>;\n\n/**\n * @alpha\n */\nexport const Workflow = (workflowProps: WorkflowProps): JSX.Element | null => {\n  const { t } = useTranslationRef(scaffolderReactTranslationRef);\n  const { title, description, namespace, templateName, onCreate, ...props } =\n    workflowProps;\n\n  const analytics = useAnalytics();\n  const styles = useStyles();\n  const templateRef = stringifyEntityRef({\n    kind: 'Template',\n    namespace: namespace,\n    name: templateName,\n  });\n\n  const errorApi = useApi(errorApiRef);\n\n  const { loading, manifest, error } = useTemplateParameterSchema(templateRef);\n\n  const sortedManifest = useFilteredSchemaProperties(manifest);\n\n  const minutesSaved = useTemplateTimeSavedMinutes(templateRef);\n\n  const workflowOnCreate = useCallback(\n    async (formState: Record<string, JsonValue>) => {\n      await onCreate(formState);\n\n      analytics.captureEvent('create', 'Task has been created', {\n        value: minutesSaved,\n        attributes: {\n          templateSteps: sortedManifest?.steps?.length ?? 0,\n        },\n      });\n    },\n    [onCreate, analytics, minutesSaved, sortedManifest],\n  );\n\n  useEffect(() => {\n    if (error) {\n      errorApi.post(new Error(`Failed to load template, ${error}`));\n    }\n  }, [error, errorApi]);\n\n  if (error) {\n    return props.onError(error);\n  }\n\n  return (\n    <Content>\n      {loading && <Progress />}\n      {sortedManifest && (\n        <InfoCard\n          title={title ?? sortedManifest.title}\n          subheader={\n            <MarkdownContent\n              className={styles.markdown}\n              linkTarget=\"_blank\"\n              content={\n                description ??\n                sortedManifest.description ??\n                t('workflow.noDescription')\n              }\n            />\n          }\n          noPadding\n          titleTypographyProps={{ component: 'h2' }}\n        >\n          <Stepper\n            manifest={sortedManifest}\n            onCreate={workflowOnCreate}\n            {...props}\n          />\n        </InfoCard>\n      )}\n    </Content>\n  );\n};\n\n/**\n * @alpha\n */\nexport const EmbeddableWorkflow = (props: WorkflowProps) => (\n  <SecretsContextProvider>\n    <Workflow {...props} />\n  </SecretsContextProvider>\n);\n"],"names":[],"mappings":"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"}