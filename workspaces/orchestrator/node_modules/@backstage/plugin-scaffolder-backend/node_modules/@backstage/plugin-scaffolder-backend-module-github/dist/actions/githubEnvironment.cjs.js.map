{"version":3,"file":"githubEnvironment.cjs.js","sources":["../../src/actions/githubEnvironment.ts"],"sourcesContent":["/*\n * Copyright 2021 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { InputError } from '@backstage/errors';\nimport {\n  createTemplateAction,\n  parseRepoUrl,\n} from '@backstage/plugin-scaffolder-node';\nimport { ScmIntegrationRegistry } from '@backstage/integration';\nimport { getOctokitOptions } from '../util';\nimport { Octokit } from 'octokit';\nimport Sodium from 'libsodium-wrappers';\nimport { examples } from './gitHubEnvironment.examples';\nimport { Entity } from '@backstage/catalog-model';\nimport { CatalogService } from '@backstage/plugin-catalog-node';\n\n/**\n * Creates an `github:environment:create` Scaffolder action that creates a Github Environment.\n *\n * @public\n */\nexport function createGithubEnvironmentAction(options: {\n  integrations: ScmIntegrationRegistry;\n  catalog: CatalogService;\n}) {\n  const { integrations, catalog } = options;\n  // For more information on how to define custom actions, see\n  //   https://backstage.io/docs/features/software-templates/writing-custom-actions\n  return createTemplateAction({\n    id: 'github:environment:create',\n    description: 'Creates Deployment Environments',\n    examples,\n    schema: {\n      input: {\n        repoUrl: z =>\n          z.string({\n            description:\n              'Accepts the format `github.com?repo=reponame&owner=owner` where `reponame` is the new repository name and `owner` is an organization or username',\n          }),\n        name: z =>\n          z.string({\n            description: `Name of the deployment environment to create`,\n          }),\n        deploymentBranchPolicy: z =>\n          z\n            .object(\n              {\n                protected_branches: z.boolean({\n                  description:\n                    'Whether only branches with branch protection rules can deploy to this environment. If `protected_branches` is `true`, `custom_branch_policies` must be `false`; if `protected_branches` is `false`, `custom_branch_policies` must be `true`.',\n                }),\n                custom_branch_policies: z.boolean({\n                  description:\n                    'Whether only branches that match the specified name patterns can deploy to this environment. If `custom_branch_policies` is `true`, `protected_branches` must be `false`; if `custom_branch_policies` is `false`, `protected_branches` must be `true`.',\n                }),\n              },\n              {\n                description:\n                  'The type of deployment branch policy for this environment. To allow all branches to deploy, set to `null`.',\n              },\n            )\n            .optional(),\n        customBranchPolicyNames: z =>\n          z\n            .array(z.string(), {\n              description: `The name pattern that branches must match in order to deploy to the environment.\n\nWildcard characters will not match \\`/\\`. For example, to match branches that begin with \\`release/\\` and contain an additional single slash, use \\`release/*/*\\`. For more information about pattern matching syntax, see the Ruby File.fnmatch documentation.`,\n            })\n            .optional(),\n        customTagPolicyNames: z =>\n          z\n            .array(z.string(), {\n              description: `The name pattern that tags must match in order to deploy to the environment.\n\nWildcard characters will not match \\`/\\`. For example, to match tags that begin with \\`release/\\` and contain an additional single slash, use \\`release/*/*\\`. For more information about pattern matching syntax, see the Ruby File.fnmatch documentation.`,\n            })\n            .optional(),\n        environmentVariables: z =>\n          z\n            .record(z.string(), {\n              description: `Environment variables attached to the deployment environment`,\n            })\n            .optional(),\n        secrets: z =>\n          z\n            .record(z.string(), {\n              description: `Secrets attached to the deployment environment`,\n            })\n            .optional(),\n        token: z =>\n          z\n            .string({\n              description: 'The token to use for authorization to GitHub',\n            })\n            .optional(),\n        waitTimer: z =>\n          z\n            .number({\n              description:\n                'The time to wait before creating or updating the environment (in milliseconds)',\n            })\n            .optional(),\n        preventSelfReview: z =>\n          z\n            .boolean({\n              description:\n                'Whether to prevent self-review for this environment',\n            })\n            .optional(),\n        reviewers: z =>\n          z\n            .array(z.string(), {\n              description:\n                'Reviewers for this environment. Must be a list of Backstage entity references.',\n            })\n            .optional(),\n      },\n    },\n    async handler(ctx) {\n      const {\n        repoUrl,\n        name,\n        deploymentBranchPolicy,\n        customBranchPolicyNames,\n        customTagPolicyNames,\n        environmentVariables,\n        secrets,\n        token: providedToken,\n        waitTimer,\n        preventSelfReview,\n        reviewers,\n      } = ctx.input;\n\n      // When environment creation step is executed right after a repo publish step, the repository might not be available immediately.\n      // Add a 2-second delay before initiating the steps in this action.\n      await new Promise(resolve => setTimeout(resolve, 2000));\n\n      const { host, owner, repo } = parseRepoUrl(repoUrl, integrations);\n\n      if (!owner) {\n        throw new InputError(`No owner provided for repo ${repoUrl}`);\n      }\n\n      const octokitOptions = await getOctokitOptions({\n        integrations,\n        token: providedToken,\n        host,\n        owner,\n        repo,\n      });\n      const client = new Octokit({\n        ...octokitOptions,\n        log: ctx.logger,\n      });\n\n      const repositoryId = await ctx.checkpoint({\n        key: `get.repo.${owner}.${repo}`,\n        fn: async () => {\n          const repository = await client.rest.repos.get({\n            owner: owner,\n            repo: repo,\n          });\n          return repository.data.id;\n        },\n      });\n\n      // convert reviewers from catalog entity to Github user or team\n      const githubReviewers: { type: 'User' | 'Team'; id: number }[] = [];\n      if (reviewers) {\n        let reviewersEntityRefs: Array<Entity | undefined> = [];\n        // Fetch reviewers from Catalog\n        const catalogResponse = await catalog.getEntitiesByRefs(\n          {\n            entityRefs: reviewers,\n          },\n          {\n            credentials: await ctx.getInitiatorCredentials(),\n          },\n        );\n        if (catalogResponse?.items?.length) {\n          reviewersEntityRefs = catalogResponse.items;\n        }\n\n        for (const reviewerEntityRef of reviewersEntityRefs) {\n          if (reviewerEntityRef?.kind === 'User') {\n            try {\n              const userId = await ctx.checkpoint({\n                key: `get.user.${reviewerEntityRef.metadata.name}`,\n                fn: async () => {\n                  const user = await client.rest.users.getByUsername({\n                    username: reviewerEntityRef.metadata.name,\n                  });\n                  return user.data.id;\n                },\n              });\n\n              githubReviewers.push({\n                type: 'User',\n                id: userId,\n              });\n            } catch (error) {\n              ctx.logger.error('User not found:', error);\n            }\n          } else if (reviewerEntityRef?.kind === 'Group') {\n            try {\n              const teamId = await ctx.checkpoint({\n                key: `get.team.${reviewerEntityRef.metadata.name}`,\n                fn: async () => {\n                  const team = await client.rest.teams.getByName({\n                    org: owner,\n                    team_slug: reviewerEntityRef.metadata.name,\n                  });\n                  return team.data.id;\n                },\n              });\n\n              githubReviewers.push({\n                type: 'Team',\n                id: teamId,\n              });\n            } catch (error) {\n              ctx.logger.error('Team not found:', error);\n            }\n          }\n        }\n      }\n\n      await ctx.checkpoint({\n        key: `create.or.update.environment.${owner}.${repo}.${name}`,\n        fn: async () => {\n          await client.rest.repos.createOrUpdateEnvironment({\n            owner: owner,\n            repo: repo,\n            environment_name: name,\n            deployment_branch_policy: deploymentBranchPolicy ?? undefined,\n            wait_timer: waitTimer ?? undefined,\n            prevent_self_review: preventSelfReview ?? undefined,\n            reviewers: githubReviewers.length ? githubReviewers : undefined,\n          });\n        },\n      });\n\n      if (customBranchPolicyNames) {\n        for (const item of customBranchPolicyNames) {\n          await ctx.checkpoint({\n            key: `create.deployment.branch.policy.branch.${owner}.${repo}.${name}.${item}`,\n            fn: async () => {\n              await client.rest.repos.createDeploymentBranchPolicy({\n                owner: owner,\n                repo: repo,\n                type: 'branch',\n                environment_name: name,\n                name: item,\n              });\n            },\n          });\n        }\n      }\n\n      if (customTagPolicyNames) {\n        for (const item of customTagPolicyNames) {\n          await ctx.checkpoint({\n            key: `create.deployment.branch.policy.tag.${owner}.${repo}.${name}.${item}`,\n            fn: async () => {\n              await client.rest.repos.createDeploymentBranchPolicy({\n                owner: owner,\n                repo: repo,\n                type: 'tag',\n                environment_name: name,\n                name: item,\n              });\n            },\n          });\n        }\n      }\n\n      for (const [key, value] of Object.entries(environmentVariables ?? {})) {\n        await ctx.checkpoint({\n          key: `create.env.variable.${owner}.${repo}.${name}.${key}`,\n          fn: async () => {\n            await client.rest.actions.createEnvironmentVariable({\n              repository_id: repositoryId,\n              owner: owner,\n              repo: repo,\n              environment_name: name,\n              name: key,\n              value,\n            });\n          },\n        });\n      }\n\n      if (secrets) {\n        const { publicKey, publicKeyId } = await ctx.checkpoint({\n          key: `get.env.public.key.${owner}.${repo}.${name}`,\n          fn: async () => {\n            const publicKeyResponse =\n              await client.rest.actions.getEnvironmentPublicKey({\n                repository_id: repositoryId,\n                owner: owner,\n                repo: repo,\n                environment_name: name,\n              });\n            return {\n              publicKey: publicKeyResponse.data.key,\n              publicKeyId: publicKeyResponse.data.key_id,\n            };\n          },\n        });\n\n        await Sodium.ready;\n        const binaryKey = Sodium.from_base64(\n          publicKey,\n          Sodium.base64_variants.ORIGINAL,\n        );\n        for (const [key, value] of Object.entries(secrets)) {\n          const binarySecret = Sodium.from_string(value);\n          const encryptedBinarySecret = Sodium.crypto_box_seal(\n            binarySecret,\n            binaryKey,\n          );\n          const encryptedBase64Secret = Sodium.to_base64(\n            encryptedBinarySecret,\n            Sodium.base64_variants.ORIGINAL,\n          );\n\n          await ctx.checkpoint({\n            key: `create.or.update.env.secret.${owner}.${repo}.${name}.${key}`,\n            fn: async () => {\n              await client.rest.actions.createOrUpdateEnvironmentSecret({\n                repository_id: repositoryId,\n                owner: owner,\n                repo: repo,\n                environment_name: name,\n                secret_name: key,\n                encrypted_value: encryptedBase64Secret,\n                key_id: publicKeyId,\n              });\n            },\n          });\n        }\n      }\n    },\n  });\n}\n"],"names":["createTemplateAction","examples","parseRepoUrl","InputError","getOctokitOptions","Octokit","Sodium"],"mappings":"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"}