{"version":3,"file":"githubDeployKey.cjs.js","sources":["../../src/actions/githubDeployKey.ts"],"sourcesContent":["/*\n * Copyright 2021 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { InputError } from '@backstage/errors';\nimport {\n  createTemplateAction,\n  parseRepoUrl,\n} from '@backstage/plugin-scaffolder-node';\nimport { ScmIntegrationRegistry } from '@backstage/integration';\nimport { getOctokitOptions } from '../util';\nimport { Octokit } from 'octokit';\nimport Sodium from 'libsodium-wrappers';\nimport { examples } from './githubDeployKey.examples';\n\n/**\n * Creates an `github:deployKey:create` Scaffolder action that creates a Deploy Key\n *\n * @public\n */\nexport function createGithubDeployKeyAction(options: {\n  integrations: ScmIntegrationRegistry;\n}) {\n  const { integrations } = options;\n  // For more information on how to define custom actions, see\n  //   https://backstage.io/docs/features/software-templates/writing-custom-actions\n  return createTemplateAction({\n    id: 'github:deployKey:create',\n    description: 'Creates and stores Deploy Keys',\n    examples,\n    schema: {\n      input: {\n        repoUrl: z =>\n          z.string({\n            description:\n              'Accepts the format `github.com?repo=reponame&owner=owner` where `reponame` is the new repository name and `owner` is an organization or username',\n          }),\n        publicKey: z =>\n          z.string({\n            description:\n              'Generated from `ssh-keygen`.  Begins with `ssh-rsa`, `ecdsa-sha2-nistp256`, `ecdsa-sha2-nistp384`, `ecdsa-sha2-nistp521`, `ssh-ed25519`, `sk-ecdsa-sha2-nistp256@openssh.com`, or `sk-ssh-ed25519@openssh.com`.',\n          }),\n        privateKey: z =>\n          z.string({\n            description: 'SSH Private Key generated from `ssh-keygen`',\n          }),\n        deployKeyName: z =>\n          z.string({\n            description: `Name of the Deploy Key`,\n          }),\n        privateKeySecretName: z =>\n          z\n            .string({\n              description:\n                'Name of the GitHub Secret to store the private key related to the Deploy Key.  Defaults to: `KEY_NAME_PRIVATE_KEY` where `KEY_NAME` is the name of the Deploy Key',\n            })\n            .optional(),\n        token: z =>\n          z\n            .string({\n              description: 'The token to use for authorization to GitHub',\n            })\n            .optional(),\n      },\n      output: {\n        privateKeySecretName: z =>\n          z.string({\n            description:\n              'The GitHub Action Repo Secret Name for the Private Key',\n          }),\n      },\n    },\n    async handler(ctx) {\n      const {\n        repoUrl,\n        publicKey,\n        privateKey,\n        deployKeyName,\n        privateKeySecretName = `${deployKeyName\n          .split(' ')\n          .join('_')\n          .toLocaleUpperCase('en-US')}_PRIVATE_KEY`,\n        token: providedToken,\n      } = ctx.input;\n\n      const { host, owner, repo } = parseRepoUrl(repoUrl, integrations);\n\n      if (!owner) {\n        throw new InputError(`No owner provided for repo ${repoUrl}`);\n      }\n\n      const octokitOptions = await getOctokitOptions({\n        integrations,\n        token: providedToken,\n        host,\n        owner,\n        repo,\n      });\n\n      const client = new Octokit({\n        ...octokitOptions,\n        log: ctx.logger,\n      });\n\n      await ctx.checkpoint({\n        key: `create.deploy.key.${owner}.${repo}.${publicKey}`,\n        fn: async () => {\n          await client.rest.repos.createDeployKey({\n            owner: owner,\n            repo: repo,\n            title: deployKeyName,\n            key: publicKey,\n          });\n        },\n      });\n\n      const { key, keyId } = await ctx.checkpoint({\n        key: `get.repo.public.key.${owner}.${repo}`,\n        fn: async () => {\n          const publicKeyResponse = await client.rest.actions.getRepoPublicKey({\n            owner: owner,\n            repo: repo,\n          });\n          return {\n            key: publicKeyResponse.data.key,\n            keyId: publicKeyResponse.data.key_id,\n          };\n        },\n      });\n\n      await Sodium.ready;\n      const binaryKey = Sodium.from_base64(\n        key,\n        Sodium.base64_variants.ORIGINAL,\n      );\n      const binarySecret = Sodium.from_string(privateKey);\n      const encryptedBinarySecret = Sodium.crypto_box_seal(\n        binarySecret,\n        binaryKey,\n      );\n      const encryptedBase64Secret = Sodium.to_base64(\n        encryptedBinarySecret,\n        Sodium.base64_variants.ORIGINAL,\n      );\n\n      await ctx.checkpoint({\n        key: `create.or.update.repo.secret.${owner}.${repo}.${keyId}`,\n        fn: async () => {\n          await client.rest.actions.createOrUpdateRepoSecret({\n            owner: owner,\n            repo: repo,\n            secret_name: privateKeySecretName,\n            encrypted_value: encryptedBase64Secret,\n            key_id: keyId,\n          });\n        },\n      });\n\n      ctx.output('privateKeySecretName', privateKeySecretName);\n    },\n  });\n}\n"],"names":["createTemplateAction","examples","parseRepoUrl","InputError","getOctokitOptions","Octokit","Sodium"],"mappings":"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"}