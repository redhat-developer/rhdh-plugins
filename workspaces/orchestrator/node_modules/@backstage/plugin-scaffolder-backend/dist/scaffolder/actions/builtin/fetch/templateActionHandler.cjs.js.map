{"version":3,"file":"templateActionHandler.cjs.js","sources":["../../../../../src/scaffolder/actions/builtin/fetch/templateActionHandler.ts"],"sourcesContent":["/*\n * Copyright 2025 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport {\n  isChildPath,\n  resolveSafeChildPath,\n} from '@backstage/backend-plugin-api';\nimport { InputError } from '@backstage/errors';\nimport { ScmIntegrations } from '@backstage/integration';\nimport {\n  ActionContext,\n  TemplateFilter,\n  TemplateGlobal,\n} from '@backstage/plugin-scaffolder-node';\nimport fs from 'fs-extra';\nimport globby from 'globby';\nimport { isBinaryFile } from 'isbinaryfile';\nimport { createDefaultFilters } from '../../../../lib/templating/filters/createDefaultFilters';\nimport { convertFiltersToRecord } from '../../../../util/templating';\nimport { SecureTemplater } from '../../../../lib/templating/SecureTemplater';\nimport { extname } from 'path';\n\nexport type TemplateActionInput = {\n  targetPath?: string;\n  values: any;\n  templateFileExtension?: string | boolean;\n  copyWithoutTemplating?: string[];\n  cookiecutterCompat?: boolean;\n  replace?: boolean;\n  trimBlocks?: boolean;\n  lstripBlocks?: boolean;\n};\n\nexport async function createTemplateActionHandler<\n  I extends TemplateActionInput,\n>(options: {\n  ctx: ActionContext<I, any, any>;\n  resolveTemplate: () => Promise<string>;\n  integrations: ScmIntegrations;\n  additionalTemplateFilters?: Record<string, TemplateFilter>;\n  additionalTemplateGlobals?: Record<string, TemplateGlobal>;\n}) {\n  const {\n    resolveTemplate,\n    integrations,\n    additionalTemplateFilters,\n    additionalTemplateGlobals: templateGlobals,\n    ctx,\n  } = options;\n\n  const templateFilters = {\n    ...convertFiltersToRecord(createDefaultFilters({ integrations })),\n    ...additionalTemplateFilters,\n  };\n\n  const { outputDir, copyOnlyPatterns, renderFilename, extension } =\n    resolveTemplateActionSettings(ctx);\n\n  const templateDir = await resolveTemplate();\n\n  if (isChildPath(templateDir, outputDir)) {\n    throw new InputError('targetPath must not be within template path');\n  }\n\n  ctx.logger.info('Listing files and directories in template');\n  const allEntriesInTemplate = await globby(`**/*`, {\n    cwd: templateDir,\n    dot: true,\n    onlyFiles: false,\n    markDirectories: true,\n    followSymbolicLinks: false,\n  });\n\n  const nonTemplatedEntries = new Set(\n    await globby(copyOnlyPatterns || [], {\n      cwd: templateDir,\n      dot: true,\n      onlyFiles: false,\n      markDirectories: true,\n      followSymbolicLinks: false,\n    }),\n  );\n\n  // Cookiecutter prefixes all parameters in templates with\n  // `cookiecutter.`. To replicate this, we wrap our parameters\n  // in an object with a `cookiecutter` property when compat\n  // mode is enabled.\n  const { cookiecutterCompat, values } = ctx.input;\n  const context = {\n    [cookiecutterCompat ? 'cookiecutter' : 'values']: values,\n  };\n\n  ctx.logger.info(\n    `Processing ${allEntriesInTemplate.length} template files/directories with input values`,\n    ctx.input.values,\n  );\n\n  const renderTemplate = await SecureTemplater.loadRenderer({\n    cookiecutterCompat: ctx.input.cookiecutterCompat,\n    templateFilters,\n    templateGlobals,\n    nunjucksConfigs: {\n      trimBlocks: ctx.input.trimBlocks,\n      lstripBlocks: ctx.input.lstripBlocks,\n    },\n  });\n\n  for (const location of allEntriesInTemplate) {\n    let renderContents: boolean;\n\n    let localOutputPath = location;\n    if (extension) {\n      renderContents = extname(localOutputPath) === extension;\n      if (renderContents) {\n        localOutputPath = localOutputPath.slice(0, -extension.length);\n      }\n      // extension is mutual exclusive with copyWithoutRender/copyWithoutTemplating,\n      // therefore the output path is always rendered.\n      localOutputPath = renderTemplate(localOutputPath, context);\n    } else {\n      renderContents = !nonTemplatedEntries.has(location);\n      // The logic here is a bit tangled because it depends on two variables.\n      // If renderFilename is true, which means copyWithoutTemplating is used,\n      // then the path is always rendered.\n      // If renderFilename is false, which means copyWithoutRender is used,\n      // then matched file/directory won't be processed, same as before.\n      if (renderFilename) {\n        localOutputPath = renderTemplate(localOutputPath, context);\n      } else {\n        localOutputPath = renderContents\n          ? renderTemplate(localOutputPath, context)\n          : localOutputPath;\n      }\n    }\n\n    if (containsSkippedContent(localOutputPath)) {\n      continue;\n    }\n\n    const outputPath = resolveSafeChildPath(outputDir, localOutputPath);\n    if (fs.existsSync(outputPath) && !ctx.input.replace) {\n      continue;\n    }\n\n    if (!renderContents && !extension) {\n      ctx.logger.info(`Copying file/directory ${location} without processing.`);\n    }\n\n    if (location.endsWith('/')) {\n      ctx.logger.info(`Writing directory ${location} to template output path.`);\n      await fs.ensureDir(outputPath);\n    } else {\n      const inputFilePath = resolveSafeChildPath(templateDir, location);\n      const stats = await fs.promises.lstat(inputFilePath);\n\n      if (stats.isSymbolicLink() || (await isBinaryFile(inputFilePath))) {\n        ctx.logger.info(\n          `Copying file binary or symbolic link at ${location}, to template output path.`,\n        );\n        await fs.copy(inputFilePath, outputPath);\n      } else {\n        const statsObj = await fs.stat(inputFilePath);\n        ctx.logger.info(\n          `Writing file ${location} to template output path with mode ${statsObj.mode}.`,\n        );\n        const inputFileContents = await fs.readFile(inputFilePath, 'utf-8');\n        await fs.outputFile(\n          outputPath,\n          renderContents\n            ? renderTemplate(inputFileContents, context)\n            : inputFileContents,\n          { mode: statsObj.mode },\n        );\n      }\n    }\n  }\n  ctx.logger.info(`Template result written to ${outputDir}`);\n}\n\nfunction resolveTemplateActionSettings<I extends TemplateActionInput>(\n  ctx: ActionContext<I, any, any>,\n): {\n  outputDir: string;\n  copyOnlyPatterns?: string[];\n  renderFilename: boolean;\n  extension: string | false;\n} {\n  const targetPath = ctx.input.targetPath ?? './';\n  const outputDir = resolveSafeChildPath(ctx.workspacePath, targetPath);\n\n  const copyOnlyPatterns = ctx.input.copyWithoutTemplating;\n  const renderFilename = true;\n\n  if (copyOnlyPatterns && !Array.isArray(copyOnlyPatterns)) {\n    throw new InputError(\n      'Fetch action input copyWithoutTemplating must be an Array',\n    );\n  }\n  if (\n    ctx.input.templateFileExtension &&\n    (copyOnlyPatterns || ctx.input.cookiecutterCompat)\n  ) {\n    throw new InputError(\n      'Fetch action input extension incompatible with copyWithoutTemplating and cookiecutterCompat',\n    );\n  }\n  let extension: string | false = false;\n  if (ctx.input.templateFileExtension) {\n    extension =\n      ctx.input.templateFileExtension === true\n        ? '.njk'\n        : ctx.input.templateFileExtension;\n    if (!extension.startsWith('.')) {\n      extension = `.${extension}`;\n    }\n  }\n  return {\n    outputDir,\n    copyOnlyPatterns,\n    renderFilename,\n    extension,\n  };\n}\n\nfunction containsSkippedContent(localOutputPath: string): boolean {\n  // if the path is empty means that there is a file skipped in the root\n  // if the path starts with a separator it means that the root directory has been skipped\n  // if the path includes // means that there is a subdirectory skipped\n  // All paths returned are considered with / separator because of globby returning the linux separator for all os'.\n  return (\n    localOutputPath === '' ||\n    localOutputPath.startsWith('/') ||\n    localOutputPath.includes('//')\n  );\n}\n"],"names":["convertFiltersToRecord","createDefaultFilters","isChildPath","InputError","globby","SecureTemplater","extname","resolveSafeChildPath","fs","isBinaryFile"],"mappings":";;;;;;;;;;;;;;;;;AA6CA,eAAsB,4BAEpB,OAAA,EAMC;AACD,EAAA,MAAM;AAAA,IACJ,eAAA;AAAA,IACA,YAAA;AAAA,IACA,yBAAA;AAAA,IACA,yBAAA,EAA2B,eAAA;AAAA,IAC3B;AAAA,GACF,GAAI,OAAA;AAEJ,EAAA,MAAM,eAAA,GAAkB;AAAA,IACtB,GAAGA,iCAAA,CAAuBC,yCAAA,CAAqB,EAAE,YAAA,EAAc,CAAC,CAAA;AAAA,IAChE,GAAG;AAAA,GACL;AAEA,EAAA,MAAM,EAAE,SAAA,EAAW,gBAAA,EAAkB,gBAAgB,SAAA,EAAU,GAC7D,8BAA8B,GAAG,CAAA;AAEnC,EAAA,MAAM,WAAA,GAAc,MAAM,eAAA,EAAgB;AAE1C,EAAA,IAAIC,4BAAA,CAAY,WAAA,EAAa,SAAS,CAAA,EAAG;AACvC,IAAA,MAAM,IAAIC,kBAAW,6CAA6C,CAAA;AAAA,EACpE;AAEA,EAAA,GAAA,CAAI,MAAA,CAAO,KAAK,2CAA2C,CAAA;AAC3D,EAAA,MAAM,oBAAA,GAAuB,MAAMC,uBAAA,CAAO,CAAA,IAAA,CAAA,EAAQ;AAAA,IAChD,GAAA,EAAK,WAAA;AAAA,IACL,GAAA,EAAK,IAAA;AAAA,IACL,SAAA,EAAW,KAAA;AAAA,IACX,eAAA,EAAiB,IAAA;AAAA,IACjB,mBAAA,EAAqB;AAAA,GACtB,CAAA;AAED,EAAA,MAAM,sBAAsB,IAAI,GAAA;AAAA,IAC9B,MAAMA,uBAAA,CAAO,gBAAA,IAAoB,EAAC,EAAG;AAAA,MACnC,GAAA,EAAK,WAAA;AAAA,MACL,GAAA,EAAK,IAAA;AAAA,MACL,SAAA,EAAW,KAAA;AAAA,MACX,eAAA,EAAiB,IAAA;AAAA,MACjB,mBAAA,EAAqB;AAAA,KACtB;AAAA,GACH;AAMA,EAAA,MAAM,EAAE,kBAAA,EAAoB,MAAA,EAAO,GAAI,GAAA,CAAI,KAAA;AAC3C,EAAA,MAAM,OAAA,GAAU;AAAA,IACd,CAAC,kBAAA,GAAqB,cAAA,GAAiB,QAAQ,GAAG;AAAA,GACpD;AAEA,EAAA,GAAA,CAAI,MAAA,CAAO,IAAA;AAAA,IACT,CAAA,WAAA,EAAc,qBAAqB,MAAM,CAAA,6CAAA,CAAA;AAAA,IACzC,IAAI,KAAA,CAAM;AAAA,GACZ;AAEA,EAAA,MAAM,cAAA,GAAiB,MAAMC,+BAAA,CAAgB,YAAA,CAAa;AAAA,IACxD,kBAAA,EAAoB,IAAI,KAAA,CAAM,kBAAA;AAAA,IAC9B,eAAA;AAAA,IACA,eAAA;AAAA,IACA,eAAA,EAAiB;AAAA,MACf,UAAA,EAAY,IAAI,KAAA,CAAM,UAAA;AAAA,MACtB,YAAA,EAAc,IAAI,KAAA,CAAM;AAAA;AAC1B,GACD,CAAA;AAED,EAAA,KAAA,MAAW,YAAY,oBAAA,EAAsB;AAC3C,IAAA,IAAI,cAAA;AAEJ,IAAA,IAAI,eAAA,GAAkB,QAAA;AACtB,IAAA,IAAI,SAAA,EAAW;AACb,MAAA,cAAA,GAAiBC,YAAA,CAAQ,eAAe,CAAA,KAAM,SAAA;AAC9C,MAAA,IAAI,cAAA,EAAgB;AAClB,QAAA,eAAA,GAAkB,eAAA,CAAgB,KAAA,CAAM,CAAA,EAAG,CAAC,UAAU,MAAM,CAAA;AAAA,MAC9D;AAGA,MAAA,eAAA,GAAkB,cAAA,CAAe,iBAAiB,OAAO,CAAA;AAAA,IAC3D,CAAA,MAAO;AACL,MAAA,cAAA,GAAiB,CAAC,mBAAA,CAAoB,GAAA,CAAI,QAAQ,CAAA;AAMlD,MAAA,IAAI,cAAA,EAAgB;AAClB,QAAA,eAAA,GAAkB,cAAA,CAAe,iBAAiB,OAAO,CAAA;AAAA,MAC3D,CAAA,MAAO;AACL,QAAA,eAAA,GAAkB,cAAA,GACd,cAAA,CAAe,eAAA,EAAiB,OAAO,CAAA,GACvC,eAAA;AAAA,MACN;AAAA,IACF;AAEA,IAAA,IAAI,sBAAA,CAAuB,eAAe,CAAA,EAAG;AAC3C,MAAA;AAAA,IACF;AAEA,IAAA,MAAM,UAAA,GAAaC,qCAAA,CAAqB,SAAA,EAAW,eAAe,CAAA;AAClE,IAAA,IAAIC,oBAAG,UAAA,CAAW,UAAU,KAAK,CAAC,GAAA,CAAI,MAAM,OAAA,EAAS;AACnD,MAAA;AAAA,IACF;AAEA,IAAA,IAAI,CAAC,cAAA,IAAkB,CAAC,SAAA,EAAW;AACjC,MAAA,GAAA,CAAI,MAAA,CAAO,IAAA,CAAK,CAAA,uBAAA,EAA0B,QAAQ,CAAA,oBAAA,CAAsB,CAAA;AAAA,IAC1E;AAEA,IAAA,IAAI,QAAA,CAAS,QAAA,CAAS,GAAG,CAAA,EAAG;AAC1B,MAAA,GAAA,CAAI,MAAA,CAAO,IAAA,CAAK,CAAA,kBAAA,EAAqB,QAAQ,CAAA,yBAAA,CAA2B,CAAA;AACxE,MAAA,MAAMA,mBAAA,CAAG,UAAU,UAAU,CAAA;AAAA,IAC/B,CAAA,MAAO;AACL,MAAA,MAAM,aAAA,GAAgBD,qCAAA,CAAqB,WAAA,EAAa,QAAQ,CAAA;AAChE,MAAA,MAAM,KAAA,GAAQ,MAAMC,mBAAA,CAAG,QAAA,CAAS,MAAM,aAAa,CAAA;AAEnD,MAAA,IAAI,MAAM,cAAA,EAAe,IAAM,MAAMC,yBAAA,CAAa,aAAa,CAAA,EAAI;AACjE,QAAA,GAAA,CAAI,MAAA,CAAO,IAAA;AAAA,UACT,2CAA2C,QAAQ,CAAA,0BAAA;AAAA,SACrD;AACA,QAAA,MAAMD,mBAAA,CAAG,IAAA,CAAK,aAAA,EAAe,UAAU,CAAA;AAAA,MACzC,CAAA,MAAO;AACL,QAAA,MAAM,QAAA,GAAW,MAAMA,mBAAA,CAAG,IAAA,CAAK,aAAa,CAAA;AAC5C,QAAA,GAAA,CAAI,MAAA,CAAO,IAAA;AAAA,UACT,CAAA,aAAA,EAAgB,QAAQ,CAAA,mCAAA,EAAsC,QAAA,CAAS,IAAI,CAAA,CAAA;AAAA,SAC7E;AACA,QAAA,MAAM,iBAAA,GAAoB,MAAMA,mBAAA,CAAG,QAAA,CAAS,eAAe,OAAO,CAAA;AAClE,QAAA,MAAMA,mBAAA,CAAG,UAAA;AAAA,UACP,UAAA;AAAA,UACA,cAAA,GACI,cAAA,CAAe,iBAAA,EAAmB,OAAO,CAAA,GACzC,iBAAA;AAAA,UACJ,EAAE,IAAA,EAAM,QAAA,CAAS,IAAA;AAAK,SACxB;AAAA,MACF;AAAA,IACF;AAAA,EACF;AACA,EAAA,GAAA,CAAI,MAAA,CAAO,IAAA,CAAK,CAAA,2BAAA,EAA8B,SAAS,CAAA,CAAE,CAAA;AAC3D;AAEA,SAAS,8BACP,GAAA,EAMA;AACA,EAAA,MAAM,UAAA,GAAa,GAAA,CAAI,KAAA,CAAM,UAAA,IAAc,IAAA;AAC3C,EAAA,MAAM,SAAA,GAAYD,qCAAA,CAAqB,GAAA,CAAI,aAAA,EAAe,UAAU,CAAA;AAEpE,EAAA,MAAM,gBAAA,GAAmB,IAAI,KAAA,CAAM,qBAAA;AACnC,EAAA,MAAM,cAAA,GAAiB,IAAA;AAEvB,EAAA,IAAI,gBAAA,IAAoB,CAAC,KAAA,CAAM,OAAA,CAAQ,gBAAgB,CAAA,EAAG;AACxD,IAAA,MAAM,IAAIJ,iBAAA;AAAA,MACR;AAAA,KACF;AAAA,EACF;AACA,EAAA,IACE,IAAI,KAAA,CAAM,qBAAA,KACT,gBAAA,IAAoB,GAAA,CAAI,MAAM,kBAAA,CAAA,EAC/B;AACA,IAAA,MAAM,IAAIA,iBAAA;AAAA,MACR;AAAA,KACF;AAAA,EACF;AACA,EAAA,IAAI,SAAA,GAA4B,KAAA;AAChC,EAAA,IAAI,GAAA,CAAI,MAAM,qBAAA,EAAuB;AACnC,IAAA,SAAA,GACE,IAAI,KAAA,CAAM,qBAAA,KAA0B,IAAA,GAChC,MAAA,GACA,IAAI,KAAA,CAAM,qBAAA;AAChB,IAAA,IAAI,CAAC,SAAA,CAAU,UAAA,CAAW,GAAG,CAAA,EAAG;AAC9B,MAAA,SAAA,GAAY,IAAI,SAAS,CAAA,CAAA;AAAA,IAC3B;AAAA,EACF;AACA,EAAA,OAAO;AAAA,IACL,SAAA;AAAA,IACA,gBAAA;AAAA,IACA,cAAA;AAAA,IACA;AAAA,GACF;AACF;AAEA,SAAS,uBAAuB,eAAA,EAAkC;AAKhE,EAAA,OACE,eAAA,KAAoB,MACpB,eAAA,CAAgB,UAAA,CAAW,GAAG,CAAA,IAC9B,eAAA,CAAgB,SAAS,IAAI,CAAA;AAEjC;;;;"}