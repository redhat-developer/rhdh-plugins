{"version":3,"file":"wait.cjs.js","sources":["../../../../../src/scaffolder/actions/builtin/debug/wait.ts"],"sourcesContent":["/*\n * Copyright 2021 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { createTemplateAction } from '@backstage/plugin-scaffolder-node';\nimport { HumanDuration } from '@backstage/types';\nimport { Duration } from 'luxon';\nimport { examples } from './wait.examples';\n\nconst id = 'debug:wait';\n\nconst MAX_WAIT_TIME_IN_ISO = 'T00:10:00';\n\n/**\n * Waits for a certain period of time.\n *\n * @remarks\n *\n * This task is useful to give some waiting time for manual intervention.\n * Has to be used in a combination with other actions.\n *\n * @public\n */\nexport function createWaitAction(options?: {\n  maxWaitTime?: Duration | HumanDuration;\n}) {\n  const toDuration = (\n    maxWaitTime: Duration | HumanDuration | undefined,\n  ): Duration => {\n    if (maxWaitTime) {\n      if (maxWaitTime instanceof Duration) {\n        return maxWaitTime;\n      }\n      return Duration.fromObject(maxWaitTime);\n    }\n    return Duration.fromISOTime(MAX_WAIT_TIME_IN_ISO);\n  };\n\n  return createTemplateAction({\n    id,\n    description: 'Waits for a certain period of time.',\n    examples,\n    schema: {\n      input: {\n        minutes: z =>\n          z\n            .number({\n              description: 'Waiting period in minutes.',\n            })\n            .optional(),\n        seconds: z =>\n          z\n            .number({\n              description: 'Waiting period in seconds.',\n            })\n            .optional(),\n        milliseconds: z =>\n          z\n            .number({\n              description: 'Waiting period in milliseconds.',\n            })\n            .optional(),\n      },\n    },\n    async handler(ctx) {\n      const delayTime = Duration.fromObject(ctx.input);\n      const maxWait = toDuration(options?.maxWaitTime);\n\n      if (delayTime.minus(maxWait).toMillis() > 0) {\n        throw new Error(\n          `Waiting duration is longer than the maximum threshold of ${maxWait.toHuman()}`,\n        );\n      }\n\n      await new Promise(resolve => {\n        const controller = new AbortController();\n        const timeoutHandle = setTimeout(abort, delayTime.toMillis());\n        ctx.signal?.addEventListener('abort', abort);\n\n        function abort() {\n          ctx.signal?.removeEventListener('abort', abort);\n          clearTimeout(timeoutHandle!);\n          controller.abort();\n          resolve('finished');\n        }\n      });\n    },\n  });\n}\n"],"names":["Duration","createTemplateAction","examples"],"mappings":";;;;;;AAqBA,MAAM,EAAA,GAAK,YAAA;AAEX,MAAM,oBAAA,GAAuB,WAAA;AAYtB,SAAS,iBAAiB,OAAA,EAE9B;AACD,EAAA,MAAM,UAAA,GAAa,CACjB,WAAA,KACa;AACb,IAAA,IAAI,WAAA,EAAa;AACf,MAAA,IAAI,uBAAuBA,cAAA,EAAU;AACnC,QAAA,OAAO,WAAA;AAAA,MACT;AACA,MAAA,OAAOA,cAAA,CAAS,WAAW,WAAW,CAAA;AAAA,IACxC;AACA,IAAA,OAAOA,cAAA,CAAS,YAAY,oBAAoB,CAAA;AAAA,EAClD,CAAA;AAEA,EAAA,OAAOC,yCAAA,CAAqB;AAAA,IAC1B,EAAA;AAAA,IACA,WAAA,EAAa,qCAAA;AAAA,cACbC,sBAAA;AAAA,IACA,MAAA,EAAQ;AAAA,MACN,KAAA,EAAO;AAAA,QACL,OAAA,EAAS,CAAA,CAAA,KACP,CAAA,CACG,MAAA,CAAO;AAAA,UACN,WAAA,EAAa;AAAA,SACd,EACA,QAAA,EAAS;AAAA,QACd,OAAA,EAAS,CAAA,CAAA,KACP,CAAA,CACG,MAAA,CAAO;AAAA,UACN,WAAA,EAAa;AAAA,SACd,EACA,QAAA,EAAS;AAAA,QACd,YAAA,EAAc,CAAA,CAAA,KACZ,CAAA,CACG,MAAA,CAAO;AAAA,UACN,WAAA,EAAa;AAAA,SACd,EACA,QAAA;AAAS;AAChB,KACF;AAAA,IACA,MAAM,QAAQ,GAAA,EAAK;AACjB,MAAA,MAAM,SAAA,GAAYF,cAAA,CAAS,UAAA,CAAW,GAAA,CAAI,KAAK,CAAA;AAC/C,MAAA,MAAM,OAAA,GAAU,UAAA,CAAW,OAAA,EAAS,WAAW,CAAA;AAE/C,MAAA,IAAI,UAAU,KAAA,CAAM,OAAO,CAAA,CAAE,QAAA,KAAa,CAAA,EAAG;AAC3C,QAAA,MAAM,IAAI,KAAA;AAAA,UACR,CAAA,yDAAA,EAA4D,OAAA,CAAQ,OAAA,EAAS,CAAA;AAAA,SAC/E;AAAA,MACF;AAEA,MAAA,MAAM,IAAI,QAAQ,CAAA,OAAA,KAAW;AAC3B,QAAA,MAAM,UAAA,GAAa,IAAI,eAAA,EAAgB;AACvC,QAAA,MAAM,aAAA,GAAgB,UAAA,CAAW,KAAA,EAAO,SAAA,CAAU,UAAU,CAAA;AAC5D,QAAA,GAAA,CAAI,MAAA,EAAQ,gBAAA,CAAiB,OAAA,EAAS,KAAK,CAAA;AAE3C,QAAA,SAAS,KAAA,GAAQ;AACf,UAAA,GAAA,CAAI,MAAA,EAAQ,mBAAA,CAAoB,OAAA,EAAS,KAAK,CAAA;AAC9C,UAAA,YAAA,CAAa,aAAc,CAAA;AAC3B,UAAA,UAAA,CAAW,KAAA,EAAM;AACjB,UAAA,OAAA,CAAQ,UAAU,CAAA;AAAA,QACpB;AAAA,MACF,CAAC,CAAA;AAAA,IACH;AAAA,GACD,CAAA;AACH;;;;"}