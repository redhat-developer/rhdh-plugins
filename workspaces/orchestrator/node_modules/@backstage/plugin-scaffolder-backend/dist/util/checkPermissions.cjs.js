'use strict';

var errors = require('@backstage/errors');
var pluginPermissionCommon = require('@backstage/plugin-permission-common');

async function checkPermission(options) {
  const { permissions, permissionService, credentials } = options;
  if (permissionService) {
    const permissionRequest = permissions.map((permission) => ({
      permission
    }));
    const authorizationResponses = await permissionService.authorize(
      permissionRequest,
      { credentials }
    );
    for (const response of authorizationResponses) {
      if (response.result === pluginPermissionCommon.AuthorizeResult.DENY) {
        throw new errors.NotAllowedError();
      }
    }
  }
}
async function checkTaskPermission(options) {
  const {
    permissions,
    permissionService,
    credentials,
    task,
    isTaskAuthorized
  } = options;
  if (permissionService) {
    const permissionRequest = permissions.map((permission) => ({
      permission
    }));
    const authorizationResponses = await permissionService.authorizeConditional(
      permissionRequest,
      { credentials }
    );
    for (const response of authorizationResponses) {
      if (response.result === pluginPermissionCommon.AuthorizeResult.DENY || !isTaskAuthorized(response, task)) {
        throw new errors.NotAllowedError();
      }
    }
  }
}
const getAuthorizeConditions = async (options) => {
  const { permission, permissionService, credentials, transformConditions } = options;
  if (permissionService) {
    const [taskDecision] = await permissionService.authorizeConditional(
      [{ permission }],
      { credentials }
    );
    if (taskDecision.result === pluginPermissionCommon.AuthorizeResult.CONDITIONAL) {
      return transformConditions(taskDecision.conditions);
    }
  }
  return void 0;
};

exports.checkPermission = checkPermission;
exports.checkTaskPermission = checkTaskPermission;
exports.getAuthorizeConditions = getAuthorizeConditions;
//# sourceMappingURL=checkPermissions.cjs.js.map
