{"version":3,"file":"TestCaches.cjs.js","sources":["../../src/cache/TestCaches.ts"],"sourcesContent":["/*\n * Copyright 2024 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport Keyv from 'keyv';\nimport { isDockerDisabledForTests } from '../util/isDockerDisabledForTests';\nimport { connectToExternalMemcache, startMemcachedContainer } from './memcache';\nimport { connectToExternalRedis, startRedisContainer } from './redis';\nimport { Instance, TestCacheId, TestCacheProperties, allCaches } from './types';\nimport { connectToExternalValkey, startValkeyContainer } from './valkey';\n\n/**\n * Encapsulates the creation of ephemeral test cache instances for use inside\n * unit or integration tests.\n *\n * @public\n */\nexport class TestCaches {\n  private readonly instanceById: Map<string, Instance>;\n  private readonly supportedIds: TestCacheId[];\n  private static defaultIds?: TestCacheId[];\n\n  /**\n   * Creates an empty `TestCaches` instance, and sets up Jest to clean up all of\n   * its acquired resources after all tests finish.\n   *\n   * You typically want to create just a single instance like this at the top of\n   * your test file or `describe` block, and then call `init` many times on that\n   * instance inside the individual tests. Spinning up a \"physical\" cache\n   * instance takes a considerable amount of time, slowing down tests. But\n   * wiping the contents of an instance using `init` is very fast.\n   */\n  static create(options?: {\n    ids?: TestCacheId[];\n    disableDocker?: boolean;\n  }): TestCaches {\n    const ids = options?.ids;\n    const disableDocker = options?.disableDocker ?? isDockerDisabledForTests();\n\n    let testCacheIds: TestCacheId[];\n    if (ids) {\n      testCacheIds = ids;\n    } else if (TestCaches.defaultIds) {\n      testCacheIds = TestCaches.defaultIds;\n    } else {\n      testCacheIds = Object.keys(allCaches) as TestCacheId[];\n    }\n\n    const supportedIds = testCacheIds.filter(id => {\n      const properties = allCaches[id];\n      if (!properties) {\n        return false;\n      }\n      // If the caller has set up the env with an explicit connection string,\n      // we'll assume that this target will work\n      if (\n        properties.connectionStringEnvironmentVariableName &&\n        process.env[properties.connectionStringEnvironmentVariableName]\n      ) {\n        return true;\n      }\n      // If the cache doesn't require docker at all, there's nothing to worry\n      // about\n      if (!properties.dockerImageName) {\n        return true;\n      }\n      // If the cache requires docker, but docker is disabled, we will fail.\n      if (disableDocker) {\n        return false;\n      }\n      return true;\n    });\n\n    const caches = new TestCaches(supportedIds);\n\n    if (supportedIds.length > 0) {\n      afterAll(async () => {\n        await caches.shutdown();\n      });\n    }\n\n    return caches;\n  }\n\n  static setDefaults(options: { ids?: TestCacheId[] }) {\n    TestCaches.defaultIds = options.ids;\n  }\n\n  private constructor(supportedIds: TestCacheId[]) {\n    this.instanceById = new Map();\n    this.supportedIds = supportedIds;\n  }\n\n  supports(id: TestCacheId): boolean {\n    return this.supportedIds.includes(id);\n  }\n\n  eachSupportedId(): [TestCacheId][] {\n    return this.supportedIds.map(id => [id]);\n  }\n\n  /**\n   * Returns a fresh, empty cache for the given driver.\n   *\n   * @param id - The ID of the cache to use, e.g. 'REDIS_7'\n   * @returns Cache connection properties\n   */\n  async init(\n    id: TestCacheId,\n  ): Promise<{ store: string; connection: string; keyv: Keyv }> {\n    const properties = allCaches[id];\n    if (!properties) {\n      const candidates = Object.keys(allCaches).join(', ');\n      throw new Error(\n        `Unknown test cache ${id}, possible values are ${candidates}`,\n      );\n    }\n    if (!this.supportedIds.includes(id)) {\n      const candidates = this.supportedIds.join(', ');\n      throw new Error(\n        `Unsupported test cache ${id} for this environment, possible values are ${candidates}`,\n      );\n    }\n\n    // Ensure that a testcontainers instance is up for this ID\n    let instance: Instance | undefined = this.instanceById.get(id);\n    if (!instance) {\n      instance = await this.initAny(properties);\n      this.instanceById.set(id, instance);\n    }\n\n    // Ensure that it's cleared of data from previous tests\n    await instance.keyv.clear();\n\n    return {\n      store: instance.store,\n      connection: instance.connection,\n      keyv: instance.keyv,\n    };\n  }\n\n  private async initAny(properties: TestCacheProperties): Promise<Instance> {\n    switch (properties.store) {\n      case 'memcache':\n        return this.initMemcached(properties);\n      case 'redis':\n        return this.initRedis(properties);\n      case 'valkey':\n        return this.initValkey(properties);\n      case 'memory':\n        return {\n          store: 'memory',\n          connection: 'memory',\n          keyv: new Keyv(),\n          stop: async () => {},\n        };\n      default:\n        throw new Error(`Unknown cache store '${properties.store}'`);\n    }\n  }\n\n  private async initMemcached(\n    properties: TestCacheProperties,\n  ): Promise<Instance> {\n    // Use the connection string if provided\n    const envVarName = properties.connectionStringEnvironmentVariableName;\n    if (envVarName) {\n      const connectionString = process.env[envVarName];\n      if (connectionString) {\n        return connectToExternalMemcache(connectionString);\n      }\n    }\n\n    return await startMemcachedContainer(properties.dockerImageName!);\n  }\n\n  private async initRedis(properties: TestCacheProperties): Promise<Instance> {\n    // Use the connection string if provided\n    const envVarName = properties.connectionStringEnvironmentVariableName;\n    if (envVarName) {\n      const connectionString = process.env[envVarName];\n      if (connectionString) {\n        return connectToExternalRedis(connectionString);\n      }\n    }\n\n    return await startRedisContainer(properties.dockerImageName!);\n  }\n\n  private async initValkey(properties: TestCacheProperties): Promise<Instance> {\n    // Use the connection string if provided\n    const envVarName = properties.connectionStringEnvironmentVariableName;\n    if (envVarName) {\n      const connectionString = process.env[envVarName];\n      if (connectionString) {\n        return connectToExternalValkey(connectionString);\n      }\n    }\n\n    return await startValkeyContainer(properties.dockerImageName!);\n  }\n\n  private async shutdown() {\n    const instances = [...this.instanceById.values()];\n    this.instanceById.clear();\n    await Promise.all(\n      instances.map(({ stop }) =>\n        stop().catch(error => {\n          console.warn(`TestCaches: Failed to stop container`, { error });\n        }),\n      ),\n    );\n  }\n}\n"],"names":["isDockerDisabledForTests","allCaches","Keyv","connectToExternalMemcache","startMemcachedContainer","connectToExternalRedis","startRedisContainer","connectToExternalValkey","startValkeyContainer"],"mappings":"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"}