{"version":3,"file":"sqlite.cjs.js","sources":["../../src/database/sqlite.ts"],"sourcesContent":["/*\n * Copyright 2024 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport knexFactory, { Knex } from 'knex';\nimport { Engine, TestDatabaseProperties } from './types';\n\nexport class SqliteEngine implements Engine {\n  static async create(\n    properties: TestDatabaseProperties,\n  ): Promise<SqliteEngine> {\n    return new SqliteEngine(properties);\n  }\n\n  readonly #properties: TestDatabaseProperties;\n  readonly #instances: Knex[];\n\n  constructor(properties: TestDatabaseProperties) {\n    this.#properties = properties;\n    this.#instances = [];\n  }\n\n  async createDatabaseInstance(): Promise<Knex> {\n    const instance = knexFactory({\n      client: this.#properties.driver,\n      connection: ':memory:',\n      useNullAsDefault: true,\n    });\n\n    instance.client.pool.on('createSuccess', (_eventId: any, resource: any) => {\n      resource.run('PRAGMA foreign_keys = ON', () => {});\n    });\n\n    this.#instances.push(instance);\n    return instance;\n  }\n\n  async shutdown(): Promise<void> {\n    for (const instance of this.#instances) {\n      await instance.destroy();\n    }\n  }\n}\n"],"names":["knexFactory"],"mappings":";;;;;;;;AAmBO,MAAM,YAAA,CAA+B;AAAA,EAC1C,aAAa,OACX,UAAA,EACuB;AACvB,IAAA,OAAO,IAAI,aAAa,UAAU,CAAA;AAAA,EACpC;AAAA,EAES,WAAA;AAAA,EACA,UAAA;AAAA,EAET,YAAY,UAAA,EAAoC;AAC9C,IAAA,IAAA,CAAK,WAAA,GAAc,UAAA;AACnB,IAAA,IAAA,CAAK,aAAa,EAAC;AAAA,EACrB;AAAA,EAEA,MAAM,sBAAA,GAAwC;AAC5C,IAAA,MAAM,WAAWA,4BAAA,CAAY;AAAA,MAC3B,MAAA,EAAQ,KAAK,WAAA,CAAY,MAAA;AAAA,MACzB,UAAA,EAAY,UAAA;AAAA,MACZ,gBAAA,EAAkB;AAAA,KACnB,CAAA;AAED,IAAA,QAAA,CAAS,OAAO,IAAA,CAAK,EAAA,CAAG,eAAA,EAAiB,CAAC,UAAe,QAAA,KAAkB;AACzE,MAAA,QAAA,CAAS,GAAA,CAAI,4BAA4B,MAAM;AAAA,MAAC,CAAC,CAAA;AAAA,IACnD,CAAC,CAAA;AAED,IAAA,IAAA,CAAK,UAAA,CAAW,KAAK,QAAQ,CAAA;AAC7B,IAAA,OAAO,QAAA;AAAA,EACT;AAAA,EAEA,MAAM,QAAA,GAA0B;AAC9B,IAAA,KAAA,MAAW,QAAA,IAAY,KAAK,UAAA,EAAY;AACtC,MAAA,MAAM,SAAS,OAAA,EAAQ;AAAA,IACzB;AAAA,EACF;AACF;;;;"}