{"version":3,"file":"MockHttpAuthService.cjs.js","sources":["../../src/services/MockHttpAuthService.ts"],"sourcesContent":["/*\n * Copyright 2024 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  AuthService,\n  BackstageCredentials,\n  BackstagePrincipalTypes,\n  BackstageUserPrincipal,\n  HttpAuthService,\n} from '@backstage/backend-plugin-api';\nimport { Request, Response } from 'express';\nimport { parse as parseCookie } from 'cookie';\nimport { MockAuthService } from './MockAuthService';\nimport { AuthenticationError, NotAllowedError } from '@backstage/errors';\nimport {\n  MOCK_NONE_TOKEN,\n  MOCK_AUTH_COOKIE,\n  mockCredentials,\n} from './mockCredentials';\n\n// TODO: support mock cookie auth?\nexport class MockHttpAuthService implements HttpAuthService {\n  #auth: AuthService;\n  #defaultCredentials: BackstageCredentials;\n\n  constructor(pluginId: string, defaultCredentials: BackstageCredentials) {\n    this.#auth = new MockAuthService({\n      pluginId,\n      disableDefaultAuthPolicy: false,\n    });\n    this.#defaultCredentials = defaultCredentials;\n  }\n\n  async #getCredentials(req: Request, allowLimitedAccess: boolean) {\n    const header = req.headers.authorization;\n    const token =\n      typeof header === 'string'\n        ? header.match(/^Bearer[ ]+(\\S+)$/i)?.[1]\n        : undefined;\n\n    if (token) {\n      if (token === MOCK_NONE_TOKEN) {\n        return this.#auth.getNoneCredentials();\n      }\n\n      return await this.#auth.authenticate(token, {\n        allowLimitedAccess,\n      });\n    }\n\n    if (allowLimitedAccess) {\n      const cookieHeader = req.headers.cookie;\n\n      if (cookieHeader) {\n        const cookies = parseCookie(cookieHeader);\n        const cookie = cookies[MOCK_AUTH_COOKIE];\n\n        if (cookie) {\n          return await this.#auth.authenticate(cookie, {\n            allowLimitedAccess: true,\n          });\n        }\n      }\n    }\n\n    return this.#defaultCredentials;\n  }\n\n  async credentials<TAllowed extends keyof BackstagePrincipalTypes = 'unknown'>(\n    req: Request,\n    options?: {\n      allow?: Array<TAllowed>;\n      allowLimitedAccess?: boolean;\n    },\n  ): Promise<BackstageCredentials<BackstagePrincipalTypes[TAllowed]>> {\n    const credentials = await this.#getCredentials(\n      req,\n      options?.allowLimitedAccess ?? false,\n    );\n\n    const allowedPrincipalTypes = options?.allow;\n    if (!allowedPrincipalTypes) {\n      return credentials as any;\n    }\n\n    if (this.#auth.isPrincipal(credentials, 'none')) {\n      if (allowedPrincipalTypes.includes('none' as TAllowed)) {\n        return credentials as any;\n      }\n\n      throw new AuthenticationError('Missing credentials');\n    } else if (this.#auth.isPrincipal(credentials, 'user')) {\n      if (allowedPrincipalTypes.includes('user' as TAllowed)) {\n        return credentials as any;\n      }\n\n      throw new NotAllowedError(\n        `This endpoint does not allow 'user' credentials`,\n      );\n    } else if (this.#auth.isPrincipal(credentials, 'service')) {\n      if (allowedPrincipalTypes.includes('service' as TAllowed)) {\n        return credentials as any;\n      }\n\n      throw new NotAllowedError(\n        `This endpoint does not allow 'service' credentials`,\n      );\n    }\n\n    throw new NotAllowedError(\n      'Unknown principal type, this should never happen',\n    );\n  }\n\n  async issueUserCookie(\n    res: Response,\n    options?: { credentials?: BackstageCredentials<BackstageUserPrincipal> },\n  ): Promise<{ expiresAt: Date }> {\n    const credentials =\n      options?.credentials ??\n      (await this.credentials(res.req, { allow: ['user'] }));\n\n    res.setHeader(\n      'Set-Cookie',\n      mockCredentials.limitedUser.cookie(credentials.principal.userEntityRef),\n    );\n\n    return { expiresAt: new Date(Date.now() + 3600_000) };\n  }\n}\n"],"names":["MockAuthService","MOCK_NONE_TOKEN","parseCookie","cookie","MOCK_AUTH_COOKIE","AuthenticationError","NotAllowedError","mockCredentials"],"mappings":"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"}