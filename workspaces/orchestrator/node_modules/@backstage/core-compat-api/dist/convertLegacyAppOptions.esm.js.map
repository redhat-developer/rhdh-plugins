{"version":3,"file":"convertLegacyAppOptions.esm.js","sources":["../src/convertLegacyAppOptions.tsx"],"sourcesContent":["/*\n * Copyright 2025 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { ComponentType } from 'react';\nimport {\n  SwappableComponentBlueprint,\n  ApiBlueprint,\n  ErrorDisplayProps,\n  createExtension,\n  createFrontendModule,\n  ExtensionDefinition,\n  FrontendModule,\n  IconBundleBlueprint,\n  RouterBlueprint,\n  SignInPageBlueprint,\n  ThemeBlueprint,\n  ErrorDisplay as SwappableErrorDisplay,\n  NotFoundErrorPage as SwappableNotFoundErrorPage,\n  Progress as SwappableProgress,\n} from '@backstage/frontend-plugin-api';\nimport {\n  AnyApiFactory,\n  AppComponents,\n  AppTheme,\n  BackstagePlugin,\n  FeatureFlag,\n  IconComponent,\n} from '@backstage/core-plugin-api';\nimport { toLegacyPlugin } from './compatWrapper/BackwardsCompatProvider';\nimport { compatWrapper } from './compatWrapper';\n\nfunction componentCompatWrapper<TProps extends {}>(\n  Component: ComponentType<TProps>,\n) {\n  return (props: TProps) => compatWrapper(<Component {...props} />);\n}\n\n/**\n * @public\n */\nexport function convertLegacyAppOptions(\n  options: {\n    apis?: Iterable<AnyApiFactory>;\n\n    icons?: { [key in string]: IconComponent };\n\n    plugins?: Array<BackstagePlugin>;\n\n    components?: Partial<AppComponents>;\n\n    themes?: AppTheme[];\n\n    featureFlags?: (FeatureFlag & Omit<FeatureFlag, 'pluginId'>)[];\n  } = {},\n): FrontendModule {\n  const { apis, icons, plugins, components, themes, featureFlags } = options;\n\n  const allApis = [\n    ...(plugins?.flatMap(plugin => [...plugin.getApis()]) ?? []),\n    ...(apis ?? []),\n  ];\n  const deduplicatedApis = Array.from(\n    new Map(allApis.map(api => [api.api.id, api])).values(),\n  );\n  const extensions: ExtensionDefinition[] = deduplicatedApis.map(factory =>\n    ApiBlueprint.make({\n      name: factory.api.id,\n      params: defineParams => defineParams(factory),\n    }),\n  );\n\n  if (icons) {\n    extensions.push(\n      IconBundleBlueprint.make({\n        name: 'app-options',\n        params: { icons },\n      }),\n    );\n  }\n\n  if (themes) {\n    // IF any themes are provided we need to disable the default ones, unless they are overridden\n    for (const id of ['light', 'dark']) {\n      if (!themes.some(theme => theme.id === id)) {\n        extensions.push(\n          createExtension({\n            kind: 'theme',\n            name: id,\n            attachTo: { id: 'api:app/app-theme', input: 'themes' },\n            disabled: true,\n            output: [],\n            factory: () => [],\n          }),\n        );\n      }\n    }\n    extensions.push(\n      ...themes.map(theme =>\n        ThemeBlueprint.make({\n          name: theme.id,\n          params: { theme },\n        }),\n      ),\n    );\n  }\n\n  if (components) {\n    const {\n      BootErrorPage,\n      ErrorBoundaryFallback,\n      NotFoundErrorPage,\n      Progress,\n      Router,\n      SignInPage,\n      ThemeProvider,\n    } = components;\n\n    if (BootErrorPage) {\n      throw new Error(\n        'components.BootErrorPage is not supported by convertLegacyAppOptions',\n      );\n    }\n    if (ThemeProvider) {\n      throw new Error(\n        'components.ThemeProvider is not supported by convertLegacyAppOptions',\n      );\n    }\n    if (Router) {\n      extensions.push(\n        RouterBlueprint.make({\n          params: { component: componentCompatWrapper(Router) },\n        }),\n      );\n    }\n    if (SignInPage) {\n      extensions.push(\n        SignInPageBlueprint.make({\n          params: {\n            loader: () => Promise.resolve(componentCompatWrapper(SignInPage)),\n          },\n        }),\n      );\n    }\n    if (Progress) {\n      extensions.push(\n        SwappableComponentBlueprint.make({\n          params: define =>\n            define({\n              component: SwappableProgress,\n              loader: () => componentCompatWrapper(Progress),\n            }),\n        }),\n      );\n    }\n\n    if (NotFoundErrorPage) {\n      extensions.push(\n        SwappableComponentBlueprint.make({\n          params: define =>\n            define({\n              component: SwappableNotFoundErrorPage,\n              loader: () => componentCompatWrapper(NotFoundErrorPage),\n            }),\n        }),\n      );\n    }\n\n    if (ErrorBoundaryFallback) {\n      const WrappedErrorBoundaryFallback = (props: ErrorDisplayProps) =>\n        compatWrapper(\n          <ErrorBoundaryFallback\n            {...props}\n            plugin={props.plugin && toLegacyPlugin(props.plugin)}\n          />,\n        );\n\n      extensions.push(\n        SwappableComponentBlueprint.make({\n          params: define =>\n            define({\n              component: SwappableErrorDisplay,\n              loader: () =>\n                componentCompatWrapper(WrappedErrorBoundaryFallback),\n            }),\n        }),\n      );\n    }\n  }\n\n  return createFrontendModule({\n    pluginId: 'app',\n    extensions,\n    featureFlags,\n  });\n}\n"],"names":["NotFoundErrorPage","Progress","SwappableProgress","SwappableNotFoundErrorPage","SwappableErrorDisplay"],"mappings":"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"}