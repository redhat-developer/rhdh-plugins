{"version":3,"file":"convertLegacyApp.esm.js","sources":["../src/convertLegacyApp.ts"],"sourcesContent":["/*\n * Copyright 2023 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  JSX,\n  cloneElement,\n  Children,\n  Fragment,\n  ReactElement,\n  ReactNode,\n  isValidElement,\n} from 'react';\nimport {\n  FrontendModule,\n  FrontendPlugin,\n  coreExtensionData,\n  createExtension,\n  createExtensionInput,\n  createFrontendModule,\n} from '@backstage/frontend-plugin-api';\nimport { getComponentData } from '@backstage/core-plugin-api';\nimport { collectLegacyRoutes } from './collectLegacyRoutes';\nimport { compatWrapper } from './compatWrapper';\n\nfunction selectChildren(\n  rootNode: ReactNode,\n  selector?: (element: ReactElement<{ children?: ReactNode }>) => boolean,\n  strictError?: string,\n): Array<ReactElement<{ children?: ReactNode }>> {\n  return Children.toArray(rootNode).flatMap(node => {\n    if (!isValidElement<{ children?: ReactNode }>(node)) {\n      return [];\n    }\n\n    if (node.type === Fragment) {\n      return selectChildren(node.props.children, selector, strictError);\n    }\n\n    if (selector === undefined || selector(node)) {\n      return [node];\n    }\n\n    if (strictError) {\n      throw new Error(strictError);\n    }\n\n    return selectChildren(node.props.children, selector, strictError);\n  });\n}\n\n/** @public */\nexport interface ConvertLegacyAppRootOptions {\n  /**\n   * By providing an entity page element here it will be split up and converted\n   * into individual extensions for the catalog plugin in the new frontend\n   * system.\n   *\n   * In order to use this option the entity page and other catalog extensions\n   * must be removed from the legacy app, and the catalog plugin for the new\n   * frontend system must be installed instead.\n   *\n   * In order for this conversion to work the entity page must be a plain React\n   * element tree without any component wrapping anywhere between the root\n   * element and the `EntityLayout.Route` elements.\n   *\n   * When enabling this conversion you are likely to encounter duplicate entity\n   * page content provided both via the old structure and the new plugins. Any\n   * duplicate content needs to be removed from the old structure.\n   */\n  entityPage?: JSX.Element;\n}\n\n/** @public */\nexport function convertLegacyAppRoot(\n  rootElement: JSX.Element,\n  options: ConvertLegacyAppRootOptions = {},\n): (FrontendPlugin | FrontendModule)[] {\n  if (getComponentData(rootElement, 'core.type') === 'FlatRoutes') {\n    return collectLegacyRoutes(rootElement, options?.entityPage);\n  }\n\n  const appRouterEls = selectChildren(\n    rootElement,\n    el => getComponentData(el, 'core.type') === 'AppRouter',\n  );\n  if (appRouterEls.length !== 1) {\n    throw new Error(\n      \"Failed to convert legacy app, AppRouter element could not been found. Make sure it's at the top level of the App element tree\",\n    );\n  }\n\n  const rootEls = selectChildren(\n    appRouterEls[0].props.children,\n    el =>\n      Boolean(el.props.children) &&\n      selectChildren(\n        el.props.children,\n        innerEl => getComponentData(innerEl, 'core.type') === 'FlatRoutes',\n      ).length === 1,\n  );\n  if (rootEls.length !== 1) {\n    throw new Error(\n      \"Failed to convert legacy app, Root element containing FlatRoutes could not been found. Make sure it's within the AppRouter element of the App element tree\",\n    );\n  }\n  const [rootEl] = rootEls;\n\n  const routesEls = selectChildren(\n    rootEls[0].props.children,\n    el => getComponentData(el, 'core.type') === 'FlatRoutes',\n  );\n  if (routesEls.length !== 1) {\n    throw new Error(\n      'Unexpectedly failed to find FlatRoutes in app element tree',\n    );\n  }\n  const [routesEl] = routesEls;\n\n  const CoreLayoutOverride = createExtension({\n    name: 'layout',\n    attachTo: { id: 'app/root', input: 'children' },\n    inputs: {\n      content: createExtensionInput([coreExtensionData.reactElement], {\n        singleton: true,\n      }),\n    },\n    output: [coreExtensionData.reactElement],\n    factory({ inputs }) {\n      // Clone the root element, this replaces the FlatRoutes declared in the app with out content input\n      return [\n        coreExtensionData.reactElement(\n          compatWrapper(\n            cloneElement(\n              rootEl,\n              undefined,\n              inputs.content.get(coreExtensionData.reactElement),\n            ),\n          ),\n        ),\n      ];\n    },\n  });\n  const CoreNavOverride = createExtension({\n    name: 'nav',\n    attachTo: { id: 'app/layout', input: 'nav' },\n    output: [],\n    factory: () => [],\n    disabled: true,\n  });\n\n  const collectedRoutes = collectLegacyRoutes(routesEl, options?.entityPage);\n\n  return [\n    ...collectedRoutes,\n    createFrontendModule({\n      pluginId: 'app',\n      extensions: [CoreLayoutOverride, CoreNavOverride],\n    }),\n  ];\n}\n\n/**\n * @public\n * @deprecated\n * Use `convertLegacyAppRoot` instead.\n */\nexport const convertLegacyApp = convertLegacyAppRoot;\n\n/**\n * @public\n * @deprecated\n * Use `ConvertLegacyAppRootOptions` instead.\n */\nexport type ConvertLegacyAppOptions = ConvertLegacyAppRootOptions;\n"],"names":[],"mappings":"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"}