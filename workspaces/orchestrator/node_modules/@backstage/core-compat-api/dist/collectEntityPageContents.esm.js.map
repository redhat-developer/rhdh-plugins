{"version":3,"file":"collectEntityPageContents.esm.js","sources":["../src/collectEntityPageContents.ts"],"sourcesContent":["/*\n * Copyright 2025 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  ApiHolder,\n  getComponentData,\n  BackstagePlugin as LegacyBackstagePlugin,\n} from '@backstage/core-plugin-api';\nimport { ExtensionDefinition } from '@backstage/frontend-plugin-api';\nimport { JSX, ReactNode, isValidElement, Children } from 'react';\nimport {\n  EntityCardBlueprint,\n  EntityContentBlueprint,\n} from '@backstage/plugin-catalog-react/alpha';\nimport { normalizeRoutePath } from './normalizeRoutePath';\n\nconst ENTITY_SWITCH_KEY = 'core.backstage.entitySwitch';\nconst ENTITY_ROUTE_KEY = 'plugin.catalog.entityLayoutRoute';\n\n// Placeholder to make sure internal types here are consistent\ntype Entity = { apiVersion: string; kind: string };\n\ntype EntityFilter = (entity: Entity, ctx: { apis: ApiHolder }) => boolean;\ntype AsyncEntityFilter = (\n  entity: Entity,\n  context: { apis: ApiHolder },\n) => boolean | Promise<boolean>;\n\nfunction allFilters(\n  ...ifs: (EntityFilter | undefined)[]\n): EntityFilter | undefined {\n  const filtered = ifs.filter(Boolean) as EntityFilter[];\n  if (!filtered.length) {\n    return undefined;\n  }\n  if (filtered.length === 1) {\n    return filtered[0];\n  }\n  return (entity, ctx) => filtered.every(ifFunc => ifFunc(entity, ctx));\n}\n\nfunction anyFilters(\n  ...ifs: (EntityFilter | undefined)[]\n): EntityFilter | undefined {\n  const filtered = ifs.filter(Boolean) as EntityFilter[];\n  if (!filtered.length) {\n    return undefined;\n  }\n  if (filtered.length === 1) {\n    return filtered[0];\n  }\n  return (entity, ctx) => filtered.some(ifFunc => ifFunc(entity, ctx));\n}\n\nfunction invertFilter(ifFunc?: EntityFilter): EntityFilter {\n  if (!ifFunc) {\n    return () => true;\n  }\n  return (entity, ctx) => !ifFunc(entity, ctx);\n}\n\nexport function collectEntityPageContents(\n  entityPageElement: JSX.Element,\n  context: {\n    discoverExtension(\n      extension: ExtensionDefinition,\n      plugin?: LegacyBackstagePlugin,\n    ): void;\n  },\n) {\n  let cardCounter = 1;\n  let routeCounter = 1;\n\n  function traverse(element: ReactNode, parentFilter?: EntityFilter) {\n    if (!isValidElement(element)) {\n      return;\n    }\n\n    const pageNode = maybeParseEntityPageNode(element);\n    if (pageNode) {\n      if (pageNode.type === 'route') {\n        const mergedIf = allFilters(parentFilter, pageNode.if);\n\n        if (pageNode.path === '/') {\n          context.discoverExtension(\n            EntityCardBlueprint.makeWithOverrides({\n              name: `discovered-${cardCounter++}`,\n              factory(originalFactory, { apis }) {\n                return originalFactory({\n                  type: 'content',\n                  filter: mergedIf && (entity => mergedIf(entity, { apis })),\n                  loader: () => Promise.resolve(pageNode.children),\n                });\n              },\n            }),\n          );\n        } else {\n          const name = `discovered-${routeCounter++}`;\n\n          context.discoverExtension(\n            EntityContentBlueprint.makeWithOverrides({\n              name,\n              factory(originalFactory, { apis }) {\n                return originalFactory({\n                  path: normalizeRoutePath(pageNode.path),\n                  title: pageNode.title,\n                  filter: mergedIf && (entity => mergedIf(entity, { apis })),\n                  loader: () => Promise.resolve(pageNode.children),\n                });\n              },\n            }),\n            getComponentData<LegacyBackstagePlugin>(\n              pageNode.children,\n              'core.plugin',\n            ),\n          );\n        }\n      }\n      if (pageNode.type === 'switch') {\n        if (pageNode.renderMultipleMatches === 'all') {\n          for (const entityCase of pageNode.cases) {\n            traverse(\n              entityCase.children,\n              allFilters(parentFilter, entityCase.if),\n            );\n          }\n        } else {\n          let previousIf: EntityFilter = () => false;\n          for (const entityCase of pageNode.cases) {\n            const didNotMatchEarlier = invertFilter(previousIf);\n            traverse(\n              entityCase.children,\n              allFilters(parentFilter, entityCase.if, didNotMatchEarlier),\n            );\n            previousIf = anyFilters(previousIf, entityCase.if)!;\n          }\n        }\n      }\n      return;\n    }\n\n    Children.forEach(\n      (element.props as { children?: ReactNode })?.children,\n      child => {\n        traverse(child, parentFilter);\n      },\n    );\n  }\n\n  traverse(entityPageElement);\n}\n\ntype EntityRoute = {\n  type: 'route';\n  path: string;\n  title: string;\n  if?: EntityFilter;\n  children: JSX.Element;\n};\n\ntype EntitySwitchCase = {\n  if?: EntityFilter;\n  children: ReactNode;\n};\n\ntype EntitySwitch = {\n  type: 'switch';\n  cases: EntitySwitchCase[];\n  renderMultipleMatches: 'first' | 'all';\n};\n\nfunction wrapAsyncEntityFilter(\n  asyncFilter?: AsyncEntityFilter,\n): EntityFilter | undefined {\n  if (!asyncFilter) {\n    return asyncFilter;\n  }\n  let loggedError = false;\n  return (entity, ctx) => {\n    const result = asyncFilter(entity, ctx);\n    if (result && typeof result === 'object' && 'then' in result) {\n      if (!loggedError) {\n        // eslint-disable-next-line no-console\n        console.error(\n          `collectEntityPageContents does not support async entity filters, skipping filter ${asyncFilter}`,\n        );\n        loggedError = true;\n      }\n      return false;\n    }\n    return result;\n  };\n}\n\nfunction maybeParseEntityPageNode(\n  element: JSX.Element,\n): EntityRoute | EntitySwitch | undefined {\n  if (getComponentData(element, ENTITY_ROUTE_KEY)) {\n    const props = element.props as EntityRoute;\n    return {\n      type: 'route',\n      path: props.path,\n      title: props.title,\n      if: props.if,\n      children: props.children,\n    };\n  }\n\n  const parentProps = element.props as {\n    children?: ReactNode;\n    renderMultipleMatches?: 'first' | 'all';\n  };\n\n  const children = Children.toArray(parentProps?.children);\n  if (!children.length) {\n    return undefined;\n  }\n\n  const cases = [];\n  for (const child of children) {\n    if (!getComponentData(child, ENTITY_SWITCH_KEY)) {\n      return undefined;\n    }\n    const props = (child as { props: EntitySwitchCase }).props;\n\n    cases.push({\n      if: wrapAsyncEntityFilter(props.if),\n      children: props.children,\n    });\n  }\n  return {\n    type: 'switch',\n    cases,\n    renderMultipleMatches: parentProps?.renderMultipleMatches ?? 'first',\n  };\n}\n"],"names":[],"mappings":"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"}