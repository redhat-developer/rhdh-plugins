{"version":3,"file":"createInitializationLogger.cjs.js","sources":["../../src/wiring/createInitializationLogger.ts"],"sourcesContent":["/*\n * Copyright 2024 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { RootLoggerService } from '@backstage/backend-plugin-api';\n\nconst LOGGER_INTERVAL_MAX = 60_000;\n\nfunction joinIds(ids: Iterable<string>): string {\n  return [...ids].map(id => `'${id}'`).join(', ');\n}\n\nexport function createInitializationLogger(\n  pluginIds: string[],\n  rootLogger?: RootLoggerService,\n): {\n  onPluginStarted(pluginId: string): void;\n  onPluginFailed(pluginId: string, error: Error): void;\n  onPermittedPluginFailure(pluginId: string, error: Error): void;\n  onPluginModuleFailed(pluginId: string, moduleId: string, error: Error): void;\n  onPermittedPluginModuleFailure(\n    pluginId: string,\n    moduleId: string,\n    error: Error,\n  ): void;\n  onAllStarted(): void;\n} {\n  const logger = rootLogger?.child({ type: 'initialization' });\n  const starting = new Set(pluginIds);\n  const started = new Set<string>();\n\n  logger?.info(`Plugin initialization started: ${joinIds(pluginIds)}`);\n\n  const getInitStatus = () => {\n    let status = '';\n    if (started.size > 0) {\n      status = `, newly initialized: ${joinIds(started)}`;\n      started.clear();\n    }\n    if (starting.size > 0) {\n      status += `, still initializing: ${joinIds(starting)}`;\n    }\n    return status;\n  };\n\n  // Periodically log the initialization status with a fibonacci backoff\n  let interval = 1000;\n  let prevInterval = 0;\n  let timeout: NodeJS.Timeout | undefined;\n  const onTimeout = () => {\n    logger?.info(`Plugin initialization in progress${getInitStatus()}`);\n\n    const nextInterval = Math.min(interval + prevInterval, LOGGER_INTERVAL_MAX);\n    prevInterval = interval;\n    interval = nextInterval;\n\n    timeout = setTimeout(onTimeout, nextInterval);\n  };\n  timeout = setTimeout(onTimeout, interval);\n\n  return {\n    onPluginStarted(pluginId: string) {\n      starting.delete(pluginId);\n      started.add(pluginId);\n    },\n    onPluginFailed(pluginId: string, error: Error) {\n      starting.delete(pluginId);\n      const status =\n        starting.size > 0\n          ? `, waiting for ${starting.size} other plugins to finish before shutting down the process`\n          : '';\n      logger?.error(\n        `Plugin '${pluginId}' threw an error during startup${status}.`,\n        error,\n      );\n    },\n    onPermittedPluginFailure(pluginId: string, error: Error) {\n      starting.delete(pluginId);\n      logger?.error(\n        `Plugin '${pluginId}' threw an error during startup, but boot failure is permitted for this plugin so startup will continue.`,\n        error,\n      );\n    },\n    onPluginModuleFailed(pluginId: string, moduleId: string, error: Error) {\n      const status =\n        starting.size > 0\n          ? `, waiting for ${starting.size} other plugins to finish before shutting down the process`\n          : '';\n      logger?.error(\n        `Module ${moduleId} in Plugin '${pluginId}' threw an error during startup${status}.`,\n        error,\n      );\n    },\n    onPermittedPluginModuleFailure(\n      pluginId: string,\n      moduleId: string,\n      error: Error,\n    ) {\n      logger?.error(\n        `Module ${moduleId} in Plugin '${pluginId}' threw an error during startup, but boot failure is permitted for this plugin module so startup will continue.`,\n        error,\n      );\n    },\n    onAllStarted() {\n      logger?.info(`Plugin initialization complete${getInitStatus()}`);\n\n      if (timeout) {\n        clearTimeout(timeout);\n        timeout = undefined;\n      }\n    },\n  };\n}\n"],"names":[],"mappings":"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"}