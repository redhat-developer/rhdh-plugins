{"version":3,"file":"render.esm.js","sources":["../../src/devApp/render.tsx"],"sourcesContent":["/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { createApp } from '@backstage/app-defaults';\nimport { AppRouter, FlatRoutes } from '@backstage/core-app-api';\nimport {\n  AlertDisplay,\n  OAuthRequestDialog,\n  Sidebar,\n  SidebarDivider,\n  SidebarItem,\n  SidebarPage,\n  SidebarSpace,\n  SidebarSpacer,\n  SignInPage,\n  SignInProviderConfig,\n} from '@backstage/core-components';\nimport {\n  AnyApiFactory,\n  ApiFactory,\n  AppTheme,\n  attachComponentData,\n  BackstagePlugin,\n  configApiRef,\n  createApiFactory,\n  createRouteRef,\n  IconComponent,\n  RouteRef,\n} from '@backstage/core-plugin-api';\nimport { TranslationResource } from '@backstage/core-plugin-api/alpha';\nimport {\n  ScmIntegrationsApi,\n  scmIntegrationsApiRef,\n} from '@backstage/integration-react';\nimport Box from '@material-ui/core/Box';\nimport BookmarkIcon from '@material-ui/icons/Bookmark';\nimport { ComponentType, PropsWithChildren, ReactNode } from 'react';\nimport { createRoutesFromChildren, Route } from 'react-router-dom';\nimport { SidebarThemeSwitcher } from './SidebarThemeSwitcher';\nimport 'react-dom';\nimport { SidebarLanguageSwitcher, SidebarSignOutButton } from '../components';\n\nlet ReactDOMPromise: Promise<\n  typeof import('react-dom') | typeof import('react-dom/client')\n>;\nif (process.env.HAS_REACT_DOM_CLIENT) {\n  ReactDOMPromise = import('react-dom/client');\n} else {\n  ReactDOMPromise = import('react-dom');\n}\n\nexport function isReactRouterBeta(): boolean {\n  const [obj] = createRoutesFromChildren(<Route index element={<div />} />);\n  return !obj.index;\n}\n\nconst MaybeGatheringRoute: (props: {\n  path: string;\n  element: JSX.Element;\n  children?: ReactNode;\n}) => JSX.Element = ({ element }) => element;\n\nif (isReactRouterBeta()) {\n  attachComponentData(MaybeGatheringRoute, 'core.gatherMountPoints', true);\n}\n\n/** @public */\nexport type DevAppPageOptions = {\n  path?: string;\n  element: JSX.Element;\n  children?: JSX.Element;\n  title?: string;\n  icon?: IconComponent;\n};\n\n/**\n * DevApp builder that is similar to the App builder API, but creates an App\n * with the purpose of developing one or more plugins inside it.\n *\n * @public\n */\nexport class DevAppBuilder {\n  private readonly plugins = new Array<BackstagePlugin>();\n  private readonly apis = new Array<AnyApiFactory>();\n  private readonly rootChildren = new Array<ReactNode>();\n  private readonly routes = new Array<JSX.Element>();\n  private readonly sidebarItems = new Array<JSX.Element>();\n  private readonly signInProviders = new Array<SignInProviderConfig>();\n  private readonly translationResources = new Array<TranslationResource>();\n\n  private defaultPage?: string;\n  private themes?: Array<AppTheme>;\n  private languages?: string[];\n  private defaultLanguage?: string;\n\n  /**\n   * Register one or more plugins to render in the dev app\n   */\n  registerPlugin(...plugins: BackstagePlugin[]): DevAppBuilder {\n    this.plugins.push(...plugins);\n    return this;\n  }\n\n  /**\n   * Register an API factory to add to the app\n   */\n  registerApi<\n    Api,\n    Impl extends Api,\n    Deps extends { [name in string]: unknown },\n  >(factory: ApiFactory<Api, Impl, Deps>): DevAppBuilder {\n    this.apis.push(factory);\n    return this;\n  }\n\n  /**\n   * Adds a React node to place just inside the App Provider.\n   *\n   * Useful for adding more global components like the AlertDisplay.\n   */\n  addRootChild(node: ReactNode): DevAppBuilder {\n    this.rootChildren.push(node);\n    return this;\n  }\n\n  /**\n   * Adds a new sidebar item to the dev app.\n   *\n   * Useful for adding only sidebar items without a corresponding page.\n   */\n  addSidebarItem(sidebarItem: JSX.Element): DevAppBuilder {\n    this.sidebarItems.push(sidebarItem);\n    return this;\n  }\n\n  /**\n   * Adds a page component along with accompanying sidebar item.\n   *\n   * If no path is provided one will be generated.\n   * If no title is provided, no sidebar item will be created.\n   */\n  addPage(opts: DevAppPageOptions): DevAppBuilder {\n    const path = opts.path ?? `/page-${this.routes.length + 1}`;\n\n    if (!this.defaultPage || path === '/') {\n      this.defaultPage = path;\n    }\n\n    if (opts.title) {\n      this.sidebarItems.push(\n        <SidebarItem\n          key={path}\n          to={path}\n          text={opts.title}\n          icon={opts.icon ?? BookmarkIcon}\n        />,\n      );\n    }\n\n    this.routes.push(\n      <MaybeGatheringRoute\n        key={path}\n        path={path}\n        element={opts.element}\n        children={opts.children}\n      />,\n    );\n    return this;\n  }\n\n  /**\n   * Adds an array of themes to override the default theme.\n   */\n  addThemes(themes: AppTheme[]) {\n    this.themes = themes;\n    return this;\n  }\n\n  /**\n   * Adds new sign in provider for the dev app\n   */\n  addSignInProvider(provider: SignInProviderConfig) {\n    this.signInProviders.push(provider);\n    return this;\n  }\n\n  /**\n   * Set available languages to be shown in the dev app\n   */\n  setAvailableLanguages(languages: string[]) {\n    this.languages = languages;\n    return this;\n  }\n\n  /**\n   * Add translation resource to the dev app\n   */\n  addTranslationResource(resource: TranslationResource) {\n    this.translationResources.push(resource);\n    return this;\n  }\n\n  /**\n   * Set default language for the dev app\n   */\n  setDefaultLanguage(language: string) {\n    this.defaultLanguage = language;\n    return this;\n  }\n\n  /**\n   * Build a DevApp component using the resources registered so far\n   */\n  build(): ComponentType<PropsWithChildren<{}>> {\n    const fakeRouteRef = createRouteRef({ id: 'fake' });\n    const FakePage = () => <Box p={3}>Page belonging to another plugin.</Box>;\n    attachComponentData(FakePage, 'core.mountPoint', fakeRouteRef);\n\n    const apis = [...this.apis];\n    if (!apis.some(api => api.api.id === scmIntegrationsApiRef.id)) {\n      apis.push(\n        createApiFactory({\n          api: scmIntegrationsApiRef,\n          deps: { configApi: configApiRef },\n          factory: ({ configApi }) => ScmIntegrationsApi.fromConfig(configApi),\n        }),\n      );\n    }\n\n    const app = createApp({\n      apis,\n      plugins: this.plugins,\n      themes: this.themes,\n      components: {\n        SignInPage: props => {\n          return (\n            <SignInPage\n              {...props}\n              providers={['guest', ...this.signInProviders]}\n              title=\"Select a sign-in method\"\n              align=\"center\"\n            />\n          );\n        },\n      },\n      bindRoutes: ({ bind }) => {\n        for (const plugin of this.plugins ?? []) {\n          const targets: Record<string, RouteRef<any>> = {};\n          for (const routeKey of Object.keys(plugin.externalRoutes)) {\n            targets[routeKey] = fakeRouteRef;\n          }\n          bind(plugin.externalRoutes, targets);\n        }\n      },\n      __experimentalTranslations: {\n        defaultLanguage: this.defaultLanguage,\n        availableLanguages: this.languages,\n        resources: this.translationResources,\n      },\n    });\n\n    const DevApp = (\n      <>\n        <AlertDisplay />\n        <OAuthRequestDialog />\n        {this.rootChildren}\n        <AppRouter>\n          <SidebarPage>\n            <Sidebar>\n              <SidebarSpacer />\n              {this.sidebarItems}\n              <SidebarSpace />\n              <SidebarDivider />\n              <SidebarThemeSwitcher />\n              <SidebarLanguageSwitcher />\n              <SidebarSignOutButton />\n            </Sidebar>\n            <FlatRoutes>\n              {this.routes}\n              <Route path=\"/_external_route\" element={<FakePage />} />\n            </FlatRoutes>\n          </SidebarPage>\n        </AppRouter>\n      </>\n    );\n\n    return app.createRoot(DevApp);\n  }\n\n  /**\n   * Build and render directory to #root element, with react hot loading.\n   */\n  render(): void {\n    const DevApp = this.build();\n\n    if (\n      window.location.pathname === '/' &&\n      this.defaultPage &&\n      this.defaultPage !== '/'\n    ) {\n      window.location.pathname = this.defaultPage;\n    }\n\n    ReactDOMPromise.then(ReactDOM => {\n      if ('createRoot' in ReactDOM) {\n        ReactDOM.createRoot(document.getElementById('root')!).render(\n          <DevApp />,\n        );\n      } else {\n        ReactDOM.render(<DevApp />, document.getElementById('root'));\n      }\n    });\n  }\n}\n\n// TODO(rugvip): Figure out patterns for how to allow in-house apps to build upon\n// this to provide their own plugin dev wrappers.\n\n/**\n * Creates a dev app for rendering one or more plugins and exposing the touch points of the plugin.\n *\n * @public\n */\nexport function createDevApp() {\n  return new DevAppBuilder();\n}\n"],"names":[],"mappings":"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"}