{"version":3,"file":"ScmAuth.esm.js","sources":["../../src/api/ScmAuth.ts"],"sourcesContent":["/*\n * Copyright 2021 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  bitbucketAuthApiRef,\n  createApiFactory,\n  githubAuthApiRef,\n  gitlabAuthApiRef,\n  microsoftAuthApiRef,\n  OAuthApi,\n} from '@backstage/core-plugin-api';\nimport {\n  ScmAuthApi,\n  scmAuthApiRef,\n  ScmAuthTokenOptions,\n  ScmAuthTokenResponse,\n} from './ScmAuthApi';\n\ntype ScopeMapping = {\n  /** The base scopes used for all requests */\n  default: string[];\n  /** Additional scopes added if `repoWrite` is requested */\n  repoWrite: string[];\n};\n\n// An enum of all supported providers\ntype ProviderName = 'generic' | 'github' | 'azure' | 'bitbucket' | 'gitlab';\n\nclass ScmAuthMux implements ScmAuthApi {\n  #providers: Array<ScmAuth>;\n\n  constructor(providers: ScmAuth[]) {\n    this.#providers = providers;\n  }\n\n  async getCredentials(\n    options: ScmAuthTokenOptions,\n  ): Promise<ScmAuthTokenResponse> {\n    const url = new URL(options.url);\n    const provider = this.#providers.find(p => p.isUrlSupported(url));\n    if (!provider) {\n      throw new Error(\n        `No auth provider available for '${options.url}', see https://backstage.io/link?scm-auth`,\n      );\n    }\n\n    return provider.getCredentials(options);\n  }\n}\n\n/**\n * An implementation of the ScmAuthApi that merges together OAuthApi instances\n * to form a single instance that can handles authentication for multiple providers.\n *\n * @public\n *\n * @example\n * ```\n * // Supports authentication towards both public GitHub and GHE:\n * createApiFactory({\n *   api: scmAuthApiRef,\n *   deps: {\n *     gheAuthApi: gheAuthApiRef,\n *     githubAuthApi: githubAuthApiRef,\n *   },\n *   factory: ({ githubAuthApi, gheAuthApi }) =>\n *     ScmAuth.merge(\n *       ScmAuth.forGithub(githubAuthApi),\n *       ScmAuth.forGithub(gheAuthApi, {\n *         host: 'ghe.example.com',\n *       }),\n *     )\n * })\n * ```\n */\nexport class ScmAuth implements ScmAuthApi {\n  /**\n   * Creates an API factory that enables auth for each of the default SCM providers.\n   */\n  static createDefaultApiFactory() {\n    return createApiFactory({\n      api: scmAuthApiRef,\n      deps: {\n        github: githubAuthApiRef,\n        gitlab: gitlabAuthApiRef,\n        azure: microsoftAuthApiRef,\n        bitbucket: bitbucketAuthApiRef,\n      },\n      factory: ({ github, gitlab, azure, bitbucket }) =>\n        ScmAuth.merge(\n          ScmAuth.forGithub(github),\n          ScmAuth.forGitlab(gitlab),\n          ScmAuth.forAzure(azure),\n          ScmAuth.forBitbucket(bitbucket),\n        ),\n    });\n  }\n\n  /**\n   * Creates a general purpose ScmAuth instance with a custom scope mapping.\n   */\n  static forAuthApi(\n    authApi: OAuthApi,\n    options: {\n      host: string;\n      scopeMapping: {\n        default: string[];\n        repoWrite: string[];\n      };\n    },\n  ): ScmAuth {\n    return new ScmAuth('generic', authApi, options.host, options.scopeMapping);\n  }\n\n  /**\n   * Creates a new ScmAuth instance that handles authentication towards GitHub.\n   *\n   * The host option determines which URLs that are handled by this instance and defaults to `github.com`.\n   *\n   * The default scopes are:\n   *\n   * `repo read:org read:user`\n   *\n   * If the additional `repoWrite` permission is requested, these scopes are added:\n   *\n   * `gist`\n   */\n  static forGithub(\n    githubAuthApi: OAuthApi,\n    options?: {\n      host?: string;\n    },\n  ): ScmAuth {\n    const host = options?.host ?? 'github.com';\n    return new ScmAuth('github', githubAuthApi, host, {\n      default: ['repo', 'read:org', 'read:user'],\n      repoWrite: ['gist'],\n    });\n  }\n\n  /**\n   * Creates a new ScmAuth instance that handles authentication towards GitLab.\n   *\n   * The host option determines which URLs that are handled by this instance and defaults to `gitlab.com`.\n   *\n   * The default scopes are:\n   *\n   * `read_user read_api read_repository`\n   *\n   * If the additional `repoWrite` permission is requested, these scopes are added:\n   *\n   * `write_repository api`\n   */\n  static forGitlab(\n    gitlabAuthApi: OAuthApi,\n    options?: {\n      host?: string;\n    },\n  ): ScmAuth {\n    const host = options?.host ?? 'gitlab.com';\n    return new ScmAuth('gitlab', gitlabAuthApi, host, {\n      default: ['read_user', 'read_api', 'read_repository'],\n      repoWrite: ['write_repository', 'api'],\n    });\n  }\n\n  /**\n   * Creates a new ScmAuth instance that handles authentication towards Azure.\n   *\n   * The host option determines which URLs that are handled by this instance and defaults to `dev.azure.com`.\n   *\n   * The default scopes are:\n   *\n   * `vso.build vso.code vso.graph vso.project vso.profile`\n   *\n   * If the additional `repoWrite` permission is requested, these scopes are added:\n   *\n   * `vso.code_manage`\n   */\n  static forAzure(\n    microsoftAuthApi: OAuthApi,\n    options?: {\n      host?: string;\n    },\n  ): ScmAuth {\n    const host = options?.host ?? 'dev.azure.com';\n    return new ScmAuth('azure', microsoftAuthApi, host, {\n      default: [\n        '499b84ac-1321-427f-aa17-267ca6975798/vso.build',\n        '499b84ac-1321-427f-aa17-267ca6975798/vso.code',\n        '499b84ac-1321-427f-aa17-267ca6975798/vso.graph',\n        '499b84ac-1321-427f-aa17-267ca6975798/vso.project',\n        '499b84ac-1321-427f-aa17-267ca6975798/vso.profile',\n      ],\n      repoWrite: ['499b84ac-1321-427f-aa17-267ca6975798/vso.code_manage'],\n    });\n  }\n\n  /**\n   * Creates a new ScmAuth instance that handles authentication towards Bitbucket.\n   *\n   * The host option determines which URLs that are handled by this instance and defaults to `bitbucket.org`.\n   *\n   * The default scopes are:\n   *\n   * `account team pullrequest snippet issue`\n   *\n   * If the additional `repoWrite` permission is requested, these scopes are added:\n   *\n   * `pullrequest:write snippet:write issue:write`\n   */\n  static forBitbucket(\n    bitbucketAuthApi: OAuthApi,\n    options?: {\n      host?: string;\n      scopeMapping?: {\n        default?: string[];\n        repoWrite?: string[];\n      };\n    },\n  ): ScmAuth {\n    const host = options?.host ?? 'bitbucket.org';\n    const defaultScopes = options?.scopeMapping?.default ?? [\n      'account',\n      'team',\n      'pullrequest',\n      'snippet',\n      'issue',\n      'project',\n    ];\n    const repoWriteScopes = options?.scopeMapping?.repoWrite ?? [\n      'pullrequest:write',\n      'snippet:write',\n      'issue:write',\n    ];\n    return new ScmAuth('bitbucket', bitbucketAuthApi, host, {\n      default: defaultScopes,\n      repoWrite: repoWriteScopes,\n    });\n  }\n\n  /**\n   * Creates a new ScmAuth instance that handles authentication towards Bitbucket Server.\n   *\n   * The host option determines which URLs that are handled by this instance.\n   *\n   * The default scopes are:\n   *\n   * `PUBLIC_REPOS REPO_READ`\n   *\n   * If the additional `repoWrite` permission is requested, these scopes are added:\n   *\n   * `REPO_WRITE`\n   */\n  static forBitbucketServer(\n    bitbucketAuthApi: OAuthApi,\n    options: {\n      host: string;\n      scopeMapping?: {\n        default?: string[];\n        repoWrite?: string[];\n      };\n    },\n  ): ScmAuth {\n    return this.forBitbucket(bitbucketAuthApi, {\n      host: options.host,\n      scopeMapping: {\n        default: options.scopeMapping?.default ?? ['PUBLIC_REPOS', 'REPO_READ'],\n        repoWrite: options.scopeMapping?.repoWrite ?? ['REPO_WRITE'],\n      },\n    });\n  }\n\n  /**\n   * Merges together multiple ScmAuth instances into one that\n   * routes requests to the correct instance based on the URL.\n   */\n  static merge(...providers: ScmAuth[]): ScmAuthApi {\n    return new ScmAuthMux(providers);\n  }\n\n  #api: OAuthApi;\n  #host: string;\n  #scopeMapping: ScopeMapping;\n  #providerName: ProviderName;\n\n  private constructor(\n    providerName: ProviderName,\n    api: OAuthApi,\n    host: string,\n    scopeMapping: ScopeMapping,\n  ) {\n    this.#api = api;\n    this.#host = host;\n    this.#scopeMapping = scopeMapping;\n    this.#providerName = providerName;\n  }\n\n  /**\n   * Checks whether the implementation is able to provide authentication for the given URL.\n   */\n  isUrlSupported(url: URL): boolean {\n    return url.host === this.#host;\n  }\n\n  private getAdditionalScopesForProvider(\n    additionalScopes: ScmAuthTokenOptions['additionalScope'],\n  ): string[] {\n    if (!additionalScopes?.customScopes || this.#providerName === 'generic') {\n      return [];\n    }\n\n    return additionalScopes.customScopes?.[this.#providerName] ?? [];\n  }\n\n  /**\n   * Fetches credentials for the given resource.\n   */\n  async getCredentials(\n    options: ScmAuthTokenOptions,\n  ): Promise<ScmAuthTokenResponse> {\n    const { url, additionalScope, ...restOptions } = options;\n\n    const scopes = this.#scopeMapping.default.slice();\n    if (additionalScope?.repoWrite) {\n      scopes.push(...this.#scopeMapping.repoWrite);\n    }\n\n    const additionalScopes =\n      this.getAdditionalScopesForProvider(additionalScope);\n\n    if (additionalScopes.length) {\n      scopes.push(...additionalScopes);\n    }\n\n    const uniqueScopes = [...new Set(scopes)];\n\n    const token = await this.#api.getAccessToken(uniqueScopes, restOptions);\n\n    return {\n      token,\n      headers: {\n        Authorization: `Bearer ${token}`,\n      },\n    };\n  }\n}\n"],"names":[],"mappings":"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"}