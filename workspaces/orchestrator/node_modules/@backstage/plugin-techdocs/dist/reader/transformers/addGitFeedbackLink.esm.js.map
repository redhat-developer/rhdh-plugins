{"version":3,"file":"addGitFeedbackLink.esm.js","sources":["../../../src/reader/transformers/addGitFeedbackLink.ts"],"sourcesContent":["/*\n * Copyright 2021 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport type { Transformer } from './transformer';\nimport {\n  replaceGithubUrlType,\n  ScmIntegrationRegistry,\n} from '@backstage/integration';\nimport FeedbackOutlinedIcon from '@material-ui/icons/FeedbackOutlined';\nimport { createElement } from 'react';\nimport parseGitUrl from 'git-url-parse';\nimport { renderReactElement } from './renderReactElement';\n\n// requires repo\nexport const addGitFeedbackLink = (\n  scmIntegrationsApi: ScmIntegrationRegistry,\n): Transformer => {\n  return dom => {\n    // attempting to use selectors that are more likely to be static as MkDocs updates over time\n    const sourceAnchor = dom.querySelector(\n      '[title=\"Edit this page\"]',\n    ) as HTMLAnchorElement;\n\n    // don't show if edit link not available in raw page\n    if (!sourceAnchor || !sourceAnchor.href) {\n      return dom;\n    }\n\n    const sourceURL = new URL(sourceAnchor.href);\n    const integration = scmIntegrationsApi.byUrl(sourceURL);\n\n    // don't show if can't identify edit link hostname as a gitlab/github hosting\n    if (integration?.type !== 'github' && integration?.type !== 'gitlab') {\n      return dom;\n    }\n\n    // topmost h1 only contains title for whole page\n    const title =\n      (dom.querySelector('article>h1') as HTMLElement)?.childNodes[0]\n        .textContent || '';\n    const issueTitle = encodeURIComponent(`Documentation Feedback: ${title}`);\n    const issueDesc = encodeURIComponent(\n      `Page source:\\n${sourceAnchor.href}\\n\\nFeedback:`,\n    );\n\n    // Convert GitHub edit url to blob type so it can be parsed by git-url-parse correctly\n    const gitUrl =\n      integration?.type === 'github'\n        ? replaceGithubUrlType(sourceURL.href, 'blob')\n        : sourceURL.href;\n    const gitInfo = parseGitUrl(gitUrl);\n    const repoPath = `/${gitInfo.organization}/${gitInfo.name}`;\n\n    const feedbackLink = sourceAnchor.cloneNode() as HTMLAnchorElement;\n    switch (integration?.type) {\n      case 'gitlab':\n        feedbackLink.href = `${sourceURL.origin}${repoPath}/issues/new?issue[title]=${issueTitle}&issue[description]=${issueDesc}`;\n        break;\n      case 'github':\n        feedbackLink.href = `${sourceURL.origin}${repoPath}/issues/new?title=${issueTitle}&body=${issueDesc}`;\n        break;\n      default:\n        return dom;\n    }\n    renderReactElement(createElement(FeedbackOutlinedIcon), feedbackLink);\n    feedbackLink.style.paddingLeft = '5px';\n    feedbackLink.title = 'Leave feedback for this page';\n    feedbackLink.id = 'git-feedback-link';\n    sourceAnchor?.insertAdjacentElement('beforebegin', feedbackLink);\n    return dom;\n  };\n};\n"],"names":[],"mappings":";;;;;;AA2BO,MAAM,kBAAA,GAAqB,CAChC,kBAAA,KACgB;AAChB,EAAA,OAAO,CAAA,GAAA,KAAO;AAEZ,IAAA,MAAM,eAAe,GAAA,CAAI,aAAA;AAAA,MACvB;AAAA,KACF;AAGA,IAAA,IAAI,CAAC,YAAA,IAAgB,CAAC,YAAA,CAAa,IAAA,EAAM;AACvC,MAAA,OAAO,GAAA;AAAA,IACT;AAEA,IAAA,MAAM,SAAA,GAAY,IAAI,GAAA,CAAI,YAAA,CAAa,IAAI,CAAA;AAC3C,IAAA,MAAM,WAAA,GAAc,kBAAA,CAAmB,KAAA,CAAM,SAAS,CAAA;AAGtD,IAAA,IAAI,WAAA,EAAa,IAAA,KAAS,QAAA,IAAY,WAAA,EAAa,SAAS,QAAA,EAAU;AACpE,MAAA,OAAO,GAAA;AAAA,IACT;AAGA,IAAA,MAAM,KAAA,GACH,IAAI,aAAA,CAAc,YAAY,GAAmB,UAAA,CAAW,CAAC,EAC3D,WAAA,IAAe,EAAA;AACpB,IAAA,MAAM,UAAA,GAAa,kBAAA,CAAmB,CAAA,wBAAA,EAA2B,KAAK,CAAA,CAAE,CAAA;AACxE,IAAA,MAAM,SAAA,GAAY,kBAAA;AAAA,MAChB,CAAA;AAAA,EAAiB,aAAa,IAAI;;AAAA,SAAA;AAAA,KACpC;AAGA,IAAA,MAAM,MAAA,GACJ,aAAa,IAAA,KAAS,QAAA,GAClB,qBAAqB,SAAA,CAAU,IAAA,EAAM,MAAM,CAAA,GAC3C,SAAA,CAAU,IAAA;AAChB,IAAA,MAAM,OAAA,GAAU,YAAY,MAAM,CAAA;AAClC,IAAA,MAAM,WAAW,CAAA,CAAA,EAAI,OAAA,CAAQ,YAAY,CAAA,CAAA,EAAI,QAAQ,IAAI,CAAA,CAAA;AAEzD,IAAA,MAAM,YAAA,GAAe,aAAa,SAAA,EAAU;AAC5C,IAAA,QAAQ,aAAa,IAAA;AAAM,MACzB,KAAK,QAAA;AACH,QAAA,YAAA,CAAa,IAAA,GAAO,GAAG,SAAA,CAAU,MAAM,GAAG,QAAQ,CAAA,yBAAA,EAA4B,UAAU,CAAA,oBAAA,EAAuB,SAAS,CAAA,CAAA;AACxH,QAAA;AAAA,MACF,KAAK,QAAA;AACH,QAAA,YAAA,CAAa,IAAA,GAAO,GAAG,SAAA,CAAU,MAAM,GAAG,QAAQ,CAAA,kBAAA,EAAqB,UAAU,CAAA,MAAA,EAAS,SAAS,CAAA,CAAA;AACnG,QAAA;AAAA,MACF;AACE,QAAA,OAAO,GAAA;AAAA;AAEX,IAAA,kBAAA,CAAmB,aAAA,CAAc,oBAAoB,CAAA,EAAG,YAAY,CAAA;AACpE,IAAA,YAAA,CAAa,MAAM,WAAA,GAAc,KAAA;AACjC,IAAA,YAAA,CAAa,KAAA,GAAQ,8BAAA;AACrB,IAAA,YAAA,CAAa,EAAA,GAAK,mBAAA;AAClB,IAAA,YAAA,EAAc,qBAAA,CAAsB,eAAe,YAAY,CAAA;AAC/D,IAAA,OAAO,GAAA;AAAA,EACT,CAAA;AACF;;;;"}