{"version":3,"file":"addBaseUrl.esm.js","sources":["../../../src/reader/transformers/addBaseUrl.ts"],"sourcesContent":["/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport { CompoundEntityRef } from '@backstage/catalog-model';\nimport { TechDocsStorageApi } from '../../api';\nimport type { Transformer } from './transformer';\n\ntype AddBaseUrlOptions = {\n  techdocsStorageApi: TechDocsStorageApi;\n  entityId: CompoundEntityRef;\n  path: string;\n};\n\n/**\n * TechDocs backend serves SVGs with text/plain content-type for security. This\n * helper determines if an SVG is being loaded from the backend, and thus needs\n * inlining to be displayed properly.\n */\nconst isSvgNeedingInlining = (\n  attrName: string,\n  attrVal: string,\n  apiOrigin: string,\n) => {\n  // Let's let the URL object do automatic parsing of the pathname for us\n  const pathname = new URL(attrVal, 'https://ignored.com').pathname;\n  const isSrcToSvg = attrName === 'src' && pathname.endsWith('.svg');\n\n  const isRelativeUrl = !attrVal.match(/^([a-z]*:)?\\/\\//i);\n  const pointsToOurBackend = attrVal.startsWith(apiOrigin);\n  return isSrcToSvg && (isRelativeUrl || pointsToOurBackend);\n};\n\nexport const addBaseUrl = ({\n  techdocsStorageApi,\n  entityId,\n  path,\n}: AddBaseUrlOptions): Transformer => {\n  return async dom => {\n    const apiOrigin = await techdocsStorageApi.getApiOrigin();\n\n    const updateDom = async <T extends Element>(\n      list: HTMLCollectionOf<T> | NodeListOf<T>,\n      attributeName: string,\n    ) => {\n      for (const elem of list) {\n        if (elem.hasAttribute(attributeName)) {\n          const elemAttribute = elem.getAttribute(attributeName);\n          if (!elemAttribute) return;\n\n          // Special handling for SVG images.\n          const newValue = await techdocsStorageApi.getBaseUrl(\n            elemAttribute,\n            entityId,\n            path,\n          );\n\n          if (isSvgNeedingInlining(attributeName, elemAttribute, apiOrigin)) {\n            try {\n              const svg = await fetch(newValue, { credentials: 'include' });\n              const svgContent = await svg.text();\n              elem.setAttribute(\n                attributeName,\n                `data:image/svg+xml;base64,${btoa(\n                  unescape(encodeURIComponent(svgContent)),\n                )}`,\n              );\n            } catch (e) {\n              elem.setAttribute('alt', `Error: ${elemAttribute}`);\n            }\n          } else {\n            elem.setAttribute(attributeName, newValue);\n          }\n        }\n      }\n    };\n\n    await Promise.all([\n      updateDom<HTMLImageElement>(dom.querySelectorAll('img'), 'src'),\n      updateDom<HTMLScriptElement>(dom.querySelectorAll('script'), 'src'),\n      updateDom<HTMLSourceElement>(dom.querySelectorAll('source'), 'src'),\n      updateDom<HTMLLinkElement>(dom.querySelectorAll('link'), 'href'),\n      updateDom<HTMLAnchorElement>(dom.querySelectorAll('a[download]'), 'href'),\n    ]);\n\n    return dom;\n  };\n};\n"],"names":[],"mappings":"AA8BA,MAAM,oBAAA,GAAuB,CAC3B,QAAA,EACA,OAAA,EACA,SAAA,KACG;AAEH,EAAA,MAAM,QAAA,GAAW,IAAI,GAAA,CAAI,OAAA,EAAS,qBAAqB,CAAA,CAAE,QAAA;AACzD,EAAA,MAAM,UAAA,GAAa,QAAA,KAAa,KAAA,IAAS,QAAA,CAAS,SAAS,MAAM,CAAA;AAEjE,EAAA,MAAM,aAAA,GAAgB,CAAC,OAAA,CAAQ,KAAA,CAAM,kBAAkB,CAAA;AACvD,EAAA,MAAM,kBAAA,GAAqB,OAAA,CAAQ,UAAA,CAAW,SAAS,CAAA;AACvD,EAAA,OAAO,eAAe,aAAA,IAAiB,kBAAA,CAAA;AACzC,CAAA;AAEO,MAAM,aAAa,CAAC;AAAA,EACzB,kBAAA;AAAA,EACA,QAAA;AAAA,EACA;AACF,CAAA,KAAsC;AACpC,EAAA,OAAO,OAAM,GAAA,KAAO;AAClB,IAAA,MAAM,SAAA,GAAY,MAAM,kBAAA,CAAmB,YAAA,EAAa;AAExD,IAAA,MAAM,SAAA,GAAY,OAChB,IAAA,EACA,aAAA,KACG;AACH,MAAA,KAAA,MAAW,QAAQ,IAAA,EAAM;AACvB,QAAA,IAAI,IAAA,CAAK,YAAA,CAAa,aAAa,CAAA,EAAG;AACpC,UAAA,MAAM,aAAA,GAAgB,IAAA,CAAK,YAAA,CAAa,aAAa,CAAA;AACrD,UAAA,IAAI,CAAC,aAAA,EAAe;AAGpB,UAAA,MAAM,QAAA,GAAW,MAAM,kBAAA,CAAmB,UAAA;AAAA,YACxC,aAAA;AAAA,YACA,QAAA;AAAA,YACA;AAAA,WACF;AAEA,UAAA,IAAI,oBAAA,CAAqB,aAAA,EAAe,aAAA,EAAe,SAAS,CAAA,EAAG;AACjE,YAAA,IAAI;AACF,cAAA,MAAM,MAAM,MAAM,KAAA,CAAM,UAAU,EAAE,WAAA,EAAa,WAAW,CAAA;AAC5D,cAAA,MAAM,UAAA,GAAa,MAAM,GAAA,CAAI,IAAA,EAAK;AAClC,cAAA,IAAA,CAAK,YAAA;AAAA,gBACH,aAAA;AAAA,gBACA,CAAA,0BAAA,EAA6B,IAAA;AAAA,kBAC3B,QAAA,CAAS,kBAAA,CAAmB,UAAU,CAAC;AAAA,iBACxC,CAAA;AAAA,eACH;AAAA,YACF,SAAS,CAAA,EAAG;AACV,cAAA,IAAA,CAAK,YAAA,CAAa,KAAA,EAAO,CAAA,OAAA,EAAU,aAAa,CAAA,CAAE,CAAA;AAAA,YACpD;AAAA,UACF,CAAA,MAAO;AACL,YAAA,IAAA,CAAK,YAAA,CAAa,eAAe,QAAQ,CAAA;AAAA,UAC3C;AAAA,QACF;AAAA,MACF;AAAA,IACF,CAAA;AAEA,IAAA,MAAM,QAAQ,GAAA,CAAI;AAAA,MAChB,SAAA,CAA4B,GAAA,CAAI,gBAAA,CAAiB,KAAK,GAAG,KAAK,CAAA;AAAA,MAC9D,SAAA,CAA6B,GAAA,CAAI,gBAAA,CAAiB,QAAQ,GAAG,KAAK,CAAA;AAAA,MAClE,SAAA,CAA6B,GAAA,CAAI,gBAAA,CAAiB,QAAQ,GAAG,KAAK,CAAA;AAAA,MAClE,SAAA,CAA2B,GAAA,CAAI,gBAAA,CAAiB,MAAM,GAAG,MAAM,CAAA;AAAA,MAC/D,SAAA,CAA6B,GAAA,CAAI,gBAAA,CAAiB,aAAa,GAAG,MAAM;AAAA,KACzE,CAAA;AAED,IAAA,OAAO,GAAA;AAAA,EACT,CAAA;AACF;;;;"}