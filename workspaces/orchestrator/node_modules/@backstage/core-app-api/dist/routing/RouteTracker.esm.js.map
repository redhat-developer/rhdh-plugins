{"version":3,"file":"RouteTracker.esm.js","sources":["../../src/routing/RouteTracker.tsx"],"sourcesContent":["/*\n * Copyright 2021 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { useEffect } from 'react';\nimport { matchRoutes, useLocation } from 'react-router-dom';\nimport {\n  useAnalytics,\n  AnalyticsContext,\n  RouteRef,\n  AnalyticsEventAttributes,\n  BackstagePlugin,\n} from '@backstage/core-plugin-api';\nimport { BackstageRouteObject } from './types';\n\n/**\n * Returns an extension context given the current pathname and a list of\n * Backstage route objects.\n */\nconst getExtensionContext = (\n  pathname: string,\n  routes: BackstageRouteObject[],\n) => {\n  try {\n    // Find matching routes for the given path name.\n    const matches = matchRoutes(routes, { pathname });\n\n    // Of the matching routes, get the last (e.g. most specific) instance of\n    // the BackstageRouteObject that contains a routeRef. Filtering by routeRef\n    // ensures subRouteRefs are aligned to their parent routes' context.\n    const routeMatch = matches\n      ?.filter(match => match?.route.routeRefs?.size > 0)\n      .pop();\n    const routeObject = routeMatch?.route;\n\n    // If there is no route object, then allow inheritance of default context.\n    if (!routeObject) {\n      return undefined;\n    }\n\n    // If the matched route is the root route (no path), and the pathname is\n    // not the path of the homepage, then inherit from the default context.\n    if (routeObject.path === '' && pathname !== '/') {\n      return undefined;\n    }\n\n    // If there is a single route ref, use it.\n    let routeRef: RouteRef | undefined;\n    if (routeObject.routeRefs.size === 1) {\n      routeRef = routeObject.routeRefs.values().next().value;\n    }\n\n    // If there is a single plugin, use it.\n    let plugin: BackstagePlugin | undefined;\n    if (routeObject.plugins.size === 1) {\n      plugin = routeObject.plugins.values().next().value;\n    }\n\n    const params = Object.entries(\n      routeMatch?.params || {},\n    ).reduce<AnalyticsEventAttributes>((acc, [key, value]) => {\n      if (value !== undefined && key !== '*') {\n        acc[key] = value;\n      }\n      return acc;\n    }, {});\n\n    return {\n      extension: 'App',\n      pluginId: plugin?.getId() || 'root',\n      ...(routeRef ? { routeRef: (routeRef as { id?: string }).id } : {}),\n      _routeNodeType: routeObject.element as string,\n      params,\n    };\n  } catch {\n    return undefined;\n  }\n};\n\n/**\n * Performs the actual event capture on render.\n */\nconst TrackNavigation = ({\n  pathname,\n  search,\n  hash,\n  attributes,\n}: {\n  pathname: string;\n  search: string;\n  hash: string;\n  attributes?: AnalyticsEventAttributes;\n}) => {\n  const analytics = useAnalytics();\n  useEffect(() => {\n    analytics.captureEvent('navigate', `${pathname}${search}${hash}`, {\n      attributes,\n    });\n  }, [analytics, pathname, search, hash, attributes]);\n\n  return null;\n};\n\n/**\n * Logs a \"navigate\" event with appropriate plugin-level analytics context\n * attributes each time the user navigates to a page.\n */\nexport const RouteTracker = ({\n  routeObjects,\n}: {\n  routeObjects: BackstageRouteObject[];\n}) => {\n  const { pathname, search, hash } = useLocation();\n\n  const { params, ...attributes } = getExtensionContext(\n    pathname,\n    routeObjects,\n  ) || { params: {} };\n\n  return (\n    <AnalyticsContext attributes={attributes}>\n      <TrackNavigation\n        pathname={pathname}\n        search={search}\n        hash={hash}\n        attributes={params}\n      />\n    </AnalyticsContext>\n  );\n};\n"],"names":[],"mappings":"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"}