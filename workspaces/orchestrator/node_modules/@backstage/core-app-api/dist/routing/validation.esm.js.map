{"version":3,"file":"validation.esm.js","sources":["../../src/routing/validation.ts"],"sourcesContent":["/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  BackstagePlugin,\n  ExternalRouteRef,\n  RouteRef,\n  SubRouteRef,\n} from '@backstage/core-plugin-api';\nimport { joinPaths } from './helpers';\nimport { AnyRouteRef } from './types';\n\n// Validates that there is no duplication of route parameter names\nexport function validateRouteParameters(\n  routePaths: Map<AnyRouteRef, string>,\n  routeParents: Map<AnyRouteRef, AnyRouteRef | undefined>,\n) {\n  const notLeafRoutes = new Set(routeParents.values());\n  notLeafRoutes.delete(undefined);\n\n  for (const route of routeParents.keys()) {\n    if (notLeafRoutes.has(route)) {\n      continue;\n    }\n\n    let currentRouteRef: AnyRouteRef | undefined = route;\n\n    let fullPath = '';\n    while (currentRouteRef) {\n      const path = routePaths.get(currentRouteRef);\n      if (path === undefined) {\n        throw new Error(`No path for ${currentRouteRef}`);\n      }\n      fullPath = joinPaths(path, fullPath);\n      currentRouteRef = routeParents.get(currentRouteRef);\n    }\n\n    const params = fullPath.match(/:(\\w+)/g);\n    if (params) {\n      for (let j = 0; j < params.length; j++) {\n        for (let i = j + 1; i < params.length; i++) {\n          if (params[i] === params[j]) {\n            throw new Error(\n              `Parameter ${params[i]} is duplicated in path ${fullPath}`,\n            );\n          }\n        }\n      }\n    }\n  }\n}\n\n// Validates that all non-optional external routes have been bound\nexport function validateRouteBindings(\n  routeBindings: Map<ExternalRouteRef, RouteRef | SubRouteRef>,\n  plugins: Iterable<\n    Pick<\n      BackstagePlugin<{}, Record<string, ExternalRouteRef>>,\n      'getId' | 'externalRoutes'\n    >\n  >,\n) {\n  for (const plugin of plugins) {\n    if (!plugin.externalRoutes) {\n      continue;\n    }\n\n    for (const [name, externalRouteRef] of Object.entries(\n      plugin.externalRoutes,\n    )) {\n      if (externalRouteRef.optional) {\n        continue;\n      }\n\n      if (!routeBindings.has(externalRouteRef)) {\n        throw new Error(\n          `External route '${name}' of the '${plugin.getId()}' plugin must be bound to a target route. ` +\n            'See https://backstage.io/link?bind-routes for details.',\n        );\n      }\n    }\n  }\n}\n"],"names":[],"mappings":";;AA0BO,SAAS,uBAAA,CACd,YACA,YAAA,EACA;AACA,EAAA,MAAM,aAAA,GAAgB,IAAI,GAAA,CAAI,YAAA,CAAa,QAAQ,CAAA;AACnD,EAAA,aAAA,CAAc,OAAO,MAAS,CAAA;AAE9B,EAAA,KAAA,MAAW,KAAA,IAAS,YAAA,CAAa,IAAA,EAAK,EAAG;AACvC,IAAA,IAAI,aAAA,CAAc,GAAA,CAAI,KAAK,CAAA,EAAG;AAC5B,MAAA;AAAA,IACF;AAEA,IAAA,IAAI,eAAA,GAA2C,KAAA;AAE/C,IAAA,IAAI,QAAA,GAAW,EAAA;AACf,IAAA,OAAO,eAAA,EAAiB;AACtB,MAAA,MAAM,IAAA,GAAO,UAAA,CAAW,GAAA,CAAI,eAAe,CAAA;AAC3C,MAAA,IAAI,SAAS,MAAA,EAAW;AACtB,QAAA,MAAM,IAAI,KAAA,CAAM,CAAA,YAAA,EAAe,eAAe,CAAA,CAAE,CAAA;AAAA,MAClD;AACA,MAAA,QAAA,GAAW,SAAA,CAAU,MAAM,QAAQ,CAAA;AACnC,MAAA,eAAA,GAAkB,YAAA,CAAa,IAAI,eAAe,CAAA;AAAA,IACpD;AAEA,IAAA,MAAM,MAAA,GAAS,QAAA,CAAS,KAAA,CAAM,SAAS,CAAA;AACvC,IAAA,IAAI,MAAA,EAAQ;AACV,MAAA,KAAA,IAAS,CAAA,GAAI,CAAA,EAAG,CAAA,GAAI,MAAA,CAAO,QAAQ,CAAA,EAAA,EAAK;AACtC,QAAA,KAAA,IAAS,IAAI,CAAA,GAAI,CAAA,EAAG,CAAA,GAAI,MAAA,CAAO,QAAQ,CAAA,EAAA,EAAK;AAC1C,UAAA,IAAI,MAAA,CAAO,CAAC,CAAA,KAAM,MAAA,CAAO,CAAC,CAAA,EAAG;AAC3B,YAAA,MAAM,IAAI,KAAA;AAAA,cACR,CAAA,UAAA,EAAa,MAAA,CAAO,CAAC,CAAC,0BAA0B,QAAQ,CAAA;AAAA,aAC1D;AAAA,UACF;AAAA,QACF;AAAA,MACF;AAAA,IACF;AAAA,EACF;AACF;AAGO,SAAS,qBAAA,CACd,eACA,OAAA,EAMA;AACA,EAAA,KAAA,MAAW,UAAU,OAAA,EAAS;AAC5B,IAAA,IAAI,CAAC,OAAO,cAAA,EAAgB;AAC1B,MAAA;AAAA,IACF;AAEA,IAAA,KAAA,MAAW,CAAC,IAAA,EAAM,gBAAgB,CAAA,IAAK,MAAA,CAAO,OAAA;AAAA,MAC5C,MAAA,CAAO;AAAA,KACT,EAAG;AACD,MAAA,IAAI,iBAAiB,QAAA,EAAU;AAC7B,QAAA;AAAA,MACF;AAEA,MAAA,IAAI,CAAC,aAAA,CAAc,GAAA,CAAI,gBAAgB,CAAA,EAAG;AACxC,QAAA,MAAM,IAAI,KAAA;AAAA,UACR,CAAA,gBAAA,EAAmB,IAAI,CAAA,UAAA,EAAa,MAAA,CAAO,OAAO,CAAA,gGAAA;AAAA,SAEpD;AAAA,MACF;AAAA,IACF;AAAA,EACF;AACF;;;;"}