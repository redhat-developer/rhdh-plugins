{"version":3,"file":"defaultConfigLoader.esm.js","sources":["../../src/app/defaultConfigLoader.ts"],"sourcesContent":["/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { AppConfig } from '@backstage/config';\nimport { JsonObject } from '@backstage/types';\nimport { AppConfigLoader } from './types';\n\n/**\n * The default config loader, which expects that config is available at compile-time\n * in `process.env.APP_CONFIG`. APP_CONFIG should be an array of config objects as\n * returned by the config loader.\n *\n * It will also load runtime config from the __APP_INJECTED_RUNTIME_CONFIG__ string,\n * which can be rewritten at runtime to contain an additional JSON config object.\n * If runtime config is present, it will be placed first in the config array, overriding\n * other config values.\n *\n * @public\n */\nexport const defaultConfigLoader: AppConfigLoader = async () =>\n  defaultConfigLoaderSync();\n\n/** @internal */\nexport function defaultConfigLoaderSync(\n  // This string may be replaced at runtime to provide additional config.\n  // It should be replaced by a JSON-serialized config object.\n  // It's a param so we can test it, but at runtime this will always fall back to default.\n  runtimeConfigJson: string = '__APP_INJECTED_RUNTIME_CONFIG__',\n) {\n  const configs = new Array<AppConfig>();\n\n  const staticConfig = process.env.APP_CONFIG;\n  if (staticConfig) {\n    if (!Array.isArray(staticConfig)) {\n      throw new Error('Static configuration has invalid format');\n    }\n    configs.push(...staticConfig);\n  }\n\n  // Check if we have any config script tags, otherwise fall back to injected config\n  const configScripts = document.querySelectorAll(\n    'script[type=\"backstage.io/config\"]',\n  );\n  if (configScripts.length > 0) {\n    for (const el of configScripts) {\n      try {\n        const content = el.textContent;\n        if (!content) {\n          throw new Error('tag is empty');\n        }\n        let data;\n        try {\n          data = JSON.parse(content);\n        } catch (error) {\n          throw new Error(`failed to parse config; ${error}`);\n        }\n        if (!Array.isArray(data)) {\n          throw new Error('data is not an array');\n        }\n        configs.push(...data);\n      } catch (error) {\n        throw new Error(\n          `Failed to load config from script tag, ${error.message}`,\n        );\n      }\n    }\n  } else if (\n    runtimeConfigJson !==\n    // Avoiding this string also being replaced at runtime\n    '__app_injected_runtime_config__'.toLocaleUpperCase('en-US')\n  ) {\n    try {\n      const data = JSON.parse(runtimeConfigJson) as JsonObject;\n      if (Array.isArray(data)) {\n        configs.push(...data);\n      } else {\n        configs.push({ data, context: 'env' });\n      }\n    } catch (error) {\n      throw new Error(`Failed to load runtime configuration, ${error}`);\n    }\n  }\n\n  const windowAppConfig = (window as any).__APP_CONFIG__;\n  if (windowAppConfig) {\n    configs.push({\n      context: 'window',\n      data: windowAppConfig,\n    });\n  }\n  return configs;\n}\n"],"names":[],"mappings":"AAgCO,MAAM,mBAAA,GAAuC,YAClD,uBAAA;AAGK,SAAS,uBAAA,CAId,oBAA4B,iCAAA,EAC5B;AACA,EAAA,MAAM,OAAA,GAAU,IAAI,KAAA,EAAiB;AAErC,EAAA,MAAM,YAAA,GAAe,QAAQ,GAAA,CAAI,UAAA;AACjC,EAAA,IAAI,YAAA,EAAc;AAChB,IAAA,IAAI,CAAC,KAAA,CAAM,OAAA,CAAQ,YAAY,CAAA,EAAG;AAChC,MAAA,MAAM,IAAI,MAAM,yCAAyC,CAAA;AAAA,IAC3D;AACA,IAAA,OAAA,CAAQ,IAAA,CAAK,GAAG,YAAY,CAAA;AAAA,EAC9B;AAGA,EAAA,MAAM,gBAAgB,QAAA,CAAS,gBAAA;AAAA,IAC7B;AAAA,GACF;AACA,EAAA,IAAI,aAAA,CAAc,SAAS,CAAA,EAAG;AAC5B,IAAA,KAAA,MAAW,MAAM,aAAA,EAAe;AAC9B,MAAA,IAAI;AACF,QAAA,MAAM,UAAU,EAAA,CAAG,WAAA;AACnB,QAAA,IAAI,CAAC,OAAA,EAAS;AACZ,UAAA,MAAM,IAAI,MAAM,cAAc,CAAA;AAAA,QAChC;AACA,QAAA,IAAI,IAAA;AACJ,QAAA,IAAI;AACF,UAAA,IAAA,GAAO,IAAA,CAAK,MAAM,OAAO,CAAA;AAAA,QAC3B,SAAS,KAAA,EAAO;AACd,UAAA,MAAM,IAAI,KAAA,CAAM,CAAA,wBAAA,EAA2B,KAAK,CAAA,CAAE,CAAA;AAAA,QACpD;AACA,QAAA,IAAI,CAAC,KAAA,CAAM,OAAA,CAAQ,IAAI,CAAA,EAAG;AACxB,UAAA,MAAM,IAAI,MAAM,sBAAsB,CAAA;AAAA,QACxC;AACA,QAAA,OAAA,CAAQ,IAAA,CAAK,GAAG,IAAI,CAAA;AAAA,MACtB,SAAS,KAAA,EAAO;AACd,QAAA,MAAM,IAAI,KAAA;AAAA,UACR,CAAA,uCAAA,EAA0C,MAAM,OAAO,CAAA;AAAA,SACzD;AAAA,MACF;AAAA,IACF;AAAA,EACF,CAAA,MAAA,IACE,iBAAA;AAAA,EAEA,iCAAA,CAAkC,iBAAA,CAAkB,OAAO,CAAA,EAC3D;AACA,IAAA,IAAI;AACF,MAAA,MAAM,IAAA,GAAO,IAAA,CAAK,KAAA,CAAM,iBAAiB,CAAA;AACzC,MAAA,IAAI,KAAA,CAAM,OAAA,CAAQ,IAAI,CAAA,EAAG;AACvB,QAAA,OAAA,CAAQ,IAAA,CAAK,GAAG,IAAI,CAAA;AAAA,MACtB,CAAA,MAAO;AACL,QAAA,OAAA,CAAQ,IAAA,CAAK,EAAE,IAAA,EAAM,OAAA,EAAS,OAAO,CAAA;AAAA,MACvC;AAAA,IACF,SAAS,KAAA,EAAO;AACd,MAAA,MAAM,IAAI,KAAA,CAAM,CAAA,sCAAA,EAAyC,KAAK,CAAA,CAAE,CAAA;AAAA,IAClE;AAAA,EACF;AAEA,EAAA,MAAM,kBAAmB,MAAA,CAAe,cAAA;AACxC,EAAA,IAAI,eAAA,EAAiB;AACnB,IAAA,OAAA,CAAQ,IAAA,CAAK;AAAA,MACX,OAAA,EAAS,QAAA;AAAA,MACT,IAAA,EAAM;AAAA,KACP,CAAA;AAAA,EACH;AACA,EAAA,OAAO,OAAA;AACT;;;;"}