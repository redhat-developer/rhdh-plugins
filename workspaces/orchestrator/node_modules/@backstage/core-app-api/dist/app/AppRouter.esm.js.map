{"version":3,"file":"AppRouter.esm.js","sources":["../../src/app/AppRouter.tsx"],"sourcesContent":["/*\n * Copyright 2022 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { useContext, ReactNode, ComponentType, useState } from 'react';\nimport {\n  attachComponentData,\n  ConfigApi,\n  configApiRef,\n  IdentityApi,\n  SignInPageProps,\n  useApi,\n  useApp,\n} from '@backstage/core-plugin-api';\nimport { InternalAppContext } from './InternalAppContext';\nimport { isReactRouterBeta } from './isReactRouterBeta';\nimport { RouteTracker } from '../routing/RouteTracker';\nimport { Route, Routes } from 'react-router-dom';\nimport { AppIdentityProxy } from '../apis/implementations/IdentityApi/AppIdentityProxy';\n\n/**\n * Get the app base path from the configured app baseUrl.\n *\n * The returned path does not have a trailing slash.\n */\nexport function getBasePath(configApi: ConfigApi) {\n  if (!isReactRouterBeta()) {\n    // When using rr v6 stable the base path is handled through the\n    // basename prop on the router component instead.\n    return '';\n  }\n\n  return readBasePath(configApi);\n}\n\n/**\n * Read the configured base path.\n *\n * The returned path does not have a trailing slash.\n */\nfunction readBasePath(configApi: ConfigApi) {\n  let { pathname } = new URL(\n    configApi.getOptionalString('app.baseUrl') ?? '/',\n    'http://sample.dev', // baseUrl can be specified as just a path\n  );\n  pathname = pathname.replace(/\\/*$/, '');\n  return pathname;\n}\n\n// This wraps the sign-in page and waits for sign-in to be completed before rendering the app\nfunction SignInPageWrapper({\n  component: Component,\n  appIdentityProxy,\n  children,\n}: {\n  component: ComponentType<SignInPageProps>;\n  appIdentityProxy: AppIdentityProxy;\n  children: ReactNode;\n}) {\n  const [identityApi, setIdentityApi] = useState<IdentityApi>();\n  const configApi = useApi(configApiRef);\n  const basePath = readBasePath(configApi);\n\n  if (!identityApi) {\n    return <Component onSignInSuccess={setIdentityApi} />;\n  }\n\n  appIdentityProxy.setTarget(identityApi, {\n    signOutTargetUrl: basePath || '/',\n  });\n  return <>{children}</>;\n}\n\n/**\n * Props for the {@link AppRouter} component.\n * @public\n */\nexport interface AppRouterProps {\n  children?: ReactNode;\n}\n\n/**\n * App router and sign-in page wrapper.\n *\n * @public\n * @remarks\n *\n * The AppRouter provides the routing context and renders the sign-in page.\n * Until the user has successfully signed in, this component will render\n * the sign-in page. Once the user has signed-in, it will instead render\n * the app, while providing routing and route tracking for the app.\n */\nexport function AppRouter(props: AppRouterProps) {\n  const { Router: RouterComponent, SignInPage: SignInPageComponent } =\n    useApp().getComponents();\n\n  const configApi = useApi(configApiRef);\n  const basePath = readBasePath(configApi);\n  const mountPath = `${basePath}/*`;\n  const internalAppContext = useContext(InternalAppContext);\n  if (!internalAppContext) {\n    throw new Error('AppRouter must be rendered within the AppProvider');\n  }\n  const { routeObjects, appIdentityProxy } = internalAppContext;\n\n  // If the app hasn't configured a sign-in page, we just continue as guest.\n  if (!SignInPageComponent) {\n    appIdentityProxy.setTarget(\n      {\n        getUserId: () => 'guest',\n        getIdToken: async () => undefined,\n        getProfile: () => ({\n          email: 'guest@example.com',\n          displayName: 'Guest',\n        }),\n        getProfileInfo: async () => ({\n          email: 'guest@example.com',\n          displayName: 'Guest',\n        }),\n        getBackstageIdentity: async () => ({\n          type: 'user',\n          userEntityRef: 'user:default/guest',\n          ownershipEntityRefs: ['user:default/guest'],\n        }),\n        getCredentials: async () => ({}),\n        signOut: async () => {},\n      },\n      { signOutTargetUrl: basePath || '/' },\n    );\n\n    if (isReactRouterBeta()) {\n      return (\n        <RouterComponent>\n          <RouteTracker routeObjects={routeObjects} />\n          <Routes>\n            <Route path={mountPath} element={<>{props.children}</>} />\n          </Routes>\n        </RouterComponent>\n      );\n    }\n\n    return (\n      <RouterComponent basename={basePath}>\n        <RouteTracker routeObjects={routeObjects} />\n        {props.children}\n      </RouterComponent>\n    );\n  }\n\n  if (isReactRouterBeta()) {\n    return (\n      <RouterComponent>\n        <RouteTracker routeObjects={routeObjects} />\n        <SignInPageWrapper\n          component={SignInPageComponent}\n          appIdentityProxy={appIdentityProxy}\n        >\n          <Routes>\n            <Route path={mountPath} element={<>{props.children}</>} />\n          </Routes>\n        </SignInPageWrapper>\n      </RouterComponent>\n    );\n  }\n\n  return (\n    <RouterComponent basename={basePath}>\n      <RouteTracker routeObjects={routeObjects} />\n      <SignInPageWrapper\n        component={SignInPageComponent}\n        appIdentityProxy={appIdentityProxy}\n      >\n        {props.children}\n      </SignInPageWrapper>\n    </RouterComponent>\n  );\n}\n\nattachComponentData(AppRouter, 'core.type', 'AppRouter');\n"],"names":[],"mappings":"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"}