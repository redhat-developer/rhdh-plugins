{"version":3,"file":"AppIdentityProxy.esm.js","sources":["../../../../src/apis/implementations/IdentityApi/AppIdentityProxy.ts"],"sourcesContent":["/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  IdentityApi,\n  ProfileInfo,\n  BackstageUserIdentity,\n  ErrorApi,\n  DiscoveryApi,\n  FetchApi,\n} from '@backstage/core-plugin-api';\nimport { startCookieAuthRefresh } from './startCookieAuthRefresh';\n\nfunction mkError(thing: string) {\n  return new Error(\n    `Tried to access IdentityApi ${thing} before app was loaded`,\n  );\n}\n\nfunction logDeprecation(thing: string) {\n  // eslint-disable-next-line no-console\n  console.warn(\n    `WARNING: Call to ${thing} is deprecated and will break in the future`,\n  );\n}\n\n// We use this for a period of backwards compatibility. It is a hidden\n// compatibility that will allow old plugins to continue working for a limited time.\ntype CompatibilityIdentityApi = IdentityApi & {\n  getUserId?(): string;\n  getIdToken?(): Promise<string | undefined>;\n  getProfile?(): ProfileInfo;\n};\n\n/**\n * Implementation of the connection between the App-wide IdentityApi\n * and sign-in page.\n */\nexport class AppIdentityProxy implements IdentityApi {\n  private target?: CompatibilityIdentityApi;\n  private waitForTarget: Promise<CompatibilityIdentityApi>;\n  private resolveTarget: (api: CompatibilityIdentityApi) => void = () => {};\n  private signOutTargetUrl = '/';\n\n  #cookieAuthSignOut?: () => Promise<void>;\n\n  constructor() {\n    this.waitForTarget = new Promise<CompatibilityIdentityApi>(resolve => {\n      this.resolveTarget = resolve;\n    });\n  }\n\n  // This is called by the app manager once the sign-in page provides us with an implementation\n  setTarget(\n    identityApi: CompatibilityIdentityApi,\n    targetOptions: { signOutTargetUrl: string },\n  ) {\n    this.target = identityApi;\n    this.signOutTargetUrl = targetOptions.signOutTargetUrl;\n    this.resolveTarget(identityApi);\n  }\n\n  getUserId(): string {\n    if (!this.target) {\n      throw mkError('getUserId');\n    }\n    if (!this.target.getUserId) {\n      throw new Error('IdentityApi does not implement getUserId');\n    }\n    logDeprecation('getUserId');\n    return this.target.getUserId();\n  }\n\n  getProfile(): ProfileInfo {\n    if (!this.target) {\n      throw mkError('getProfile');\n    }\n    if (!this.target.getProfile) {\n      throw new Error('IdentityApi does not implement getProfile');\n    }\n    logDeprecation('getProfile');\n    return this.target.getProfile();\n  }\n\n  async getProfileInfo(): Promise<ProfileInfo> {\n    return this.waitForTarget.then(target => target.getProfileInfo());\n  }\n\n  async getBackstageIdentity(): Promise<BackstageUserIdentity> {\n    const identity = await this.waitForTarget.then(target =>\n      target.getBackstageIdentity(),\n    );\n    if (!identity.userEntityRef.match(/^.*:.*\\/.*$/)) {\n      // eslint-disable-next-line no-console\n      console.warn(\n        `WARNING: The App IdentityApi provided an invalid userEntityRef, '${identity.userEntityRef}'. ` +\n          `It must be a full Entity Reference of the form '<kind>:<namespace>/<name>'.`,\n      );\n    }\n\n    return identity;\n  }\n\n  async getCredentials(): Promise<{ token?: string | undefined }> {\n    return this.waitForTarget.then(target => target.getCredentials());\n  }\n\n  async getIdToken(): Promise<string | undefined> {\n    return this.waitForTarget.then(target => {\n      if (!target.getIdToken) {\n        throw new Error('IdentityApi does not implement getIdToken');\n      }\n      logDeprecation('getIdToken');\n      return target.getIdToken();\n    });\n  }\n\n  async signOut(): Promise<void> {\n    await this.waitForTarget.then(target => target.signOut());\n\n    await this.#cookieAuthSignOut?.();\n\n    window.location.href = this.signOutTargetUrl;\n  }\n\n  enableCookieAuth(ctx: {\n    errorApi: ErrorApi;\n    fetchApi: FetchApi;\n    discoveryApi: DiscoveryApi;\n  }) {\n    if (this.#cookieAuthSignOut) {\n      return;\n    }\n\n    const stopRefresh = startCookieAuthRefresh(ctx);\n\n    this.#cookieAuthSignOut = async () => {\n      stopRefresh();\n\n      // It is fine if we do NOT worry yet about deleting cookies for OTHER backends like techdocs\n      const appBaseUrl = await ctx.discoveryApi.getBaseUrl('app');\n      try {\n        await fetch(`${appBaseUrl}/.backstage/auth/v1/cookie`, {\n          method: 'DELETE',\n          credentials: 'include',\n        });\n      } catch {\n        // Ignore the error for those who use static serving of the frontend\n      }\n    };\n  }\n}\n"],"names":[],"mappings":"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"}