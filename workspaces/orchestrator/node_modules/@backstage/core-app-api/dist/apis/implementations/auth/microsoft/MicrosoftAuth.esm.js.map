{"version":3,"file":"MicrosoftAuth.esm.js","sources":["../../../../../src/apis/implementations/auth/microsoft/MicrosoftAuth.ts"],"sourcesContent":["/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  microsoftAuthApiRef,\n  AuthRequestOptions,\n  AuthProviderInfo,\n  ConfigApi,\n  DiscoveryApi,\n  OAuthRequestApi,\n} from '@backstage/core-plugin-api';\nimport { OAuth2, OAuth2CreateOptions } from '../oauth2';\n\nconst DEFAULT_PROVIDER = {\n  id: 'microsoft',\n  title: 'Microsoft',\n  icon: () => null,\n};\n\n/**\n * Implements the OAuth flow to Microsoft products.\n *\n * @public\n */\nexport default class MicrosoftAuth {\n  private oauth2: { [aud: string]: OAuth2 };\n  private configApi: ConfigApi | undefined;\n  private environment: string;\n  private provider: AuthProviderInfo;\n  private oauthRequestApi: OAuthRequestApi;\n  private discoveryApi: DiscoveryApi;\n  private scopeTransform: (scopes: string[]) => string[];\n\n  private static MicrosoftGraphID = '00000003-0000-0000-c000-000000000000';\n\n  static create(options: OAuth2CreateOptions): typeof microsoftAuthApiRef.T {\n    return new MicrosoftAuth(options);\n  }\n  private constructor(options: OAuth2CreateOptions) {\n    const {\n      configApi,\n      environment = 'development',\n      provider = DEFAULT_PROVIDER,\n      oauthRequestApi,\n      discoveryApi,\n      defaultScopes = [\n        'openid',\n        'offline_access',\n        'profile',\n        'email',\n        'User.Read',\n      ],\n      scopeTransform = scopes => scopes.concat('offline_access'),\n    } = options;\n\n    this.configApi = configApi;\n    this.environment = environment;\n    this.provider = provider;\n    this.oauthRequestApi = oauthRequestApi;\n    this.discoveryApi = discoveryApi;\n    this.scopeTransform = scopeTransform;\n\n    this.oauth2 = {\n      [MicrosoftAuth.MicrosoftGraphID]: OAuth2.create({\n        configApi: this.configApi,\n        discoveryApi: this.discoveryApi,\n        oauthRequestApi: this.oauthRequestApi,\n        provider: this.provider,\n        environment: this.environment,\n        scopeTransform: this.scopeTransform,\n        defaultScopes,\n      }),\n    };\n  }\n\n  private microsoftGraph(): OAuth2 {\n    return this.oauth2[MicrosoftAuth.MicrosoftGraphID];\n  }\n\n  private static resourceForScopes(scope: string): Promise<string> {\n    const audiences = [\n      ...new Set(\n        scope\n          .split(' ')\n          .map(MicrosoftAuth.resourceForScope)\n          .filter(aud => aud !== 'openid'),\n      ),\n    ];\n\n    if (audiences.length > 1) {\n      return Promise.reject(\n        new Error(\n          `Requested access token with scopes from multiple Azure resources: ${audiences.join(\n            ', ',\n          )}. Access tokens can only have a single audience.`,\n        ),\n      );\n    }\n    const audience = audiences[0] ?? MicrosoftAuth.MicrosoftGraphID;\n    return Promise.resolve(audience);\n  }\n\n  private static resourceForScope(scope: string): string {\n    const groups = scope.match(/^(?<resourceURI>.*)\\/(?<scp>[^\\/]*)$/)?.groups;\n    if (groups) {\n      const { resourceURI } = groups;\n      const aud = resourceURI.replace(/^api:\\/\\//, '');\n      return aud;\n    }\n    switch (scope) {\n      case 'email':\n      case 'openid':\n      case 'offline_access':\n      case 'profile': {\n        return 'openid';\n      }\n      default:\n        return MicrosoftAuth.MicrosoftGraphID;\n    }\n  }\n\n  async getAccessToken(\n    scope?: string | string[],\n    options?: AuthRequestOptions,\n  ): Promise<string> {\n    const aud =\n      scope === undefined\n        ? MicrosoftAuth.MicrosoftGraphID\n        : await MicrosoftAuth.resourceForScopes(\n            Array.isArray(scope) ? scope.join(' ') : scope,\n          );\n    if (!(aud in this.oauth2)) {\n      this.oauth2[aud] = OAuth2.create({\n        configApi: this.configApi,\n        discoveryApi: this.discoveryApi,\n        oauthRequestApi: this.oauthRequestApi,\n        provider: this.provider,\n        environment: this.environment,\n        scopeTransform: this.scopeTransform,\n      });\n    }\n    return this.oauth2[aud].getAccessToken(scope, options);\n  }\n\n  getIdToken(options?: AuthRequestOptions) {\n    return this.microsoftGraph().getIdToken(options);\n  }\n\n  getProfile(options?: AuthRequestOptions) {\n    return this.microsoftGraph().getProfile(options);\n  }\n\n  getBackstageIdentity(options?: AuthRequestOptions) {\n    return this.microsoftGraph().getBackstageIdentity(options);\n  }\n\n  signIn() {\n    return this.microsoftGraph().signIn();\n  }\n\n  signOut() {\n    return this.microsoftGraph().signOut();\n  }\n\n  sessionState$() {\n    return this.microsoftGraph().sessionState$();\n  }\n}\n"],"names":[],"mappings":"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"}