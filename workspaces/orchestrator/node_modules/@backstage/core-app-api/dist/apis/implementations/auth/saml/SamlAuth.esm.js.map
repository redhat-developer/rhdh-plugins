{"version":3,"file":"SamlAuth.esm.js","sources":["../../../../../src/apis/implementations/auth/saml/SamlAuth.ts"],"sourcesContent":["/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  AuthRequestOptions,\n  BackstageIdentityApi,\n  ProfileInfo,\n  ProfileInfoApi,\n  SessionApi,\n  SessionState,\n  BackstageIdentityResponse,\n} from '@backstage/core-plugin-api';\nimport { Observable } from '@backstage/types';\nimport { DirectAuthConnector } from '../../../../lib/AuthConnector';\nimport {\n  AuthSessionStore,\n  StaticAuthSessionManager,\n} from '../../../../lib/AuthSessionManager';\nimport { SessionManager } from '../../../../lib/AuthSessionManager/types';\nimport { AuthApiCreateOptions } from '../types';\nimport { SamlSession, samlSessionSchema } from './types';\n\nexport type SamlAuthResponse = {\n  profile: ProfileInfo;\n  backstageIdentity: BackstageIdentityResponse;\n};\n\nconst DEFAULT_PROVIDER = {\n  id: 'saml',\n  title: 'SAML',\n  icon: () => null,\n};\n\n/**\n * Implements a general SAML based auth flow.\n *\n * @public\n */\nexport default class SamlAuth\n  implements ProfileInfoApi, BackstageIdentityApi, SessionApi\n{\n  static create(options: AuthApiCreateOptions) {\n    const {\n      discoveryApi,\n      environment = 'development',\n      provider = DEFAULT_PROVIDER,\n    } = options;\n\n    const connector = new DirectAuthConnector<SamlSession>({\n      discoveryApi,\n      environment,\n      provider,\n    });\n\n    const sessionManager = new StaticAuthSessionManager<SamlSession>({\n      connector,\n    });\n\n    const authSessionStore = new AuthSessionStore<SamlSession>({\n      manager: sessionManager,\n      storageKey: `${provider.id}Session`,\n      schema: samlSessionSchema,\n    });\n\n    return new SamlAuth(authSessionStore);\n  }\n\n  sessionState$(): Observable<SessionState> {\n    return this.sessionManager.sessionState$();\n  }\n\n  private constructor(\n    private readonly sessionManager: SessionManager<SamlSession>,\n  ) {}\n\n  async signIn() {\n    await this.getBackstageIdentity({});\n  }\n  async signOut() {\n    await this.sessionManager.removeSession();\n  }\n\n  async getBackstageIdentity(\n    options: AuthRequestOptions = {},\n  ): Promise<BackstageIdentityResponse | undefined> {\n    const session = await this.sessionManager.getSession(options);\n    return session?.backstageIdentity;\n  }\n\n  async getProfile(options: AuthRequestOptions = {}) {\n    const session = await this.sessionManager.getSession(options);\n    return session?.profile;\n  }\n}\n"],"names":[],"mappings":";;;;;;;AAwCA,MAAM,gBAAA,GAAmB;AAAA,EACvB,EAAA,EAAI,MAAA;AAAA,EACJ,KAAA,EAAO,MAAA;AAAA,EACP,MAAM,MAAM;AACd,CAAA;AAOA,MAAqB,QAAA,CAErB;AAAA,EA+BU,YACW,cAAA,EACjB;AADiB,IAAA,IAAA,CAAA,cAAA,GAAA,cAAA;AAAA,EAChB;AAAA,EAhCH,OAAO,OAAO,OAAA,EAA+B;AAC3C,IAAA,MAAM;AAAA,MACJ,YAAA;AAAA,MACA,WAAA,GAAc,aAAA;AAAA,MACd,QAAA,GAAW;AAAA,KACb,GAAI,OAAA;AAEJ,IAAA,MAAM,SAAA,GAAY,IAAI,mBAAA,CAAiC;AAAA,MACrD,YAAA;AAAA,MACA,WAAA;AAAA,MACA;AAAA,KACD,CAAA;AAED,IAAA,MAAM,cAAA,GAAiB,IAAI,wBAAA,CAAsC;AAAA,MAC/D;AAAA,KACD,CAAA;AAED,IAAA,MAAM,gBAAA,GAAmB,IAAI,gBAAA,CAA8B;AAAA,MACzD,OAAA,EAAS,cAAA;AAAA,MACT,UAAA,EAAY,CAAA,EAAG,QAAA,CAAS,EAAE,CAAA,OAAA,CAAA;AAAA,MAC1B,MAAA,EAAQ;AAAA,KACT,CAAA;AAED,IAAA,OAAO,IAAI,SAAS,gBAAgB,CAAA;AAAA,EACtC;AAAA,EAEA,aAAA,GAA0C;AACxC,IAAA,OAAO,IAAA,CAAK,eAAe,aAAA,EAAc;AAAA,EAC3C;AAAA,EAMA,MAAM,MAAA,GAAS;AACb,IAAA,MAAM,IAAA,CAAK,oBAAA,CAAqB,EAAE,CAAA;AAAA,EACpC;AAAA,EACA,MAAM,OAAA,GAAU;AACd,IAAA,MAAM,IAAA,CAAK,eAAe,aAAA,EAAc;AAAA,EAC1C;AAAA,EAEA,MAAM,oBAAA,CACJ,OAAA,GAA8B,EAAC,EACiB;AAChD,IAAA,MAAM,OAAA,GAAU,MAAM,IAAA,CAAK,cAAA,CAAe,WAAW,OAAO,CAAA;AAC5D,IAAA,OAAO,OAAA,EAAS,iBAAA;AAAA,EAClB;AAAA,EAEA,MAAM,UAAA,CAAW,OAAA,GAA8B,EAAC,EAAG;AACjD,IAAA,MAAM,OAAA,GAAU,MAAM,IAAA,CAAK,cAAA,CAAe,WAAW,OAAO,CAAA;AAC5D,IAAA,OAAO,OAAA,EAAS,OAAA;AAAA,EAClB;AACF;;;;"}