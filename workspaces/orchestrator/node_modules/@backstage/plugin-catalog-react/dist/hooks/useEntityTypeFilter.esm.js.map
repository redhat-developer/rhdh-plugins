{"version":3,"file":"useEntityTypeFilter.esm.js","sources":["../../src/hooks/useEntityTypeFilter.tsx"],"sourcesContent":["/*\n * Copyright 2021 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { useEffect, useMemo, useRef, useState } from 'react';\nimport useAsync from 'react-use/esm/useAsync';\nimport isEqual from 'lodash/isEqual';\nimport sortBy from 'lodash/sortBy';\nimport { useApi } from '@backstage/core-plugin-api';\nimport { catalogApiRef } from '../api';\nimport { useEntityList } from './useEntityListProvider';\nimport { EntityTypeFilter } from '../filters';\n\n/**\n * A hook built on top of `useEntityList` for enabling selection of valid `spec.type` values\n * based on the selected EntityKindFilter.\n * @public\n */\nexport function useEntityTypeFilter(): {\n  loading: boolean;\n  error?: Error;\n  availableTypes: string[];\n  selectedTypes: string[];\n  setSelectedTypes: (types: string[]) => void;\n} {\n  const catalogApi = useApi(catalogApiRef);\n  const {\n    filters: { kind: kindFilter, type: typeFilter },\n    queryParameters: { type: typeParameter },\n    updateFilters,\n  } = useEntityList();\n\n  const flattenedQueryTypes = useMemo(\n    () => [typeParameter].flat().filter(Boolean) as string[],\n    [typeParameter],\n  );\n\n  const [selectedTypes, setSelectedTypes] = useState(\n    flattenedQueryTypes.length\n      ? flattenedQueryTypes\n      : typeFilter?.getTypes() ?? [],\n  );\n\n  // Set selected types on query parameter updates; this happens at initial page load and from\n  // external updates to the page location.\n  useEffect(() => {\n    if (flattenedQueryTypes.length) {\n      setSelectedTypes(flattenedQueryTypes);\n    }\n  }, [flattenedQueryTypes]);\n\n  const [availableTypes, setAvailableTypes] = useState<string[]>([]);\n  const kind = useMemo(() => kindFilter?.value, [kindFilter]);\n\n  // Load all valid spec.type values straight from the catalogApi, paying attention to only the\n  // kind filter for a complete list.\n  const {\n    error,\n    loading,\n    value: facets,\n  } = useAsync(async () => {\n    if (kind) {\n      const items = await catalogApi\n        .getEntityFacets({\n          filter: { kind },\n          facets: ['spec.type'],\n        })\n        .then(response => response.facets['spec.type'] || []);\n      return items;\n    }\n    return [];\n  }, [kind, catalogApi]);\n\n  const facetsRef = useRef(facets);\n  useEffect(() => {\n    const oldFacets = facetsRef.current;\n    facetsRef.current = facets;\n    // Delay processing hook until kind and facets load updates have settled to generate list of types;\n    // This prevents resetting the type filter due to saved type value from query params not matching the\n    // empty set of type values while values are still being loaded; also only run this hook on changes\n    // to facets\n    if (loading || !kind || oldFacets === facets || !facets) {\n      return;\n    }\n\n    // Sort by facet count descending, so the most common types appear on top\n    const newTypes = [\n      ...new Set(\n        sortBy(facets, f => -f.count).map(f =>\n          f.value.toLocaleLowerCase('en-US'),\n        ),\n      ),\n    ];\n    setAvailableTypes(newTypes);\n\n    // Update type filter to only valid values when the list of available types has changed\n    const stillValidTypes = selectedTypes.filter(value =>\n      newTypes.includes(value),\n    );\n    if (!isEqual(selectedTypes, stillValidTypes)) {\n      setSelectedTypes(stillValidTypes);\n    }\n  }, [loading, kind, selectedTypes, setSelectedTypes, facets]);\n\n  useEffect(() => {\n    updateFilters({\n      type: selectedTypes.length\n        ? new EntityTypeFilter(selectedTypes)\n        : undefined,\n    });\n  }, [selectedTypes, updateFilters]);\n\n  return {\n    loading,\n    error,\n    availableTypes,\n    selectedTypes,\n    setSelectedTypes,\n  };\n}\n"],"names":[],"mappings":"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"}