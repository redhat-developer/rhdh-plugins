{"version":3,"file":"useFetchEntities.esm.js","sources":["../../../src/components/EntityOwnerPicker/useFetchEntities.ts"],"sourcesContent":["/*\n * Copyright 2023 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport { useRef } from 'react';\nimport { useFacetsEntities } from './useFacetsEntities';\nimport { useQueryEntities } from './useQueryEntities';\nimport { Entity, stringifyEntityRef } from '@backstage/catalog-model';\nimport { useApi } from '@backstage/core-plugin-api';\nimport { catalogApiRef } from '../../api';\nimport useAsyncFn from 'react-use/esm/useAsyncFn';\nimport { useMountEffect } from '@react-hookz/web';\n\nexport function useFetchEntities({\n  mode,\n  initialSelectedOwnersRefs,\n}: {\n  mode: 'owners-only' | 'all';\n  initialSelectedOwnersRefs: string[];\n}) {\n  const isOwnersOnlyMode = mode === 'owners-only';\n  const queryEntitiesResponse = useQueryEntities();\n  const facetsEntitiesResponse = useFacetsEntities({\n    enabled: isOwnersOnlyMode,\n  });\n\n  const [state, handleFetch] = isOwnersOnlyMode\n    ? facetsEntitiesResponse\n    : queryEntitiesResponse;\n\n  return [\n    state,\n    handleFetch,\n    useSelectedOwners({\n      enabled: !isOwnersOnlyMode,\n      initialSelectedOwnersRefs,\n    }),\n  ] as const;\n}\n\n/**\n * Hook used for storing the full entity of the specified owners\n * in order to display users and group using the information contained on each entity.\n * When a component is rendered for the first time, it loads the content of the entities\n * specified by `initialSelectedOwnersRefs` and export the `getEntity` and `setEntity`\n * utilities, used to retrieve and modify the owners.\n */\nfunction useSelectedOwners({\n  enabled,\n  initialSelectedOwnersRefs,\n}: {\n  enabled: boolean;\n  initialSelectedOwnersRefs: string[];\n}) {\n  const allEntities = useRef<Record<string, Entity>>({});\n  const catalogApi = useApi(catalogApiRef);\n\n  const [, handleFetch] = useAsyncFn(async () => {\n    const initialSelectedEntities = await catalogApi.getEntitiesByRefs({\n      entityRefs: initialSelectedOwnersRefs,\n    });\n    initialSelectedEntities.items.forEach(e => {\n      if (e) {\n        allEntities.current[stringifyEntityRef(e)] = e;\n      }\n    });\n  }, []);\n\n  useMountEffect(() => {\n    if (enabled && initialSelectedOwnersRefs.length > 0) {\n      handleFetch();\n    }\n  });\n\n  return {\n    getEntity: (entityRef: string) => allEntities.current[entityRef],\n    setEntity: (entity: Entity) => {\n      allEntities.current[stringifyEntityRef(entity)] = entity;\n    },\n  };\n}\n"],"names":[],"mappings":";;;;;;;;;AAwBO,SAAS,gBAAA,CAAiB;AAAA,EAC/B,IAAA;AAAA,EACA;AACF,CAAA,EAGG;AACD,EAAA,MAAM,mBAAmB,IAAA,KAAS,aAAA;AAClC,EAAA,MAAM,wBAAwB,gBAAA,EAAiB;AAC/C,EAAA,MAAM,yBAAyB,iBAAA,CAAkB;AAAA,IAC/C,OAAA,EAAS;AAAA,GACV,CAAA;AAED,EAAA,MAAM,CAAC,KAAA,EAAO,WAAW,CAAA,GAAI,mBACzB,sBAAA,GACA,qBAAA;AAEJ,EAAA,OAAO;AAAA,IACL,KAAA;AAAA,IACA,WAAA;AAAA,IACA,iBAAA,CAAkB;AAAA,MAChB,SAAS,CAAC,gBAAA;AAAA,MACV;AAAA,KACD;AAAA,GACH;AACF;AASA,SAAS,iBAAA,CAAkB;AAAA,EACzB,OAAA;AAAA,EACA;AACF,CAAA,EAGG;AACD,EAAA,MAAM,WAAA,GAAc,MAAA,CAA+B,EAAE,CAAA;AACrD,EAAA,MAAM,UAAA,GAAa,OAAO,aAAa,CAAA;AAEvC,EAAA,MAAM,GAAG,WAAW,CAAA,GAAI,WAAW,YAAY;AAC7C,IAAA,MAAM,uBAAA,GAA0B,MAAM,UAAA,CAAW,iBAAA,CAAkB;AAAA,MACjE,UAAA,EAAY;AAAA,KACb,CAAA;AACD,IAAA,uBAAA,CAAwB,KAAA,CAAM,QAAQ,CAAA,CAAA,KAAK;AACzC,MAAA,IAAI,CAAA,EAAG;AACL,QAAA,WAAA,CAAY,OAAA,CAAQ,kBAAA,CAAmB,CAAC,CAAC,CAAA,GAAI,CAAA;AAAA,MAC/C;AAAA,IACF,CAAC,CAAA;AAAA,EACH,CAAA,EAAG,EAAE,CAAA;AAEL,EAAA,cAAA,CAAe,MAAM;AACnB,IAAA,IAAI,OAAA,IAAW,yBAAA,CAA0B,MAAA,GAAS,CAAA,EAAG;AACnD,MAAA,WAAA,EAAY;AAAA,IACd;AAAA,EACF,CAAC,CAAA;AAED,EAAA,OAAO;AAAA,IACL,SAAA,EAAW,CAAC,SAAA,KAAsB,WAAA,CAAY,QAAQ,SAAS,CAAA;AAAA,IAC/D,SAAA,EAAW,CAAC,MAAA,KAAmB;AAC7B,MAAA,WAAA,CAAY,OAAA,CAAQ,kBAAA,CAAmB,MAAM,CAAC,CAAA,GAAI,MAAA;AAAA,IACpD;AAAA,GACF;AACF;;;;"}