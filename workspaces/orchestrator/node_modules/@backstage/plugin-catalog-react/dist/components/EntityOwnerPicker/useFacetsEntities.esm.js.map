{"version":3,"file":"useFacetsEntities.esm.js","sources":["../../../src/components/EntityOwnerPicker/useFacetsEntities.ts"],"sourcesContent":["/*\n * Copyright 2023 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport { useApi } from '@backstage/core-plugin-api';\nimport useAsyncFn from 'react-use/esm/useAsyncFn';\nimport { catalogApiRef } from '../../api';\nimport { useState } from 'react';\nimport { Entity, parseEntityRef } from '@backstage/catalog-model';\n\ntype FacetsCursor = {\n  start: number;\n  text: string;\n};\n\ntype FacetsEntitiesResponse = {\n  items: Entity[];\n  cursor?: string;\n};\n\ntype FacetsInitialRequest = {\n  text: string;\n};\n\n/**\n * This hook asynchronously loads the entity owners using the facets endpoint.\n * EntityOwnerPicker uses this hook when mode=\"owners-only\" is passed as prop.\n * All the owners are kept internally in memory and rendered in batches once requested\n * by the frontend. The values returned by this hook are compatible with `useQueryEntities`\n * hook, which is also used by EntityOwnerPicker.\n * In this mode, the EntityOwnerPicker won't show detailed information of the owners.\n */\nexport function useFacetsEntities({ enabled }: { enabled: boolean }) {\n  const catalogApi = useApi(catalogApiRef);\n\n  const [facetsPromise] = useState(async () => {\n    if (!enabled) {\n      return [];\n    }\n    const facet = 'relations.ownedBy';\n\n    return catalogApi\n      .getEntityFacets({ facets: [facet] })\n      .then(response =>\n        response.facets[facet]\n          .map(e => e.value)\n          .map(ref => {\n            const { kind, name, namespace } = parseEntityRef(ref);\n            return {\n              apiVersion: 'backstage.io/v1beta1',\n              kind,\n              metadata: { name, namespace },\n            };\n          })\n          .sort(\n            (a, b) =>\n              a.kind.localeCompare(b.kind, 'en-US') ||\n              a.metadata.namespace.localeCompare(\n                b.metadata.namespace,\n                'en-US',\n              ) ||\n              a.metadata.name.localeCompare(b.metadata.name, 'en-US'),\n          ),\n      )\n      .catch(() => []);\n  });\n\n  return useAsyncFn<\n    (\n      request: FacetsInitialRequest | FacetsEntitiesResponse,\n      options?: { limit?: number },\n    ) => Promise<FacetsEntitiesResponse>\n  >(\n    async (request, options) => {\n      const facets = await facetsPromise;\n\n      if (!facets) {\n        return {\n          items: [],\n        };\n      }\n\n      const limit = options?.limit ?? 20;\n\n      const { text, start } = decodeCursor(request);\n      const filteredRefs = facets.filter(e => filterEntity(text, e));\n      const end = start + limit;\n      return {\n        items: filteredRefs.slice(0, end),\n        ...encodeCursor({\n          entities: filteredRefs,\n          limit: end,\n          payload: {\n            text,\n            start: end,\n          },\n        }),\n      };\n    },\n    [facetsPromise],\n    { loading: true, value: { items: [] } },\n  );\n}\n\nfunction decodeCursor(\n  request: FacetsInitialRequest | FacetsEntitiesResponse,\n): FacetsCursor {\n  if (isFacetsResponse(request) && request.cursor) {\n    return JSON.parse(atob(request.cursor));\n  }\n  return {\n    text: (request as FacetsInitialRequest).text || '',\n    start: 0,\n  };\n}\n\nfunction isFacetsResponse(\n  request: FacetsInitialRequest | FacetsEntitiesResponse,\n): request is FacetsEntitiesResponse {\n  return !!(request as FacetsEntitiesResponse).cursor;\n}\n\nfunction encodeCursor({\n  entities,\n  limit,\n  payload,\n}: {\n  entities: Entity[];\n  limit: number;\n  payload: { text: string; start: number };\n}) {\n  if (entities.length > limit) {\n    return { cursor: btoa(JSON.stringify(payload)) };\n  }\n  return {};\n}\n\nfunction filterEntity(text: string, entity: Entity) {\n  const normalizedText = text.trim();\n  return (\n    entity.kind.includes(normalizedText) ||\n    entity.metadata.namespace?.includes(normalizedText) ||\n    entity.metadata.name.includes(normalizedText)\n  );\n}\n"],"names":[],"mappings":"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"}