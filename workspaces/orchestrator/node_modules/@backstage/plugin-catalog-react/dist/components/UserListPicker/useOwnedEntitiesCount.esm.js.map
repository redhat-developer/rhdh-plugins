{"version":3,"file":"useOwnedEntitiesCount.esm.js","sources":["../../../src/components/UserListPicker/useOwnedEntitiesCount.ts"],"sourcesContent":["/*\n * Copyright 2023 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { identityApiRef, useApi } from '@backstage/core-plugin-api';\nimport { compact, intersection } from 'lodash';\nimport { useMemo } from 'react';\nimport useAsync from 'react-use/esm/useAsync';\nimport { catalogApiRef } from '../../api';\nimport { EntityOwnerFilter, EntityUserFilter } from '../../filters';\nimport { useEntityList } from '../../hooks';\nimport { CatalogFilters, reduceCatalogFilters } from '../../utils/filters';\nimport useAsyncFn from 'react-use/esm/useAsyncFn';\nimport useDeepCompareEffect from 'react-use/esm/useDeepCompareEffect';\n\nexport function useOwnedEntitiesCount() {\n  const identityApi = useApi(identityApiRef);\n  const catalogApi = useApi(catalogApiRef);\n\n  const { filters } = useEntityList();\n\n  const { value: ownershipEntityRefs, loading: loadingEntityRefs } = useAsync(\n    async () => (await identityApi.getBackstageIdentity()).ownershipEntityRefs,\n    // load only on mount\n    [],\n  );\n\n  const { user, owners, ...allFilters } = filters;\n  const { orderFields, ...catalogFilters } = reduceCatalogFilters(\n    compact(Object.values(allFilters)),\n  );\n\n  const [{ value: count, loading: loadingEntityOwnership }, fetchEntities] =\n    useAsyncFn(\n      async (req: {\n        ownershipEntityRefs: string[];\n        owners: EntityOwnerFilter | undefined;\n        filter: CatalogFilters;\n      }) => {\n        const ownedClaims = getOwnedCountClaims(\n          req.owners,\n          req.ownershipEntityRefs,\n        );\n        if (ownedClaims === undefined) {\n          // this implicitly means that there aren't claims in common with\n          // the logged in users, so avoid invoking the queryEntities endpoint\n          // which will implicitly returns 0\n          return 0;\n        }\n\n        const { ['metadata.name']: metadata, ...filter } = req.filter.filter;\n\n        const { totalItems } = await catalogApi.queryEntities({\n          ...req.filter,\n          filter: {\n            ...filter,\n            'relations.ownedBy': ownedClaims,\n          },\n          limit: 0,\n        });\n        return totalItems;\n      },\n      [],\n      { loading: true },\n    );\n\n  useDeepCompareEffect(() => {\n    // context contains no filter, wait\n    if (Object.keys(catalogFilters.filter).length === 0) {\n      return;\n    }\n    // ownershipEntityRefs is loading, wait\n    if (ownershipEntityRefs === undefined) {\n      return;\n    }\n    fetchEntities({\n      ownershipEntityRefs,\n      owners,\n      filter: catalogFilters,\n    });\n  }, [ownershipEntityRefs, owners, catalogFilters]);\n\n  const loading = loadingEntityRefs || loadingEntityOwnership;\n\n  return {\n    count,\n    loading,\n    filter: useMemo(\n      () => EntityUserFilter.owned(ownershipEntityRefs ?? []),\n      [ownershipEntityRefs],\n    ),\n    ownershipEntityRefs,\n  };\n}\n\nfunction getOwnedCountClaims(\n  owners: EntityOwnerFilter | undefined,\n  ownershipEntityRefs: string[] | undefined,\n) {\n  if (ownershipEntityRefs === undefined) {\n    return undefined;\n  }\n  const ownersRefs = owners?.values ?? [];\n  if (ownersRefs.length) {\n    const commonOwnedBy = intersection(ownersRefs, ownershipEntityRefs);\n    if (commonOwnedBy.length === 0) {\n      return undefined;\n    }\n    return commonOwnedBy;\n  }\n  return ownershipEntityRefs;\n}\n"],"names":[],"mappings":"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"}