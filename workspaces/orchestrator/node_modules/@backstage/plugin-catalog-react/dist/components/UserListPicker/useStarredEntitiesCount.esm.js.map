{"version":3,"file":"useStarredEntitiesCount.esm.js","sources":["../../../src/components/UserListPicker/useStarredEntitiesCount.ts"],"sourcesContent":["/*\n * Copyright 2023 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { QueryEntitiesInitialRequest } from '@backstage/catalog-client';\nimport { parseEntityRef, stringifyEntityRef } from '@backstage/catalog-model';\nimport { useApi } from '@backstage/core-plugin-api';\nimport { compact, isEqual } from 'lodash';\nimport { useMemo, useRef } from 'react';\nimport useAsync from 'react-use/esm/useAsync';\nimport { catalogApiRef } from '../../api';\nimport { EntityUserFilter } from '../../filters';\nimport { useEntityList, useStarredEntities } from '../../hooks';\nimport { reduceCatalogFilters } from '../../utils/filters';\n\nexport function useStarredEntitiesCount() {\n  const catalogApi = useApi(catalogApiRef);\n  const { filters } = useEntityList();\n  const { starredEntities } = useStarredEntities();\n\n  const prevRequest = useRef<QueryEntitiesInitialRequest>();\n  const request = useMemo(() => {\n    const { user, ...allFilters } = filters;\n    const compacted = compact(Object.values(allFilters));\n    const { orderFields, ...catalogFilters } = reduceCatalogFilters(compacted);\n\n    const facet = 'metadata.name';\n\n    const newRequest: QueryEntitiesInitialRequest = {\n      ...catalogFilters,\n      filter: {\n        ...catalogFilters.filter,\n        /**\n         * here we are filtering entities by `name`. Given this filter,\n         * the response might contain more entities than expected, in case multiple entities\n         * of different kind or namespace share the same name. Those extra entities are filtered out\n         * client side by `EntityUserFilter`, so they won't be visible to the user.\n         */\n        [facet]: Array.from(starredEntities).map(e => parseEntityRef(e).name),\n      },\n      /**\n       * limit is set to a high value as we are not expecting many starred entities\n       */\n      limit: 1000,\n    };\n    if (isEqual(newRequest, prevRequest.current)) {\n      return prevRequest.current;\n    }\n    prevRequest.current = newRequest;\n\n    return newRequest;\n  }, [filters, starredEntities]);\n\n  const { value: count, loading } = useAsync(async () => {\n    if (!starredEntities.size) {\n      return 0;\n    }\n\n    /**\n     * given a list of starred entity refs and some filters coming from CatalogPage,\n     * it reduces the list of starred entities, to a list of entities that matches the\n     * provided filters. It won't be possible to getEntitiesByRefs\n     * as the method doesn't accept any filter.\n     */\n    const response = await catalogApi.queryEntities(request);\n\n    return response.items\n      .map(e =>\n        stringifyEntityRef({\n          kind: e.kind,\n          namespace: e.metadata.namespace,\n          name: e.metadata.name,\n        }),\n      )\n      .filter(e => starredEntities.has(e)).length;\n  }, [request, starredEntities]);\n\n  const filter = useMemo(\n    () => EntityUserFilter.starred(Array.from(starredEntities)),\n    [starredEntities],\n  );\n\n  return { count, loading, filter };\n}\n"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;AA2BO,SAAS,uBAAA,GAA0B;AACxC,EAAA,MAAM,UAAA,GAAa,OAAO,aAAa,CAAA;AACvC,EAAA,MAAM,EAAE,OAAA,EAAQ,GAAI,aAAA,EAAc;AAClC,EAAA,MAAM,EAAE,eAAA,EAAgB,GAAI,kBAAA,EAAmB;AAE/C,EAAA,MAAM,cAAc,MAAA,EAAoC;AACxD,EAAA,MAAM,OAAA,GAAU,QAAQ,MAAM;AAC5B,IAAA,MAAM,EAAE,IAAA,EAAM,GAAG,UAAA,EAAW,GAAI,OAAA;AAChC,IAAA,MAAM,SAAA,GAAY,OAAA,CAAQ,MAAA,CAAO,MAAA,CAAO,UAAU,CAAC,CAAA;AACnD,IAAA,MAAM,EAAE,WAAA,EAAa,GAAG,cAAA,EAAe,GAAI,qBAAqB,SAAS,CAAA;AAEzE,IAAA,MAAM,KAAA,GAAQ,eAAA;AAEd,IAAA,MAAM,UAAA,GAA0C;AAAA,MAC9C,GAAG,cAAA;AAAA,MACH,MAAA,EAAQ;AAAA,QACN,GAAG,cAAA,CAAe,MAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,QAOlB,CAAC,KAAK,GAAG,KAAA,CAAM,IAAA,CAAK,eAAe,CAAA,CAAE,GAAA,CAAI,CAAA,CAAA,KAAK,cAAA,CAAe,CAAC,CAAA,CAAE,IAAI;AAAA,OACtE;AAAA;AAAA;AAAA;AAAA,MAIA,KAAA,EAAO;AAAA,KACT;AACA,IAAA,IAAI,OAAA,CAAQ,UAAA,EAAY,WAAA,CAAY,OAAO,CAAA,EAAG;AAC5C,MAAA,OAAO,WAAA,CAAY,OAAA;AAAA,IACrB;AACA,IAAA,WAAA,CAAY,OAAA,GAAU,UAAA;AAEtB,IAAA,OAAO,UAAA;AAAA,EACT,CAAA,EAAG,CAAC,OAAA,EAAS,eAAe,CAAC,CAAA;AAE7B,EAAA,MAAM,EAAE,KAAA,EAAO,KAAA,EAAO,OAAA,EAAQ,GAAI,SAAS,YAAY;AACrD,IAAA,IAAI,CAAC,gBAAgB,IAAA,EAAM;AACzB,MAAA,OAAO,CAAA;AAAA,IACT;AAQA,IAAA,MAAM,QAAA,GAAW,MAAM,UAAA,CAAW,aAAA,CAAc,OAAO,CAAA;AAEvD,IAAA,OAAO,SAAS,KAAA,CACb,GAAA;AAAA,MAAI,OACH,kBAAA,CAAmB;AAAA,QACjB,MAAM,CAAA,CAAE,IAAA;AAAA,QACR,SAAA,EAAW,EAAE,QAAA,CAAS,SAAA;AAAA,QACtB,IAAA,EAAM,EAAE,QAAA,CAAS;AAAA,OAClB;AAAA,MAEF,MAAA,CAAO,CAAA,CAAA,KAAK,gBAAgB,GAAA,CAAI,CAAC,CAAC,CAAA,CAAE,MAAA;AAAA,EACzC,CAAA,EAAG,CAAC,OAAA,EAAS,eAAe,CAAC,CAAA;AAE7B,EAAA,MAAM,MAAA,GAAS,OAAA;AAAA,IACb,MAAM,gBAAA,CAAiB,OAAA,CAAQ,KAAA,CAAM,IAAA,CAAK,eAAe,CAAC,CAAA;AAAA,IAC1D,CAAC,eAAe;AAAA,GAClB;AAEA,EAAA,OAAO,EAAE,KAAA,EAAO,OAAA,EAAS,MAAA,EAAO;AAClC;;;;"}