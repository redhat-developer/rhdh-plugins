{"version":3,"file":"gitHelpers.cjs.js","sources":["../../src/actions/gitHelpers.ts"],"sourcesContent":["/*\n * Copyright 2023 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Git } from '../scm';\nimport { LoggerService } from '@backstage/backend-plugin-api';\n\n/**\n * @public\n */\nexport async function initRepoAndPush(input: {\n  dir: string;\n  remoteUrl: string;\n  // For use cases where token has to be used with Basic Auth\n  // it has to be provided as password together with a username\n  // which may be a fixed value defined by the provider.\n  auth: { username: string; password: string } | { token: string };\n  logger: LoggerService;\n  defaultBranch?: string;\n  commitMessage?: string;\n  gitAuthorInfo?: { name?: string; email?: string };\n  signingKey?: string;\n}): Promise<{ commitHash: string }> {\n  const {\n    dir,\n    remoteUrl,\n    auth,\n    logger,\n    defaultBranch = 'master',\n    commitMessage = 'Initial commit',\n    gitAuthorInfo,\n    signingKey,\n  } = input;\n  const git = Git.fromAuth({\n    ...auth,\n    logger,\n  });\n\n  await git.init({\n    dir,\n    defaultBranch,\n  });\n\n  await git.add({ dir, filepath: '.' });\n\n  // use provided info if possible, otherwise use fallbacks\n  const authorInfo = {\n    name: gitAuthorInfo?.name ?? 'Scaffolder',\n    email: gitAuthorInfo?.email ?? 'scaffolder@backstage.io',\n  };\n\n  const commitHash = await git.commit({\n    dir,\n    message: commitMessage,\n    author: authorInfo,\n    committer: authorInfo,\n    signingKey,\n  });\n\n  await git.push({\n    dir,\n    remote: 'origin',\n    url: remoteUrl,\n  });\n\n  return { commitHash };\n}\n\n/**\n * @public\n */\nexport async function commitAndPushRepo(input: {\n  dir: string;\n  // For use cases where token has to be used with Basic Auth\n  // it has to be provided as password together with a username\n  // which may be a fixed value defined by the provider.\n  auth: { username: string; password: string } | { token: string };\n  logger: LoggerService;\n  commitMessage: string;\n  gitAuthorInfo?: { name?: string; email?: string };\n  branch?: string;\n  remoteRef?: string;\n  signingKey?: string;\n}): Promise<{ commitHash: string }> {\n  const {\n    dir,\n    auth,\n    logger,\n    commitMessage,\n    gitAuthorInfo,\n    branch = 'master',\n    remoteRef,\n    signingKey,\n  } = input;\n\n  const git = Git.fromAuth({\n    ...auth,\n    logger,\n  });\n\n  await git.fetch({ dir });\n  await git.checkout({ dir, ref: branch });\n  await git.add({ dir, filepath: '.' });\n\n  // use provided info if possible, otherwise use fallbacks\n  const authorInfo = {\n    name: gitAuthorInfo?.name ?? 'Scaffolder',\n    email: gitAuthorInfo?.email ?? 'scaffolder@backstage.io',\n  };\n\n  const commitHash = await git.commit({\n    dir,\n    message: commitMessage,\n    author: authorInfo,\n    committer: authorInfo,\n    signingKey,\n  });\n\n  await git.push({\n    dir,\n    remote: 'origin',\n    remoteRef: remoteRef ?? `refs/heads/${branch}`,\n  });\n\n  return { commitHash };\n}\n\n/**\n * @public\n */\nexport async function cloneRepo(options: {\n  url: string;\n  dir: string;\n  // For use cases where token has to be used with Basic Auth\n  // it has to be provided as password together with a username\n  // which may be a fixed value defined by the provider.\n  auth: { username: string; password: string } | { token: string };\n  logger?: LoggerService | undefined;\n  ref?: string | undefined;\n  depth?: number | undefined;\n  noCheckout?: boolean | undefined;\n}): Promise<void> {\n  const { url, dir, auth, logger, ref, depth, noCheckout } = options;\n\n  const git = Git.fromAuth({\n    ...auth,\n    logger,\n  });\n\n  await git.clone({ url, dir, ref, depth, noCheckout });\n}\n\n/**\n * @public\n */\nexport async function createBranch(options: {\n  dir: string;\n  ref: string;\n  // For use cases where token has to be used with Basic Auth\n  // it has to be provided as password together with a username\n  // which may be a fixed value defined by the provider.\n  auth: { username: string; password: string } | { token: string };\n  logger?: LoggerService | undefined;\n}): Promise<void> {\n  const { dir, ref, auth, logger } = options;\n  const git = Git.fromAuth({\n    ...auth,\n    logger,\n  });\n\n  await git.branch({ dir, ref });\n}\n\n/**\n * @public\n */\nexport async function addFiles(options: {\n  dir: string;\n  filepath: string;\n  // For use cases where token has to be used with Basic Auth\n  // it has to be provided as password together with a username\n  // which may be a fixed value defined by the provider.\n  auth: { username: string; password: string } | { token: string };\n  logger?: LoggerService | undefined;\n}): Promise<void> {\n  const { dir, filepath, auth, logger } = options;\n  const git = Git.fromAuth({\n    ...auth,\n    logger,\n  });\n\n  await git.add({ dir, filepath });\n}\n\n/**\n * @public\n */\nexport async function commitAndPushBranch(options: {\n  dir: string;\n  // For use cases where token has to be used with Basic Auth\n  // it has to be provided as password together with a username\n  // which may be a fixed value defined by the provider.\n  auth: { username: string; password: string } | { token: string };\n  logger?: LoggerService | undefined;\n  commitMessage: string;\n  gitAuthorInfo?: { name?: string; email?: string };\n  branch?: string;\n  remoteRef?: string;\n  remote?: string;\n  signingKey?: string;\n}): Promise<{ commitHash: string }> {\n  const {\n    dir,\n    auth,\n    logger,\n    commitMessage,\n    gitAuthorInfo,\n    branch = 'master',\n    remoteRef,\n    remote = 'origin',\n    signingKey,\n  } = options;\n  const git = Git.fromAuth({\n    ...auth,\n    logger,\n  });\n\n  // use provided info if possible, otherwise use fallbacks\n  const authorInfo = {\n    name: gitAuthorInfo?.name ?? 'Scaffolder',\n    email: gitAuthorInfo?.email ?? 'scaffolder@backstage.io',\n  };\n\n  const commitHash = await git.commit({\n    dir,\n    message: commitMessage,\n    author: authorInfo,\n    committer: authorInfo,\n    signingKey,\n  });\n\n  await git.push({\n    dir,\n    remote,\n    remoteRef: remoteRef ?? `refs/heads/${branch}`,\n  });\n\n  return { commitHash };\n}\n"],"names":["git","Git"],"mappings":"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"}