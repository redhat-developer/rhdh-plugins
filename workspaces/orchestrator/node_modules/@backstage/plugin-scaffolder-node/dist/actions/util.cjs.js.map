{"version":3,"file":"util.cjs.js","sources":["../../src/actions/util.ts"],"sourcesContent":["/*\n * Copyright 2021 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { InputError } from '@backstage/errors';\nimport { isChildPath } from '@backstage/backend-plugin-api';\nimport { join as joinPath, normalize as normalizePath } from 'path';\nimport { ScmIntegrationRegistry } from '@backstage/integration';\nimport { TemplateActionOptions } from './createTemplateAction';\nimport zodToJsonSchema from 'zod-to-json-schema';\nimport { z } from 'zod';\nimport { Schema } from 'jsonschema';\nimport { trim } from 'lodash';\n\n/**\n * @public\n */\nexport const getRepoSourceDirectory = (\n  workspacePath: string,\n  sourcePath: string | undefined,\n) => {\n  if (sourcePath) {\n    const safeSuffix = normalizePath(sourcePath).replace(\n      /^(\\.\\.(\\/|\\\\|$))+/,\n      '',\n    );\n    const path = joinPath(workspacePath, safeSuffix);\n    if (!isChildPath(workspacePath, path)) {\n      throw new Error('Invalid source path');\n    }\n    return path;\n  }\n  return workspacePath;\n};\n\n/**\n * @public\n */\nexport const parseRepoUrl = (\n  repoUrl: string,\n  integrations: ScmIntegrationRegistry,\n): {\n  repo: string;\n  host: string;\n  owner?: string;\n  organization?: string;\n  workspace?: string;\n  project?: string;\n} => {\n  let parsed;\n  try {\n    parsed = new URL(`https://${repoUrl}`);\n  } catch (error) {\n    throw new InputError(\n      `Invalid repo URL passed to publisher, got ${repoUrl}, ${error}`,\n    );\n  }\n  const host = parsed.host;\n  const type = integrations.byHost(host)?.type;\n\n  if (!type) {\n    throw new InputError(\n      `No matching integration configuration for host ${host}, please check your integrations config`,\n    );\n  }\n  const { owner, organization, workspace, project, repo } = Object.fromEntries(\n    ['owner', 'organization', 'workspace', 'project', 'repo'].map(param => [\n      param,\n      parsed.searchParams.has(param)\n        ? trim(parsed.searchParams.get(param)!, '/')\n        : undefined,\n    ]),\n  );\n  switch (type) {\n    case 'bitbucket': {\n      if (host === 'www.bitbucket.org') {\n        checkRequiredParams(parsed, 'workspace');\n      }\n      checkRequiredParams(parsed, 'project', 'repo');\n      break;\n    }\n    case 'azure': {\n      checkRequiredParams(parsed, 'project', 'repo');\n      break;\n    }\n    case 'gitlab': {\n      // project is the projectID, and if defined, owner and repo won't be needed.\n      if (!project) {\n        checkRequiredParams(parsed, 'owner', 'repo');\n      }\n      break;\n    }\n    case 'gitea': {\n      checkRequiredParams(parsed, 'repo');\n      break;\n    }\n    case 'gerrit': {\n      checkRequiredParams(parsed, 'repo');\n      break;\n    }\n    default: {\n      checkRequiredParams(parsed, 'repo', 'owner');\n      break;\n    }\n  }\n  return { host, owner, repo: repo!, organization, workspace, project };\n};\n\nfunction checkRequiredParams(repoUrl: URL, ...params: string[]) {\n  for (let i = 0; i < params.length; i++) {\n    if (!repoUrl.searchParams.get(params[i])) {\n      throw new InputError(\n        `Invalid repo URL passed to publisher: ${repoUrl.toString()}, missing ${\n          params[i]\n        }`,\n      );\n    }\n  }\n}\n\nconst isKeyValueZodCallback = (\n  schema: unknown,\n): schema is { [key in string]: (zImpl: typeof z) => z.ZodType } => {\n  return (\n    typeof schema === 'object' &&\n    !!schema &&\n    Object.values(schema).every(v => typeof v === 'function')\n  );\n};\n\nconst isZodFunctionDefinition = (\n  schema: unknown,\n): schema is (zImpl: typeof z) => z.ZodType => {\n  return typeof schema === 'function';\n};\n\nexport const parseSchemas = (\n  action: TemplateActionOptions<any, any, any>,\n): { inputSchema?: Schema; outputSchema?: Schema } => {\n  if (!action.schema) {\n    return { inputSchema: undefined, outputSchema: undefined };\n  }\n\n  if (isKeyValueZodCallback(action.schema.input)) {\n    const input = z.object(\n      Object.fromEntries(\n        Object.entries(action.schema.input).map(([k, v]) => [k, v(z)]),\n      ),\n    );\n\n    return {\n      inputSchema: zodToJsonSchema(input) as Schema,\n      outputSchema: isKeyValueZodCallback(action.schema.output)\n        ? (zodToJsonSchema(\n            z.object(\n              Object.fromEntries(\n                Object.entries(action.schema.output).map(([k, v]) => [k, v(z)]),\n              ),\n            ),\n          ) as Schema)\n        : undefined,\n    };\n  }\n\n  if (isZodFunctionDefinition(action.schema.input)) {\n    return {\n      inputSchema: zodToJsonSchema(action.schema.input(z)) as Schema,\n      outputSchema: isZodFunctionDefinition(action.schema.output)\n        ? (zodToJsonSchema(action.schema.output(z)) as Schema)\n        : undefined,\n    };\n  }\n\n  return {\n    inputSchema: undefined,\n    outputSchema: undefined,\n  };\n};\n\n/**\n * Filter function to exclude the .git directory and its contents\n * while keeping other files like .gitignore\n * @public\n */\nexport function isNotGitDirectoryOrContents(path: string): boolean {\n  return !(path.endsWith('.git') || path.includes('.git/'));\n}\n"],"names":["normalizePath","path","joinPath","isChildPath","InputError","trim","z","zodToJsonSchema"],"mappings":"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"}