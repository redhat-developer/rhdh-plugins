{"version":3,"file":"PodExecTerminal.esm.js","sources":["../../../src/components/PodExecTerminal/PodExecTerminal.tsx"],"sourcesContent":["/*\n * Copyright 2023 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport 'xterm/css/xterm.css';\n\nimport { discoveryApiRef, useApi } from '@backstage/core-plugin-api';\nimport { ClusterAttributes } from '@backstage/plugin-kubernetes-common';\nimport { createStyles, makeStyles, Theme } from '@material-ui/core/styles';\nimport React, { useEffect, useMemo, useState } from 'react';\nimport { Terminal } from 'xterm';\nimport { FitAddon } from 'xterm-addon-fit';\n\nimport { PodExecTerminalAttachAddon } from './PodExecTerminalAttachAddon';\n\n/**\n * Props drilled down to the PodExecTerminal component\n *\n * @public\n */\nexport interface PodExecTerminalProps {\n  cluster: ClusterAttributes;\n  containerName: string;\n  podName: string;\n  podNamespace: string;\n}\n\nconst hasSocketProtocol = (url: string | URL) =>\n  /wss?:\\/\\//.test(url.toString());\n\nconst useStyles = makeStyles((theme: Theme) =>\n  createStyles({\n    podExecTerminal: {\n      width: '100%',\n      height: '100%',\n      '& .xterm-screen': { padding: theme.spacing(1) },\n    },\n  }),\n);\n\n/**\n * Executes a `/bin/sh` process in the given pod's container and opens a terminal connected to it\n *\n * @public\n */\nexport const PodExecTerminal = (props: PodExecTerminalProps) => {\n  const classes = useStyles();\n  const { containerName, podNamespace, podName } = props;\n\n  const [baseUrl, setBaseUrl] = useState(window.location.host);\n\n  const terminalRef = React.useRef(null);\n  const discoveryApi = useApi(discoveryApiRef);\n  const namespace = podNamespace ?? 'default';\n\n  useEffect(() => {\n    discoveryApi\n      .getBaseUrl('kubernetes')\n      .then(url => url ?? window.location.host)\n      .then(url => url.replace(/^http(s?):\\/\\//, 'ws$1://'))\n      .then(url => setBaseUrl(url));\n  }, [discoveryApi]);\n\n  const urlParams = useMemo(() => {\n    const params = new URLSearchParams({\n      container: containerName,\n      stdin: 'true',\n      stdout: 'true',\n      stderr: 'true',\n      tty: 'true',\n      command: '/bin/sh',\n    });\n    return params;\n  }, [containerName]);\n\n  const socketUrl = useMemo(() => {\n    if (!hasSocketProtocol(baseUrl)) {\n      return '';\n    }\n\n    return new URL(\n      `${baseUrl}/proxy/api/v1/namespaces/${namespace}/pods/${podName}/exec?${urlParams}`,\n    );\n  }, [baseUrl, namespace, podName, urlParams]);\n\n  useEffect(() => {\n    if (!hasSocketProtocol(socketUrl)) {\n      return () => {};\n    }\n\n    const terminal = new Terminal();\n    const fitAddon = new FitAddon();\n    terminal.loadAddon(fitAddon);\n\n    if (terminalRef.current) {\n      terminal.open(terminalRef.current);\n      fitAddon.fit();\n    }\n\n    terminal.writeln('Starting terminal, please wait...');\n\n    const socket = new WebSocket(socketUrl, ['channel.k8s.io']);\n\n    socket.onopen = () => {\n      terminal.clear();\n      const attachAddon = new PodExecTerminalAttachAddon(socket, {\n        bidirectional: true,\n      });\n\n      terminal.loadAddon(attachAddon);\n    };\n\n    socket.onclose = () => {\n      terminal.writeln('Socket connection closed');\n    };\n\n    return () => {\n      terminal?.clear();\n      socket?.close();\n    };\n  }, [baseUrl, socketUrl]);\n\n  return (\n    <div\n      data-testid=\"terminal\"\n      ref={terminalRef}\n      className={classes.podExecTerminal}\n    />\n  );\n};\n"],"names":["React"],"mappings":"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"}