{"version":3,"file":"OAuthRequestManager.esm.js","sources":["../../../../../../../../../packages/core-app-api/src/apis/implementations/OAuthRequestApi/OAuthRequestManager.ts"],"sourcesContent":["/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  OAuthRequestApi,\n  PendingOAuthRequest,\n  OAuthRequester,\n  OAuthRequesterOptions,\n} from '@backstage/core-plugin-api';\nimport { Observable } from '@backstage/types';\nimport { OAuthPendingRequests, PendingRequest } from './OAuthPendingRequests';\nimport { PublishSubject } from '../../../lib/subjects';\n\n/**\n * The OAuthRequestManager is an implementation of the OAuthRequestApi.\n *\n * The purpose of this class and the API is to read a stream of incoming requests\n * of OAuth access tokens from different providers with varying scope, and funnel\n * them all together into a single request for each OAuth provider.\n *\n * @public\n */\nexport class OAuthRequestManager implements OAuthRequestApi {\n  private readonly subject = new PublishSubject<PendingOAuthRequest[]>();\n  private currentRequests: PendingOAuthRequest[] = [];\n  private handlerCount = 0;\n\n  createAuthRequester<T>(options: OAuthRequesterOptions<T>): OAuthRequester<T> {\n    const handler = new OAuthPendingRequests<T>();\n\n    const index = this.handlerCount;\n    this.handlerCount++;\n\n    handler.pending().subscribe({\n      next: scopeRequest => {\n        const newRequests = this.currentRequests.slice();\n        const request = this.makeAuthRequest(scopeRequest, options);\n        if (!request) {\n          delete newRequests[index];\n        } else {\n          newRequests[index] = request;\n        }\n        this.currentRequests = newRequests;\n        // Convert from sparse array to array of present items only\n        this.subject.next(newRequests.filter(Boolean));\n      },\n    });\n\n    return scopes => {\n      return handler.request(scopes);\n    };\n  }\n\n  // Converts the pending request and popup options into a popup request that we can forward to subscribers.\n  private makeAuthRequest(\n    request: PendingRequest<any>,\n    options: OAuthRequesterOptions<any>,\n  ): PendingOAuthRequest | undefined {\n    const { scopes } = request;\n    if (!scopes) {\n      return undefined;\n    }\n\n    return {\n      provider: options.provider,\n      trigger: async () => {\n        const result = await options.onAuthRequest(scopes);\n        request.resolve(result);\n      },\n      reject: () => {\n        const error = new Error('Login failed, rejected by user');\n        error.name = 'RejectedError';\n        request.reject(error);\n      },\n    };\n  }\n\n  authRequest$(): Observable<PendingOAuthRequest[]> {\n    return this.subject;\n  }\n}\n"],"names":[],"mappings":";;;AAmCO,MAAM,mBAAA,CAA+C;AAAA,EACzC,OAAA,GAAU,IAAI,cAAA,EAAsC;AAAA,EAC7D,kBAAyC,EAAC;AAAA,EAC1C,YAAA,GAAe,CAAA;AAAA,EAEvB,oBAAuB,OAAA,EAAsD;AAC3E,IAAA,MAAM,OAAA,GAAU,IAAI,oBAAA,EAAwB;AAE5C,IAAA,MAAM,QAAQ,IAAA,CAAK,YAAA;AACnB,IAAA,IAAA,CAAK,YAAA,EAAA;AAEL,IAAA,OAAA,CAAQ,OAAA,GAAU,SAAA,CAAU;AAAA,MAC1B,MAAM,CAAA,YAAA,KAAgB;AACpB,QAAA,MAAM,WAAA,GAAc,IAAA,CAAK,eAAA,CAAgB,KAAA,EAAM;AAC/C,QAAA,MAAM,OAAA,GAAU,IAAA,CAAK,eAAA,CAAgB,YAAA,EAAc,OAAO,CAAA;AAC1D,QAAA,IAAI,CAAC,OAAA,EAAS;AACZ,UAAA,OAAO,YAAY,KAAK,CAAA;AAAA,QAC1B,CAAA,MAAO;AACL,UAAA,WAAA,CAAY,KAAK,CAAA,GAAI,OAAA;AAAA,QACvB;AACA,QAAA,IAAA,CAAK,eAAA,GAAkB,WAAA;AAEvB,QAAA,IAAA,CAAK,OAAA,CAAQ,IAAA,CAAK,WAAA,CAAY,MAAA,CAAO,OAAO,CAAC,CAAA;AAAA,MAC/C;AAAA,KACD,CAAA;AAED,IAAA,OAAO,CAAA,MAAA,KAAU;AACf,MAAA,OAAO,OAAA,CAAQ,QAAQ,MAAM,CAAA;AAAA,IAC/B,CAAA;AAAA,EACF;AAAA;AAAA,EAGQ,eAAA,CACN,SACA,OAAA,EACiC;AACjC,IAAA,MAAM,EAAE,QAAO,GAAI,OAAA;AACnB,IAAA,IAAI,CAAC,MAAA,EAAQ;AACX,MAAA,OAAO,MAAA;AAAA,IACT;AAEA,IAAA,OAAO;AAAA,MACL,UAAU,OAAA,CAAQ,QAAA;AAAA,MAClB,SAAS,YAAY;AACnB,QAAA,MAAM,MAAA,GAAS,MAAM,OAAA,CAAQ,aAAA,CAAc,MAAM,CAAA;AACjD,QAAA,OAAA,CAAQ,QAAQ,MAAM,CAAA;AAAA,MACxB,CAAA;AAAA,MACA,QAAQ,MAAM;AACZ,QAAA,MAAM,KAAA,GAAQ,IAAI,KAAA,CAAM,gCAAgC,CAAA;AACxD,QAAA,KAAA,CAAM,IAAA,GAAO,eAAA;AACb,QAAA,OAAA,CAAQ,OAAO,KAAK,CAAA;AAAA,MACtB;AAAA,KACF;AAAA,EACF;AAAA,EAEA,YAAA,GAAkD;AAChD,IAAA,OAAO,IAAA,CAAK,OAAA;AAAA,EACd;AACF;;;;"}