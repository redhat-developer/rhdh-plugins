{"version":3,"file":"Tracker.esm.js","sources":["../../src/analytics/Tracker.ts"],"sourcesContent":["/*\n * Copyright 2021 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { getOrCreateGlobalSingleton } from '@backstage/version-bridge';\nimport {\n  AnalyticsApi,\n  AnalyticsEventAttributes,\n  AnalyticsTracker,\n} from '../apis';\nimport { AnalyticsContextValue } from './types';\n\ntype TempGlobalEvents = {\n  /**\n   * Stores the most recent \"gathered\" mountpoint navigation.\n   */\n  mostRecentGatheredNavigation?: {\n    action: string;\n    subject: string;\n    value?: number;\n    attributes?: AnalyticsEventAttributes;\n    context: AnalyticsContextValue;\n  };\n  /**\n   * Stores the most recent routable extension render.\n   */\n  mostRecentRoutableExtensionRender?: {\n    context: AnalyticsContextValue;\n  };\n  /**\n   * Tracks whether or not a beforeunload event listener has already been\n   * registered.\n   */\n  beforeUnloadRegistered: boolean;\n};\n\n/**\n * Temporary global store for select event data. Used to make `navigate` events\n * more accurate when gathered mountpoints are used.\n */\nconst globalEvents = getOrCreateGlobalSingleton<TempGlobalEvents>(\n  'core-plugin-api:analytics-tracker-events',\n  () => ({\n    mostRecentGatheredNavigation: undefined,\n    mostRecentRoutableExtensionRender: undefined,\n    beforeUnloadRegistered: false,\n  }),\n);\n\n/**\n * Internal-only event representing when a routable extension is rendered.\n */\nexport const routableExtensionRenderedEvent = '_ROUTABLE-EXTENSION-RENDERED';\n\nexport class Tracker implements AnalyticsTracker {\n  constructor(\n    private readonly analyticsApi: AnalyticsApi,\n    private context: AnalyticsContextValue = {\n      routeRef: 'unknown',\n      pluginId: 'root',\n      extension: 'App',\n    },\n  ) {\n    // Only register a single beforeunload event across all trackers.\n    if (!globalEvents.beforeUnloadRegistered) {\n      // Before the page unloads, attempt to capture any deferred navigation\n      // events that haven't yet been captured.\n      addEventListener(\n        'beforeunload',\n        () => {\n          if (globalEvents.mostRecentGatheredNavigation) {\n            this.analyticsApi.captureEvent({\n              ...globalEvents.mostRecentGatheredNavigation,\n              ...globalEvents.mostRecentRoutableExtensionRender,\n            });\n            globalEvents.mostRecentGatheredNavigation = undefined;\n            globalEvents.mostRecentRoutableExtensionRender = undefined;\n          }\n        },\n        { once: true, passive: true },\n      );\n\n      // Prevent duplicate handlers from being registered.\n      globalEvents.beforeUnloadRegistered = true;\n    }\n  }\n\n  setContext(context: AnalyticsContextValue) {\n    this.context = context;\n  }\n\n  captureEvent(\n    action: string,\n    subject: string,\n    {\n      value,\n      attributes,\n    }: { value?: number; attributes?: AnalyticsEventAttributes } = {},\n  ) {\n    // Never pass internal \"_routeNodeType\" context value.\n    const { _routeNodeType, ...context } = this.context;\n\n    // Never fire the special \"_routable-extension-rendered\" internal event.\n    if (action === routableExtensionRenderedEvent) {\n      // But keep track of it if we're delaying a `navigate` event for a\n      // a gathered route node type.\n      if (globalEvents.mostRecentGatheredNavigation) {\n        globalEvents.mostRecentRoutableExtensionRender = {\n          context: {\n            ...context,\n            extension: 'App',\n          },\n        };\n      }\n      return;\n    }\n\n    // If we are about to fire a real event, and we have an un-fired gathered\n    // mountpoint navigation on the global store, we need to fire the navigate\n    // event first, so this real event happens accurately after the navigation.\n    if (globalEvents.mostRecentGatheredNavigation) {\n      try {\n        this.analyticsApi.captureEvent({\n          ...globalEvents.mostRecentGatheredNavigation,\n          ...globalEvents.mostRecentRoutableExtensionRender,\n        });\n      } catch (e) {\n        // eslint-disable-next-line no-console\n        console.warn('Error during analytics event capture. %o', e);\n      }\n\n      // Clear the global stores.\n      globalEvents.mostRecentGatheredNavigation = undefined;\n      globalEvents.mostRecentRoutableExtensionRender = undefined;\n    }\n\n    // Never directly fire a navigation event on a gathered route with default\n    // contextual details.\n    if (\n      action === 'navigate' &&\n      _routeNodeType === 'gathered' &&\n      context.pluginId === 'root'\n    ) {\n      // Instead, set it on the global store.\n      globalEvents.mostRecentGatheredNavigation = {\n        action,\n        subject,\n        value,\n        attributes,\n        context,\n      };\n      return;\n    }\n\n    try {\n      this.analyticsApi.captureEvent({\n        action,\n        subject,\n        value,\n        attributes,\n        context,\n      });\n    } catch (e) {\n      // eslint-disable-next-line no-console\n      console.warn('Error during analytics event capture. %o', e);\n    }\n  }\n}\n"],"names":[],"mappings":"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"}