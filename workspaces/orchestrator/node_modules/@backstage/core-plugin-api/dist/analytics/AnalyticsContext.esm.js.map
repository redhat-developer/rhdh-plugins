{"version":3,"file":"AnalyticsContext.esm.js","sources":["../../src/analytics/AnalyticsContext.tsx"],"sourcesContent":["/*\n * Copyright 2021 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  createVersionedContext,\n  createVersionedValueMap,\n} from '@backstage/version-bridge';\nimport { ComponentType, ReactNode, useContext } from 'react';\nimport { AnalyticsContextValue } from './types';\n\nconst AnalyticsReactContext = createVersionedContext<{\n  1: AnalyticsContextValue;\n}>('analytics-context');\n\n/**\n * A \"private\" (to this package) hook that enables context inheritance and a\n * way to read Analytics Context values at event capture-time.\n *\n * @internal\n */\nexport const useAnalyticsContext = (): AnalyticsContextValue => {\n  const theContext = useContext(AnalyticsReactContext);\n\n  // Provide a default value if no value exists.\n  if (theContext === undefined) {\n    return {\n      routeRef: 'unknown',\n      pluginId: 'root',\n      extension: 'App',\n    };\n  }\n\n  // This should probably never happen, but check for it.\n  const theValue = theContext.atVersion(1);\n  if (theValue === undefined) {\n    throw new Error('No context found for version 1.');\n  }\n\n  return theValue;\n};\n\n/**\n * Provides components in the child react tree an Analytics Context, ensuring\n * all analytics events captured within the context have relevant attributes.\n *\n * @remarks\n *\n * Analytics contexts are additive, meaning the context ultimately emitted with\n * an event is the combination of all contexts in the parent tree.\n *\n * @public\n */\nexport const AnalyticsContext = (options: {\n  attributes: Partial<AnalyticsContextValue>;\n  children: ReactNode;\n}) => {\n  const { attributes, children } = options;\n\n  const parentValues = useAnalyticsContext();\n  const combinedValue = {\n    ...parentValues,\n    ...attributes,\n  };\n\n  const versionedCombinedValue = createVersionedValueMap({ 1: combinedValue });\n  return (\n    <AnalyticsReactContext.Provider value={versionedCombinedValue}>\n      {children}\n    </AnalyticsReactContext.Provider>\n  );\n};\n\n/**\n * Returns an HOC wrapping the provided component in an Analytics context with\n * the given values.\n *\n * @param Component - Component to be wrapped with analytics context attributes\n * @param values - Analytics context key/value pairs.\n * @internal\n */\nexport function withAnalyticsContext<TProps extends {}>(\n  Component: ComponentType<TProps>,\n  values: AnalyticsContextValue,\n) {\n  const ComponentWithAnalyticsContext = (props: TProps) => {\n    return (\n      <AnalyticsContext attributes={values}>\n        <Component {...props} />\n      </AnalyticsContext>\n    );\n  };\n  ComponentWithAnalyticsContext.displayName = `WithAnalyticsContext(${\n    Component.displayName || Component.name || 'Component'\n  })`;\n  return ComponentWithAnalyticsContext;\n}\n"],"names":[],"mappings":";;;;AAuBA,MAAM,qBAAA,GAAwB,uBAE3B,mBAAmB,CAAA;AAQf,MAAM,sBAAsB,MAA6B;AAC9D,EAAA,MAAM,UAAA,GAAa,WAAW,qBAAqB,CAAA;AAGnD,EAAA,IAAI,eAAe,MAAA,EAAW;AAC5B,IAAA,OAAO;AAAA,MACL,QAAA,EAAU,SAAA;AAAA,MACV,QAAA,EAAU,MAAA;AAAA,MACV,SAAA,EAAW;AAAA,KACb;AAAA,EACF;AAGA,EAAA,MAAM,QAAA,GAAW,UAAA,CAAW,SAAA,CAAU,CAAC,CAAA;AACvC,EAAA,IAAI,aAAa,MAAA,EAAW;AAC1B,IAAA,MAAM,IAAI,MAAM,iCAAiC,CAAA;AAAA,EACnD;AAEA,EAAA,OAAO,QAAA;AACT;AAaO,MAAM,gBAAA,GAAmB,CAAC,OAAA,KAG3B;AACJ,EAAA,MAAM,EAAE,UAAA,EAAY,QAAA,EAAS,GAAI,OAAA;AAEjC,EAAA,MAAM,eAAe,mBAAA,EAAoB;AACzC,EAAA,MAAM,aAAA,GAAgB;AAAA,IACpB,GAAG,YAAA;AAAA,IACH,GAAG;AAAA,GACL;AAEA,EAAA,MAAM,sBAAA,GAAyB,uBAAA,CAAwB,EAAE,CAAA,EAAG,eAAe,CAAA;AAC3E,EAAA,2BACG,qBAAA,CAAsB,QAAA,EAAtB,EAA+B,KAAA,EAAO,wBACpC,QAAA,EACH,CAAA;AAEJ;;;;"}