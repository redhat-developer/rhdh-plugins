{"version":3,"file":"useElementFilter.esm.js","sources":["../../src/extensions/useElementFilter.tsx"],"sourcesContent":["/*\n * Copyright 2021 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport {\n  Children,\n  Fragment,\n  isValidElement,\n  ReactNode,\n  ReactElement,\n  useMemo,\n} from 'react';\nimport { getComponentData } from './componentData';\nimport { useApi, FeatureFlagsApi, featureFlagsApiRef } from '../apis';\n\nfunction selectChildren(\n  rootNode: ReactNode,\n  featureFlagsApi: FeatureFlagsApi,\n  selector?: (element: ReactElement<unknown>) => boolean,\n  strictError?: string,\n): Array<ReactElement<unknown>> {\n  return Children.toArray(rootNode).flatMap(node => {\n    if (!isValidElement(node)) {\n      return [];\n    }\n\n    if (node.type === Fragment) {\n      return selectChildren(\n        node.props.children,\n        featureFlagsApi,\n        selector,\n        strictError,\n      );\n    }\n\n    if (getComponentData(node, 'core.featureFlagged')) {\n      const props = node.props as { with: string } | { without: string };\n      const isEnabled =\n        'with' in props\n          ? featureFlagsApi.isActive(props.with)\n          : !featureFlagsApi.isActive(props.without);\n      if (isEnabled) {\n        return selectChildren(\n          node.props.children,\n          featureFlagsApi,\n          selector,\n          strictError,\n        );\n      }\n      return [];\n    }\n\n    if (selector === undefined || selector(node)) {\n      return [node];\n    }\n\n    if (strictError) {\n      throw new Error(strictError);\n    }\n\n    return selectChildren(\n      node.props.children,\n      featureFlagsApi,\n      selector,\n      strictError,\n    );\n  });\n}\n\n/**\n * A querying interface tailored to traversing a set of selected React elements\n * and extracting data.\n *\n * @remarks\n *\n * Methods prefixed with `selectBy` are used to narrow the set of selected elements.\n *\n * Methods prefixed with `find` return concrete data using a deep traversal of the set.\n *\n * Methods prefixed with `get` return concrete data using a shallow traversal of the set.\n *\n * @public\n */\nexport interface ElementCollection {\n  /**\n   * Narrows the set of selected components by doing a deep traversal and\n   * only including those that have defined component data for the given `key`.\n   *\n   * @remarks\n   *\n   * Whether an element in the tree has component data set for the given key\n   * is determined by whether `getComponentData` returns undefined.\n   *\n   * The traversal does not continue deeper past elements that match the criteria,\n   * and it also includes the root children in the selection, meaning that if the,\n   * of all the currently selected elements contain data for the given key, this\n   * method is a no-op.\n   *\n   * If `withStrictError` is set, the resulting selection must be a full match, meaning\n   * there may be no elements that were excluded in the selection. If the selection\n   * is not a clean match, an error will be throw with `withStrictError` as the message.\n   *\n   * @param query - Filtering query.\n   */\n  selectByComponentData(query: {\n    key: string;\n    withStrictError?: string;\n  }): ElementCollection;\n\n  /**\n   * Finds all elements using the same criteria as `selectByComponentData`, but\n   * returns the actual component data of each of those elements instead.\n   *\n   * @param query - Lookup query.\n   */\n  findComponentData<T>(query: { key: string }): T[];\n\n  /**\n   * Returns all of the elements currently selected by this collection.\n   */\n  getElements<Props extends { [name: string]: unknown }>(): Array<\n    ReactElement<Props>\n  >;\n}\n\nclass Collection implements ElementCollection {\n  constructor(\n    private readonly node: ReactNode,\n    private readonly featureFlagsApi: FeatureFlagsApi,\n  ) {}\n\n  selectByComponentData(query: { key: string; withStrictError?: string }) {\n    const selection = selectChildren(\n      this.node,\n      this.featureFlagsApi,\n      node => getComponentData(node, query.key) !== undefined,\n      query.withStrictError,\n    );\n    return new Collection(selection, this.featureFlagsApi);\n  }\n\n  findComponentData<T>(query: { key: string }): T[] {\n    const selection = selectChildren(\n      this.node,\n      this.featureFlagsApi,\n      node => getComponentData(node, query.key) !== undefined,\n    );\n    return selection\n      .map(node => getComponentData<T>(node, query.key))\n      .filter((data: T | undefined): data is T => data !== undefined);\n  }\n\n  getElements<Props extends { [name: string]: unknown }>(): Array<\n    ReactElement<Props>\n  > {\n    return selectChildren(this.node, this.featureFlagsApi) as Array<\n      ReactElement<Props>\n    >;\n  }\n}\n\n/**\n * useElementFilter is a utility that helps you narrow down and retrieve data\n * from a React element tree, typically operating on the `children` property\n * passed in to a component.\n *\n * @remarks\n *\n * A common use-case is to construct declarative APIs\n * where a React component defines its behavior based on its children, such as\n * the relationship between `Routes` and `Route` in `react-router`.\n *\n * The purpose of this hook is similar to `React.Children.map`, and it expands upon\n * it to also handle traversal of fragments and Backstage specific things like the\n * `FeatureFlagged` component.\n *\n * The return value of the hook is computed by the provided filter function, but\n * with added memoization based on the input `node`. If further memoization\n * dependencies are used in the filter function, they should be added to the\n * third `dependencies` argument, just like `useMemo`, `useEffect`, etc.\n *\n * @public\n */\nexport function useElementFilter<T>(\n  node: ReactNode,\n  filterFn: (arg: ElementCollection) => T,\n  dependencies: any[] = [],\n) {\n  const featureFlagsApi = useApi(featureFlagsApiRef);\n  const elements = new Collection(node, featureFlagsApi);\n  // eslint-disable-next-line react-hooks/exhaustive-deps\n  return useMemo(() => filterFn(elements), [node, ...dependencies]);\n}\n"],"names":[],"mappings":"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"}