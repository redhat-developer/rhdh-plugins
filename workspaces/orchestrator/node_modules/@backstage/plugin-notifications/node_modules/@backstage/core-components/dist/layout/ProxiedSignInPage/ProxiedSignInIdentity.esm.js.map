{"version":3,"file":"ProxiedSignInIdentity.esm.js","sources":["../../../src/layout/ProxiedSignInPage/ProxiedSignInIdentity.ts"],"sourcesContent":["/*\n * Copyright 2021 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  BackstageUserIdentity,\n  discoveryApiRef,\n  IdentityApi,\n  ProfileInfo,\n} from '@backstage/core-plugin-api';\nimport { ResponseError } from '@backstage/errors';\nimport { ProxiedSession, proxiedSessionSchema } from './types';\n\nexport const DEFAULTS = {\n  // The amount of time between token refreshes, if we fail to get an actual\n  // value out of the exp claim\n  defaultTokenExpiryMillis: 5 * 60 * 1000,\n  // The amount of time before the actual expiry of the Backstage token, that we\n  // shall start trying to get a new one\n  tokenExpiryMarginMillis: 5 * 60 * 1000,\n} as const;\n\n// When the token expires, with some margin\nexport function tokenToExpiry(jwtToken: string | undefined): Date {\n  const fallback = new Date(Date.now() + DEFAULTS.defaultTokenExpiryMillis);\n  if (!jwtToken) {\n    return fallback;\n  }\n\n  const [_header, rawPayload, _signature] = jwtToken.split('.');\n  const payload = JSON.parse(window.atob(rawPayload));\n  if (typeof payload.exp !== 'number') {\n    return fallback;\n  }\n\n  return new Date(payload.exp * 1000 - DEFAULTS.tokenExpiryMarginMillis);\n}\n\ntype ProxiedSignInIdentityOptions = {\n  provider: string;\n  discoveryApi: typeof discoveryApiRef.T;\n  headers?: HeadersInit | (() => HeadersInit) | (() => Promise<HeadersInit>);\n};\n\ntype State =\n  | {\n      type: 'empty';\n    }\n  | {\n      type: 'fetching';\n      promise: Promise<ProxiedSession>;\n      previous: ProxiedSession | undefined;\n    }\n  | {\n      type: 'active';\n      session: ProxiedSession;\n      expiresAt: Date;\n    }\n  | {\n      type: 'failed';\n      error: Error;\n    };\n\n/**\n * An identity API that gets the user auth information solely based on a\n * provider's `/refresh` endpoint.\n */\nexport class ProxiedSignInIdentity implements IdentityApi {\n  private readonly options: ProxiedSignInIdentityOptions;\n  private readonly abortController: AbortController;\n  private state: State;\n\n  constructor(options: ProxiedSignInIdentityOptions) {\n    this.options = options;\n    this.abortController = new AbortController();\n    this.state = { type: 'empty' };\n  }\n\n  async start() {\n    // Try to make a first fetch, bubble up any errors to the caller\n    await this.getSessionAsync();\n  }\n\n  /** {@inheritdoc @backstage/core-plugin-api#IdentityApi.getUserId} */\n  getUserId(): string {\n    const { backstageIdentity } = this.getSessionSync();\n    const ref = backstageIdentity.identity.userEntityRef;\n    const match = /^([^:/]+:)?([^:/]+\\/)?([^:/]+)$/.exec(ref);\n    if (!match) {\n      throw new TypeError(`Invalid user entity reference \"${ref}\"`);\n    }\n\n    return match[3];\n  }\n\n  /** {@inheritdoc @backstage/core-plugin-api#IdentityApi.getIdToken} */\n  async getIdToken(): Promise<string | undefined> {\n    const session = await this.getSessionAsync();\n    return session.backstageIdentity.token;\n  }\n\n  /** {@inheritdoc @backstage/core-plugin-api#IdentityApi.getProfile} */\n  getProfile(): ProfileInfo {\n    const session = this.getSessionSync();\n    return session.profile;\n  }\n\n  /** {@inheritdoc @backstage/core-plugin-api#IdentityApi.getProfileInfo} */\n  async getProfileInfo(): Promise<ProfileInfo> {\n    const session = await this.getSessionAsync();\n    return session.profile;\n  }\n\n  /** {@inheritdoc @backstage/core-plugin-api#IdentityApi.getBackstageIdentity} */\n  async getBackstageIdentity(): Promise<BackstageUserIdentity> {\n    const session = await this.getSessionAsync();\n    return session.backstageIdentity.identity;\n  }\n\n  /** {@inheritdoc @backstage/core-plugin-api#IdentityApi.getCredentials} */\n  async getCredentials(): Promise<{ token?: string | undefined }> {\n    const session = await this.getSessionAsync();\n    return {\n      token: session.backstageIdentity.token,\n    };\n  }\n\n  /** {@inheritdoc @backstage/core-plugin-api#IdentityApi.signOut} */\n  async signOut(): Promise<void> {\n    this.abortController.abort();\n  }\n\n  getSessionSync(): ProxiedSession {\n    if (this.state.type === 'active') {\n      return this.state.session;\n    } else if (this.state.type === 'fetching' && this.state.previous) {\n      return this.state.previous;\n    }\n    throw new Error('No session available. Try reloading your browser page.');\n  }\n\n  async getSessionAsync(): Promise<ProxiedSession> {\n    if (this.state.type === 'fetching') {\n      return this.state.promise;\n    } else if (\n      this.state.type === 'active' &&\n      new Date() < this.state.expiresAt\n    ) {\n      return this.state.session;\n    }\n\n    const previous =\n      this.state.type === 'active' ? this.state.session : undefined;\n\n    const promise = this.fetchSession().then(\n      session => {\n        this.state = {\n          type: 'active',\n          session,\n          expiresAt: tokenToExpiry(session.backstageIdentity.token),\n        };\n        return session;\n      },\n      error => {\n        this.state = {\n          type: 'failed',\n          error,\n        };\n        throw error;\n      },\n    );\n\n    this.state = {\n      type: 'fetching',\n      promise,\n      previous,\n    };\n\n    return promise;\n  }\n\n  async fetchSession(): Promise<ProxiedSession> {\n    const baseUrl = await this.options.discoveryApi.getBaseUrl('auth');\n\n    const headers =\n      typeof this.options.headers === 'function'\n        ? await this.options.headers()\n        : this.options.headers;\n    const mergedHeaders = new Headers(headers);\n    mergedHeaders.set('X-Requested-With', 'XMLHttpRequest');\n\n    // Note that we do not use the fetchApi here, since this all happens before\n    // sign-in completes so there can be no automatic token injection and\n    // similar.\n    const response = await fetch(\n      `${baseUrl}/${this.options.provider}/refresh`,\n      {\n        signal: this.abortController.signal,\n        headers: mergedHeaders,\n        credentials: 'include',\n      },\n    );\n\n    if (!response.ok) {\n      throw await ResponseError.fromResponse(response);\n    }\n\n    return proxiedSessionSchema.parse(await response.json());\n  }\n}\n"],"names":[],"mappings":"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"}