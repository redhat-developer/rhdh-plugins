{"version":3,"file":"githubPullRequest.cjs.js","sources":["../../src/actions/githubPullRequest.ts"],"sourcesContent":["/*\n * Copyright 2021 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport path from 'path';\nimport {\n  GithubCredentialsProvider,\n  ScmIntegrationRegistry,\n} from '@backstage/integration';\nimport {\n  createTemplateAction,\n  parseRepoUrl,\n  SerializedFile,\n  serializeDirectoryContents,\n} from '@backstage/plugin-scaffolder-node';\nimport { Octokit } from 'octokit';\nimport { CustomErrorBase, InputError } from '@backstage/errors';\nimport {\n  createPullRequest,\n  DELETE_FILE,\n} from 'octokit-plugin-create-pull-request';\nimport { getOctokitOptions } from '../util';\nimport { examples } from './githubPullRequest.examples';\nimport {\n  LoggerService,\n  resolveSafeChildPath,\n} from '@backstage/backend-plugin-api';\nimport { Config } from '@backstage/config';\nimport { JsonValue } from '@backstage/types';\n\nexport type Encoding = 'utf-8' | 'base64';\n\nclass GithubResponseError extends CustomErrorBase {}\n\nexport const defaultClientFactory: CreateGithubPullRequestActionOptions['clientFactory'] =\n  async ({\n    integrations,\n    githubCredentialsProvider,\n    owner,\n    repo,\n    host = 'github.com',\n    token: providedToken,\n  }) => {\n    const octokitOptions = await getOctokitOptions({\n      integrations,\n      credentialsProvider: githubCredentialsProvider,\n      host,\n      owner,\n      repo,\n      token: providedToken,\n    });\n\n    const OctokitPR = Octokit.plugin(createPullRequest);\n    return new OctokitPR({\n      ...octokitOptions,\n      ...{ throttle: { enabled: false } },\n    });\n  };\n\n/**\n * The options passed to {@link createPublishGithubPullRequestAction} method\n * @public\n */\nexport interface CreateGithubPullRequestActionOptions {\n  /**\n   * An instance of {@link @backstage/integration#ScmIntegrationRegistry} that will be used in the action.\n   */\n  integrations: ScmIntegrationRegistry;\n  /**\n   * An instance of {@link @backstage/integration#GithubCredentialsProvider} that will be used to get credentials for the action.\n   */\n  githubCredentialsProvider?: GithubCredentialsProvider;\n  /**\n   * A method to return the Octokit client with the Pull Request Plugin.\n   */\n  clientFactory?: (input: {\n    integrations: ScmIntegrationRegistry;\n    githubCredentialsProvider?: GithubCredentialsProvider;\n    host: string;\n    owner: string;\n    repo: string;\n    token?: string;\n  }) => Promise<\n    Octokit & {\n      createPullRequest(options: createPullRequest.Options): Promise<{\n        data: {\n          html_url: string;\n          number: number;\n          base: {\n            ref: string;\n          };\n        };\n      } | null>;\n    }\n  >;\n  /**\n   * An instance of {@link @backstage/config#Config} that will be used in the action.\n   */\n  config?: Config;\n}\n\ntype GithubPullRequest = {\n  owner: string;\n  repo: string;\n  number: number;\n};\n\n/**\n * Creates a Github Pull Request action.\n * @public\n */\nexport const createPublishGithubPullRequestAction = (\n  options: CreateGithubPullRequestActionOptions,\n) => {\n  const {\n    integrations,\n    githubCredentialsProvider,\n    clientFactory = defaultClientFactory,\n    config,\n  } = options;\n\n  return createTemplateAction({\n    id: 'publish:github:pull-request',\n    examples,\n    supportsDryRun: true,\n    schema: {\n      input: {\n        repoUrl: z =>\n          z.string({\n            description:\n              'Accepts the format `github.com?repo=reponame&owner=owner` where `reponame` is the repository name and `owner` is an organization or username',\n          }),\n        branchName: z =>\n          z.string({\n            description: 'The name for the branch',\n          }),\n        filesToDelete: z =>\n          z\n            .array(z.string(), {\n              description: 'List of files that will be deleted',\n            })\n            .optional(),\n        targetBranchName: z =>\n          z\n            .string({\n              description: 'The target branch name of the pull request',\n            })\n            .optional(),\n        title: z =>\n          z.string({\n            description: 'The name for the pull request',\n          }),\n        description: z =>\n          z.string({\n            description: 'The description of the pull request',\n          }),\n        draft: z =>\n          z\n            .boolean({\n              description: 'Create a draft pull request',\n            })\n            .optional(),\n        sourcePath: z =>\n          z\n            .string({\n              description:\n                'Subdirectory of working directory to copy changes from',\n            })\n            .optional(),\n        targetPath: z =>\n          z\n            .string({\n              description: 'Subdirectory of repository to apply changes to',\n            })\n            .optional(),\n        token: z =>\n          z\n            .string({\n              description: 'The token to use for authorization to GitHub',\n            })\n            .optional(),\n        reviewers: z =>\n          z\n            .array(z.string(), {\n              description:\n                'The users that will be added as reviewers to the pull request',\n            })\n            .optional(),\n        assignees: z =>\n          z\n            .array(z.string(), {\n              description:\n                'The users that will be added as assignees to the pull request',\n            })\n            .optional(),\n        teamReviewers: z =>\n          z\n            .array(z.string(), {\n              description:\n                'The teams that will be added as reviewers to the pull request',\n            })\n            .optional(),\n        commitMessage: z =>\n          z\n            .string({\n              description: 'The commit message for the pull request commit',\n            })\n            .optional(),\n        update: z =>\n          z\n            .boolean({\n              description: 'Update pull request if already exists',\n            })\n            .optional(),\n        forceFork: z =>\n          z\n            .boolean({\n              description: 'Create pull request from a fork',\n            })\n            .optional(),\n        gitAuthorName: z =>\n          z\n            .string({\n              description:\n                'Sets the default author name for the commit. The default value is the authenticated user or `Scaffolder`',\n            })\n            .optional(),\n        gitAuthorEmail: z =>\n          z\n            .string({\n              description:\n                'Sets the default author email for the commit. The default value is the authenticated user or `scaffolder@backstage.io`',\n            })\n            .optional(),\n        forceEmptyGitAuthor: z =>\n          z\n            .boolean({\n              description:\n                'Forces the author to be empty. This is useful when using a Github App, it permit the commit to be verified on Github',\n            })\n            .optional(),\n        createWhenEmpty: z =>\n          z\n            .boolean({\n              description:\n                'Set whether to create pull request when there are no changes to commit. The default value is true. If set to false, remoteUrl is no longer a required output.',\n            })\n            .optional(),\n      },\n      output: {\n        targetBranchName: z =>\n          z.string({\n            description: 'Target branch name of the merge request',\n          }),\n        remoteUrl: z =>\n          z.string({\n            description: 'Link to the pull request in Github',\n          }),\n        pullRequestNumber: z =>\n          z.number({\n            description: 'The pull request number',\n          }),\n      },\n    },\n    async handler(ctx) {\n      const {\n        repoUrl,\n        branchName,\n        filesToDelete,\n        targetBranchName,\n        title,\n        description,\n        draft,\n        targetPath,\n        sourcePath,\n        token: providedToken,\n        reviewers,\n        assignees,\n        teamReviewers,\n        commitMessage,\n        update,\n        forceFork,\n        gitAuthorEmail,\n        gitAuthorName,\n        forceEmptyGitAuthor,\n        createWhenEmpty,\n      } = ctx.input;\n\n      const { owner, repo, host } = parseRepoUrl(repoUrl, integrations);\n\n      if (!owner) {\n        throw new InputError(\n          `No owner provided for host: ${host}, and repo ${repo}`,\n        );\n      }\n\n      const client = await clientFactory({\n        integrations,\n        githubCredentialsProvider,\n        host,\n        owner,\n        repo,\n        token: providedToken,\n      });\n\n      const fileRoot = sourcePath\n        ? resolveSafeChildPath(ctx.workspacePath, sourcePath)\n        : ctx.workspacePath;\n\n      const directoryContents = await serializeDirectoryContents(fileRoot, {\n        gitignore: true,\n      });\n\n      const determineFileMode = (file: SerializedFile): string => {\n        if (file.symlink) return '120000';\n        if (file.executable) return '100755';\n        return '100644';\n      };\n\n      const determineFileEncoding = (\n        file: SerializedFile,\n      ): 'utf-8' | 'base64' => (file.symlink ? 'utf-8' : 'base64');\n\n      const files = Object.fromEntries([\n        ...directoryContents.map(file => [\n          targetPath ? path.posix.join(targetPath, file.path) : file.path,\n          {\n            // See the properties of tree items\n            // in https://docs.github.com/en/rest/reference/git#trees\n            mode: determineFileMode(file),\n            // Always use base64 encoding where possible to avoid doubling a binary file in size\n            // due to interpreting a binary file as utf-8 and sending github\n            // the utf-8 encoded content. Symlinks are kept as utf-8 to avoid them\n            // being formatted as a series of scrambled characters\n            //\n            // For example, the original gradle-wrapper.jar is 57.8k in https://github.com/kennethzfeng/pull-request-test/pull/5/files.\n            // Its size could be doubled to 98.3K (See https://github.com/kennethzfeng/pull-request-test/pull/4/files)\n            encoding: determineFileEncoding(file),\n            content: file.content.toString(determineFileEncoding(file)),\n          },\n        ]),\n        // order of arrays is important so filesToDelete will overwrite\n        // changes from files above\n        ...(filesToDelete || []).map(filePath => [\n          targetPath ? path.posix.join(targetPath, filePath) : filePath,\n          DELETE_FILE,\n        ]),\n      ]);\n\n      // If this is a dry run, log and return\n      if (ctx.isDryRun) {\n        ctx.logger.info(`Performing dry run of creating pull request`);\n        ctx.output('targetBranchName', branchName);\n        ctx.output('remoteUrl', repoUrl);\n        ctx.output('pullRequestNumber', 43);\n        ctx.logger.info(`Dry run complete`);\n        return;\n      }\n\n      try {\n        const createOptions: createPullRequest.Options = {\n          owner,\n          repo,\n          title,\n          changes: [\n            {\n              files,\n              commit:\n                commitMessage ??\n                config?.getOptionalString('scaffolder.defaultCommitMessage') ??\n                title,\n            },\n          ],\n          body: description,\n          head: branchName,\n          draft,\n          update,\n          forceFork,\n          createWhenEmpty,\n        };\n\n        const gitAuthorInfo = {\n          name:\n            gitAuthorName ??\n            config?.getOptionalString('scaffolder.defaultAuthor.name'),\n          email:\n            gitAuthorEmail ??\n            config?.getOptionalString('scaffolder.defaultAuthor.email'),\n        };\n\n        if (!forceEmptyGitAuthor) {\n          if (gitAuthorInfo.name || gitAuthorInfo.email) {\n            if (Array.isArray(createOptions.changes)) {\n              createOptions.changes = createOptions.changes.map(change => ({\n                ...change,\n                author: {\n                  name: gitAuthorInfo.name || 'Scaffolder',\n                  email: gitAuthorInfo.email || 'scaffolder@backstage.io',\n                },\n              }));\n            } else {\n              createOptions.changes = {\n                ...createOptions.changes,\n                author: {\n                  name: gitAuthorInfo.name || 'Scaffolder',\n                  email: gitAuthorInfo.email || 'scaffolder@backstage.io',\n                },\n              };\n            }\n          }\n        }\n\n        if (targetBranchName) {\n          createOptions.base = targetBranchName;\n        }\n\n        const pr = await ctx.checkpoint({\n          key: `create.pr.${owner}.${repo}.${branchName}`,\n          fn: async () => {\n            const response = await client.createPullRequest(createOptions);\n            if (!response) {\n              return null;\n            }\n\n            return {\n              base: response?.data.base,\n              html_url: response?.data.html_url,\n              number: response?.data.number,\n            };\n          },\n        });\n\n        if (createWhenEmpty === false && !pr) {\n          ctx.logger.info('No changes to commit, pull request was not created');\n          return;\n        }\n\n        if (!pr) {\n          throw new GithubResponseError('null response from Github');\n        }\n\n        const pullRequestNumber = pr.number;\n        const pullRequest = { owner, repo, number: pullRequestNumber };\n        if (reviewers || teamReviewers) {\n          await requestReviewersOnPullRequest(\n            pullRequest,\n            reviewers,\n            teamReviewers,\n            client,\n            ctx.logger,\n            ctx.checkpoint,\n          );\n        }\n\n        if (assignees) {\n          if (assignees.length > 10) {\n            ctx.logger.warn(\n              'Assignees list is too long, only the first 10 will be used.',\n            );\n          }\n          await addAssigneesToPullRequest(\n            pullRequest,\n            assignees,\n            client,\n            ctx.logger,\n            ctx.checkpoint,\n          );\n        }\n\n        const targetBranch = pr.base.ref;\n        ctx.output('targetBranchName', targetBranch);\n        ctx.output('remoteUrl', pr.html_url);\n        ctx.output('pullRequestNumber', pullRequestNumber);\n      } catch (e) {\n        throw new GithubResponseError('Pull request creation failed', e);\n      }\n    },\n  });\n\n  async function addAssigneesToPullRequest(\n    pr: GithubPullRequest,\n    assignees: string[],\n    client: Octokit,\n    logger: LoggerService,\n    checkpoint: <T extends JsonValue | void>(opts: {\n      key: string;\n      fn: () => Promise<T> | T;\n    }) => Promise<T>,\n  ) {\n    try {\n      await checkpoint({\n        key: `add.assignees.${pr.owner}.${pr.repo}.${pr.number}`,\n        fn: async () => {\n          const result = await client.rest.issues.addAssignees({\n            owner: pr.owner,\n            repo: pr.repo,\n            issue_number: pr.number,\n            assignees,\n          });\n\n          const addedAssignees = result.data.assignees?.join(', ') ?? '';\n\n          logger.info(\n            `Added assignees [${addedAssignees}] to Pull request ${pr.number}`,\n          );\n        },\n      });\n    } catch (e) {\n      logger.error(\n        `Failure when adding assignees to Pull request ${pr.number}`,\n        e,\n      );\n    }\n  }\n\n  async function requestReviewersOnPullRequest(\n    pr: GithubPullRequest,\n    reviewers: string[] | undefined,\n    teamReviewers: string[] | undefined,\n    client: Octokit,\n    logger: LoggerService,\n    checkpoint: <T extends JsonValue | void>(opts: {\n      key: string;\n      fn: () => Promise<T> | T;\n    }) => Promise<T>,\n  ) {\n    try {\n      await checkpoint({\n        key: `request.reviewers.${pr.owner}.${pr.repo}.${pr.number}`,\n        fn: async () => {\n          const result = await client.rest.pulls.requestReviewers({\n            owner: pr.owner,\n            repo: pr.repo,\n            pull_number: pr.number,\n            reviewers,\n            team_reviewers: teamReviewers\n              ? [...new Set(teamReviewers)]\n              : undefined,\n          });\n\n          const addedUsers = result.data.requested_reviewers?.join(', ') ?? '';\n          const addedTeams = result.data.requested_teams?.join(', ') ?? '';\n\n          logger.info(\n            `Added users [${addedUsers}] and teams [${addedTeams}] as reviewers to Pull request ${pr.number}`,\n          );\n        },\n      });\n    } catch (e) {\n      logger.error(\n        `Failure when adding reviewers to Pull request ${pr.number}`,\n        e,\n      );\n    }\n  }\n};\n"],"names":["CustomErrorBase","getOctokitOptions","Octokit","createPullRequest","createTemplateAction","examples","parseRepoUrl","InputError","resolveSafeChildPath","serializeDirectoryContents","path","DELETE_FILE"],"mappings":"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"}