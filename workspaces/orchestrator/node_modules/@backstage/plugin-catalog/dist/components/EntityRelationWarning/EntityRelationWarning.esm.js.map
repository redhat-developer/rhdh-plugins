{"version":3,"file":"EntityRelationWarning.esm.js","sources":["../../../src/components/EntityRelationWarning/EntityRelationWarning.tsx"],"sourcesContent":["/*\n * Copyright 2021 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Entity } from '@backstage/catalog-model';\nimport {\n  CatalogApi,\n  catalogApiRef,\n  useEntity,\n} from '@backstage/plugin-catalog-react';\nimport Alert from '@material-ui/lab/Alert';\nimport useAsync from 'react-use/esm/useAsync';\nimport Box from '@material-ui/core/Box';\nimport { ResponseErrorPanel } from '@backstage/core-components';\nimport { useApi, ApiHolder } from '@backstage/core-plugin-api';\nimport { catalogTranslationRef } from '../../alpha/translation';\nimport { useTranslationRef } from '@backstage/core-plugin-api/alpha';\n\nasync function getRelationWarnings(entity: Entity, catalogApi: CatalogApi) {\n  const entityRefRelations = entity.relations?.map(\n    relation => relation.targetRef,\n  );\n  if (\n    !entityRefRelations ||\n    entityRefRelations?.length < 1 ||\n    entityRefRelations.length > 1000\n  ) {\n    return [];\n  }\n\n  const relatedEntities = await catalogApi.getEntitiesByRefs({\n    entityRefs: entityRefRelations,\n    fields: ['kind', 'metadata.name', 'metadata.namespace'],\n  });\n\n  return entityRefRelations.filter(\n    (_, index) => relatedEntities.items[index] === undefined,\n  );\n}\n\n/**\n * Returns true if the given entity has relations to other entities, which\n * don't exist in the catalog\n *\n * @public\n */\nexport async function hasRelationWarnings(\n  entity: Entity,\n  context: { apis: ApiHolder },\n) {\n  const catalogApi = context.apis.get(catalogApiRef);\n  if (!catalogApi) {\n    throw new Error(`No implementation available for ${catalogApiRef}`);\n  }\n\n  const relatedEntitiesMissing = await getRelationWarnings(entity, catalogApi);\n  return relatedEntitiesMissing.length > 0;\n}\n\n/**\n * Displays a warning alert if the entity has relations to other entities, which\n * don't exist in the catalog\n *\n * @public\n */\nexport function EntityRelationWarning() {\n  const { entity } = useEntity();\n  const catalogApi = useApi(catalogApiRef);\n  const { loading, error, value } = useAsync(async () => {\n    return getRelationWarnings(entity, catalogApi);\n  }, [entity, catalogApi]);\n  const { t } = useTranslationRef(catalogTranslationRef);\n\n  if (error) {\n    return (\n      <Box mb={1}>\n        <ResponseErrorPanel error={error} />\n      </Box>\n    );\n  }\n\n  if (loading || !value || value.length === 0) {\n    return null;\n  }\n\n  return (\n    <>\n      <Alert severity=\"warning\" style={{ whiteSpace: 'pre-line' }}>\n        {t('entityRelationWarningDescription')} {value.join(', ')}\n      </Alert>\n    </>\n  );\n}\n"],"names":[],"mappings":";;;;;;;;;;AA8BA,eAAe,mBAAA,CAAoB,QAAgB,UAAA,EAAwB;AACzE,EAAA,MAAM,kBAAA,GAAqB,OAAO,SAAA,EAAW,GAAA;AAAA,IAC3C,cAAY,QAAA,CAAS;AAAA,GACvB;AACA,EAAA,IACE,CAAC,kBAAA,IACD,kBAAA,EAAoB,SAAS,CAAA,IAC7B,kBAAA,CAAmB,SAAS,GAAA,EAC5B;AACA,IAAA,OAAO,EAAC;AAAA,EACV;AAEA,EAAA,MAAM,eAAA,GAAkB,MAAM,UAAA,CAAW,iBAAA,CAAkB;AAAA,IACzD,UAAA,EAAY,kBAAA;AAAA,IACZ,MAAA,EAAQ,CAAC,MAAA,EAAQ,eAAA,EAAiB,oBAAoB;AAAA,GACvD,CAAA;AAED,EAAA,OAAO,kBAAA,CAAmB,MAAA;AAAA,IACxB,CAAC,CAAA,EAAG,KAAA,KAAU,eAAA,CAAgB,KAAA,CAAM,KAAK,CAAA,KAAM;AAAA,GACjD;AACF;AAQA,eAAsB,mBAAA,CACpB,QACA,OAAA,EACA;AACA,EAAA,MAAM,UAAA,GAAa,OAAA,CAAQ,IAAA,CAAK,GAAA,CAAI,aAAa,CAAA;AACjD,EAAA,IAAI,CAAC,UAAA,EAAY;AACf,IAAA,MAAM,IAAI,KAAA,CAAM,CAAA,gCAAA,EAAmC,aAAa,CAAA,CAAE,CAAA;AAAA,EACpE;AAEA,EAAA,MAAM,sBAAA,GAAyB,MAAM,mBAAA,CAAoB,MAAA,EAAQ,UAAU,CAAA;AAC3E,EAAA,OAAO,uBAAuB,MAAA,GAAS,CAAA;AACzC;AAQO,SAAS,qBAAA,GAAwB;AACtC,EAAA,MAAM,EAAE,MAAA,EAAO,GAAI,SAAA,EAAU;AAC7B,EAAA,MAAM,UAAA,GAAa,OAAO,aAAa,CAAA;AACvC,EAAA,MAAM,EAAE,OAAA,EAAS,KAAA,EAAO,KAAA,EAAM,GAAI,SAAS,YAAY;AACrD,IAAA,OAAO,mBAAA,CAAoB,QAAQ,UAAU,CAAA;AAAA,EAC/C,CAAA,EAAG,CAAC,MAAA,EAAQ,UAAU,CAAC,CAAA;AACvB,EAAA,MAAM,EAAE,CAAA,EAAE,GAAI,iBAAA,CAAkB,qBAAqB,CAAA;AAErD,EAAA,IAAI,KAAA,EAAO;AACT,IAAA,2BACG,GAAA,EAAA,EAAI,EAAA,EAAI,GACP,QAAA,kBAAA,GAAA,CAAC,kBAAA,EAAA,EAAmB,OAAc,CAAA,EACpC,CAAA;AAAA,EAEJ;AAEA,EAAA,IAAI,OAAA,IAAW,CAAC,KAAA,IAAS,KAAA,CAAM,WAAW,CAAA,EAAG;AAC3C,IAAA,OAAO,IAAA;AAAA,EACT;AAEA,EAAA,uBACE,GAAA,CAAA,QAAA,EAAA,EACE,+BAAC,KAAA,EAAA,EAAM,QAAA,EAAS,WAAU,KAAA,EAAO,EAAE,UAAA,EAAY,UAAA,EAAW,EACvD,QAAA,EAAA;AAAA,IAAA,CAAA,CAAE,kCAAkC,CAAA;AAAA,IAAE,GAAA;AAAA,IAAE,KAAA,CAAM,KAAK,IAAI;AAAA,GAAA,EAC1D,CAAA,EACF,CAAA;AAEJ;;;;"}