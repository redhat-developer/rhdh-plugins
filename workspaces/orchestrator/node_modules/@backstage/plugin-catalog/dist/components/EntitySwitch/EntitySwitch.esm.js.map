{"version":3,"file":"EntitySwitch.esm.js","sources":["../../../src/components/EntitySwitch/EntitySwitch.tsx"],"sourcesContent":["/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Entity } from '@backstage/catalog-model';\nimport { useAsyncEntity } from '@backstage/plugin-catalog-react';\nimport { ReactNode, ReactElement } from 'react';\nimport {\n  attachComponentData,\n  useApiHolder,\n  useElementFilter,\n  ApiHolder,\n} from '@backstage/core-plugin-api';\nimport useAsync from 'react-use/esm/useAsync';\n\nconst ENTITY_SWITCH_KEY = 'core.backstage.entitySwitch';\n\n/** @public */\nexport interface EntitySwitchCaseProps {\n  if?: (\n    entity: Entity,\n    context: { apis: ApiHolder },\n  ) => boolean | Promise<boolean>;\n  children: ReactNode;\n}\n\nconst EntitySwitchCaseComponent = (_props: EntitySwitchCaseProps) => null;\n\nattachComponentData(EntitySwitchCaseComponent, ENTITY_SWITCH_KEY, true);\n\ninterface EntitySwitchCase {\n  if?: (\n    entity: Entity,\n    context: { apis: ApiHolder },\n  ) => boolean | Promise<boolean>;\n  children: JSX.Element;\n}\n\ntype SwitchCaseResult = {\n  if?: boolean | Promise<boolean>;\n  children: JSX.Element;\n};\n\n/**\n * Props for the {@link EntitySwitch} component.\n * @public\n */\nexport interface EntitySwitchProps {\n  children: ReactNode;\n  renderMultipleMatches?: 'first' | 'all';\n}\n\n/** @public */\nexport const EntitySwitch = (props: EntitySwitchProps) => {\n  const { entity, loading } = useAsyncEntity();\n  const apis = useApiHolder();\n\n  const results = useElementFilter(\n    props.children,\n    collection =>\n      collection\n        .selectByComponentData({\n          key: ENTITY_SWITCH_KEY,\n          withStrictError: 'Child of EntitySwitch is not an EntitySwitch.Case',\n        })\n        .getElements()\n        .flatMap<SwitchCaseResult>((element: ReactElement) => {\n          if (loading && !entity) {\n            return [];\n          }\n\n          const { if: condition, children: elementsChildren } =\n            element.props as EntitySwitchCase;\n\n          if (!entity) {\n            return [\n              {\n                if: condition === undefined,\n                children: elementsChildren,\n              },\n            ];\n          }\n          return [\n            {\n              if: condition?.(entity, { apis }),\n              children: elementsChildren,\n            },\n          ];\n        }),\n    [apis, entity, loading],\n  );\n\n  const hasAsyncCases = results.some(\n    r => typeof r.if === 'object' && 'then' in r.if,\n  );\n\n  if (hasAsyncCases) {\n    return (\n      <AsyncEntitySwitch\n        results={results}\n        renderMultipleMatches={props.renderMultipleMatches}\n      />\n    );\n  }\n\n  if (props.renderMultipleMatches === 'all') {\n    const children = results.filter(r => r.if).map(r => r.children);\n    if (children.length === 0) {\n      return getDefaultChildren(results);\n    }\n    return <>{children}</>;\n  }\n\n  return results.find(r => r.if)?.children ?? getDefaultChildren(results);\n};\n\nfunction AsyncEntitySwitch({\n  results,\n  renderMultipleMatches,\n}: {\n  results: SwitchCaseResult[];\n  renderMultipleMatches?: 'first' | 'all';\n}) {\n  const { loading, value } = useAsync(async () => {\n    const promises = results.map(\n      async ({ if: condition, children: output }) => {\n        try {\n          if (await condition) {\n            return output;\n          }\n        } catch {\n          /* ignored */\n        }\n        return null;\n      },\n    );\n\n    if (renderMultipleMatches === 'all') {\n      const children = (await Promise.all(promises)).filter(Boolean);\n      if (children.length === 0) {\n        return getDefaultChildren(results);\n      }\n      return <>{children}</>;\n    }\n\n    return (\n      (await Promise.all(promises)).find(Boolean) ?? getDefaultChildren(results)\n    );\n  }, [results]);\n\n  if (loading || !value) {\n    return null;\n  }\n\n  return value;\n}\n\nfunction getDefaultChildren(results: SwitchCaseResult[]) {\n  return results.filter(r => r.if === undefined)[0]?.children ?? null;\n}\n\nEntitySwitch.Case = EntitySwitchCaseComponent;\n"],"names":[],"mappings":"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"}