{"version":3,"file":"migration.esm.js","sources":["../../../src/apis/StarredEntitiesApi/migration.ts"],"sourcesContent":["/*\n * Copyright 2021 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { stringifyEntityRef } from '@backstage/catalog-model';\nimport { StorageApi } from '@backstage/core-plugin-api';\nimport { isArray, isString } from 'lodash';\n\n/**\n * Migrate the starred entities from the old format (entity:<kind>:<namespace>:<name>) from the\n * old storage location (/settings/starredEntities) to entity references in the new location\n * (/starredEntities/entityRefs).\n *\n * This will only be executed once since the old location is cleared.\n *\n * @param storageApi - the StorageApi to migrate\n */\nexport async function performMigrationToTheNewBucket({\n  storageApi,\n}: {\n  storageApi: StorageApi;\n}) {\n  const source = storageApi.forBucket('settings');\n  const target = storageApi.forBucket('starredEntities');\n\n  const oldStarredEntities = source.snapshot('starredEntities').value;\n\n  if (!isArray(oldStarredEntities)) {\n    // nothing to do\n    return;\n  }\n  const targetEntities = new Set(\n    target.snapshot<string[]>('entityRefs').value ?? [],\n  );\n\n  oldStarredEntities\n    .filter(isString)\n    // extract the old format 'entity:<kind>:<namespace>:<name>'\n    .map(old => old.split(':'))\n    // check if the format is valid\n    .filter(split => split.length === 4 && split[0] === 'entity')\n    // convert to entity references\n    .map(([_, kind, namespace, name]) =>\n      stringifyEntityRef({ kind, namespace, name }),\n    )\n    .forEach(e => targetEntities.add(e));\n\n  await target.set('entityRefs', Array.from(targetEntities));\n\n  await source.remove('starredEntities');\n}\n"],"names":[],"mappings":";;;AA6BA,eAAsB,8BAAA,CAA+B;AAAA,EACnD;AACF,CAAA,EAEG;AACD,EAAA,MAAM,MAAA,GAAS,UAAA,CAAW,SAAA,CAAU,UAAU,CAAA;AAC9C,EAAA,MAAM,MAAA,GAAS,UAAA,CAAW,SAAA,CAAU,iBAAiB,CAAA;AAErD,EAAA,MAAM,kBAAA,GAAqB,MAAA,CAAO,QAAA,CAAS,iBAAiB,CAAA,CAAE,KAAA;AAE9D,EAAA,IAAI,CAAC,OAAA,CAAQ,kBAAkB,CAAA,EAAG;AAEhC,IAAA;AAAA,EACF;AACA,EAAA,MAAM,iBAAiB,IAAI,GAAA;AAAA,IACzB,MAAA,CAAO,QAAA,CAAmB,YAAY,CAAA,CAAE,SAAS;AAAC,GACpD;AAEA,EAAA,kBAAA,CACG,OAAO,QAAQ,CAAA,CAEf,IAAI,CAAA,GAAA,KAAO,GAAA,CAAI,MAAM,GAAG,CAAC,EAEzB,MAAA,CAAO,CAAA,KAAA,KAAS,MAAM,MAAA,KAAW,CAAA,IAAK,MAAM,CAAC,CAAA,KAAM,QAAQ,CAAA,CAE3D,GAAA;AAAA,IAAI,CAAC,CAAC,CAAA,EAAG,IAAA,EAAM,SAAA,EAAW,IAAI,CAAA,KAC7B,kBAAA,CAAmB,EAAE,IAAA,EAAM,SAAA,EAAW,IAAA,EAAM;AAAA,IAE7C,OAAA,CAAQ,CAAA,CAAA,KAAK,cAAA,CAAe,GAAA,CAAI,CAAC,CAAC,CAAA;AAErC,EAAA,MAAM,OAAO,GAAA,CAAI,YAAA,EAAc,KAAA,CAAM,IAAA,CAAK,cAAc,CAAC,CAAA;AAEzD,EAAA,MAAM,MAAA,CAAO,OAAO,iBAAiB,CAAA;AACvC;;;;"}