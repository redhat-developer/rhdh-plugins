{"version":3,"file":"GoogleMigration.cjs.js","sources":["../../../../src/stages/publish/migrations/GoogleMigration.ts"],"sourcesContent":["/*\n * Copyright 2021 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { assertError } from '@backstage/errors';\nimport { File } from '@google-cloud/storage';\nimport { Writable } from 'stream';\nimport { lowerCaseEntityTripletInStoragePath } from '../helpers';\nimport { LoggerService } from '@backstage/backend-plugin-api';\n\n/**\n * Writable stream to handle object copy/move operations. This implementation\n * ensures we don't read in files from GCS faster than GCS can copy/move them.\n */\nexport class MigrateWriteStream extends Writable {\n  protected logger: LoggerService;\n  protected removeOriginal: boolean;\n  protected maxConcurrency: number;\n  protected inFlight = 0;\n\n  constructor(\n    logger: LoggerService,\n    removeOriginal: boolean,\n    concurrency: number,\n  ) {\n    super({ objectMode: true });\n    this.logger = logger;\n    this.removeOriginal = removeOriginal;\n    this.maxConcurrency = concurrency;\n  }\n\n  _write(file: File, _encoding: BufferEncoding, next: Function) {\n    let shouldCallNext = true;\n    let newFile;\n    try {\n      newFile = lowerCaseEntityTripletInStoragePath(file.name);\n    } catch (e) {\n      assertError(e);\n      this.logger.warn(e.message);\n      next();\n      return;\n    }\n\n    // If all parts are already lowercase, ignore.\n    if (newFile === file.name) {\n      next();\n      return;\n    }\n\n    // Allow up to n-many files to be migrated at a time.\n    this.inFlight++;\n    if (this.inFlight < this.maxConcurrency) {\n      next();\n      shouldCallNext = false;\n    }\n\n    // Otherwise, copy or move the file.\n    const migrate = this.removeOriginal\n      ? file.move.bind(file)\n      : file.copy.bind(file);\n    this.logger.debug(`Migrating ${file.name}`);\n    migrate(newFile)\n      .catch(e =>\n        this.logger.warn(`Unable to migrate ${file.name}: ${e.message}`),\n      )\n      .finally(() => {\n        this.inFlight--;\n        if (shouldCallNext) {\n          next();\n        }\n      });\n  }\n}\n"],"names":["Writable","lowerCaseEntityTripletInStoragePath","assertError"],"mappings":";;;;;;AA0BO,MAAM,2BAA2BA,eAAA,CAAS;AAAA,EACrC,MAAA;AAAA,EACA,cAAA;AAAA,EACA,cAAA;AAAA,EACA,QAAA,GAAW,CAAA;AAAA,EAErB,WAAA,CACE,MAAA,EACA,cAAA,EACA,WAAA,EACA;AACA,IAAA,KAAA,CAAM,EAAE,UAAA,EAAY,IAAA,EAAM,CAAA;AAC1B,IAAA,IAAA,CAAK,MAAA,GAAS,MAAA;AACd,IAAA,IAAA,CAAK,cAAA,GAAiB,cAAA;AACtB,IAAA,IAAA,CAAK,cAAA,GAAiB,WAAA;AAAA,EACxB;AAAA,EAEA,MAAA,CAAO,IAAA,EAAY,SAAA,EAA2B,IAAA,EAAgB;AAC5D,IAAA,IAAI,cAAA,GAAiB,IAAA;AACrB,IAAA,IAAI,OAAA;AACJ,IAAA,IAAI;AACF,MAAA,OAAA,GAAUC,2CAAA,CAAoC,KAAK,IAAI,CAAA;AAAA,IACzD,SAAS,CAAA,EAAG;AACV,MAAAC,kBAAA,CAAY,CAAC,CAAA;AACb,MAAA,IAAA,CAAK,MAAA,CAAO,IAAA,CAAK,CAAA,CAAE,OAAO,CAAA;AAC1B,MAAA,IAAA,EAAK;AACL,MAAA;AAAA,IACF;AAGA,IAAA,IAAI,OAAA,KAAY,KAAK,IAAA,EAAM;AACzB,MAAA,IAAA,EAAK;AACL,MAAA;AAAA,IACF;AAGA,IAAA,IAAA,CAAK,QAAA,EAAA;AACL,IAAA,IAAI,IAAA,CAAK,QAAA,GAAW,IAAA,CAAK,cAAA,EAAgB;AACvC,MAAA,IAAA,EAAK;AACL,MAAA,cAAA,GAAiB,KAAA;AAAA,IACnB;AAGA,IAAA,MAAM,OAAA,GAAU,IAAA,CAAK,cAAA,GACjB,IAAA,CAAK,IAAA,CAAK,IAAA,CAAK,IAAI,CAAA,GACnB,IAAA,CAAK,IAAA,CAAK,IAAA,CAAK,IAAI,CAAA;AACvB,IAAA,IAAA,CAAK,MAAA,CAAO,KAAA,CAAM,CAAA,UAAA,EAAa,IAAA,CAAK,IAAI,CAAA,CAAE,CAAA;AAC1C,IAAA,OAAA,CAAQ,OAAO,CAAA,CACZ,KAAA;AAAA,MAAM,CAAA,CAAA,KACL,IAAA,CAAK,MAAA,CAAO,IAAA,CAAK,CAAA,kBAAA,EAAqB,KAAK,IAAI,CAAA,EAAA,EAAK,CAAA,CAAE,OAAO,CAAA,CAAE;AAAA,KACjE,CACC,QAAQ,MAAM;AACb,MAAA,IAAA,CAAK,QAAA,EAAA;AACL,MAAA,IAAI,cAAA,EAAgB;AAClB,QAAA,IAAA,EAAK;AAAA,MACP;AAAA,IACF,CAAC,CAAA;AAAA,EACL;AACF;;;;"}