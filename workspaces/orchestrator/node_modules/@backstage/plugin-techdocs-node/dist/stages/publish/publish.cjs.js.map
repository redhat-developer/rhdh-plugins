{"version":3,"file":"publish.cjs.js","sources":["../../../src/stages/publish/publish.ts"],"sourcesContent":["/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Config } from '@backstage/config';\nimport { AwsS3Publish } from './awsS3';\nimport { AzureBlobStoragePublish } from './azureBlobStorage';\nimport { GoogleGCSPublish } from './googleStorage';\nimport { LocalPublish } from './local';\nimport { OpenStackSwiftPublish } from './openStackSwift';\nimport {\n  PublisherFactory,\n  PublisherBase,\n  PublisherType,\n  PublisherBuilder,\n} from './types';\n\n/**\n * Factory class to create a TechDocs publisher based on defined publisher type in app config.\n * Uses `techdocs.publisher.type`.\n * @public\n */\nexport class Publisher implements PublisherBuilder {\n  private publishers: Map<PublisherType | 'techdocs', PublisherBase> =\n    new Map();\n\n  register(type: PublisherType | 'techdocs', publisher: PublisherBase): void {\n    this.publishers.set(type, publisher);\n  }\n\n  get(config: Config): PublisherBase {\n    const publisherType = (config.getOptionalString(\n      'techdocs.publisher.type',\n    ) ?? 'local') as PublisherType;\n\n    if (!publisherType) {\n      throw new Error('TechDocs publisher type not specified for the entity');\n    }\n\n    const publisher = this.publishers.get(publisherType);\n    if (!publisher) {\n      throw new Error(\n        `TechDocs publisher '${publisherType}' is not registered`,\n      );\n    }\n\n    return publisher;\n  }\n\n  /**\n   * Returns a instance of TechDocs publisher\n   * @param config - A Backstage configuration\n   * @param options - Options for configuring the publisher factory\n   */\n  static async fromConfig(\n    config: Config,\n    options: PublisherFactory,\n  ): Promise<PublisherBase> {\n    const { logger, discovery, customPublisher } = options;\n\n    const publishers = new Publisher();\n\n    if (customPublisher) {\n      publishers.register('techdocs', customPublisher);\n      return customPublisher;\n    }\n\n    const publisherType = (config.getOptionalString(\n      'techdocs.publisher.type',\n    ) ?? 'local') as PublisherType;\n\n    switch (publisherType) {\n      case 'googleGcs':\n        logger.info('Creating Google Storage Bucket publisher for TechDocs');\n        publishers.register(\n          publisherType,\n          GoogleGCSPublish.fromConfig(\n            config,\n            logger,\n            options.publisherSettings?.googleGcs,\n          ),\n        );\n        break;\n      case 'awsS3':\n        logger.info('Creating AWS S3 Bucket publisher for TechDocs');\n        publishers.register(\n          publisherType,\n          await AwsS3Publish.fromConfig(config, logger),\n        );\n        break;\n      case 'azureBlobStorage':\n        logger.info(\n          'Creating Azure Blob Storage Container publisher for TechDocs',\n        );\n        publishers.register(\n          publisherType,\n          AzureBlobStoragePublish.fromConfig(config, logger),\n        );\n        break;\n      case 'openStackSwift':\n        logger.info(\n          'Creating OpenStack Swift Container publisher for TechDocs',\n        );\n        publishers.register(\n          publisherType,\n          OpenStackSwiftPublish.fromConfig(config, logger),\n        );\n        break;\n      case 'local':\n        logger.info('Creating Local publisher for TechDocs');\n        publishers.register(\n          publisherType,\n          LocalPublish.fromConfig(config, logger, discovery),\n        );\n        break;\n      default:\n        logger.info('Creating Local publisher for TechDocs');\n        publishers.register(\n          publisherType,\n          LocalPublish.fromConfig(config, logger, discovery),\n        );\n    }\n\n    return publishers.get(config);\n  }\n}\n"],"names":["GoogleGCSPublish","AwsS3Publish","AzureBlobStoragePublish","OpenStackSwiftPublish","LocalPublish"],"mappings":"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"}