{"version":3,"file":"local.cjs.js","sources":["../../../src/stages/publish/local.ts"],"sourcesContent":["/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  DiscoveryService,\n  LoggerService,\n  resolvePackagePath,\n  resolveSafeChildPath,\n} from '@backstage/backend-plugin-api';\nimport {\n  Entity,\n  CompoundEntityRef,\n  stringifyEntityRef,\n} from '@backstage/catalog-model';\nimport { Config } from '@backstage/config';\nimport express from 'express';\nimport fs from 'fs-extra';\nimport os from 'os';\nimport createLimiter from 'p-limit';\nimport path from 'path';\nimport {\n  PublisherBase,\n  PublishRequest,\n  PublishResponse,\n  ReadinessResponse,\n  TechDocsMetadata,\n} from './types';\nimport {\n  getFileTreeRecursively,\n  getHeadersForFileExtension,\n  lowerCaseEntityTripletInStoragePath,\n} from './helpers';\nimport { ForwardedError } from '@backstage/errors';\n\n/**\n * Local publisher which uses the local filesystem to store the generated static files. It uses by default a\n * directory called \"static\" at the root of techdocs-backend plugin unless a directory has been configured by\n * \"techdocs.publisher.local.publishDirectory\".\n */\nexport class LocalPublish implements PublisherBase {\n  private readonly legacyPathCasing: boolean;\n  private readonly logger: LoggerService;\n  private readonly discovery: DiscoveryService;\n  private readonly staticDocsDir: string;\n\n  constructor(options: {\n    logger: LoggerService;\n    discovery: DiscoveryService;\n    legacyPathCasing: boolean;\n    staticDocsDir: string;\n  }) {\n    this.logger = options.logger;\n    this.discovery = options.discovery;\n    this.legacyPathCasing = options.legacyPathCasing;\n    this.staticDocsDir = options.staticDocsDir;\n  }\n\n  static fromConfig(\n    config: Config,\n    logger: LoggerService,\n    discovery: DiscoveryService,\n  ): PublisherBase {\n    const legacyPathCasing =\n      config.getOptionalBoolean(\n        'techdocs.legacyUseCaseSensitiveTripletPaths',\n      ) || false;\n\n    let staticDocsDir = config.getOptionalString(\n      'techdocs.publisher.local.publishDirectory',\n    );\n    if (!staticDocsDir) {\n      try {\n        staticDocsDir = resolvePackagePath(\n          '@backstage/plugin-techdocs-backend',\n          'static/docs',\n        );\n      } catch (err) {\n        // This will most probably never be used.\n        // The try/catch is introduced so that techdocs-cli can import @backstage/plugin-techdocs-node\n        // on CI/CD without installing techdocs backend plugin.\n        staticDocsDir = os.tmpdir();\n      }\n    }\n\n    return new LocalPublish({\n      logger,\n      discovery,\n      legacyPathCasing,\n      staticDocsDir,\n    });\n  }\n\n  async getReadiness(): Promise<ReadinessResponse> {\n    return {\n      isAvailable: true,\n    };\n  }\n\n  async publish({\n    entity,\n    directory,\n  }: PublishRequest): Promise<PublishResponse> {\n    const entityNamespace = entity.metadata.namespace ?? 'default';\n    let publishDir: string;\n\n    try {\n      publishDir = this.staticEntityPathJoin(\n        entityNamespace,\n        entity.kind,\n        entity.metadata.name,\n      );\n    } catch (error) {\n      throw new ForwardedError(\n        `Unable to publish TechDocs site for entity: ${stringifyEntityRef(\n          entity,\n        )}`,\n        error,\n      );\n    }\n\n    if (!fs.existsSync(publishDir)) {\n      this.logger.info(`Could not find ${publishDir}, creating the directory.`);\n      fs.mkdirSync(publishDir, { recursive: true });\n    }\n\n    try {\n      await fs.copy(directory, publishDir);\n      this.logger.info(`Published site stored at ${publishDir}`);\n    } catch (error) {\n      this.logger.debug(\n        `Failed to copy docs from ${directory} to ${publishDir}`,\n      );\n      throw error;\n    }\n\n    // Generate publish response.\n    const techdocsApiUrl = await this.discovery.getBaseUrl('techdocs');\n    const publishedFilePaths = (await getFileTreeRecursively(publishDir)).map(\n      abs => {\n        return abs.split(`${this.staticDocsDir}/`)[1];\n      },\n    );\n\n    return {\n      remoteUrl: `${techdocsApiUrl}/static/docs/${encodeURIComponent(\n        entity.metadata.name,\n      )}`,\n      objects: publishedFilePaths,\n    };\n  }\n\n  async fetchTechDocsMetadata(\n    entityName: CompoundEntityRef,\n  ): Promise<TechDocsMetadata> {\n    let metadataPath: string;\n\n    try {\n      metadataPath = this.staticEntityPathJoin(\n        entityName.namespace,\n        entityName.kind,\n        entityName.name,\n        'techdocs_metadata.json',\n      );\n    } catch (err) {\n      throw new ForwardedError(\n        `Unexpected entity when fetching metadata: ${stringifyEntityRef(\n          entityName,\n        )}`,\n        err,\n      );\n    }\n\n    try {\n      return await fs.readJson(metadataPath);\n    } catch (err) {\n      throw new ForwardedError(\n        `Unable to read techdocs_metadata.json at ${metadataPath}. Error: ${err}`,\n        err,\n      );\n    }\n  }\n\n  docsRouter(): express.Handler {\n    const router = express.Router();\n\n    // Redirect middleware ensuring that requests to case-sensitive entity\n    // triplet paths are always sent to lower-case versions.\n    router.use((req, res, next) => {\n      // If legacy path casing is on, let the request immediately continue.\n      if (this.legacyPathCasing) {\n        return next();\n      }\n\n      // Generate a lower-case entity triplet path.\n      const [_, namespace, kind, name, ...rest] = req.path.split('/');\n\n      // Ignore non-triplet objects.\n      if (!namespace || !kind || !name) {\n        return next();\n      }\n\n      const newPath = [\n        _,\n        namespace.toLowerCase(),\n        kind.toLowerCase(),\n        name.toLowerCase(),\n        ...rest,\n      ].join('/');\n\n      // If there was no change, then let express.static() handle the request.\n      if (newPath === req.path) {\n        return next();\n      }\n\n      // Otherwise, redirect to the new path.\n      return res.redirect(301, req.baseUrl + newPath);\n    });\n    router.use(\n      express.static(this.staticDocsDir, {\n        // Handle content-type header the same as all other publishers.\n        setHeaders: (res, filePath) => {\n          const fileExtension = path.extname(filePath);\n          const headers = getHeadersForFileExtension(fileExtension);\n          for (const [header, value] of Object.entries(headers)) {\n            res.setHeader(header, value);\n          }\n        },\n      }),\n    );\n\n    return router;\n  }\n\n  async hasDocsBeenGenerated(entity: Entity): Promise<boolean> {\n    const namespace = entity.metadata.namespace ?? 'default';\n\n    // Check if the file exists\n    try {\n      const indexHtmlPath = this.staticEntityPathJoin(\n        namespace,\n        entity.kind,\n        entity.metadata.name,\n        'index.html',\n      );\n\n      await fs.access(indexHtmlPath, fs.constants.F_OK);\n\n      return true;\n    } catch (err) {\n      if (err.name === 'NotAllowedError') {\n        this.logger.error(\n          `Unexpected entity when checking if generated: ${stringifyEntityRef(\n            entity,\n          )}`,\n        );\n      }\n      return false;\n    }\n  }\n\n  /**\n   * This code will never run in practice. It is merely here to illustrate how\n   * to implement this method for other storage providers.\n   */\n  async migrateDocsCase({\n    removeOriginal = false,\n    concurrency = 25,\n  }): Promise<void> {\n    // Iterate through every file in the root of the publisher.\n    const files = await getFileTreeRecursively(this.staticDocsDir);\n    const limit = createLimiter(concurrency);\n\n    await Promise.all(\n      files.map(f =>\n        limit(async file => {\n          const relativeFile = file.replace(\n            `${this.staticDocsDir}${path.sep}`,\n            '',\n          );\n          const newFile = lowerCaseEntityTripletInStoragePath(relativeFile);\n\n          // If all parts are already lowercase, ignore.\n          if (relativeFile === newFile) {\n            return;\n          }\n\n          // Otherwise, copy or move the file.\n          await new Promise<void>(resolve => {\n            const migrate = removeOriginal ? fs.move : fs.copyFile;\n            this.logger.debug(`Migrating ${relativeFile}`);\n            migrate(file, newFile, err => {\n              if (err) {\n                this.logger.warn(\n                  `Unable to migrate ${relativeFile}: ${err.message}`,\n                );\n              }\n              resolve();\n            });\n          });\n        }, f),\n      ),\n    );\n  }\n\n  /**\n   * Utility wrapper around path.join(), used to control legacy case logic.\n   */\n  protected staticEntityPathJoin(...allParts: string[]): string {\n    let staticEntityPath = this.staticDocsDir;\n\n    allParts\n      .map(part => part.split(path.sep))\n      .flat()\n      .forEach((part, index) => {\n        // Respect legacy path casing when operating on namespace, kind, or name.\n        if (index < 3) {\n          staticEntityPath = resolveSafeChildPath(\n            staticEntityPath,\n            this.legacyPathCasing ? part : part.toLowerCase(),\n          );\n          return;\n        }\n\n        // Otherwise, respect the provided case.\n        staticEntityPath = resolveSafeChildPath(staticEntityPath, part);\n      });\n\n    return staticEntityPath;\n  }\n}\n"],"names":["resolvePackagePath","os","ForwardedError","stringifyEntityRef","fs","getFileTreeRecursively","express","path","getHeadersForFileExtension","createLimiter","lowerCaseEntityTripletInStoragePath","resolveSafeChildPath"],"mappings":"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"}