{"version":3,"file":"core.cjs.js","sources":["../../src/harness/core.ts"],"sourcesContent":["/*\n * Copyright 2024 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport { HarnessIntegrationConfig } from './config';\n\n/**\n * Given a URL pointing to a file, returns a URL\n * for editing the contents of the data.\n *\n * @remarks\n *\n * Converts\n * from: https://app.harness.io/a/b/src/branchname/path/to/c.yaml\n * or:   https://app.harness.io/a/b/_edit/branchname/path/to/c.yaml\n *\n * @param url - A URL pointing to a file\n * @param config - The relevant provider config\n * @public\n */\nexport function getHarnessEditContentsUrl(\n  config: HarnessIntegrationConfig,\n  url: string,\n) {\n  const parsedUrl = parseHarnessUrl(config, url);\n\n  return `${parsedUrl.baseUrl}/ng/account/${parsedUrl.accountId}/module/code${\n    parsedUrl.orgName !== '' ? `/orgs/${parsedUrl.orgName}` : ''\n  }${\n    parsedUrl.projectName !== '' ? `/projects/${parsedUrl.projectName}` : ''\n  }/repos/${parsedUrl.repoName}/files/${parsedUrl.branch}/~/${parsedUrl.path}`;\n}\n\n/**\n * Given a file path URL,\n * it returns an API URL which returns the contents of the file .\n * @remarks\n *\n * Converts\n * from: https://app.harness.io/ng/account/accountId/module/code/orgs/orgName/projects/projName/repos/repoName/files/refMain/~/all-apis.yaml\n *       https://qa.harness.io/ng/account/bDCAuAjFSJCLFj_0ug3lCg/module/code/orgs/HiteshTest/repos/impoorter/files/main/~/catalog.yaml\n * to:   https://app.harness.io/gateway/code/api/v1/repos/accountId/orgName/projName/repoName/+/content/all-apis.yaml?routingId=accountId&include_commit=false&ref=refMain\n *\n * @param url - A URL pointing to a file\n * @param config - The relevant provider config\n * @public\n */\nexport function getHarnessFileContentsUrl(\n  config: HarnessIntegrationConfig,\n  url: string,\n) {\n  const parsedUrl = parseHarnessUrl(config, url);\n\n  let constructedUrl = `${parsedUrl.baseUrl}/gateway/code/api/v1/repos/${parsedUrl.accountId}`;\n\n  if (parsedUrl.orgName) {\n    constructedUrl += `/${parsedUrl.orgName}`;\n  }\n\n  if (parsedUrl.projectName) {\n    constructedUrl += `/${parsedUrl.projectName}`;\n  }\n\n  constructedUrl += `/${parsedUrl.repoName}/+/raw/${parsedUrl.path}?routingId=${parsedUrl.accountId}&git_ref=refs/heads/${parsedUrl.refString}`;\n\n  return constructedUrl;\n}\n\n/**\n * Given a URL pointing to a repository/path, returns a URL\n * for archive contents of the repository.\n *\n * @remarks\n *\n * Converts\n * from: https://qa.harness.io/ng/account/accountId/module/code/orgs/orgId/projects/projectName/repos/repoName/files/branch/~/fileName\n * to:   https://qa.harness.io/gateway/code/api/v1/repos/accountId/orgId/projectName/repoName/+/archive/branch.zip?routingId=accountId\n *\n * @param url - A URL pointing to a repository/path\n * @param config - The relevant provider config\n * @public\n */\nexport function getHarnessArchiveUrl(\n  config: HarnessIntegrationConfig,\n  url: string,\n) {\n  const parsedUrl = parseHarnessUrl(config, url);\n\n  let constructedUrl = `${parsedUrl.baseUrl}/gateway/code/api/v1/repos/${parsedUrl.accountId}`;\n\n  if (parsedUrl.orgName) {\n    constructedUrl += `/${parsedUrl.orgName}`;\n  }\n\n  if (parsedUrl.projectName) {\n    constructedUrl += `/${parsedUrl.projectName}`;\n  }\n\n  constructedUrl += `/${parsedUrl.repoName}/+/archive/${parsedUrl.branch}.zip?routingId=${parsedUrl.accountId}`;\n\n  return constructedUrl;\n}\n\n/**\n * Given a URL pointing to a repository branch, returns a URL\n * for latest commit information.\n *\n * @remarks\n *\n * Converts\n * from: https://app.harness.io/ng/account/accountId/module/code/orgs/orgName/projects/projectName/repos/repoName/files/branchName\n * to:   https://app.harness.io/gateway/code/api/v1/repos/accountId/orgName/projectName/repoName/+/content?routingId=accountId&include_commit=true&git_ref=refs/heads/branchName\n *\n * @param url - A URL pointing to a repository branch\n * @param config - The relevant provider config\n * @public\n */\nexport function getHarnessLatestCommitUrl(\n  config: HarnessIntegrationConfig,\n  url: string,\n) {\n  const parsedUrl = parseHarnessUrl(config, url);\n\n  let constructedUrl = `${parsedUrl.baseUrl}/gateway/code/api/v1/repos/${parsedUrl.accountId}`;\n\n  if (parsedUrl.orgName) {\n    constructedUrl += `/${parsedUrl.orgName}`;\n  }\n\n  if (parsedUrl.projectName) {\n    constructedUrl += `/${parsedUrl.projectName}`;\n  }\n\n  constructedUrl += `/${parsedUrl.repoName}/+/content?routingId=${parsedUrl.accountId}&include_commit=true&git_ref=refs/heads/${parsedUrl.branch}`;\n\n  return constructedUrl;\n}\n\n/**\n * Return request headers for a Harness Code provider.\n *\n * @param config - A Harness Code provider config\n * @public\n */\nexport function getHarnessRequestOptions(config: HarnessIntegrationConfig): {\n  headers?: Record<string, string>;\n} {\n  const headers: Record<string, string> = {};\n  const { token, apiKey } = config;\n\n  if (apiKey) {\n    headers['x-api-key'] = apiKey;\n  } else if (token) {\n    headers.Authorization = `Bearer ${token}`;\n  }\n\n  return {\n    headers,\n  };\n}\n\n/**\n * Return parsed git url properties.\n *\n * @param config - A Harness provider config\n * @param url - A URL pointing to a repository\n * @public\n */\nexport function parseHarnessUrl(\n  config: HarnessIntegrationConfig,\n  url: string,\n): {\n  baseUrl: string;\n  accountId: string;\n  orgName: string;\n  projectName: string;\n  refString: string;\n  repoName: string;\n  path: string;\n  refDashStr: string;\n  branch: string;\n} {\n  const baseUrl = `https://${config.host}`;\n  try {\n    const pathUrl = new URL(url);\n    const pathSegments = pathUrl.pathname\n      .split('/')\n      .filter(segment => segment !== '');\n    const urlParts = pathUrl.pathname.split('/');\n\n    const accountIdIndex =\n      pathSegments.findIndex(segment => segment === 'account') + 1;\n    const accountId = pathSegments[accountIdIndex];\n\n    const orgNameIndex = pathSegments.findIndex(segment => segment === 'orgs');\n    const orgName = orgNameIndex !== -1 ? pathSegments[orgNameIndex + 1] : '';\n    const projectNameIndex = pathSegments.findIndex(\n      segment => segment === 'projects',\n    );\n\n    const projectName =\n      projectNameIndex !== -1 ? pathSegments[projectNameIndex + 1] : '';\n    // Adjust repoNameIndex to correctly identify the repository name\n    const repoNameIndex =\n      pathSegments.findIndex(\n        (segment, index) =>\n          segment === 'repos' &&\n          index > Math.max(accountIdIndex, orgNameIndex, projectNameIndex),\n      ) + 1;\n    const repoName = pathSegments[repoNameIndex];\n    const refAndPath = urlParts.slice(\n      urlParts.findIndex(i => i === 'files' || i === 'edit') + 1,\n    );\n    const refIndex = refAndPath.findIndex(item => item === '~');\n\n    const refString = refAndPath.slice(0, refIndex).join('/');\n    const pathWithoutSlash =\n      refIndex !== -1\n        ? refAndPath\n            .slice(refIndex + 1)\n            .join('/')\n            .replace(/^\\//, '')\n        : '';\n\n    return {\n      baseUrl: baseUrl,\n      accountId: accountId,\n      orgName: orgName,\n      projectName: projectName,\n      refString: refString,\n      path: pathWithoutSlash,\n      repoName: repoName,\n      refDashStr: refAndPath.slice(0, refIndex).join('-'),\n      branch:\n        refIndex !== -1\n          ? refAndPath.slice(0, refIndex).join('/')\n          : refAndPath.join('/'),\n    };\n  } catch (e) {\n    throw new Error(`Incorrect URL: ${url}, ${e}`);\n  }\n}\n"],"names":[],"mappings":"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"}