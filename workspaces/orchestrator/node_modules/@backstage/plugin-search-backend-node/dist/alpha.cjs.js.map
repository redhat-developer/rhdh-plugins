{"version":3,"file":"alpha.cjs.js","sources":["../src/alpha.ts"],"sourcesContent":["/*\n * Copyright 2023 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  coreServices,\n  createExtensionPoint,\n  createServiceFactory,\n  createServiceRef,\n  LoggerService,\n} from '@backstage/backend-plugin-api';\nimport { DocumentTypeInfo } from '@backstage/plugin-search-common';\nimport {\n  IndexBuilder,\n  RegisterCollatorParameters,\n  RegisterDecoratorParameters,\n  Scheduler,\n  SearchEngine,\n} from '@backstage/plugin-search-backend-node';\n\n/**\n * @alpha\n * Options for the init method on {@link SearchIndexService}.\n */\nexport type SearchIndexServiceInitOptions = {\n  searchEngine: SearchEngine;\n  collators: RegisterCollatorParameters[];\n  decorators: RegisterDecoratorParameters[];\n};\n\n/**\n * @alpha\n * Interface for implementation of index service.\n */\nexport interface SearchIndexService {\n  /**\n   * Initializes state in preparation for starting the search index service\n   */\n  init(options: SearchIndexServiceInitOptions): void;\n\n  /**\n   * Starts indexing process\n   */\n  start(): Promise<void>;\n\n  /**\n   * Stops indexing process\n   */\n  stop(): Promise<void>;\n\n  /**\n   * Returns an index types list.\n   */\n  getDocumentTypes(): Record<string, DocumentTypeInfo>;\n}\n\n/**\n * @alpha\n * Interface for search index registry extension point.\n */\nexport interface SearchIndexRegistryExtensionPoint {\n  addCollator(options: RegisterCollatorParameters): void;\n  addDecorator(options: RegisterDecoratorParameters): void;\n}\n\n/**\n * @alpha\n * Interface for search engine registry extension point.\n */\nexport interface SearchEngineRegistryExtensionPoint {\n  setSearchEngine(searchEngine: SearchEngine): void;\n}\n\ntype DefaultSearchIndexServiceOptions = {\n  logger: LoggerService;\n};\n\n/**\n * @alpha\n * Responsible for register the indexing task and start the schedule.\n */\nclass DefaultSearchIndexService implements SearchIndexService {\n  private readonly logger: LoggerService;\n  private indexBuilder: IndexBuilder | null = null;\n  private scheduler: Scheduler | null = null;\n\n  private constructor(options: DefaultSearchIndexServiceOptions) {\n    this.logger = options.logger;\n  }\n\n  static fromConfig(options: DefaultSearchIndexServiceOptions) {\n    return new DefaultSearchIndexService(options);\n  }\n\n  init(options: SearchIndexServiceInitOptions): void {\n    this.indexBuilder = new IndexBuilder({\n      logger: this.logger,\n      searchEngine: options.searchEngine,\n    });\n\n    options.collators.forEach(collator =>\n      this.indexBuilder?.addCollator(collator),\n    );\n\n    options.decorators.forEach(decorator =>\n      this.indexBuilder?.addDecorator(decorator),\n    );\n  }\n\n  async start(): Promise<void> {\n    if (!this.indexBuilder) {\n      throw new Error('IndexBuilder is not initialized, call init first');\n    }\n    const { scheduler } = await this.indexBuilder.build();\n    this.scheduler = scheduler;\n    this.scheduler!.start();\n  }\n\n  async stop(): Promise<void> {\n    if (this.scheduler) {\n      this.scheduler.stop();\n      this.scheduler = null;\n    }\n  }\n\n  getDocumentTypes(): Record<string, DocumentTypeInfo> {\n    return this.indexBuilder?.getDocumentTypes() ?? {};\n  }\n}\n\n/**\n * @alpha\n * Service that builds a search index.\n */\nexport const searchIndexServiceRef = createServiceRef<SearchIndexService>({\n  id: 'search.index.service',\n  defaultFactory: async service =>\n    createServiceFactory({\n      service,\n      deps: {\n        logger: coreServices.logger,\n      },\n      factory({ logger }) {\n        return DefaultSearchIndexService.fromConfig({\n          logger,\n        });\n      },\n    }),\n});\n\n/**\n * @alpha\n * Extension point for register a search engine.\n */\nexport const searchEngineRegistryExtensionPoint =\n  createExtensionPoint<SearchEngineRegistryExtensionPoint>({\n    id: 'search.engine.registry',\n  });\n\n/**\n * @alpha\n * Extension point for registering collators and decorators\n */\nexport const searchIndexRegistryExtensionPoint =\n  createExtensionPoint<SearchIndexRegistryExtensionPoint>({\n    id: 'search.index.registry',\n  });\n"],"names":["IndexBuilder","createServiceRef","createServiceFactory","coreServices","createExtensionPoint"],"mappings":";;;;;AA6FA,MAAM,yBAAA,CAAwD;AAAA,EAC3C,MAAA;AAAA,EACT,YAAA,GAAoC,IAAA;AAAA,EACpC,SAAA,GAA8B,IAAA;AAAA,EAE9B,YAAY,OAAA,EAA2C;AAC7D,IAAA,IAAA,CAAK,SAAS,OAAA,CAAQ,MAAA;AAAA,EACxB;AAAA,EAEA,OAAO,WAAW,OAAA,EAA2C;AAC3D,IAAA,OAAO,IAAI,0BAA0B,OAAO,CAAA;AAAA,EAC9C;AAAA,EAEA,KAAK,OAAA,EAA8C;AACjD,IAAA,IAAA,CAAK,YAAA,GAAe,IAAIA,oCAAA,CAAa;AAAA,MACnC,QAAQ,IAAA,CAAK,MAAA;AAAA,MACb,cAAc,OAAA,CAAQ;AAAA,KACvB,CAAA;AAED,IAAA,OAAA,CAAQ,SAAA,CAAU,OAAA;AAAA,MAAQ,CAAA,QAAA,KACxB,IAAA,CAAK,YAAA,EAAc,WAAA,CAAY,QAAQ;AAAA,KACzC;AAEA,IAAA,OAAA,CAAQ,UAAA,CAAW,OAAA;AAAA,MAAQ,CAAA,SAAA,KACzB,IAAA,CAAK,YAAA,EAAc,YAAA,CAAa,SAAS;AAAA,KAC3C;AAAA,EACF;AAAA,EAEA,MAAM,KAAA,GAAuB;AAC3B,IAAA,IAAI,CAAC,KAAK,YAAA,EAAc;AACtB,MAAA,MAAM,IAAI,MAAM,kDAAkD,CAAA;AAAA,IACpE;AACA,IAAA,MAAM,EAAE,SAAA,EAAU,GAAI,MAAM,IAAA,CAAK,aAAa,KAAA,EAAM;AACpD,IAAA,IAAA,CAAK,SAAA,GAAY,SAAA;AACjB,IAAA,IAAA,CAAK,UAAW,KAAA,EAAM;AAAA,EACxB;AAAA,EAEA,MAAM,IAAA,GAAsB;AAC1B,IAAA,IAAI,KAAK,SAAA,EAAW;AAClB,MAAA,IAAA,CAAK,UAAU,IAAA,EAAK;AACpB,MAAA,IAAA,CAAK,SAAA,GAAY,IAAA;AAAA,IACnB;AAAA,EACF;AAAA,EAEA,gBAAA,GAAqD;AACnD,IAAA,OAAO,IAAA,CAAK,YAAA,EAAc,gBAAA,EAAiB,IAAK,EAAC;AAAA,EACnD;AACF;AAMO,MAAM,wBAAwBC,iCAAA,CAAqC;AAAA,EACxE,EAAA,EAAI,sBAAA;AAAA,EACJ,cAAA,EAAgB,OAAM,OAAA,KACpBC,qCAAA,CAAqB;AAAA,IACnB,OAAA;AAAA,IACA,IAAA,EAAM;AAAA,MACJ,QAAQC,6BAAA,CAAa;AAAA,KACvB;AAAA,IACA,OAAA,CAAQ,EAAE,MAAA,EAAO,EAAG;AAClB,MAAA,OAAO,0BAA0B,UAAA,CAAW;AAAA,QAC1C;AAAA,OACD,CAAA;AAAA,IACH;AAAA,GACD;AACL,CAAC;AAMM,MAAM,qCACXC,qCAAA,CAAyD;AAAA,EACvD,EAAA,EAAI;AACN,CAAC;AAMI,MAAM,oCACXA,qCAAA,CAAwD;AAAA,EACtD,EAAA,EAAI;AACN,CAAC;;;;;;"}