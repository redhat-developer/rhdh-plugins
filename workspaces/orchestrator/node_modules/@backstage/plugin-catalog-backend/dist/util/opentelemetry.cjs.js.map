{"version":3,"file":"opentelemetry.cjs.js","sources":["../../src/util/opentelemetry.ts"],"sourcesContent":["/*\n * Copyright 2023 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Span, SpanOptions, SpanStatusCode, Tracer } from '@opentelemetry/api';\nimport { Entity } from '@backstage/catalog-model';\n\nexport const TRACER_ID = 'backstage-plugin-catalog-backend';\n\nfunction setAttributeIfDefined(span: Span, attribute: string, value?: string) {\n  if (value !== null && value !== undefined) {\n    span.setAttribute(attribute, value);\n  }\n}\n\nexport function addEntityAttributes(span: Span, entity: Entity) {\n  setAttributeIfDefined(span, 'backstage.entity.apiVersion', entity.apiVersion);\n  setAttributeIfDefined(span, 'backstage.entity.kind', entity.kind);\n  setAttributeIfDefined(\n    span,\n    'backstage.entity.metadata.namespace',\n    entity.metadata?.namespace,\n  );\n  setAttributeIfDefined(\n    span,\n    'backstage.entity.metadata.name',\n    entity.metadata?.name,\n  );\n}\n\n// Adapted from https://github.com/open-telemetry/opentelemetry-js/blob/359fbcc40a859057a02b14e84599eac399b8dba7/api/src/trace/SugaredTracer.ts\n// While waiting for something like https://github.com/open-telemetry/opentelemetry-js/pull/3317 to land upstream\n\nconst onException = (e: Error, span: Span) => {\n  span.recordException(e);\n  span.setStatus({\n    code: SpanStatusCode.ERROR,\n  });\n};\n\nfunction isPromiseLike<T, S>(obj: PromiseLike<T> | S): obj is PromiseLike<T> {\n  return (\n    !!obj &&\n    (typeof obj === 'object' || typeof obj === 'function') &&\n    'then' in obj &&\n    typeof obj.then === 'function'\n  );\n}\n\nfunction handleFn<F extends (span: Span) => ReturnType<F>>(\n  span: Span,\n  fn: F,\n): ReturnType<F> {\n  try {\n    const ret = fn(span);\n\n    // if fn is an async function attach a recordException and spanEnd callback to the promise\n    if (isPromiseLike(ret)) {\n      ret.then(\n        () => {\n          span.end();\n        },\n        e => {\n          onException(e, span);\n          span.end();\n        },\n      );\n    } else {\n      span.end();\n    }\n\n    return ret;\n  } catch (e) {\n    onException(e, span);\n    span.end();\n    throw e;\n  }\n}\n\nexport function withActiveSpan<F extends (span: Span) => ReturnType<F>>(\n  tracer: Tracer,\n  name: string,\n  fn: F,\n  spanOptions: SpanOptions = {},\n): ReturnType<F> {\n  return tracer.startActiveSpan(name, spanOptions, (span: Span) => {\n    return handleFn(span, fn);\n  });\n}\n"],"names":["SpanStatusCode"],"mappings":";;;;AAmBO,MAAM,SAAA,GAAY;AAEzB,SAAS,qBAAA,CAAsB,IAAA,EAAY,SAAA,EAAmB,KAAA,EAAgB;AAC5E,EAAA,IAAI,KAAA,KAAU,IAAA,IAAQ,KAAA,KAAU,MAAA,EAAW;AACzC,IAAA,IAAA,CAAK,YAAA,CAAa,WAAW,KAAK,CAAA;AAAA,EACpC;AACF;AAEO,SAAS,mBAAA,CAAoB,MAAY,MAAA,EAAgB;AAC9D,EAAA,qBAAA,CAAsB,IAAA,EAAM,6BAAA,EAA+B,MAAA,CAAO,UAAU,CAAA;AAC5E,EAAA,qBAAA,CAAsB,IAAA,EAAM,uBAAA,EAAyB,MAAA,CAAO,IAAI,CAAA;AAChE,EAAA,qBAAA;AAAA,IACE,IAAA;AAAA,IACA,qCAAA;AAAA,IACA,OAAO,QAAA,EAAU;AAAA,GACnB;AACA,EAAA,qBAAA;AAAA,IACE,IAAA;AAAA,IACA,gCAAA;AAAA,IACA,OAAO,QAAA,EAAU;AAAA,GACnB;AACF;AAKA,MAAM,WAAA,GAAc,CAAC,CAAA,EAAU,IAAA,KAAe;AAC5C,EAAA,IAAA,CAAK,gBAAgB,CAAC,CAAA;AACtB,EAAA,IAAA,CAAK,SAAA,CAAU;AAAA,IACb,MAAMA,kBAAA,CAAe;AAAA,GACtB,CAAA;AACH,CAAA;AAEA,SAAS,cAAoB,GAAA,EAAgD;AAC3E,EAAA,OACE,CAAC,CAAC,GAAA,KACD,OAAO,GAAA,KAAQ,QAAA,IAAY,OAAO,GAAA,KAAQ,UAAA,CAAA,IAC3C,MAAA,IAAU,GAAA,IACV,OAAO,IAAI,IAAA,KAAS,UAAA;AAExB;AAEA,SAAS,QAAA,CACP,MACA,EAAA,EACe;AACf,EAAA,IAAI;AACF,IAAA,MAAM,GAAA,GAAM,GAAG,IAAI,CAAA;AAGnB,IAAA,IAAI,aAAA,CAAc,GAAG,CAAA,EAAG;AACtB,MAAA,GAAA,CAAI,IAAA;AAAA,QACF,MAAM;AACJ,UAAA,IAAA,CAAK,GAAA,EAAI;AAAA,QACX,CAAA;AAAA,QACA,CAAA,CAAA,KAAK;AACH,UAAA,WAAA,CAAY,GAAG,IAAI,CAAA;AACnB,UAAA,IAAA,CAAK,GAAA,EAAI;AAAA,QACX;AAAA,OACF;AAAA,IACF,CAAA,MAAO;AACL,MAAA,IAAA,CAAK,GAAA,EAAI;AAAA,IACX;AAEA,IAAA,OAAO,GAAA;AAAA,EACT,SAAS,CAAA,EAAG;AACV,IAAA,WAAA,CAAY,GAAG,IAAI,CAAA;AACnB,IAAA,IAAA,CAAK,GAAA,EAAI;AACT,IAAA,MAAM,CAAA;AAAA,EACR;AACF;AAEO,SAAS,eACd,MAAA,EACA,IAAA,EACA,EAAA,EACA,WAAA,GAA2B,EAAC,EACb;AACf,EAAA,OAAO,MAAA,CAAO,eAAA,CAAgB,IAAA,EAAM,WAAA,EAAa,CAAC,IAAA,KAAe;AAC/D,IAAA,OAAO,QAAA,CAAS,MAAM,EAAE,CAAA;AAAA,EAC1B,CAAC,CAAA;AACH;;;;;;"}