{"version":3,"file":"DefaultRefreshService.cjs.js","sources":["../../src/service/DefaultRefreshService.ts"],"sourcesContent":["/*\n * Copyright 2021 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { DefaultCatalogDatabase } from '../database/DefaultCatalogDatabase';\nimport { RefreshOptions, RefreshService } from './types';\n\nexport class DefaultRefreshService implements RefreshService {\n  private database: DefaultCatalogDatabase;\n\n  constructor(options: { database: DefaultCatalogDatabase }) {\n    this.database = options.database;\n  }\n\n  async refresh(options: RefreshOptions) {\n    await this.database.transaction(async tx => {\n      const { entityRefs } = await this.database.listAncestors(tx, {\n        entityRef: options.entityRef,\n      });\n      const locationAncestor = entityRefs.find(ref =>\n        ref.startsWith('location:'),\n      );\n\n      // TODO: Refreshes are currently scheduled(as soon as possible) for execution and will therefore happen in the future.\n      // There's room for improvements here where the refresh could potentially hang or return an ID so that the user can check progress.\n      if (locationAncestor) {\n        await this.database.refresh(tx, {\n          entityRef: locationAncestor,\n        });\n      }\n      await this.database.refresh(tx, {\n        entityRef: options.entityRef,\n      });\n    });\n  }\n}\n"],"names":[],"mappings":";;AAmBO,MAAM,qBAAA,CAAgD;AAAA,EACnD,QAAA;AAAA,EAER,YAAY,OAAA,EAA+C;AACzD,IAAA,IAAA,CAAK,WAAW,OAAA,CAAQ,QAAA;AAAA,EAC1B;AAAA,EAEA,MAAM,QAAQ,OAAA,EAAyB;AACrC,IAAA,MAAM,IAAA,CAAK,QAAA,CAAS,WAAA,CAAY,OAAM,EAAA,KAAM;AAC1C,MAAA,MAAM,EAAE,UAAA,EAAW,GAAI,MAAM,IAAA,CAAK,QAAA,CAAS,cAAc,EAAA,EAAI;AAAA,QAC3D,WAAW,OAAA,CAAQ;AAAA,OACpB,CAAA;AACD,MAAA,MAAM,mBAAmB,UAAA,CAAW,IAAA;AAAA,QAAK,CAAA,GAAA,KACvC,GAAA,CAAI,UAAA,CAAW,WAAW;AAAA,OAC5B;AAIA,MAAA,IAAI,gBAAA,EAAkB;AACpB,QAAA,MAAM,IAAA,CAAK,QAAA,CAAS,OAAA,CAAQ,EAAA,EAAI;AAAA,UAC9B,SAAA,EAAW;AAAA,SACZ,CAAA;AAAA,MACH;AACA,MAAA,MAAM,IAAA,CAAK,QAAA,CAAS,OAAA,CAAQ,EAAA,EAAI;AAAA,QAC9B,WAAW,OAAA,CAAQ;AAAA,OACpB,CAAA;AAAA,IACH,CAAC,CAAA;AAAA,EACH;AACF;;;;"}