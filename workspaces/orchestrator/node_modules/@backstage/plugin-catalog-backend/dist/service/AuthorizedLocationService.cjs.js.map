{"version":3,"file":"AuthorizedLocationService.cjs.js","sources":["../../src/service/AuthorizedLocationService.ts"],"sourcesContent":["/*\n * Copyright 2022 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Location } from '@backstage/catalog-client';\nimport { CompoundEntityRef, Entity } from '@backstage/catalog-model';\nimport { NotAllowedError, NotFoundError } from '@backstage/errors';\nimport {\n  catalogLocationCreatePermission,\n  catalogLocationDeletePermission,\n  catalogLocationReadPermission,\n} from '@backstage/plugin-catalog-common/alpha';\nimport { AuthorizeResult } from '@backstage/plugin-permission-common';\nimport { LocationInput, LocationService } from './types';\nimport {\n  BackstageCredentials,\n  PermissionsService,\n} from '@backstage/backend-plugin-api';\n\nexport class AuthorizedLocationService implements LocationService {\n  constructor(\n    private readonly locationService: LocationService,\n    private readonly permissionApi: PermissionsService,\n  ) {}\n\n  async createLocation(\n    spec: LocationInput,\n    dryRun: boolean,\n    options: {\n      credentials: BackstageCredentials;\n    },\n  ): Promise<{\n    location: Location;\n    entities: Entity[];\n    exists?: boolean | undefined;\n  }> {\n    const authorizationResponse = (\n      await this.permissionApi.authorize(\n        [{ permission: catalogLocationCreatePermission }],\n        { credentials: options.credentials },\n      )\n    )[0];\n\n    if (authorizationResponse.result === AuthorizeResult.DENY) {\n      throw new NotAllowedError();\n    }\n\n    return this.locationService.createLocation(spec, dryRun, options);\n  }\n\n  async listLocations(options: {\n    credentials: BackstageCredentials;\n  }): Promise<Location[]> {\n    const authorizationResponse = (\n      await this.permissionApi.authorize(\n        [{ permission: catalogLocationReadPermission }],\n        { credentials: options.credentials },\n      )\n    )[0];\n\n    if (authorizationResponse.result === AuthorizeResult.DENY) {\n      return [];\n    }\n\n    return this.locationService.listLocations(options);\n  }\n\n  async getLocation(\n    id: string,\n    options: { credentials: BackstageCredentials },\n  ): Promise<Location> {\n    const authorizationResponse = (\n      await this.permissionApi.authorize(\n        [{ permission: catalogLocationReadPermission }],\n        { credentials: options.credentials },\n      )\n    )[0];\n\n    if (authorizationResponse.result === AuthorizeResult.DENY) {\n      throw new NotFoundError(`Found no location with ID ${id}`);\n    }\n\n    return this.locationService.getLocation(id, options);\n  }\n\n  async deleteLocation(\n    id: string,\n    options: { credentials: BackstageCredentials },\n  ): Promise<void> {\n    const authorizationResponse = (\n      await this.permissionApi.authorize(\n        [{ permission: catalogLocationDeletePermission }],\n        { credentials: options.credentials },\n      )\n    )[0];\n\n    if (authorizationResponse.result === AuthorizeResult.DENY) {\n      throw new NotAllowedError();\n    }\n\n    return this.locationService.deleteLocation(id, options);\n  }\n\n  async getLocationByEntity(\n    entityRef: CompoundEntityRef | string,\n    options: { credentials: BackstageCredentials },\n  ): Promise<Location> {\n    const authorizationResponse = (\n      await this.permissionApi.authorize(\n        [{ permission: catalogLocationReadPermission }],\n        { credentials: options.credentials },\n      )\n    )[0];\n\n    if (authorizationResponse.result === AuthorizeResult.DENY) {\n      throw new NotFoundError();\n    }\n    return this.locationService.getLocationByEntity(entityRef, options);\n  }\n}\n"],"names":["catalogLocationCreatePermission","AuthorizeResult","NotAllowedError","catalogLocationReadPermission","NotFoundError","catalogLocationDeletePermission"],"mappings":"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"}