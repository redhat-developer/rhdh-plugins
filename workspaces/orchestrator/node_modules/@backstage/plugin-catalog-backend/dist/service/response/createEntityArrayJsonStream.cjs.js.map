{"version":3,"file":"createEntityArrayJsonStream.cjs.js","sources":["../../../src/service/response/createEntityArrayJsonStream.ts"],"sourcesContent":["/*\n * Copyright 2024 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { EntitiesResponseItems } from '../../catalog/types';\nimport { Response } from 'express';\nimport { createResponseDataWriter } from './write';\n\nexport interface EntityArrayJsonStream {\n  send(entities: EntitiesResponseItems): Promise<'ok' | 'closed'>;\n  complete(): void;\n  close(): void;\n}\n\n// Helps stream EntitiesResponseItems[] as a JSON response stream to avoid performance issues\nexport function createEntityArrayJsonStream(\n  res: Response,\n): EntityArrayJsonStream {\n  const writer = createResponseDataWriter(res);\n\n  // Imitate the httpRouter behavior of pretty-printing in development\n  const prettyPrint = process.env.NODE_ENV === 'development';\n  let firstSend = true;\n  let completed = false;\n\n  return {\n    async send(response) {\n      if (firstSend) {\n        res.setHeader('Content-Type', 'application/json; charset=utf-8');\n        res.status(200);\n        res.flushHeaders();\n      }\n\n      if (response.type === 'raw') {\n        for (const item of response.entities) {\n          const prefix = firstSend ? '[' : ',';\n          firstSend = false;\n\n          if ((await writer(prefix + item)) === 'closed') {\n            return 'closed';\n          }\n        }\n        return 'ok';\n      }\n\n      let data: string;\n      if (prettyPrint) {\n        data = JSON.stringify(response.entities, null, 2);\n        data = firstSend ? data.slice(0, -2) : `,\\n${data.slice(2, -2)}`;\n      } else {\n        data = JSON.stringify(response.entities);\n        data = firstSend ? data.slice(0, -1) : `,${data.slice(1, -1)}`;\n      }\n\n      firstSend = false;\n      return writer(data);\n    },\n    complete() {\n      if (firstSend) {\n        res.json([]);\n      } else {\n        res.end(prettyPrint ? '\\n]' : ']', 'utf8');\n      }\n      completed = true;\n    },\n    close() {\n      if (!completed) {\n        res.end();\n      }\n    },\n  };\n}\n"],"names":["createResponseDataWriter"],"mappings":";;;;AA2BO,SAAS,4BACd,GAAA,EACuB;AACvB,EAAA,MAAM,MAAA,GAASA,+BAAyB,GAAG,CAAA;AAG3C,EAAA,MAAM,WAAA,GAAc,OAAA,CAAQ,GAAA,CAAI,QAAA,KAAa,aAAA;AAC7C,EAAA,IAAI,SAAA,GAAY,IAAA;AAChB,EAAA,IAAI,SAAA,GAAY,KAAA;AAEhB,EAAA,OAAO;AAAA,IACL,MAAM,KAAK,QAAA,EAAU;AACnB,MAAA,IAAI,SAAA,EAAW;AACb,QAAA,GAAA,CAAI,SAAA,CAAU,gBAAgB,iCAAiC,CAAA;AAC/D,QAAA,GAAA,CAAI,OAAO,GAAG,CAAA;AACd,QAAA,GAAA,CAAI,YAAA,EAAa;AAAA,MACnB;AAEA,MAAA,IAAI,QAAA,CAAS,SAAS,KAAA,EAAO;AAC3B,QAAA,KAAA,MAAW,IAAA,IAAQ,SAAS,QAAA,EAAU;AACpC,UAAA,MAAM,MAAA,GAAS,YAAY,GAAA,GAAM,GAAA;AACjC,UAAA,SAAA,GAAY,KAAA;AAEZ,UAAA,IAAK,MAAM,MAAA,CAAO,MAAA,GAAS,IAAI,MAAO,QAAA,EAAU;AAC9C,YAAA,OAAO,QAAA;AAAA,UACT;AAAA,QACF;AACA,QAAA,OAAO,IAAA;AAAA,MACT;AAEA,MAAA,IAAI,IAAA;AACJ,MAAA,IAAI,WAAA,EAAa;AACf,QAAA,IAAA,GAAO,IAAA,CAAK,SAAA,CAAU,QAAA,CAAS,QAAA,EAAU,MAAM,CAAC,CAAA;AAChD,QAAA,IAAA,GAAO,SAAA,GAAY,IAAA,CAAK,KAAA,CAAM,CAAA,EAAG,EAAE,CAAA,GAAI,CAAA;AAAA,EAAM,IAAA,CAAK,KAAA,CAAM,CAAA,EAAG,EAAE,CAAC,CAAA,CAAA;AAAA,MAChE,CAAA,MAAO;AACL,QAAA,IAAA,GAAO,IAAA,CAAK,SAAA,CAAU,QAAA,CAAS,QAAQ,CAAA;AACvC,QAAA,IAAA,GAAO,SAAA,GAAY,IAAA,CAAK,KAAA,CAAM,CAAA,EAAG,EAAE,CAAA,GAAI,CAAA,CAAA,EAAI,IAAA,CAAK,KAAA,CAAM,CAAA,EAAG,EAAE,CAAC,CAAA,CAAA;AAAA,MAC9D;AAEA,MAAA,SAAA,GAAY,KAAA;AACZ,MAAA,OAAO,OAAO,IAAI,CAAA;AAAA,IACpB,CAAA;AAAA,IACA,QAAA,GAAW;AACT,MAAA,IAAI,SAAA,EAAW;AACb,QAAA,GAAA,CAAI,IAAA,CAAK,EAAE,CAAA;AAAA,MACb,CAAA,MAAO;AACL,QAAA,GAAA,CAAI,GAAA,CAAI,WAAA,GAAc,KAAA,GAAQ,GAAA,EAAK,MAAM,CAAA;AAAA,MAC3C;AACA,MAAA,SAAA,GAAY,IAAA;AAAA,IACd,CAAA;AAAA,IACA,KAAA,GAAQ;AACN,MAAA,IAAI,CAAC,SAAA,EAAW;AACd,QAAA,GAAA,CAAI,GAAA,EAAI;AAAA,MACV;AAAA,IACF;AAAA,GACF;AACF;;;;"}