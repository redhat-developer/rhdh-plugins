{"version":3,"file":"parseEntityTransformParams.cjs.js","sources":["../../../src/service/request/parseEntityTransformParams.ts"],"sourcesContent":["/*\n * Copyright 2021 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Entity } from '@backstage/catalog-model';\nimport { InputError } from '@backstage/errors';\nimport lodash from 'lodash';\nimport { RecursivePartial } from '../../util/RecursivePartial';\nimport { parseStringsParam } from './common';\n\nfunction getPathArrayAndValue(input: Entity, field: string) {\n  return field.split('.').reduce(\n    ([pathArray, inputSubset], pathPart, index, fieldParts) => {\n      if (lodash.hasIn(inputSubset, pathPart)) {\n        return [pathArray.concat(pathPart), inputSubset[pathPart]];\n      } else if (fieldParts[index + 1] !== undefined) {\n        fieldParts[index + 1] = `${pathPart}.${fieldParts[index + 1]}`;\n        return [pathArray, inputSubset];\n      }\n\n      return [pathArray, undefined];\n    },\n    [[] as string[], input as any],\n  );\n}\n\nexport function parseEntityTransformParams(\n  params: Record<string, unknown>,\n  extra?: string[],\n): ((entity: Entity) => Entity) | undefined {\n  const queryFields = parseStringsParam(params.fields, 'fields');\n\n  const fields = Array.from(\n    new Set(\n      [...(extra ?? []), ...(queryFields?.map(s => s.split(',')) ?? [])]\n        .flat()\n        .map(s => s.trim())\n        .filter(Boolean),\n    ),\n  );\n\n  if (!fields.length) {\n    return undefined;\n  }\n\n  const arrayTypeField = fields.find(f => f.includes('['));\n  if (arrayTypeField) {\n    throw new InputError(\n      `Invalid field \"${arrayTypeField}\", array type fields are not supported`,\n    );\n  }\n\n  return input => {\n    const output: RecursivePartial<Entity> = {};\n\n    for (const field of fields) {\n      const [pathArray, value] = getPathArrayAndValue(input, field);\n\n      if (value !== undefined) {\n        lodash.set(output, pathArray, value);\n      }\n    }\n\n    return output as Entity;\n  };\n}\n"],"names":["lodash","parseStringsParam","InputError"],"mappings":";;;;;;;;;;AAsBA,SAAS,oBAAA,CAAqB,OAAe,KAAA,EAAe;AAC1D,EAAA,OAAO,KAAA,CAAM,KAAA,CAAM,GAAG,CAAA,CAAE,MAAA;AAAA,IACtB,CAAC,CAAC,SAAA,EAAW,WAAW,CAAA,EAAG,QAAA,EAAU,OAAO,UAAA,KAAe;AACzD,MAAA,IAAIA,uBAAA,CAAO,KAAA,CAAM,WAAA,EAAa,QAAQ,CAAA,EAAG;AACvC,QAAA,OAAO,CAAC,SAAA,CAAU,MAAA,CAAO,QAAQ,CAAA,EAAG,WAAA,CAAY,QAAQ,CAAC,CAAA;AAAA,MAC3D,CAAA,MAAA,IAAW,UAAA,CAAW,KAAA,GAAQ,CAAC,MAAM,MAAA,EAAW;AAC9C,QAAA,UAAA,CAAW,KAAA,GAAQ,CAAC,CAAA,GAAI,CAAA,EAAG,QAAQ,CAAA,CAAA,EAAI,UAAA,CAAW,KAAA,GAAQ,CAAC,CAAC,CAAA,CAAA;AAC5D,QAAA,OAAO,CAAC,WAAW,WAAW,CAAA;AAAA,MAChC;AAEA,MAAA,OAAO,CAAC,WAAW,MAAS,CAAA;AAAA,IAC9B,CAAA;AAAA,IACA,CAAC,EAAC,EAAe,KAAY;AAAA,GAC/B;AACF;AAEO,SAAS,0BAAA,CACd,QACA,KAAA,EAC0C;AAC1C,EAAA,MAAM,WAAA,GAAcC,wBAAA,CAAkB,MAAA,CAAO,MAAA,EAAQ,QAAQ,CAAA;AAE7D,EAAA,MAAM,SAAS,KAAA,CAAM,IAAA;AAAA,IACnB,IAAI,GAAA;AAAA,MACF,CAAC,GAAI,KAAA,IAAS,EAAC,EAAI,GAAI,WAAA,EAAa,GAAA,CAAI,CAAA,CAAA,KAAK,CAAA,CAAE,KAAA,CAAM,GAAG,CAAC,KAAK,EAAG,CAAA,CAC9D,IAAA,EAAK,CACL,GAAA,CAAI,CAAA,CAAA,KAAK,CAAA,CAAE,IAAA,EAAM,CAAA,CACjB,MAAA,CAAO,OAAO;AAAA;AACnB,GACF;AAEA,EAAA,IAAI,CAAC,OAAO,MAAA,EAAQ;AAClB,IAAA,OAAO,MAAA;AAAA,EACT;AAEA,EAAA,MAAM,iBAAiB,MAAA,CAAO,IAAA,CAAK,OAAK,CAAA,CAAE,QAAA,CAAS,GAAG,CAAC,CAAA;AACvD,EAAA,IAAI,cAAA,EAAgB;AAClB,IAAA,MAAM,IAAIC,iBAAA;AAAA,MACR,kBAAkB,cAAc,CAAA,sCAAA;AAAA,KAClC;AAAA,EACF;AAEA,EAAA,OAAO,CAAA,KAAA,KAAS;AACd,IAAA,MAAM,SAAmC,EAAC;AAE1C,IAAA,KAAA,MAAW,SAAS,MAAA,EAAQ;AAC1B,MAAA,MAAM,CAAC,SAAA,EAAW,KAAK,CAAA,GAAI,oBAAA,CAAqB,OAAO,KAAK,CAAA;AAE5D,MAAA,IAAI,UAAU,MAAA,EAAW;AACvB,QAAAF,uBAAA,CAAO,GAAA,CAAI,MAAA,EAAQ,SAAA,EAAW,KAAK,CAAA;AAAA,MACrC;AAAA,IACF;AAEA,IAAA,OAAO,MAAA;AAAA,EACT,CAAA;AACF;;;;"}