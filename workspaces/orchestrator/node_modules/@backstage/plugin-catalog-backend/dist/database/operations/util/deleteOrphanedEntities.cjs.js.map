{"version":3,"file":"deleteOrphanedEntities.cjs.js","sources":["../../../../src/database/operations/util/deleteOrphanedEntities.ts"],"sourcesContent":["/*\n * Copyright 2023 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Knex } from 'knex';\nimport uniq from 'lodash/uniq';\nimport { StitchingStrategy } from '../../../stitching/types';\nimport { DbRefreshStateRow } from '../../tables';\nimport { markForStitching } from '../stitcher/markForStitching';\n\n/**\n * Finds and deletes all orphaned entities, i.e. entities that do not have any\n * incoming references to them, and also eagerly deletes all of their children\n * that would otherwise become orphaned.\n */\nexport async function deleteOrphanedEntities(options: {\n  knex: Knex.Transaction | Knex;\n  strategy: StitchingStrategy;\n}): Promise<number> {\n  const { knex, strategy } = options;\n\n  let total = 0;\n\n  // Limit iterations for sanity\n  for (let i = 0; i < 100; ++i) {\n    const candidates = await knex\n      .with('orphans', ['entity_id', 'entity_ref'], orphans =>\n        orphans\n          .from('refresh_state')\n          .select('refresh_state.entity_id', 'refresh_state.entity_ref')\n          .leftOuterJoin(\n            'refresh_state_references',\n            'refresh_state_references.target_entity_ref',\n            'refresh_state.entity_ref',\n          )\n          .whereNull('refresh_state_references.target_entity_ref'),\n      )\n      .select({\n        entityId: 'orphans.entity_id',\n        relationSourceId: 'refresh_state.entity_id',\n      })\n      .from('orphans')\n      .leftOuterJoin(\n        'relations',\n        'relations.target_entity_ref',\n        'orphans.entity_ref',\n      )\n      .leftOuterJoin(\n        'refresh_state',\n        'refresh_state.entity_ref',\n        'relations.source_entity_ref',\n      );\n\n    if (!candidates.length) {\n      break;\n    }\n\n    const orphanIds: string[] = uniq(candidates.map(r => r.entityId));\n    const orphanRelationIds: string[] = uniq(\n      candidates.map(r => r.relationSourceId).filter(Boolean),\n    );\n\n    total += orphanIds.length;\n\n    // Delete the orphans themselves\n    await knex\n      .table<DbRefreshStateRow>('refresh_state')\n      .delete()\n      .whereIn('entity_id', orphanIds);\n\n    // Mark all of the things that the orphans had relations to for stitching\n    await markForStitching({\n      knex,\n      strategy,\n      entityIds: orphanRelationIds,\n    });\n  }\n\n  return total;\n}\n"],"names":["uniq","markForStitching"],"mappings":";;;;;;;;;AA2BA,eAAsB,uBAAuB,OAAA,EAGzB;AAClB,EAAA,MAAM,EAAE,IAAA,EAAM,QAAA,EAAS,GAAI,OAAA;AAE3B,EAAA,IAAI,KAAA,GAAQ,CAAA;AAGZ,EAAA,KAAA,IAAS,CAAA,GAAI,CAAA,EAAG,CAAA,GAAI,GAAA,EAAK,EAAE,CAAA,EAAG;AAC5B,IAAA,MAAM,UAAA,GAAa,MAAM,IAAA,CACtB,IAAA;AAAA,MAAK,SAAA;AAAA,MAAW,CAAC,aAAa,YAAY,CAAA;AAAA,MAAG,CAAA,OAAA,KAC5C,QACG,IAAA,CAAK,eAAe,EACpB,MAAA,CAAO,yBAAA,EAA2B,0BAA0B,CAAA,CAC5D,aAAA;AAAA,QACC,0BAAA;AAAA,QACA,4CAAA;AAAA,QACA;AAAA,OACF,CACC,UAAU,4CAA4C;AAAA,MAE1D,MAAA,CAAO;AAAA,MACN,QAAA,EAAU,mBAAA;AAAA,MACV,gBAAA,EAAkB;AAAA,KACnB,CAAA,CACA,IAAA,CAAK,SAAS,CAAA,CACd,aAAA;AAAA,MACC,WAAA;AAAA,MACA,6BAAA;AAAA,MACA;AAAA,KACF,CACC,aAAA;AAAA,MACC,eAAA;AAAA,MACA,0BAAA;AAAA,MACA;AAAA,KACF;AAEF,IAAA,IAAI,CAAC,WAAW,MAAA,EAAQ;AACtB,MAAA;AAAA,IACF;AAEA,IAAA,MAAM,YAAsBA,qBAAA,CAAK,UAAA,CAAW,IAAI,CAAA,CAAA,KAAK,CAAA,CAAE,QAAQ,CAAC,CAAA;AAChE,IAAA,MAAM,iBAAA,GAA8BA,qBAAA;AAAA,MAClC,WAAW,GAAA,CAAI,CAAA,CAAA,KAAK,EAAE,gBAAgB,CAAA,CAAE,OAAO,OAAO;AAAA,KACxD;AAEA,IAAA,KAAA,IAAS,SAAA,CAAU,MAAA;AAGnB,IAAA,MAAM,IAAA,CACH,MAAyB,eAAe,CAAA,CACxC,QAAO,CACP,OAAA,CAAQ,aAAa,SAAS,CAAA;AAGjC,IAAA,MAAMC,iCAAA,CAAiB;AAAA,MACrB,IAAA;AAAA,MACA,QAAA;AAAA,MACA,SAAA,EAAW;AAAA,KACZ,CAAA;AAAA,EACH;AAEA,EAAA,OAAO,KAAA;AACT;;;;"}