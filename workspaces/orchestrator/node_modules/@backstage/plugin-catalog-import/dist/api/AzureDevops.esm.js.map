{"version":3,"file":"AzureDevops.esm.js","sources":["../../src/api/AzureDevops.ts"],"sourcesContent":["/*\n * Copyright 2024 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport { ScmAuthApi } from '@backstage/integration-react';\nimport { ConfigApi } from '@backstage/core-plugin-api';\nimport { getBranchName, getCatalogFilename } from '../components/helpers';\nimport { createAzurePullRequest } from './AzureRepoApiClient';\n\nexport interface AzureRepoParts {\n  tenantUrl: string;\n  repoName: string;\n  project: string;\n}\n\nexport function parseAzureUrl(repoUrl: string): AzureRepoParts {\n  const { org, repo, project, host } = parseRepoUrl(repoUrl);\n  if (!org || !repo || !project) {\n    throw new Error(\n      'Invalid AzureDevops Repository. Please use a valid repository url and try again ',\n    );\n  }\n  const tenantUrl = `https://${host}/${org}`;\n\n  return { tenantUrl, repoName: repo, project: project };\n}\n\nexport async function submitAzurePrToRepo(\n  options: {\n    title: string;\n    body: string;\n    fileContent: string;\n    repositoryUrl: string;\n  },\n  scmAuthApi: ScmAuthApi,\n  configApi: ConfigApi,\n) {\n  const { repositoryUrl, fileContent, title, body } = options;\n\n  const branchName = getBranchName(configApi);\n  const fileName = getCatalogFilename(configApi);\n\n  const { token } = await scmAuthApi.getCredentials({\n    url: repositoryUrl,\n    additionalScope: {\n      repoWrite: true,\n    },\n  });\n  const { tenantUrl, repoName, project } = parseAzureUrl(repositoryUrl);\n  const result = await createAzurePullRequest({\n    token,\n    fileContent,\n    title,\n    description: body,\n    project,\n    repository: repoName,\n    branchName,\n    tenantUrl,\n    fileName,\n  });\n  const catalogLocation = `${result.repository.webUrl}?path=/${fileName}`;\n  const prLocation = `${result.repository.webUrl}/pullrequest/${result.pullRequestId}`;\n  return {\n    link: prLocation!,\n    location: catalogLocation,\n  };\n}\n\nexport function parseRepoUrl(sourceUrl: string) {\n  const url = new URL(sourceUrl);\n\n  let host = url.host;\n  let org;\n  let project;\n  let repo;\n\n  const parts = url.pathname.split('/').map(part => decodeURIComponent(part));\n  if (parts[2] === '_git') {\n    org = parts[1];\n    project = repo = parts[3];\n  } else if (parts[3] === '_git') {\n    org = parts[1];\n    project = parts[2];\n    repo = parts[4];\n  } else if (parts[4] === '_git') {\n    host = `${host}/${parts[1]}`;\n    org = parts[2];\n    project = parts[3];\n    repo = parts[5];\n  }\n\n  return { host, org, project, repo };\n}\n"],"names":[],"mappings":"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"}