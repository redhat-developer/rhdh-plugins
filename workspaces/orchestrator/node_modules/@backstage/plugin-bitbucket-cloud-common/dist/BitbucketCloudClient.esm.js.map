{"version":3,"file":"BitbucketCloudClient.esm.js","sources":["../src/BitbucketCloudClient.ts"],"sourcesContent":["/*\n * Copyright 2022 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { BitbucketCloudIntegrationConfig } from '@backstage/integration';\nimport fetch, { Request } from 'cross-fetch';\nimport { Models } from './models';\nimport { WithPagination } from './pagination';\nimport {\n  FilterAndSortOptions,\n  PartialResponseOptions,\n  RequestOptions,\n} from './types';\n\n/** @public */\nexport class BitbucketCloudClient {\n  static fromConfig(\n    config: BitbucketCloudIntegrationConfig,\n  ): BitbucketCloudClient {\n    return new BitbucketCloudClient(config);\n  }\n\n  private constructor(\n    private readonly config: BitbucketCloudIntegrationConfig,\n  ) {}\n\n  searchCode(\n    workspace: string,\n    query: string,\n    options?: FilterAndSortOptions & PartialResponseOptions,\n  ): WithPagination<Models.SearchResultPage, Models.SearchCodeSearchResult> {\n    const workspaceEnc = encodeURIComponent(workspace);\n    return new WithPagination(\n      paginationOptions =>\n        this.createUrl(`/workspaces/${workspaceEnc}/search/code`, {\n          ...paginationOptions,\n          ...options,\n          search_query: query,\n        }),\n      url => this.getTypeMapped(url),\n    );\n  }\n\n  listRepositoriesByWorkspace(\n    workspace: string,\n    options?: FilterAndSortOptions & PartialResponseOptions,\n  ): WithPagination<Models.PaginatedRepositories, Models.Repository> {\n    const workspaceEnc = encodeURIComponent(workspace);\n\n    return new WithPagination(\n      paginationOptions =>\n        this.createUrl(`/repositories/${workspaceEnc}`, {\n          ...paginationOptions,\n          ...options,\n        }),\n      url => this.getTypeMapped(url),\n    );\n  }\n\n  listProjectsByWorkspace(\n    workspace: string,\n    options?: FilterAndSortOptions & PartialResponseOptions,\n  ): WithPagination<Models.PaginatedProjects, Models.Project> {\n    const workspaceEnc = encodeURIComponent(workspace);\n\n    return new WithPagination(\n      paginationOptions =>\n        this.createUrl(`/workspaces/${workspaceEnc}/projects`, {\n          ...paginationOptions,\n          ...options,\n        }),\n      url => this.getTypeMapped(url),\n    );\n  }\n\n  listWorkspaces(\n    options?: FilterAndSortOptions & PartialResponseOptions,\n  ): WithPagination<Models.PaginatedWorkspaces, Models.Workspace> {\n    return new WithPagination(\n      paginationOptions =>\n        this.createUrl('/workspaces', { ...paginationOptions, ...options }),\n      url => this.getTypeMapped(url),\n    );\n  }\n\n  listBranchesByRepository(\n    repository: string,\n    workspace: string,\n    options?: FilterAndSortOptions & PartialResponseOptions,\n  ): WithPagination<Models.PaginatedBranches, Models.Branch> {\n    const workspaceEnc = encodeURIComponent(workspace);\n\n    return new WithPagination(\n      paginationOptions =>\n        this.createUrl(\n          `/repositories/${workspaceEnc}/${repository}/refs/branches`,\n          {\n            ...paginationOptions,\n            ...options,\n          },\n        ),\n      url => this.getTypeMapped(url),\n    );\n  }\n\n  private createUrl(endpoint: string, options?: RequestOptions): URL {\n    const request = new URL(this.config.apiBaseUrl + endpoint);\n    for (const key in options) {\n      if (options[key]) {\n        request.searchParams.append(key, options[key]!.toString());\n      }\n    }\n\n    return request;\n  }\n\n  private async getTypeMapped<T = any>(url: URL): Promise<T> {\n    return this.get(url).then(\n      (response: Response) => response.json() as Promise<T>,\n    );\n  }\n\n  private async get(url: URL): Promise<Response> {\n    return this.request(new Request(url.toString(), { method: 'GET' }));\n  }\n\n  private async request(req: Request): Promise<Response> {\n    return fetch(req, { headers: this.getAuthHeaders() }).then(\n      (response: Response) => {\n        if (!response.ok) {\n          throw new Error(\n            `Unexpected response for ${req.method} ${req.url}. Expected 200 but got ${response.status} - ${response.statusText}`,\n          );\n        }\n\n        return response;\n      },\n    );\n  }\n\n  private getAuthHeaders(): Record<string, string> {\n    const headers: Record<string, string> = {};\n\n    if (this.config.username) {\n      const buffer = Buffer.from(\n        `${this.config.username}:${this.config.appPassword}`,\n        'utf8',\n      );\n      headers.Authorization = `Basic ${buffer.toString('base64')}`;\n    } else if (this.config.token) {\n      headers.Authorization = `Bearer ${this.config.token}`;\n    }\n\n    return headers;\n  }\n}\n"],"names":[],"mappings":";;;AA2BO,MAAM,oBAAA,CAAqB;AAAA,EAOxB,YACW,MAAA,EACjB;AADiB,IAAA,IAAA,CAAA,MAAA,GAAA,MAAA;AAAA,EAChB;AAAA,EARH,OAAO,WACL,MAAA,EACsB;AACtB,IAAA,OAAO,IAAI,qBAAqB,MAAM,CAAA;AAAA,EACxC;AAAA,EAMA,UAAA,CACE,SAAA,EACA,KAAA,EACA,OAAA,EACwE;AACxE,IAAA,MAAM,YAAA,GAAe,mBAAmB,SAAS,CAAA;AACjD,IAAA,OAAO,IAAI,cAAA;AAAA,MACT,CAAA,iBAAA,KACE,IAAA,CAAK,SAAA,CAAU,CAAA,YAAA,EAAe,YAAY,CAAA,YAAA,CAAA,EAAgB;AAAA,QACxD,GAAG,iBAAA;AAAA,QACH,GAAG,OAAA;AAAA,QACH,YAAA,EAAc;AAAA,OACf,CAAA;AAAA,MACH,CAAA,GAAA,KAAO,IAAA,CAAK,aAAA,CAAc,GAAG;AAAA,KAC/B;AAAA,EACF;AAAA,EAEA,2BAAA,CACE,WACA,OAAA,EACiE;AACjE,IAAA,MAAM,YAAA,GAAe,mBAAmB,SAAS,CAAA;AAEjD,IAAA,OAAO,IAAI,cAAA;AAAA,MACT,CAAA,iBAAA,KACE,IAAA,CAAK,SAAA,CAAU,CAAA,cAAA,EAAiB,YAAY,CAAA,CAAA,EAAI;AAAA,QAC9C,GAAG,iBAAA;AAAA,QACH,GAAG;AAAA,OACJ,CAAA;AAAA,MACH,CAAA,GAAA,KAAO,IAAA,CAAK,aAAA,CAAc,GAAG;AAAA,KAC/B;AAAA,EACF;AAAA,EAEA,uBAAA,CACE,WACA,OAAA,EAC0D;AAC1D,IAAA,MAAM,YAAA,GAAe,mBAAmB,SAAS,CAAA;AAEjD,IAAA,OAAO,IAAI,cAAA;AAAA,MACT,CAAA,iBAAA,KACE,IAAA,CAAK,SAAA,CAAU,CAAA,YAAA,EAAe,YAAY,CAAA,SAAA,CAAA,EAAa;AAAA,QACrD,GAAG,iBAAA;AAAA,QACH,GAAG;AAAA,OACJ,CAAA;AAAA,MACH,CAAA,GAAA,KAAO,IAAA,CAAK,aAAA,CAAc,GAAG;AAAA,KAC/B;AAAA,EACF;AAAA,EAEA,eACE,OAAA,EAC8D;AAC9D,IAAA,OAAO,IAAI,cAAA;AAAA,MACT,CAAA,iBAAA,KACE,KAAK,SAAA,CAAU,aAAA,EAAe,EAAE,GAAG,iBAAA,EAAmB,GAAG,OAAA,EAAS,CAAA;AAAA,MACpE,CAAA,GAAA,KAAO,IAAA,CAAK,aAAA,CAAc,GAAG;AAAA,KAC/B;AAAA,EACF;AAAA,EAEA,wBAAA,CACE,UAAA,EACA,SAAA,EACA,OAAA,EACyD;AACzD,IAAA,MAAM,YAAA,GAAe,mBAAmB,SAAS,CAAA;AAEjD,IAAA,OAAO,IAAI,cAAA;AAAA,MACT,uBACE,IAAA,CAAK,SAAA;AAAA,QACH,CAAA,cAAA,EAAiB,YAAY,CAAA,CAAA,EAAI,UAAU,CAAA,cAAA,CAAA;AAAA,QAC3C;AAAA,UACE,GAAG,iBAAA;AAAA,UACH,GAAG;AAAA;AACL,OACF;AAAA,MACF,CAAA,GAAA,KAAO,IAAA,CAAK,aAAA,CAAc,GAAG;AAAA,KAC/B;AAAA,EACF;AAAA,EAEQ,SAAA,CAAU,UAAkB,OAAA,EAA+B;AACjE,IAAA,MAAM,UAAU,IAAI,GAAA,CAAI,IAAA,CAAK,MAAA,CAAO,aAAa,QAAQ,CAAA;AACzD,IAAA,KAAA,MAAW,OAAO,OAAA,EAAS;AACzB,MAAA,IAAI,OAAA,CAAQ,GAAG,CAAA,EAAG;AAChB,QAAA,OAAA,CAAQ,aAAa,MAAA,CAAO,GAAA,EAAK,QAAQ,GAAG,CAAA,CAAG,UAAU,CAAA;AAAA,MAC3D;AAAA,IACF;AAEA,IAAA,OAAO,OAAA;AAAA,EACT;AAAA,EAEA,MAAc,cAAuB,GAAA,EAAsB;AACzD,IAAA,OAAO,IAAA,CAAK,GAAA,CAAI,GAAG,CAAA,CAAE,IAAA;AAAA,MACnB,CAAC,QAAA,KAAuB,QAAA,CAAS,IAAA;AAAK,KACxC;AAAA,EACF;AAAA,EAEA,MAAc,IAAI,GAAA,EAA6B;AAC7C,IAAA,OAAO,IAAA,CAAK,OAAA,CAAQ,IAAI,OAAA,CAAQ,GAAA,CAAI,QAAA,EAAS,EAAG,EAAE,MAAA,EAAQ,KAAA,EAAO,CAAC,CAAA;AAAA,EACpE;AAAA,EAEA,MAAc,QAAQ,GAAA,EAAiC;AACrD,IAAA,OAAO,KAAA,CAAM,KAAK,EAAE,OAAA,EAAS,KAAK,cAAA,EAAe,EAAG,CAAA,CAAE,IAAA;AAAA,MACpD,CAAC,QAAA,KAAuB;AACtB,QAAA,IAAI,CAAC,SAAS,EAAA,EAAI;AAChB,UAAA,MAAM,IAAI,KAAA;AAAA,YACR,CAAA,wBAAA,EAA2B,GAAA,CAAI,MAAM,CAAA,CAAA,EAAI,GAAA,CAAI,GAAG,CAAA,uBAAA,EAA0B,QAAA,CAAS,MAAM,CAAA,GAAA,EAAM,QAAA,CAAS,UAAU,CAAA;AAAA,WACpH;AAAA,QACF;AAEA,QAAA,OAAO,QAAA;AAAA,MACT;AAAA,KACF;AAAA,EACF;AAAA,EAEQ,cAAA,GAAyC;AAC/C,IAAA,MAAM,UAAkC,EAAC;AAEzC,IAAA,IAAI,IAAA,CAAK,OAAO,QAAA,EAAU;AACxB,MAAA,MAAM,SAAS,MAAA,CAAO,IAAA;AAAA,QACpB,GAAG,IAAA,CAAK,MAAA,CAAO,QAAQ,CAAA,CAAA,EAAI,IAAA,CAAK,OAAO,WAAW,CAAA,CAAA;AAAA,QAClD;AAAA,OACF;AACA,MAAA,OAAA,CAAQ,aAAA,GAAgB,CAAA,MAAA,EAAS,MAAA,CAAO,QAAA,CAAS,QAAQ,CAAC,CAAA,CAAA;AAAA,IAC5D,CAAA,MAAA,IAAW,IAAA,CAAK,MAAA,CAAO,KAAA,EAAO;AAC5B,MAAA,OAAA,CAAQ,aAAA,GAAgB,CAAA,OAAA,EAAU,IAAA,CAAK,MAAA,CAAO,KAAK,CAAA,CAAA;AAAA,IACrD;AAEA,IAAA,OAAO,OAAA;AAAA,EACT;AACF;;;;"}