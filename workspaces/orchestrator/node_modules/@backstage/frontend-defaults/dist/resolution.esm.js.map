{"version":3,"file":"resolution.esm.js","sources":["../src/resolution.ts"],"sourcesContent":["/*\n * Copyright 2025 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Config } from '@backstage/config';\nimport { stringifyError } from '@backstage/errors';\nimport {\n  FrontendFeature,\n  FrontendFeatureLoader,\n} from '@backstage/frontend-plugin-api';\n// eslint-disable-next-line @backstage/no-relative-monorepo-imports\nimport { isInternalFrontendFeatureLoader } from '../../frontend-plugin-api/src/wiring/createFrontendFeatureLoader';\n\n/** @public */\nexport async function resolveAsyncFeatures(options: {\n  config: Config;\n  features?: (FrontendFeature | FrontendFeatureLoader)[];\n}): Promise<{ features: FrontendFeature[] }> {\n  const loadedFeatures: FrontendFeature[] = [];\n  const alreadyMetFeatureLoaders: FrontendFeatureLoader[] = [];\n  const maxRecursionDepth = 5;\n\n  async function applyFeatureLoaders(\n    featuresOrLoaders: (FrontendFeature | FrontendFeatureLoader)[],\n    recursionDepth: number,\n  ) {\n    if (featuresOrLoaders.length === 0) {\n      return;\n    }\n\n    for (const featureOrLoader of featuresOrLoaders) {\n      if (isBackstageFeatureLoader(featureOrLoader)) {\n        if (alreadyMetFeatureLoaders.some(l => l === featureOrLoader)) {\n          continue;\n        }\n        if (isInternalFrontendFeatureLoader(featureOrLoader)) {\n          if (recursionDepth > maxRecursionDepth) {\n            throw new Error(\n              `Maximum feature loading recursion depth (${maxRecursionDepth}) reached for the feature loader ${featureOrLoader.description}`,\n            );\n          }\n          alreadyMetFeatureLoaders.push(featureOrLoader);\n          let result: (FrontendFeature | FrontendFeatureLoader)[];\n          try {\n            result = await featureOrLoader.loader({ config: options.config });\n          } catch (e) {\n            throw new Error(\n              `Failed to read frontend features from loader ${\n                featureOrLoader.description\n              }: ${stringifyError(e)}`,\n            );\n          }\n          await applyFeatureLoaders(result, recursionDepth + 1);\n        }\n      } else {\n        loadedFeatures.push(featureOrLoader);\n      }\n    }\n  }\n\n  await applyFeatureLoaders(options.features ?? [], 1);\n\n  return { features: loadedFeatures };\n}\n\nexport function isBackstageFeatureLoader(\n  obj: unknown,\n): obj is FrontendFeatureLoader {\n  return (\n    obj !== null &&\n    typeof obj === 'object' &&\n    '$$type' in obj &&\n    obj.$$type === '@backstage/FrontendFeatureLoader'\n  );\n}\n"],"names":[],"mappings":";;;AA0BA,eAAsB,qBAAqB,OAAA,EAGE;AAC3C,EAAA,MAAM,iBAAoC,EAAC;AAC3C,EAAA,MAAM,2BAAoD,EAAC;AAC3D,EAAA,MAAM,iBAAA,GAAoB,CAAA;AAE1B,EAAA,eAAe,mBAAA,CACb,mBACA,cAAA,EACA;AACA,IAAA,IAAI,iBAAA,CAAkB,WAAW,CAAA,EAAG;AAClC,MAAA;AAAA,IACF;AAEA,IAAA,KAAA,MAAW,mBAAmB,iBAAA,EAAmB;AAC/C,MAAA,IAAI,wBAAA,CAAyB,eAAe,CAAA,EAAG;AAC7C,QAAA,IAAI,wBAAA,CAAyB,IAAA,CAAK,CAAA,CAAA,KAAK,CAAA,KAAM,eAAe,CAAA,EAAG;AAC7D,UAAA;AAAA,QACF;AACA,QAAA,IAAI,+BAAA,CAAgC,eAAe,CAAA,EAAG;AACpD,UAAA,IAAI,iBAAiB,iBAAA,EAAmB;AACtC,YAAA,MAAM,IAAI,KAAA;AAAA,cACR,CAAA,yCAAA,EAA4C,iBAAiB,CAAA,iCAAA,EAAoC,eAAA,CAAgB,WAAW,CAAA;AAAA,aAC9H;AAAA,UACF;AACA,UAAA,wBAAA,CAAyB,KAAK,eAAe,CAAA;AAC7C,UAAA,IAAI,MAAA;AACJ,UAAA,IAAI;AACF,YAAA,MAAA,GAAS,MAAM,eAAA,CAAgB,MAAA,CAAO,EAAE,MAAA,EAAQ,OAAA,CAAQ,QAAQ,CAAA;AAAA,UAClE,SAAS,CAAA,EAAG;AACV,YAAA,MAAM,IAAI,KAAA;AAAA,cACR,gDACE,eAAA,CAAgB,WAClB,CAAA,EAAA,EAAK,cAAA,CAAe,CAAC,CAAC,CAAA;AAAA,aACxB;AAAA,UACF;AACA,UAAA,MAAM,mBAAA,CAAoB,MAAA,EAAQ,cAAA,GAAiB,CAAC,CAAA;AAAA,QACtD;AAAA,MACF,CAAA,MAAO;AACL,QAAA,cAAA,CAAe,KAAK,eAAe,CAAA;AAAA,MACrC;AAAA,IACF;AAAA,EACF;AAEA,EAAA,MAAM,mBAAA,CAAoB,OAAA,CAAQ,QAAA,IAAY,IAAI,CAAC,CAAA;AAEnD,EAAA,OAAO,EAAE,UAAU,cAAA,EAAe;AACpC;AAEO,SAAS,yBACd,GAAA,EAC8B;AAC9B,EAAA,OACE,GAAA,KAAQ,QACR,OAAO,GAAA,KAAQ,YACf,QAAA,IAAY,GAAA,IACZ,IAAI,MAAA,KAAW,kCAAA;AAEnB;;;;"}