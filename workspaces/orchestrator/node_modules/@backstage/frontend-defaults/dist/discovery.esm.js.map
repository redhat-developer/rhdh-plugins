{"version":3,"file":"discovery.esm.js","sources":["../src/discovery.ts"],"sourcesContent":["/*\n * Copyright 2023 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Config, ConfigReader } from '@backstage/config';\nimport {\n  FrontendFeature,\n  FrontendFeatureLoader,\n} from '@backstage/frontend-plugin-api';\nimport { isBackstageFeatureLoader } from './resolution';\n\ninterface DiscoveryGlobal {\n  modules: Array<{ name: string; export?: string; default: unknown }>;\n}\n\nfunction readPackageDetectionConfig(config: Config) {\n  // The experimental key is deprecated, but supported still for backwards compatibility\n  const packages =\n    config.getOptional('app.packages') ??\n    config.getOptional('app.experimental.packages');\n  if (packages === undefined || packages === null) {\n    return undefined;\n  }\n\n  if (typeof packages === 'string') {\n    if (packages !== 'all') {\n      throw new Error(\n        `Invalid app.packages mode, got '${packages}', expected 'all'`,\n      );\n    }\n    return {};\n  }\n\n  if (typeof packages !== 'object' || Array.isArray(packages)) {\n    throw new Error(\"Invalid config at 'app.packages', expected object\");\n  }\n  const packagesConfig = new ConfigReader(packages, 'app.packages');\n\n  return {\n    include: packagesConfig.getOptionalStringArray('include'),\n    exclude: packagesConfig.getOptionalStringArray('exclude'),\n  };\n}\n\n/**\n * @public\n */\nexport function discoverAvailableFeatures(config: Config): {\n  features: (FrontendFeature | FrontendFeatureLoader)[];\n} {\n  const discovered = (\n    window as { '__@backstage/discovered__'?: DiscoveryGlobal }\n  )['__@backstage/discovered__'];\n\n  const detection = readPackageDetectionConfig(config);\n  if (!detection) {\n    return { features: [] };\n  }\n\n  return {\n    features:\n      discovered?.modules\n        .filter(({ name }) => {\n          if (detection.exclude?.includes(name)) {\n            return false;\n          }\n          if (detection.include && !detection.include.includes(name)) {\n            return false;\n          }\n          return true;\n        })\n        .map(m => m.default)\n        .filter(isFeatureOrLoader) ?? [],\n  };\n}\n\nfunction isBackstageFeature(obj: unknown): obj is FrontendFeature {\n  if (obj !== null && typeof obj === 'object' && '$$type' in obj) {\n    return (\n      obj.$$type === '@backstage/FrontendPlugin' ||\n      obj.$$type === '@backstage/FrontendModule'\n    );\n  }\n  return false;\n}\n\nfunction isFeatureOrLoader(\n  obj: unknown,\n): obj is FrontendFeature | FrontendFeatureLoader {\n  return isBackstageFeature(obj) || isBackstageFeatureLoader(obj);\n}\n"],"names":[],"mappings":";;;AA2BA,SAAS,2BAA2B,MAAA,EAAgB;AAElD,EAAA,MAAM,WACJ,MAAA,CAAO,WAAA,CAAY,cAAc,CAAA,IACjC,MAAA,CAAO,YAAY,2BAA2B,CAAA;AAChD,EAAA,IAAI,QAAA,KAAa,MAAA,IAAa,QAAA,KAAa,IAAA,EAAM;AAC/C,IAAA,OAAO,MAAA;AAAA,EACT;AAEA,EAAA,IAAI,OAAO,aAAa,QAAA,EAAU;AAChC,IAAA,IAAI,aAAa,KAAA,EAAO;AACtB,MAAA,MAAM,IAAI,KAAA;AAAA,QACR,mCAAmC,QAAQ,CAAA,iBAAA;AAAA,OAC7C;AAAA,IACF;AACA,IAAA,OAAO,EAAC;AAAA,EACV;AAEA,EAAA,IAAI,OAAO,QAAA,KAAa,QAAA,IAAY,KAAA,CAAM,OAAA,CAAQ,QAAQ,CAAA,EAAG;AAC3D,IAAA,MAAM,IAAI,MAAM,mDAAmD,CAAA;AAAA,EACrE;AACA,EAAA,MAAM,cAAA,GAAiB,IAAI,YAAA,CAAa,QAAA,EAAU,cAAc,CAAA;AAEhE,EAAA,OAAO;AAAA,IACL,OAAA,EAAS,cAAA,CAAe,sBAAA,CAAuB,SAAS,CAAA;AAAA,IACxD,OAAA,EAAS,cAAA,CAAe,sBAAA,CAAuB,SAAS;AAAA,GAC1D;AACF;AAKO,SAAS,0BAA0B,MAAA,EAExC;AACA,EAAA,MAAM,UAAA,GACJ,OACA,2BAA2B,CAAA;AAE7B,EAAA,MAAM,SAAA,GAAY,2BAA2B,MAAM,CAAA;AACnD,EAAA,IAAI,CAAC,SAAA,EAAW;AACd,IAAA,OAAO,EAAE,QAAA,EAAU,EAAC,EAAE;AAAA,EACxB;AAEA,EAAA,OAAO;AAAA,IACL,UACE,UAAA,EAAY,OAAA,CACT,OAAO,CAAC,EAAE,MAAK,KAAM;AACpB,MAAA,IAAI,SAAA,CAAU,OAAA,EAAS,QAAA,CAAS,IAAI,CAAA,EAAG;AACrC,QAAA,OAAO,KAAA;AAAA,MACT;AACA,MAAA,IAAI,UAAU,OAAA,IAAW,CAAC,UAAU,OAAA,CAAQ,QAAA,CAAS,IAAI,CAAA,EAAG;AAC1D,QAAA,OAAO,KAAA;AAAA,MACT;AACA,MAAA,OAAO,IAAA;AAAA,IACT,CAAC,CAAA,CACA,GAAA,CAAI,CAAA,CAAA,KAAK,CAAA,CAAE,OAAO,CAAA,CAClB,MAAA,CAAO,iBAAiB,CAAA,IAAK;AAAC,GACrC;AACF;AAEA,SAAS,mBAAmB,GAAA,EAAsC;AAChE,EAAA,IAAI,QAAQ,IAAA,IAAQ,OAAO,GAAA,KAAQ,QAAA,IAAY,YAAY,GAAA,EAAK;AAC9D,IAAA,OACE,GAAA,CAAI,MAAA,KAAW,2BAAA,IACf,GAAA,CAAI,MAAA,KAAW,2BAAA;AAAA,EAEnB;AACA,EAAA,OAAO,KAAA;AACT;AAEA,SAAS,kBACP,GAAA,EACgD;AAChD,EAAA,OAAO,kBAAA,CAAmB,GAAG,CAAA,IAAK,wBAAA,CAAyB,GAAG,CAAA;AAChE;;;;"}