{"version":3,"file":"createApp.esm.js","sources":["../src/createApp.tsx"],"sourcesContent":["/*\n * Copyright 2024 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { JSX, lazy, ReactNode, Suspense } from 'react';\nimport {\n  ConfigApi,\n  coreExtensionData,\n  ExtensionFactoryMiddleware,\n  FrontendFeature,\n  FrontendFeatureLoader,\n} from '@backstage/frontend-plugin-api';\nimport { Progress } from '@backstage/core-components';\n// eslint-disable-next-line @backstage/no-relative-monorepo-imports\nimport { defaultConfigLoaderSync } from '../../core-app-api/src/app/defaultConfigLoader';\n// eslint-disable-next-line @backstage/no-relative-monorepo-imports\nimport { overrideBaseUrlConfigs } from '../../core-app-api/src/app/overrideBaseUrlConfigs';\nimport { ConfigReader } from '@backstage/config';\nimport {\n  CreateAppRouteBinder,\n  createSpecializedApp,\n  FrontendPluginInfoResolver,\n} from '@backstage/frontend-app-api';\nimport appPlugin from '@backstage/plugin-app';\nimport { discoverAvailableFeatures } from './discovery';\nimport { resolveAsyncFeatures } from './resolution';\nimport { maybeCreateErrorPage } from './maybeCreateErrorPage';\n\n/**\n * Options for {@link createApp}.\n *\n * @public\n */\nexport interface CreateAppOptions {\n  /**\n   * The list of features to load.\n   */\n  features?: (FrontendFeature | FrontendFeatureLoader)[];\n\n  /**\n   * Allows for the binding of plugins' external route refs within the app.\n   */\n  bindRoutes?(context: { bind: CreateAppRouteBinder }): void;\n\n  /**\n   * Advanced, more rarely used options.\n   */\n  advanced?: {\n    /**\n     * If set to true, the system will silently accept and move on if\n     * encountering config for extensions that do not exist. The default is to\n     * reject such config to help catch simple mistakes.\n     *\n     * This flag can be useful in some scenarios where you have a dynamic set of\n     * extensions enabled at different times, but also increases the risk of\n     * accidentally missing e.g. simple typos in your config.\n     */\n    allowUnknownExtensionConfig?: boolean;\n\n    /**\n     * Sets a custom config loader, replacing the builtin one.\n     *\n     * This can be used e.g. if you have the need to source config out of custom\n     * storages.\n     */\n    configLoader?: () => Promise<{ config: ConfigApi }>;\n\n    /**\n     * Applies one or more middleware on every extension, as they are added to\n     * the application.\n     *\n     * This is an advanced use case for modifying extension data on the fly as\n     * it gets emitted by extensions being instantiated.\n     */\n    extensionFactoryMiddleware?:\n      | ExtensionFactoryMiddleware\n      | ExtensionFactoryMiddleware[];\n\n    /**\n     * The element to render while loading the app (waiting for config, features, etc).\n     *\n     * This is the `<Progress />` component from `@backstage/core-components` by default.\n     * If set to `null` then no loading fallback element is rendered at all.\n     */\n    loadingElement?: ReactNode;\n\n    /**\n     * Allows for customizing how plugin info is retrieved.\n     */\n    pluginInfoResolver?: FrontendPluginInfoResolver;\n  };\n}\n\n/**\n * Creates a new Backstage frontend app instance. See https://backstage.io/docs/frontend-system/building-apps/index\n *\n * @public\n */\nexport function createApp(options?: CreateAppOptions): {\n  createRoot(): JSX.Element;\n} {\n  let suspenseFallback = options?.advanced?.loadingElement;\n  if (suspenseFallback === undefined) {\n    suspenseFallback = <Progress />;\n  }\n\n  async function appLoader() {\n    const config =\n      (await options?.advanced?.configLoader?.().then(c => c.config)) ??\n      ConfigReader.fromConfigs(\n        overrideBaseUrlConfigs(defaultConfigLoaderSync()),\n      );\n\n    const { features: discoveredFeaturesAndLoaders } =\n      discoverAvailableFeatures(config);\n    const { features: loadedFeatures } = await resolveAsyncFeatures({\n      config,\n      features: [...discoveredFeaturesAndLoaders, ...(options?.features ?? [])],\n    });\n\n    const app = createSpecializedApp({\n      features: [appPlugin, ...loadedFeatures],\n      config,\n      bindRoutes: options?.bindRoutes,\n      advanced: options?.advanced,\n    });\n\n    const errorPage = maybeCreateErrorPage(app);\n    if (errorPage) {\n      return { default: () => errorPage };\n    }\n\n    const rootEl = app.tree.root.instance!.getData(\n      coreExtensionData.reactElement,\n    );\n\n    return { default: () => rootEl };\n  }\n\n  const LazyApp = lazy(appLoader);\n\n  return {\n    createRoot() {\n      return (\n        <Suspense fallback={suspenseFallback}>\n          <LazyApp />\n        </Suspense>\n      );\n    },\n  };\n}\n"],"names":[],"mappings":";;;;;;;;;;;;;AA8GO,SAAS,UAAU,OAAA,EAExB;AACA,EAAA,IAAI,gBAAA,GAAmB,SAAS,QAAA,EAAU,cAAA;AAC1C,EAAA,IAAI,qBAAqB,MAAA,EAAW;AAClC,IAAA,gBAAA,uBAAoB,QAAA,EAAA,EAAS,CAAA;AAAA,EAC/B;AAEA,EAAA,eAAe,SAAA,GAAY;AACzB,IAAA,MAAM,MAAA,GACH,MAAM,OAAA,EAAS,QAAA,EAAU,YAAA,IAAe,CAAE,IAAA,CAAK,CAAA,CAAA,KAAK,CAAA,CAAE,MAAM,CAAA,IAC7D,YAAA,CAAa,WAAA;AAAA,MACX,sBAAA,CAAuB,yBAAyB;AAAA,KAClD;AAEF,IAAA,MAAM,EAAE,QAAA,EAAU,4BAAA,EAA6B,GAC7C,0BAA0B,MAAM,CAAA;AAClC,IAAA,MAAM,EAAE,QAAA,EAAU,cAAA,EAAe,GAAI,MAAM,oBAAA,CAAqB;AAAA,MAC9D,MAAA;AAAA,MACA,QAAA,EAAU,CAAC,GAAG,4BAAA,EAA8B,GAAI,OAAA,EAAS,QAAA,IAAY,EAAG;AAAA,KACzE,CAAA;AAED,IAAA,MAAM,MAAM,oBAAA,CAAqB;AAAA,MAC/B,QAAA,EAAU,CAAC,SAAA,EAAW,GAAG,cAAc,CAAA;AAAA,MACvC,MAAA;AAAA,MACA,YAAY,OAAA,EAAS,UAAA;AAAA,MACrB,UAAU,OAAA,EAAS;AAAA,KACpB,CAAA;AAED,IAAA,MAAM,SAAA,GAAY,qBAAqB,GAAG,CAAA;AAC1C,IAAA,IAAI,SAAA,EAAW;AACb,MAAA,OAAO,EAAE,OAAA,EAAS,MAAM,SAAA,EAAU;AAAA,IACpC;AAEA,IAAA,MAAM,MAAA,GAAS,GAAA,CAAI,IAAA,CAAK,IAAA,CAAK,QAAA,CAAU,OAAA;AAAA,MACrC,iBAAA,CAAkB;AAAA,KACpB;AAEA,IAAA,OAAO,EAAE,OAAA,EAAS,MAAM,MAAA,EAAO;AAAA,EACjC;AAEA,EAAA,MAAM,OAAA,GAAU,KAAK,SAAS,CAAA;AAE9B,EAAA,OAAO;AAAA,IACL,UAAA,GAAa;AACX,MAAA,2BACG,QAAA,EAAA,EAAS,QAAA,EAAU,gBAAA,EAClB,QAAA,kBAAA,GAAA,CAAC,WAAQ,CAAA,EACX,CAAA;AAAA,IAEJ;AAAA,GACF;AACF;;;;"}