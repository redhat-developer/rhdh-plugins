{"version":3,"file":"Router.esm.js","sources":["../../../src/components/Router/Router.tsx"],"sourcesContent":["/*\n * Copyright 2022 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport { ComponentType, PropsWithChildren } from 'react';\nimport { Routes, Route, useOutlet } from 'react-router-dom';\n\nimport {\n  FieldExtensionOptions,\n  FormProps,\n  ReviewStepProps,\n  TemplateGroupFilter,\n} from '@backstage/plugin-scaffolder-react';\nimport {\n  ScaffolderTaskOutput,\n  SecretsContextProvider,\n  useCustomFieldExtensions,\n  useCustomLayouts,\n} from '@backstage/plugin-scaffolder-react';\n\nimport { TemplateEntityV1beta3 } from '@backstage/plugin-scaffolder-common';\nimport { DEFAULT_SCAFFOLDER_FIELD_EXTENSIONS } from '../../extensions/default';\n\nimport {\n  actionsRouteRef,\n  editorRouteRef,\n  customFieldsRouteRef,\n  editRouteRef,\n  scaffolderListTaskRouteRef,\n  scaffolderTaskRouteRef,\n  selectedTemplateRouteRef,\n  templateFormRouteRef,\n  templatingExtensionsRouteRef,\n} from '../../routes';\n\nimport { ActionsPage } from '../../components/ActionsPage';\nimport { ListTasksPage } from '../../components/ListTasksPage';\n\nimport {\n  TemplateListPageProps,\n  TemplateWizardPageProps,\n} from '@backstage/plugin-scaffolder/alpha';\nimport { TemplateListPage, TemplateWizardPage } from '../../alpha/components';\nimport { OngoingTask } from '../OngoingTask';\nimport {\n  TemplateFormPage,\n  TemplateIntroPage,\n  TemplateEditorPage,\n  CustomFieldsPage,\n} from '../../alpha/components/TemplateEditorPage';\nimport { RequirePermission } from '@backstage/plugin-permission-react';\nimport { templateManagementPermission } from '@backstage/plugin-scaffolder-common/alpha';\nimport { useApp } from '@backstage/core-plugin-api';\nimport { OpaqueFormField } from '@internal/scaffolder';\nimport { useAsync, useMountEffect } from '@react-hookz/web';\nimport { TemplatingExtensionsPage } from '../TemplatingExtensionsPage';\nimport { FormField } from '@backstage/plugin-scaffolder-react/alpha';\n\n/**\n * The Props for the Scaffolder Router\n *\n * @public\n */\nexport type RouterProps = {\n  components?: {\n    ReviewStepComponent?: ComponentType<ReviewStepProps>;\n    TemplateCardComponent?: ComponentType<{\n      template: TemplateEntityV1beta3;\n    }>;\n    TaskPageComponent?: ComponentType<PropsWithChildren<{}>>;\n    EXPERIMENTAL_TemplateOutputsComponent?: ComponentType<{\n      output?: ScaffolderTaskOutput;\n    }>;\n    EXPERIMENTAL_TemplateListPageComponent?: ComponentType<TemplateListPageProps>;\n    EXPERIMENTAL_TemplateWizardPageComponent?: ComponentType<TemplateWizardPageProps>;\n  };\n  groups?: TemplateGroupFilter[];\n  templateFilter?: (entity: TemplateEntityV1beta3) => boolean;\n  headerOptions?: {\n    pageTitleOverride?: string;\n    title?: string;\n    subtitle?: string;\n  };\n  defaultPreviewTemplate?: string;\n  formProps?: FormProps;\n  contextMenu?: {\n    /** Whether to show a link to the template editor */\n    editor?: boolean;\n    /** Whether to show a link to the actions documentation */\n    actions?: boolean;\n    /** Whether to show a link to the tasks page */\n    tasks?: boolean;\n    /** Whether to show a link to the create page (on /create subroutes) */\n    create?: boolean;\n  };\n};\n\n/**\n * Internal router with additional props that aren't available in the public API\n * for the old frontend system.\n *\n * @internal\n */\nexport const InternalRouter = (\n  props: PropsWithChildren<\n    RouterProps & { formFieldLoaders?: Array<() => Promise<FormField>> }\n  >,\n) => {\n  const {\n    components: {\n      TemplateCardComponent,\n      TaskPageComponent = OngoingTask,\n      ReviewStepComponent,\n      EXPERIMENTAL_TemplateOutputsComponent: TemplateOutputsComponent,\n      EXPERIMENTAL_TemplateListPageComponent:\n        TemplateListPageComponent = TemplateListPage,\n      EXPERIMENTAL_TemplateWizardPageComponent:\n        TemplateWizardPageComponent = TemplateWizardPage,\n    } = {},\n  } = props;\n  const outlet = useOutlet() || props.children;\n  const customFieldExtensions = useCustomFieldExtensions(outlet);\n  const loadedFieldExtensions = useFormFieldLoaders(props.formFieldLoaders);\n\n  const app = useApp();\n  const { NotFoundErrorPage } = app.getComponents();\n\n  const fieldExtensions = [\n    ...customFieldExtensions,\n    ...loadedFieldExtensions,\n    ...DEFAULT_SCAFFOLDER_FIELD_EXTENSIONS.filter(\n      ({ name }) =>\n        !customFieldExtensions.some(\n          customFieldExtension => customFieldExtension.name === name,\n        ),\n    ),\n  ] as FieldExtensionOptions[];\n\n  const customLayouts = useCustomLayouts(outlet);\n\n  return (\n    <Routes>\n      <Route\n        path=\"/\"\n        element={\n          <TemplateListPageComponent\n            TemplateCardComponent={TemplateCardComponent}\n            contextMenu={props.contextMenu}\n            groups={props.groups}\n            templateFilter={props.templateFilter}\n            headerOptions={props.headerOptions}\n          />\n        }\n      />\n      <Route\n        path={selectedTemplateRouteRef.path}\n        element={\n          <SecretsContextProvider>\n            <TemplateWizardPageComponent\n              headerOptions={props.headerOptions}\n              customFieldExtensions={fieldExtensions}\n              layouts={customLayouts}\n              components={{ ReviewStepComponent }}\n              formProps={props.formProps}\n            />\n          </SecretsContextProvider>\n        }\n      />\n      <Route\n        path={scaffolderTaskRouteRef.path}\n        element={\n          <TaskPageComponent\n            TemplateOutputsComponent={TemplateOutputsComponent}\n          />\n        }\n      />\n      <Route\n        path={editRouteRef.path}\n        element={\n          <RequirePermission permission={templateManagementPermission}>\n            <SecretsContextProvider>\n              <TemplateIntroPage />\n            </SecretsContextProvider>\n          </RequirePermission>\n        }\n      />\n      <Route\n        path={customFieldsRouteRef.path}\n        element={\n          <RequirePermission permission={templateManagementPermission}>\n            <SecretsContextProvider>\n              <CustomFieldsPage fieldExtensions={fieldExtensions} />\n            </SecretsContextProvider>\n          </RequirePermission>\n        }\n      />\n      <Route\n        path={templateFormRouteRef.path}\n        element={\n          <RequirePermission permission={templateManagementPermission}>\n            <SecretsContextProvider>\n              <TemplateFormPage\n                layouts={customLayouts}\n                formProps={props.formProps}\n                fieldExtensions={fieldExtensions}\n              />\n            </SecretsContextProvider>\n          </RequirePermission>\n        }\n      />\n\n      <Route\n        path={actionsRouteRef.path}\n        element={<ActionsPage contextMenu={props.contextMenu} />}\n      />\n      <Route\n        path={scaffolderListTaskRouteRef.path}\n        element={<ListTasksPage contextMenu={props.contextMenu} />}\n      />\n      <Route\n        path={editorRouteRef.path}\n        element={\n          <RequirePermission permission={templateManagementPermission}>\n            <SecretsContextProvider>\n              <TemplateEditorPage\n                layouts={customLayouts}\n                formProps={props.formProps}\n                fieldExtensions={fieldExtensions}\n              />\n            </SecretsContextProvider>\n          </RequirePermission>\n        }\n      />\n      <Route\n        path={templatingExtensionsRouteRef.path}\n        element={<TemplatingExtensionsPage />}\n      />\n      <Route path=\"*\" element={<NotFoundErrorPage />} />\n    </Routes>\n  );\n};\n\n/**\n * The Scaffolder Router\n *\n * @public\n */\nexport const Router = (props: PropsWithChildren<RouterProps>) => {\n  return <InternalRouter {...props} />;\n};\n\nfunction useFormFieldLoaders(\n  formFieldLoaders?: Array<() => Promise<FormField>>,\n) {\n  const [{ result: loadedFieldExtensions }, { execute }] =\n    useAsync(async () => {\n      const loaded = await Promise.all(\n        (formFieldLoaders ?? []).map(loader => loader()),\n      );\n      return loaded.map(f => OpaqueFormField.toInternal(f));\n    }, []);\n  useMountEffect(execute);\n  return loadedFieldExtensions;\n}\n"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;AAkHO,MAAM,cAAA,GAAiB,CAC5B,KAAA,KAGG;AACH,EAAA,MAAM;AAAA,IACJ,UAAA,EAAY;AAAA,MACV,qBAAA;AAAA,MACA,iBAAA,GAAoB,WAAA;AAAA,MACpB,mBAAA;AAAA,MACA,qCAAA,EAAuC,wBAAA;AAAA,MACvC,wCACE,yBAAA,GAA4B,gBAAA;AAAA,MAC9B,0CACE,2BAAA,GAA8B;AAAA,QAC9B;AAAC,GACP,GAAI,KAAA;AACJ,EAAA,MAAM,MAAA,GAAS,SAAA,EAAU,IAAK,KAAA,CAAM,QAAA;AACpC,EAAA,MAAM,qBAAA,GAAwB,yBAAyB,MAAM,CAAA;AAC7D,EAAA,MAAM,qBAAA,GAAwB,mBAAA,CAAoB,KAAA,CAAM,gBAAgB,CAAA;AAExE,EAAA,MAAM,MAAM,MAAA,EAAO;AACnB,EAAA,MAAM,EAAE,iBAAA,EAAkB,GAAI,GAAA,CAAI,aAAA,EAAc;AAEhD,EAAA,MAAM,eAAA,GAAkB;AAAA,IACtB,GAAG,qBAAA;AAAA,IACH,GAAG,qBAAA;AAAA,IACH,GAAG,mCAAA,CAAoC,MAAA;AAAA,MACrC,CAAC,EAAE,IAAA,EAAK,KACN,CAAC,qBAAA,CAAsB,IAAA;AAAA,QACrB,CAAA,oBAAA,KAAwB,qBAAqB,IAAA,KAAS;AAAA;AACxD;AACJ,GACF;AAEA,EAAA,MAAM,aAAA,GAAgB,iBAAiB,MAAM,CAAA;AAE7C,EAAA,4BACG,MAAA,EAAA,EACC,QAAA,EAAA;AAAA,oBAAA,GAAA;AAAA,MAAC,KAAA;AAAA,MAAA;AAAA,QACC,IAAA,EAAK,GAAA;AAAA,QACL,OAAA,kBACE,GAAA;AAAA,UAAC,yBAAA;AAAA,UAAA;AAAA,YACC,qBAAA;AAAA,YACA,aAAa,KAAA,CAAM,WAAA;AAAA,YACnB,QAAQ,KAAA,CAAM,MAAA;AAAA,YACd,gBAAgB,KAAA,CAAM,cAAA;AAAA,YACtB,eAAe,KAAA,CAAM;AAAA;AAAA;AACvB;AAAA,KAEJ;AAAA,oBACA,GAAA;AAAA,MAAC,KAAA;AAAA,MAAA;AAAA,QACC,MAAM,wBAAA,CAAyB,IAAA;AAAA,QAC/B,OAAA,sBACG,sBAAA,EAAA,EACC,QAAA,kBAAA,GAAA;AAAA,UAAC,2BAAA;AAAA,UAAA;AAAA,YACC,eAAe,KAAA,CAAM,aAAA;AAAA,YACrB,qBAAA,EAAuB,eAAA;AAAA,YACvB,OAAA,EAAS,aAAA;AAAA,YACT,UAAA,EAAY,EAAE,mBAAA,EAAoB;AAAA,YAClC,WAAW,KAAA,CAAM;AAAA;AAAA,SACnB,EACF;AAAA;AAAA,KAEJ;AAAA,oBACA,GAAA;AAAA,MAAC,KAAA;AAAA,MAAA;AAAA,QACC,MAAM,sBAAA,CAAuB,IAAA;AAAA,QAC7B,OAAA,kBACE,GAAA;AAAA,UAAC,iBAAA;AAAA,UAAA;AAAA,YACC;AAAA;AAAA;AACF;AAAA,KAEJ;AAAA,oBACA,GAAA;AAAA,MAAC,KAAA;AAAA,MAAA;AAAA,QACC,MAAM,YAAA,CAAa,IAAA;AAAA,QACnB,OAAA,kBACE,GAAA,CAAC,iBAAA,EAAA,EAAkB,UAAA,EAAY,4BAAA,EAC7B,8BAAC,sBAAA,EAAA,EACC,QAAA,kBAAA,GAAA,CAAC,iBAAA,EAAA,EAAkB,CAAA,EACrB,CAAA,EACF;AAAA;AAAA,KAEJ;AAAA,oBACA,GAAA;AAAA,MAAC,KAAA;AAAA,MAAA;AAAA,QACC,MAAM,oBAAA,CAAqB,IAAA;AAAA,QAC3B,OAAA,kBACE,GAAA,CAAC,iBAAA,EAAA,EAAkB,UAAA,EAAY,4BAAA,EAC7B,QAAA,kBAAA,GAAA,CAAC,sBAAA,EAAA,EACC,QAAA,kBAAA,GAAA,CAAC,gBAAA,EAAA,EAAiB,eAAA,EAAkC,CAAA,EACtD,CAAA,EACF;AAAA;AAAA,KAEJ;AAAA,oBACA,GAAA;AAAA,MAAC,KAAA;AAAA,MAAA;AAAA,QACC,MAAM,oBAAA,CAAqB,IAAA;AAAA,QAC3B,yBACE,GAAA,CAAC,iBAAA,EAAA,EAAkB,UAAA,EAAY,4BAAA,EAC7B,8BAAC,sBAAA,EAAA,EACC,QAAA,kBAAA,GAAA;AAAA,UAAC,gBAAA;AAAA,UAAA;AAAA,YACC,OAAA,EAAS,aAAA;AAAA,YACT,WAAW,KAAA,CAAM,SAAA;AAAA,YACjB;AAAA;AAAA,WAEJ,CAAA,EACF;AAAA;AAAA,KAEJ;AAAA,oBAEA,GAAA;AAAA,MAAC,KAAA;AAAA,MAAA;AAAA,QACC,MAAM,eAAA,CAAgB,IAAA;AAAA,QACtB,OAAA,kBAAS,GAAA,CAAC,WAAA,EAAA,EAAY,WAAA,EAAa,MAAM,WAAA,EAAa;AAAA;AAAA,KACxD;AAAA,oBACA,GAAA;AAAA,MAAC,KAAA;AAAA,MAAA;AAAA,QACC,MAAM,0BAAA,CAA2B,IAAA;AAAA,QACjC,OAAA,kBAAS,GAAA,CAAC,aAAA,EAAA,EAAc,WAAA,EAAa,MAAM,WAAA,EAAa;AAAA;AAAA,KAC1D;AAAA,oBACA,GAAA;AAAA,MAAC,KAAA;AAAA,MAAA;AAAA,QACC,MAAM,cAAA,CAAe,IAAA;AAAA,QACrB,yBACE,GAAA,CAAC,iBAAA,EAAA,EAAkB,UAAA,EAAY,4BAAA,EAC7B,8BAAC,sBAAA,EAAA,EACC,QAAA,kBAAA,GAAA;AAAA,UAAC,kBAAA;AAAA,UAAA;AAAA,YACC,OAAA,EAAS,aAAA;AAAA,YACT,WAAW,KAAA,CAAM,SAAA;AAAA,YACjB;AAAA;AAAA,WAEJ,CAAA,EACF;AAAA;AAAA,KAEJ;AAAA,oBACA,GAAA;AAAA,MAAC,KAAA;AAAA,MAAA;AAAA,QACC,MAAM,4BAAA,CAA6B,IAAA;AAAA,QACnC,OAAA,sBAAU,wBAAA,EAAA,EAAyB;AAAA;AAAA,KACrC;AAAA,wBACC,KAAA,EAAA,EAAM,IAAA,EAAK,KAAI,OAAA,kBAAS,GAAA,CAAC,qBAAkB,CAAA,EAAI;AAAA,GAAA,EAClD,CAAA;AAEJ;AAOO,MAAM,MAAA,GAAS,CAAC,KAAA,KAA0C;AAC/D,EAAA,uBAAO,GAAA,CAAC,cAAA,EAAA,EAAgB,GAAG,KAAA,EAAO,CAAA;AACpC;AAEA,SAAS,oBACP,gBAAA,EACA;AACA,EAAA,MAAM,CAAC,EAAE,MAAA,EAAQ,qBAAA,EAAsB,EAAG,EAAE,OAAA,EAAS,CAAA,GACnD,QAAA,CAAS,YAAY;AACnB,IAAA,MAAM,MAAA,GAAS,MAAM,OAAA,CAAQ,GAAA;AAAA,MAAA,CAC1B,oBAAoB,EAAC,EAAG,GAAA,CAAI,CAAA,MAAA,KAAU,QAAQ;AAAA,KACjD;AACA,IAAA,OAAO,OAAO,GAAA,CAAI,CAAA,CAAA,KAAK,eAAA,CAAgB,UAAA,CAAW,CAAC,CAAC,CAAA;AAAA,EACtD,CAAA,EAAG,EAAE,CAAA;AACP,EAAA,cAAA,CAAe,OAAO,CAAA;AACtB,EAAA,OAAO,qBAAA;AACT;;;;"}