{"version":3,"file":"OwnedEntityPicker.esm.js","sources":["../../../../src/components/fields/OwnedEntityPicker/OwnedEntityPicker.tsx"],"sourcesContent":["/*\n * Copyright 2021 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport { RELATION_OWNED_BY } from '@backstage/catalog-model';\nimport { identityApiRef, useApi } from '@backstage/core-plugin-api';\nimport TextField from '@material-ui/core/TextField';\nimport Autocomplete from '@material-ui/lab/Autocomplete';\nimport useAsync from 'react-use/esm/useAsync';\nimport { EntityPicker } from '../EntityPicker/EntityPicker';\n\nimport { OwnedEntityPickerProps } from './schema';\nimport { EntityPickerProps } from '../EntityPicker/schema';\nimport { useTranslationRef } from '@backstage/core-plugin-api/alpha';\nimport { scaffolderTranslationRef } from '../../../translation';\nimport { ScaffolderField } from '@backstage/plugin-scaffolder-react/alpha';\n\nexport { OwnedEntityPickerSchema } from './schema';\n\n/**\n * The underlying component that is rendered in the form for the `OwnedEntityPicker`\n * field extension.\n *\n * @public\n */\nexport const OwnedEntityPicker = (props: OwnedEntityPickerProps) => {\n  const { t } = useTranslationRef(scaffolderTranslationRef);\n  const {\n    schema: {\n      title = t('fields.ownedEntityPicker.title'),\n      description = t('fields.ownedEntityPicker.description'),\n    },\n    uiSchema,\n    required,\n  } = props;\n\n  const identityApi = useApi(identityApiRef);\n  const { loading, value: identityRefs } = useAsync(async () => {\n    const identity = await identityApi.getBackstageIdentity();\n    return identity.ownershipEntityRefs;\n  });\n\n  if (loading)\n    return (\n      <ScaffolderField\n        rawDescription={uiSchema['ui:description'] ?? description}\n        required={required}\n        disabled={uiSchema['ui:disabled']}\n      >\n        <Autocomplete\n          loading={loading}\n          renderInput={params => (\n            <TextField\n              {...params}\n              label={title}\n              margin=\"dense\"\n              FormHelperTextProps={{\n                margin: 'dense',\n                style: { marginLeft: 0 },\n              }}\n              variant=\"outlined\"\n              required={required}\n              InputProps={params.InputProps}\n            />\n          )}\n          options={[]}\n        />\n      </ScaffolderField>\n    );\n\n  const entityPickerUISchema = buildEntityPickerUISchema(\n    uiSchema,\n    identityRefs,\n  );\n\n  return <EntityPicker {...props} uiSchema={entityPickerUISchema} />;\n};\n\n/**\n * Builds a `uiSchema` for an `EntityPicker` from a parent `OwnedEntityPicker`.\n * Migrates deprecated parameters such as `allowedKinds` to `catalogFilter` structure.\n *\n * @param uiSchema The `uiSchema` of an `OwnedEntityPicker` component.\n * @param identityRefs The user and group entities that the user claims ownership through.\n * @returns The `uiSchema` for an `EntityPicker` component.\n */\nfunction buildEntityPickerUISchema(\n  uiSchema: OwnedEntityPickerProps['uiSchema'],\n  identityRefs: string[] | undefined,\n): EntityPickerProps['uiSchema'] {\n  // Note: This is typed to avoid es-lint rule TS2698\n  const uiOptions: EntityPickerProps['uiSchema']['ui:options'] =\n    uiSchema?.['ui:options'] || {};\n  const { allowedKinds, ...extraOptions } = uiOptions;\n\n  const catalogFilter = asArray(uiOptions.catalogFilter).map(e => ({\n    ...e,\n    ...(allowedKinds ? { kind: allowedKinds } : {}),\n    [`relations.${RELATION_OWNED_BY}`]: identityRefs || [],\n  }));\n\n  return {\n    'ui:options': {\n      ...extraOptions,\n      catalogFilter,\n    },\n  };\n}\n\nfunction asArray(catalogFilter: any): any[] {\n  if (catalogFilter) {\n    return Array.isArray(catalogFilter) ? catalogFilter : [catalogFilter];\n  }\n  return [{}];\n}\n"],"names":[],"mappings":";;;;;;;;;;;;AAoCO,MAAM,iBAAA,GAAoB,CAAC,KAAA,KAAkC;AAClE,EAAA,MAAM,EAAE,CAAA,EAAE,GAAI,iBAAA,CAAkB,wBAAwB,CAAA;AACxD,EAAA,MAAM;AAAA,IACJ,MAAA,EAAQ;AAAA,MACN,KAAA,GAAQ,EAAE,gCAAgC,CAAA;AAAA,MAC1C,WAAA,GAAc,EAAE,sCAAsC;AAAA,KACxD;AAAA,IACA,QAAA;AAAA,IACA;AAAA,GACF,GAAI,KAAA;AAEJ,EAAA,MAAM,WAAA,GAAc,OAAO,cAAc,CAAA;AACzC,EAAA,MAAM,EAAE,OAAA,EAAS,KAAA,EAAO,YAAA,EAAa,GAAI,SAAS,YAAY;AAC5D,IAAA,MAAM,QAAA,GAAW,MAAM,WAAA,CAAY,oBAAA,EAAqB;AACxD,IAAA,OAAO,QAAA,CAAS,mBAAA;AAAA,EAClB,CAAC,CAAA;AAED,EAAA,IAAI,OAAA;AACF,IAAA,uBACE,GAAA;AAAA,MAAC,eAAA;AAAA,MAAA;AAAA,QACC,cAAA,EAAgB,QAAA,CAAS,gBAAgB,CAAA,IAAK,WAAA;AAAA,QAC9C,QAAA;AAAA,QACA,QAAA,EAAU,SAAS,aAAa,CAAA;AAAA,QAEhC,QAAA,kBAAA,GAAA;AAAA,UAAC,YAAA;AAAA,UAAA;AAAA,YACC,OAAA;AAAA,YACA,aAAa,CAAA,MAAA,qBACX,GAAA;AAAA,cAAC,SAAA;AAAA,cAAA;AAAA,gBACE,GAAG,MAAA;AAAA,gBACJ,KAAA,EAAO,KAAA;AAAA,gBACP,MAAA,EAAO,OAAA;AAAA,gBACP,mBAAA,EAAqB;AAAA,kBACnB,MAAA,EAAQ,OAAA;AAAA,kBACR,KAAA,EAAO,EAAE,UAAA,EAAY,CAAA;AAAE,iBACzB;AAAA,gBACA,OAAA,EAAQ,UAAA;AAAA,gBACR,QAAA;AAAA,gBACA,YAAY,MAAA,CAAO;AAAA;AAAA,aACrB;AAAA,YAEF,SAAS;AAAC;AAAA;AACZ;AAAA,KACF;AAGJ,EAAA,MAAM,oBAAA,GAAuB,yBAAA;AAAA,IAC3B,QAAA;AAAA,IACA;AAAA,GACF;AAEA,EAAA,uBAAO,GAAA,CAAC,YAAA,EAAA,EAAc,GAAG,KAAA,EAAO,UAAU,oBAAA,EAAsB,CAAA;AAClE;AAUA,SAAS,yBAAA,CACP,UACA,YAAA,EAC+B;AAE/B,EAAA,MAAM,SAAA,GACJ,QAAA,GAAW,YAAY,CAAA,IAAK,EAAC;AAC/B,EAAA,MAAM,EAAE,YAAA,EAAc,GAAG,YAAA,EAAa,GAAI,SAAA;AAE1C,EAAA,MAAM,gBAAgB,OAAA,CAAQ,SAAA,CAAU,aAAa,CAAA,CAAE,IAAI,CAAA,CAAA,MAAM;AAAA,IAC/D,GAAG,CAAA;AAAA,IACH,GAAI,YAAA,GAAe,EAAE,IAAA,EAAM,YAAA,KAAiB,EAAC;AAAA,IAC7C,CAAC,CAAA,UAAA,EAAa,iBAAiB,CAAA,CAAE,GAAG,gBAAgB;AAAC,GACvD,CAAE,CAAA;AAEF,EAAA,OAAO;AAAA,IACL,YAAA,EAAc;AAAA,MACZ,GAAG,YAAA;AAAA,MACH;AAAA;AACF,GACF;AACF;AAEA,SAAS,QAAQ,aAAA,EAA2B;AAC1C,EAAA,IAAI,aAAA,EAAe;AACjB,IAAA,OAAO,MAAM,OAAA,CAAQ,aAAa,CAAA,GAAI,aAAA,GAAgB,CAAC,aAAa,CAAA;AAAA,EACtE;AACA,EAAA,OAAO,CAAC,EAAE,CAAA;AACZ;;;;"}